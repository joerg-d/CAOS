SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page   1
CAOS47  Z80

    1                   ;*************************************************
    2                   ;**						**
    3                   ;**	CAOS 4.7   (c) KC-Club 2019		**
    4                   ;**						**
    5                   ;*************************************************
    6                   ;**						**
    7                   ;**	Entwickler:				**
    8                   ;**		Mario Leubner			**
    9                   ;**		Daniel Elstner (CAOS 4.5)	**
   10                   ;**						**
   11                   ;**	CAOS-Versionen:				**
   12                   ;**	13.04.1994 - CAOS 4.2 Reassemblierung	**
   13                   ;**	17.02.1995 - CAOS 4.3			**
   14                   ;**	09.02.2003 - CAOS 4.4			**
   15                   ;**	06.09.2010 - CAOS 4.5			**
   16                   ;**	04.02.2015 - CAOS 4.6 beta1		**
   17                   ;**	05.03.2016 - CAOS 4.6 beta2 (KC-Labor)	**
   18                   ;**	18.02.2017 - CAOS 4.7 beta1 (KC-Labor)	**
   19                   ;**	21.02.2017 - CAOS 4.7 beta2 (KC-Labor)	**
   20                   ;**	26.07.2017 - CAOS 4.7 beta3 (KC-Labor)	**
   21                   ;**	20.11.2017 - CAOS 4.7 beta4 (KC-Labor)	**
   22                   ;**	05.02.2018 - CAOS 4.7 beta5 (KC-Labor)	**
   23                   ;**	03.04.2018 - CAOS 4.7 beta6 (KC-Labor)	**
   24                   ;**	04.12.2018 - CAOS 4.7 (beta7 mit Turbo)	**
   25                   ;**	27.12.2018 - CAOS 4.7 (EDIT 0.2 -> 0.3)	**
   26                   ;**	03.02.2018 - CAOS 4.7 final & EDIT 0.4	**
   27                   ;**	10.04.2019 - CAOS 4.7 Patch 1		**
   28                   ;*************************************************
   29                   ;**	10.04.2019 - CAOS 4.7			**
   30                   ;*************************************************
   31                   
   32                   DATUM	MACRO
   33                   	DB	'10.04.2019'	; Versionsdatum nur hier aendern!
   34                   	ENDM
   35                   
   36         0000      Turbo	EQU	0		; Turbolader einbinden?
   37                   	;benoetigt  14 Byte im ROM C
   38                   	;benoetigt 253 Byte im ROM D
   39                   	;benoetigt  33 Byte im ROM E
   40                   	;benoetigt   4 Byte im ROM F
   41                   
   42         0000      RAM1MB	EQU	0		; RAM8 mit 1MB verwalten?
   43                   	;benoetigt 28 Byte im ROM C
   44                   ; Diese Erweiterung setzt 1MByte RAM statt des 256K RAM im Grundgeraet voraus.
   45                   ; Die Idee dazu stammt von Frank Dachselt und war im Original sogar 2MByte gross
   46                   ; und zusaetzlich noch auf Moduladresse 06 mit dem zweiten Megabyte praesent.
   47                   ; Hardware: Die zusaetzlichen beiden RAM-Adressen werden auf Bit 2 und 3 des
   48                   ; Port2 (86h) gelegt (Bei 2MB war das Bit 4 auch noch mit genutzt)
   49                   
   50         0000      SYSROM	EQU	0		; Erweiterung des System-ROM durch Flash-ROM
   51                   	;benoetigt 22 Byte im ROM C
   52                   	;spart     -3 Byte im ROM D
   53                   	;benoetigt 25 Byte im ROM F
   54                   ; Diese Erweiterung setzt einen 128K-Flash-ROM an Stelle des CAOS- und BASIC-
   55                   ; ROM voraus. Enthalten sind 4x die CAOS-ROM C und E sowie 2x der USER-ROM
   56                   ; Umgeschalten wird mit Jumper, alternativ auch mit Bit 2 und 3 des Port 86h
   57                   ; Wenn diese Erweiterung aktiv ist, dann kann nicht gleichzeitig die 1MB-RAM-
   58                   ; erweiterung eingebaut werden.
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page   2
CAOS47  Z80

   59                   
   60         0000      if Turbo
   62                   else
   63         0000      beta	equ	0		; 0 fuer Vollversion, 1 fuer beta-Version
   64                   endif
   65                   ; Uebersetzen ohne Erzeugen eines Listings:
   66                   ;	SLRZ80 CAOS47.@@Z/F
   67                   ; oder:	Z80ASM CAOS47.@@Z/F
   68                   ;	REN CAOS47.COM CAOS47.KCC
   69                   
   70                   ; Uebersetzen mit Erzeugen eines Listings:
   71                   ;	SLRZ80 CAOS47/F
   72                   ; oder:	Z80ASM CAOS47/F
   73                   ;	REN CAOS47.COM CAOS47.KCC
   74                   
   75                   ; Hardware:	(KC85/5)
   76                   ;
   77                   ;256 KByte interner RAM (RAM0,RAM4,RAM8)
   78                   ; 64 KByte IRM (2 unabhaengige Bilder)
   79                   ; 16 KByte CAOS-ROM C000-FFFF
   80                   ; 32 KByte USER-ROM C000-DFFF (4 Ebenen)
   81                   
   82                   ;---------------------------------------------------------------------
   83                   
   84                   ;**	Speicheruebersicht, Belegung der CAOS-ROMs	**
   85                   
   86                   ;Inhalt ROM-C:
   87                   ;C000	IRM-Defaulttabelle
   88                   ;	System-Initialisierung, Erzeugung Device-Treibertabellen
   89                   ;	SYSTEM-Check, Modulcheck
   90                   ;	Module lesen und schalten (SWITCH)
   91                   ;	F-Tastenbelegung (KEY, KEYLIST)
   92                   ;	Farben setzen (COLOR)
   93                   ;	Fensterfunktionen (WINDOW, WINAK, WININ)
   94                   ;	Grafikfunktionen (LINE, PUSE, CIRCLE, PUDE)
   95                   ;	Speicherfunktionen (DISPLAY, MODIFY)
   96                   ;	Initialisierung Druckerausgabe, Duplexbetrieb
   97                   ;	allgemeine Druckroutine mit Protokoll, Screen- oder Hardcopy
   98                   ;	Byteweise Ein-/Ausgaberoutinen (MBOUT, MBIN)
   99                   ;	Tabelle der Modulnamen
  100                   
  101                   ;Inhalt ROM-D:
  102                   ;D000	(Turbo-TAPE-Treiber = Kassettenausgabe, Kassetteneingabe MPM-Turbo)
  103                   ;	TAPE-Treiber = Kassettenausgabe, Kassetteneingabe Standard
  104                   ;	DISK-Treiber = D004/D008 Floppy-Routinen
  105                   ;	Pixelausgabe, Fensterscrolling, Zeile loeschen
  106                   ;	Wurzelberechnung, Multiplikation (SQR, MULT)
  107                   ;	Speichercheck VIEW
  108                   ;	Unterprogramme fuer Modulcheck
  109                   ;	DISK: DIR, STAT, ERA, REN
  110                   ;	TYPE, DUMP, INIT
  111                   ;	DEVICE-Treiber umschalten, auflisten
  112                   ;	DISK: Laufwerk wechseln mit DRIVE
  113                   ;	TAPE: Kassetteninhalt auflisten mit TAPELIST
  114                   ;	Grafiksequenzen fuer die Drucker
  115                   ;	V.24-Initialisierungstabellen
  116                   ;	Original der Unterprogrammtabelle SUTAB
  117                   ;	Treibertabelle fuer TAPE (Turbo,) und DISK
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page   3
CAOS47  Z80

  118                   ;	Portinittabellen
  119                   ;	M001-Initialisierungstabelle fuer Centronics
  120                   ;	Defaulttabelle fuer Joystick-Belegung
  121                   ;	ISRTAB	Interrupttabelle
  122                   ;	IBM-Codierungen fuer Druckerausgabe
  123                   ;	CAOS-Versionsanzeige (help)
  124                   ;DAB8	IBM-Zeichensatz
  125                   
  126                   ;Inhalt ROM-E:
  127                   ;E000	RESET, BASIC-Verteiler
  128                   ;	CRT-Treiber (PADR, DABR, CRT-Grundprogramm)
  129                   ;	Routinen der Steuercodes
  130                   ;	Tastaturtreiber mit ISR CTC Kanal 3, PIO-B, SIO-B
  131                   ;	Joysticktreiber fuer M008/M021
  132                   ;	Kassetten-Routinen Eingabe/Ausgabe
  133                   ;	Programmverteiler PV7 fuer DEVICE-Umleitungen
  134                   ;	DEVICE-Routinen MBO, MBI, ISRO, CSRO, ISRI, CSRI
  135                   ;	Interruptroutinen fuer Kassetten-Ein/Ausgabe
  136                   ;	BASIC-Erweiterungen
  137                   ;	Sprung aus CAOS-ROM-C in ROM-Modul (z.B. M052-USB)
  138                   ;	Initialisierungstabelle fuer M021
  139                   ;	(CTC-Interrupt fuer Turbo-Routinen)
  140                   ;EDFF	CAOS-Versionsnummer
  141                   ;EE00	Zeichenbildtabelle Grossbuchstaben
  142                   
  143                   ;Inhalt ROM-F:
  144                   ;F000	Power-ON, Programmverteiler, IRMON, IRMOF, RCALL
  145                   ;	Zeichenkette anzeigen (OSTR)
  146                   ;	Kommandos SWITCH und JUMP
  147                   ;	Systemstart mit Autostart ROM-Modul oder Floppy
  148                   ;	Kommandointerpreter, MENU, ZSUCH
  149                   ;	Zeichenaus-/eingabe (HLHX, AHEX, OCHR, INTB, ...)
  150                   ;	Tastatureingabe KBD, INLIN
  151                   ;	Kommando go
  152                   ;	Hex-Zahlen/Argumente erfassen (RHEX, GARG)
  153                   ;	Ports initialisieren (INIEA, INIMEX)
  154                   ;	Device-Kommandos (SAVE, VERIFY, LOAD)
  155                   ;	Kommandos COLOR, DISPLAY, MODIFY
  156                   ;	Kommandos WINDOW, KEY (mit Keylist)
  157                   ;	Cursordarstellung, Grafikroutinen
  158                   ;	BASIC-I/O-Verteiler
  159                   ;	Zeichenkette anzeigen (ZKOUT)
  160                   ;	Tonausgabe (TON)
  161                   ;	ESC-Programme
  162                   ;	Drucker-, und Duplexroutinen (M001, M021, V.24-Modul)
  163                   ;	SIO-Empfangsinterrupt (Tastatur, ESC...)
  164                   ;	Umschaltroutine fuer CAOS-ROM-C und SIXD
  165                   ;	Menuewort DEVICE
  166                   ;	Versteckte Menueworte DIR, CD, ERA, REN
  167                   ;	Tastencodetabelle KTAB
  168                   ;	Tabelle der ESC-Funktionen
  169                   ;	CRTTAB	Steuerfunktionstabelle
  170                   ;	TOKTAB	BASIC-Token mit Sprungtabelle
  171                   ;FDF0	BASIC-Unterprogrammtabelle
  172                   ;FDF8	Bittabelle fuer Punktroutinen
  173                   ;FE00	Zeichenbildtabelle Kleinbuchstaben
  174                   
  175                   ;---------------------------------------------------------------------
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page   4
CAOS47  Z80

  176                   
  177                   ; CAOS-Vorblock:
  178                   
  179 0100  43 41 4F 53 	DB	'CAOS47  KCC'
  180 010B  00 00 00 00 	DS	5,0
  181 0110  02          	DB	2		; 2 Adressen
  182 0111  4000        	DW	4000H		; AADR
  183 0113  8000        	DW	8000H		; EADR+1
  184 0115  00 00 00 00 	DS	97,0
  185                   	DATUM			; Versionsdatum
    1 0176  31 30 2E 30 	DB	'10.04.2019'	; Versionsdatum nur hier aendern!
  186                   
  187                   	INCLUDE	EQU47.INC	; Vereinbarungen, Uebersicht
    1                   ;*****************************************
    2                   ;**	CAOS 4.7			**
    3                   ;**					**
    4                   ;**	Macros und Vereinbarungen	**
    5                   ;**					**
    6                   ;**	letzte Aenderung: 25.07.2018	**
    7                   ;*****************************************
    8                   
    9                   MESSAGE	MACRO	MSG1,N,MSG2
   10                   	 .PRINTX MSG1 N MSG2
   11                   	ENDM
   12                   
   13                   ; Mit FF auffuellen, bis die absolute Adresse LOC erreicht ist:
   14                   ABSFILL	MACRO	LOC,WHAT
   15                   	 IF $ GT LOC
   16                   	  MESSAGE <Fehler! LOC:>,% $ - LOC,<Byte zu viel vor WHAT>
   17                   	 ELSE
   18                   	  IF2
   19                   	   MESSAGE <LOC:>,% LOC - $,<Byte frei vor WHAT>
   20                   	  ENDIF
   21                   	  DS	LOC - $,0FFh
   22                   	 ENDIF
   23                   	ENDM
   24                   
   25                   ; Undokumentierter Opcode:
   26                   ;	IN	F,(C)
   27                   INFC	MACRO
   28                   	 DB	0EDh,70h
   29                   	ENDM
   30                   
   31                   ; Undokumentierter Opcode:	Hinweis von KaiOr:
   32                   ;	OUT	(C),0		ED 71 ------- OUT (C),f
   33                   ;				bewirkt:
   34                   ;				NMOS-Z80 ---> OUT (C),0
   35                   ;				CMOS-Z80 ---> OUT (C),255
   36                   ;				Z380 -------> OUT (C),n -> Ausg. des nachfolgenden Bytes
   37                   ;
   38                   ;OUTC0	MACRO
   39                   ;	 DB	0EDh,71h
   40                   ;	ENDM
   41                   ; nicht mehr verwendet ab 05.03.2016 !
   42                   
   43                   ; Undokumentierter Opcode:
   44                   ;	RES	BI,(IX+DISP),A
   45                   RESIXA	MACRO	BI,DISP
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page   5
EQU47   INC

   46                   	 DB	0DDh,0CBh,DISP
   47                   	 DB	BI SHL 3 OR 10000111b
   48                   	ENDM
   49                   
   50                   ; Undokumentierter Opcode:
   51                   ;	SET	BI,(IX+DISP),A
   52                   SETIXA	MACRO	BI,DISP
   53                   	 DB	0DDh,0CBh,DISP
   54                   	 DB	BI SHL 3 OR 11000111b
   55                   	ENDM
   56                   
   57                   ; Setze Bit 7 des ersten Zeichens fuer BASIC-Token:
   58                   TOKEN	MACRO	STRING
   59                   Y	 DEFL	80h
   60                   	 IRPC	X,STRING
   61                   	  DB	'&X' + Y
   62                   Y	  DEFL	0
   63                   	 ENDM
   64                   	ENDM
   65                   
   66                   ;---------------------------------------
   67                   
   68                   ; Steuerzeichen:
   69                   
   70         000A      LF	EQU	0AH
   71         000D      CR	EQU	0DH
   72         001B      ESC	EQU	1BH
   73                   
   74                   ;---------------------------------------
   75                   
   76                   ; Portadressen im Grundgeraet:
   77                   
   78         0084      PORT1	EQU	84H	; Ausgabe-Port D08A	Merkzelle ist (IX+1)
   79                   			;	Bit 0 - Anzeige Bild 0 oder 1
   80                   			;	Bit 1 - Zugriff auf 0=Pixel- oder 1=Farbebene
   81                   			;	Bit 2 - Zugriff auf Bild 0 oder 1
   82                   			;	Bit 3 - 0=hohe Farbaufloesung oder 1=niedrige
   83                   			;	Bit 4-7 Auswahl der RAM8-Ebene (256K)
   84         0086      PORT2	EQU	86H	; Ausgabe-Port D09A	Merkzelle ist (IX+4)
   85                   			;	Bit 0 - RAM4 ein/aus
   86                   			;	Bit 1 - RAM4 Schreibschutz (1=aus)
   87                   			;	Bit 2-4 Bankauswahl fuer 2MB RAM On Board
   88                   			;	Bit 5-6 Auswahl der USER-ROM-Ebene
   89                   			;	Bit 7 - CAOS-ROM C ein/aus
   90         0088      PIOAD	EQU	88H	; System-PIO Datenbyte Port A
   91                   			;	Bit 0 - CAOS ROM-E ein/aus
   92                   			;	Bit 1 - RAM0 ein/aus
   93                   			;	Bit 2 - IRM ein/aus
   94                   			;	Bit 3 - Schreibschutz RAM0
   95                   			;	Bit 4 - K_OUT
   96                   			;	Bit 5 - System-LED
   97                   			;	Bit 6 - Motorschaltspannung
   98                   			;	Bit 7 - USER-ROM ein/aus
   99         0089      PIOBD	EQU	89H	; System-PIO Datenbyte Port B
  100                   			;	Bit 0 - Symmetrie-Flip-Flop Tonausgabe
  101                   			;	Bit 1 \
  102                   			;	Bit 2 - Lautstaerke Tonausgabe
  103                   			;	Bit 3 - 4 Bit (Low-aktiv)
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page   6
EQU47   INC

  104                   			;	Bit 4 /
  105                   			;	Bit 5 - RAM8 ein/aus
  106                   			;	Bit 6 - Schreibschutz RAM8
  107                   			;	Bit 7 - Blinken ein/aus
  108         008A      PIOAS	EQU	8AH	; System-PIO Steuerbyte Port A
  109         008B      PIOBS	EQU	8BH	; System-PIO Steuerbyte Port B
  110         008C      CTC0	EQU	8CH	; CTC Kanal 0 (Tonhoehe 1)
  111         008D      CTC1	EQU	8DH	; CTC Kanal 1 (Kassettenausgabe)
  112         008E      CTC2	EQU	8EH	; CTC Kanal 2 (Tondauer)
  113         008F      CTC3	EQU	8FH	; CTC Kanal 3 (Tastatur)
  114                   
  115                   ; Portadressen des Koppel-RAM (D004):
  116                   
  117         00F1      ERRTX	EQU	000F1H	; Fehlertext			(ab DEP 2.0)
  118         80F1      STBYT2	EQU	080F1H	; 2. Steuerbyte:		(ab DEP 2.0)
  119                   			;	Bit 0 - Anforderung
  120                   			;	Bit 1 - Laufwerkswechsel
  121                   			;	Bit 2 - Userwechsel
  122                   			;	Bit 3..6 reserviert
  123                   			;	Bit 7 - Fehlerrueckmeldung
  124         81F1      LWANF	EQU	081F1H	; Laufwerk ('A', 'B', ... 'P')
  125         82F1      UANF	EQU	082F1H	; User-Bereich (00H ... 0FH)
  126         83F1      DEPVER	EQU	083F1H	; DEP-Version BCD
  127         84F1      DATE	EQU	084F1H	; Datum BCD			(ab DEP 3.0)
  128                   			;	Jahr (00..99)
  129                   			;	Monat (1..12)
  130                   			;	Tag (1..31)
  131         87F1      TIME	EQU	087F1H	; Uhrzeit BCD			(ab DEP 3.0)
  132                   			;	Stunde (0..23)
  133                   			;	Minute (0..59)
  134                   			;	Sekunde (0..59)
  135                   
  136         80F2      FDATA	EQU	080F2H	; Daten- bzw. Sektorpuffer 128 Byte lang
  137         80F3      STBYT1	EQU	080F3H	; 1. Steuerbyte:
  138                   			;	Bit 0 - Anforderung
  139                   			;	Bit 1 - 1=schreiben/0=lesen
  140                   			;	Bit 3 - oeffnen
  141                   			;	Bit 6 - schliessen
  142                   			;	Bit 7 - Fehlerrueckmeldung
  143                   			;	Bit	5 4 2	Funktionsauswahl:
  144                   			;		0 0 0	Sektor lesen/schreiben
  145                   			;		0 0 1	DIR-Anforderung
  146                   			;		0 1 0	ERA
  147                   			;		0 1 1	STAT
  148                   			;		1 0 0	REN
  149                   			;		1 0 1	SETRO
  150                   			;		1 1 0	SETWR
  151                   			;		1 1 1	BASIC-Byte lesen/schreiben
  152         81F3      FCODE	EQU	081F3H	; Fehlercode
  153         82F3      DIRBUF	EQU	082F3H	; Puffer fuer Dateiname oder Directory
  154         8EF3      BASBYT	EQU	08EF3H	; Datenbyte fuer BASIC-Byte-Schnittstelle
  155         B3F3      UROK	EQU	0B3F3H	; Betriebsart
  156                   
  157                   ;---------------------------------------
  158                   
  159                   ; Adressen im RAM0:
  160                   
  161                   ; 0000-00FFh	; Arbeitszellen von ASM/EDIT/DEBUG
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page   7
EQU47   INC

  162                   ; 0000-00E4h	; FLOAD.KCC Original von Muehlhausen
  163                   ; 0000-00EDh	; AFLOAD.KCC mit Unterdrueckung Autostart
  164                   ; 0000-00D6h	; FLOAD2.KCC mit Fehlertexten
  165                   ; 00D8-00F7h	; BASIC-CALLs aus Original-SERVICE.KCC oder CAOS 4.3 bis 4.5
  166                   ; 0108-012Fh	; Tasten-UP von CALC, falls dieses mit %?i aktiviert worden ist.
  167                   ; 0102+0122h	; Interruptvektor von M066-Software
  168                   ; 0150-016Fh	; Umschaltroutine aus Original-BASEX.KCC
  169                   
  170         01C4      STACK	EQU	01C4H	; Systemstack
  171                   
  172                   ; Belegung der IX - Zellen:	(Standard IX=01F0h)
  173                   
  174                   ; IX+0	Zeitkonstante fuer Kassettenroutinen
  175                   ; IX+1	Merkzelle fuer Ausgabeport 84H
  176                   ; IX+2	gelesene Blocknummer (Kassette)
  177                   ; IX+3	erwartete Blocknummer (Kassette)
  178                   ; IX+4	Merkzelle fuer Ausgabeport 86H
  179                   ; IX+5	Ein- Ausgabepufferadresse (low)
  180                   ; IX+6	Ein- Ausgabepufferadresse (high)
  181                   ; IX+7	Kennbyte fuer LOAD/VERIFY
  182                   ;	 BIT 0: =1 ->LOAD  =0 ->VERIFY
  183                   ;	 BIT 1: =1 kein Selbstart bei LOAD (in BASIC Kennung fuer 1. Block)
  184                   ;	 BIT 2-4 : Anzahl Argumente (bei SAVE)/ARGN>3 (Startoffset)
  185                   ;	 BIT 5-7 : BASIC: fuer CLOAD/CSAVE 
  186                   ; IX+8	Kennbyte Tastatur
  187                   ;	 BIT 0: gueltiges Byte (ASCII) in IX+13
  188                   ;	 BIT 1: Tonausgabe laeuft
  189                   ;	 BIT 2-4: aktuelles Speichergeraet
  190                   ;		  0=Kassette, 1=Diskette, 2=USB (M052), 3=Netzwerk (M052)
  191                   ;		  4=Headersave, 5..7 frei
  192                   ;	 BIT 5: Tastenclick ein/aus
  193                   ;	 BIT 6: Code kommt von F-Taste
  194                   ;	 BIT 7: 0=Shiftlock
  195                   ; IX+9	Prologbyte (normal 7FH)
  196                   ; IX+10	Autorepeatzaehler (Tastatur)
  197                   ; IX+11	Merkzelle fuer Akku (bei BWS on/off mit Stackverlagerung)
  198                   ;	und Pruefsummenberechnung fuer MB-Eingabe
  199                   ; IX+12	7-Bit-Scancode von Tastatur
  200                   ; IX+13	ASCII-Code von Tastatur
  201                   ; IX+14	Tastaturcodetabelle low
  202                   ; IX+15	Tastaturcodetabelle high
  203                   
  204                   ; von den BASIC-Erweiterungen genutzte Arbeitszellen im RAM:
  205                   
  206         0307      IOCHNL	EQU	0307H	; Ein-/Ausgabekanal
  207         0309      ININD	EQU	0309H	; IN-Index
  208         031B      RNDVR3	EQU	031BH	; Zufallszahl
  209         034E      ANF	EQU	034EH	; erste Zeilennummer
  210         0350      ENDE	EQU	0350H	; letzte Zeilennummer
  211         0352      NANF	EQU	0352H	; neue erste Zeilennummer
  212         0354      DISTAN	EQU	0354H	; Zeilennummernabstand
  213         035E      DATFLG	EQU	035EH	; List-, Editierschutz wenn <> 0
  214         035F      PSTBEG	EQU	035FH	; Programmstartadresse (Standardwert = 0401H)
  215         037E      COLRET	EQU	037EH	; Ablage Farbbyte
  216         03C0      STRDAT	EQU	03C0H	; 4 Byte: Laenge und Adresse des aktuellen Strings
  217         03D7      SVARPT	EQU	03D7H	; Adresse der Liste der einfachen und Stringvariablen
  218         03EA      INTPRB	EQU	03EAH	; Druckpuffer=Dateiname
  219         03FD      PRTFLG	EQU	03FDH	; PRINT-Erweiterung
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page   8
EQU47   INC

  220                   
  221                   ; IRM-Belegung:
  222                   
  223         A800      V24PL	EQU	0A800H	; Steckplatz V.24-Modul
  224                   ;INTV1		0A801H	; Initialisierungsdaten V.24-Druckausgabe
  225                   ;INTV2		0A809H	; Initialisierungsdaten V.24-duplex
  226                   
  227                   ;		0A820h	; urspruenglich geplant fuer Arbeitszellen Maustreiber
  228                   	; bis	0A893h	; (115 Byte)
  229                   
  230         A880      INITU	EQU	0A880h	; Kommandoablage von INITIAL.UUU als Tastencode
  231                   	; bis	0A8FFh	; und Assemblierpuffer von EDAS/ASM
  232                   
  233                   ;		0A8A0H	; urspruenglich geplant fuer Ablage IRM-Inhalt unter
  234                   	; bis	0A8FFH	; Mauspfeil (96 Byte)
  235                   
  236         A900      DEVTAB	EQU	0A900H	; Tabelle der 8 Geraetetreiber: 8*32=256 Byte gross
  237         AA00      SUT_IRM	EQU	0AA00H	; SUTAB per Default im IRM
  238                   	; bis	0AA93h	fuer UP 00 bis 49h
  239                   
  240         AA94      JOYIRM	EQU	0AA94H	; Joystick-Tabelle (noch nicht endgueltig)     (12 Byte)
  241                   	; bis	0AA9Fh
  242                   
  243         AAA0      JWORK	EQU	0AAA0H	; Arbeitszellen vom Joystick-Editor	       (17 Byte)
  244                   	; bis	0AAB1H
  245                   
  246         AAE8      WTEMO	EQU	0AAE8H	; TEMO-Arbeitszellen zur Ablage von 2 Fenster-Daten
  247                   	; bis	0AAFFH
  248                   
  249                   ;		0AB00H	; reserviert fuer anwenderspez. Systemerweiterungen
  250                   	; bis	0ACFFH	; z.B. Treiber UOUT1/2 oder UIN1/2
  251                   
  252         AD00      VRAM1	EQU	0AD00H	; ASCII-RAM Bild 1
  253         B200      VRAM0	EQU	0B200H	; ASCII-RAM Bild 0
  254         B700      CASS	EQU	0B700H	; 128 Byte Kassettenpuffer
  255                   	; bis	0B77FH
  256         B780      ARGC	EQU	0B780H	; UP-Nummer fuer PV2 und PV6
  257         B781      ARGN	EQU	0B781H	; Anzahl Argumente
  258         B782      ARG1	EQU	0B782H	; Argument 1
  259         B784      ARG2	EQU	0B784H	;    "	   2
  260         B786      ARG3	EQU	0B786H	;    "	   3
  261         B788      ARG4	EQU	0B788H	;    "	   4
  262         B78A      ARG5	EQU	0B78AH	;    "	   5
  263         B78C      ARG6	EQU	0B78CH	;    "	   6
  264         B78E      ARG7	EQU	0B78EH	;    "	   7
  265         B790      ARG8	EQU	0B790H	;    "	   8
  266         B792      ARG9	EQU	0B792H	;    "	   9
  267         B794      ARG10	EQU	0B794H	;    "	  10
  268         B796      NUMNX	EQU	0B796H	; Anzahl Zeichen
  269         B797      NUMVX	EQU	0B797H	; Wert HEX-Zahl
  270         B799      HCADR	EQU	0B799H	; Hardcopy-Aufruf
  271         B79B      WINNR	EQU	0B79BH	; Fenster-Nr.
  272         B79C      WINON	EQU	0B79CH	; Fenster-Anfang
  273         B79E      WINLG	EQU	0B79EH	; Fenster-Groesse
  274         B7A0      CURSO	EQU	0B7A0H	; Cursor-Position
  275         B7A2      STBT	EQU	0B7A2H	; BS-Steuerbyte
  276         B7A3      COLOR	EQU	0B7A3H	; Farbe
  277         B7A4      WEND	EQU	0B7A4H	; Adresse fuer Scrolling-Routine
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page   9
EQU47   INC

  278         B7A6      CCTL0	EQU	0B7A6H	; Zeichentabelle 0
  279         B7A8      CCTL1	EQU	0B7A8H	;	"	 1
  280         B7AA      CCTL2	EQU	0B7AAH	;	"	 2
  281         B7AC      CCTL3	EQU	0B7ACH	;	"	 3
  282         B7AE      SYSP	EQU	0B7AEH	; System Stackpointer
  283         B7B0      SUTAB	EQU	0B7B0H	; UP-Tabelle
  284         B7B2      CTAB	EQU	0B7B2H	; CRT-Steuerprogramm
  285         B7B4      NCAOS	EQU	0B7B4H	; Sprung in neues System ueber IRM
  286         B7B9      OUTAB	EQU	0B7B9H	; Zeiger Ausgabe
  287         B7BB      INTAB	EQU	0B7BBH	; Zeiger Eingabe
  288         B7BD      UOUT1	EQU	0B7BDH	; Sprung OUT#2
  289         B7C0      UIN1	EQU	0B7C0H	; Sprung IN#2
  290         B7C3      UOUT2	EQU	0B7C3H	; Sprung OUT#3
  291         B7C6      UIN2	EQU	0B7C6H	; Sprung IN#3
  292         B7C9      IOERR	EQU	0B7C9H	; BASIC-Error
  293         B7CB      VRAM	EQU	0B7CBH	; Adresse Video-RAM
  294         B7CD      ZOTAB	EQU	0B7CDH
  295         B7CF      ZWEND	EQU	0B7CFH	; WEND-Merker
  296         B7D1      FTAST	EQU	0B7D1H	; F-Tastenpointer
  297         B7D3      HOR	EQU	0B7D3H	; Grafik Horizontalposition
  298         B7D5      VERT	EQU	0B7D5H	; Grafik Vertikalposition
  299         B7D6      FARB	EQU	0B7D6H	; Grafik Farbe
  300                   		; Bit 0=1	XOR-Funktion
  301                   		; Bit 1=1	Punkt loeschen
  302                   		; Bit 2=1	Farbebene nicht veraendern
  303                   		; Bit 3-7	Vordergrundfarbe + Blinken
  304         B7D7      MIXIT	EQU	0B7D7H	; IX-Merker
  305         B7D8      VORTN	EQU	0B7D8H	; Vortonlaenge fuer byteweise Kassettenausgabe
  306         B7DA      DTPTR	EQU	0B7DAH	; CASS-Pointer
  307         B7DB      CTCMD	EQU	0B7DBH	; CTC2-Modus
  308         B7DC      BLINK	EQU	0B7DCH	; Blinkfrequenz
  309         B7DD      L3TAB	EQU	0B7DDH	; ESC-Tabelle
  310         B7DF      L3SIZ	EQU	0B7DFH	; Anzahl ESC-Routinen
  311         B7E0      COUNT	EQU	0B7E0H	; Tastatur-Repeat
  312         B7E1      HCPZ	EQU	0B7E1H	; Druckersteuerbyte
  313                   		; Bit 0=0	Protokollfunktion
  314                   		; Bit 0=1	Hardcopyfunktion
  315                   		; Bit 1=0/1	USER I/O-Kanal 1/2
  316                   		; Bit 2=0/1	SIO-Kanal A oder B
  317                   		; Bit 3		-
  318                   		; Bit 4..7	Druckertyp (0 bis F)
  319                   		; Bit 7=0	Matrixdrucker
  320                   		; Bit 7=1	Schreibmaschine
  321         B7E2      INTV1	EQU	0B7E2H	; Druckerinitialisierung
  322         B7E4      INTV1L	EQU	0B7E4H	;	"  -Laenge
  323         B7E5      INTV2	EQU	0B7E5H	; Duplexinitialisierung
  324         B7E7      INTV2L	EQU	0B7E7H	;	"  -Laenge
  325         B7E8      HCPZ2	EQU	0B7E8H	; Duplexsteuerbyte
  326                   		; Bit 0		-
  327                   		; Bit 1=0/1	USER I/O-Kanal 1/2
  328                   		; Bit 2=0/1	SIO-Kanal A oder B
  329                   		; Bit 3		WR5 Bit 3: Senden ein/aus
  330                   		; Bit 4		-
  331                   		; Bit 5,6	WR5 Bit 5,6: 5-8 Bit pro Zeichen (Senden)
  332                   		; Bit 7		WR3 Bit 7: 7/8 Bit pro Zeichen (Empfang)
  333         B7E9      OFILT	EQU	0B7E9H	; Druckroutine (ungefiltert)
  334         B7EC      PROMPT	EQU	0B7ECH	; Systemprompt
  335         B7ED      LINTYP	EQU	0B7EDH	; Linientyp
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  10
EQU47   INC

  336         B7EE      CUMUST	EQU	0B7EEH	; ^Cursormuster
  337         B7F0      JOYTAB	EQU	0B7F0H	; Joystick-Tastencodes
  338                   ;		0B7F2H
  339                   ;		bis	; reservicert fuer Arbeitszellen von REAS und TEMO
  340                   ;		0B7F4H
  341         B7F5      FNAME	EQU	0B7F5H	; 11 Byte Dateiname+Typ fuer DEVICE-Routinen
  342         B800      MODST	EQU	0B800H	; Modulsteuerbytespeicher
  343                   	; bis	0B8FFH
  344         B900      FTASTE	EQU	0B900H	; Funktionstastenspeicher
  345                   	; bis	0B99BH
  346         B99C      WNDFN	EQU	0B99CH	; Fenstersvektorpeicher
  347                   	; bis	0B9FFH
  348                   
  349                   ; von den BASIC-Erweiterungen genutzte Routinen aus dem BASIC-ROM:
  350                   
  351         C00D      PRIST	EQU	0C00DH	; BASIC-Interpreter Kaltstart
  352         C08C      SECST	EQU	0C08CH	; BASIC-Interpreter Warmstart
  353         C327      TMEMO	EQU	0C327H	; Test, ob RAM fuer naechste Operationen reicht
  354         C348      SNER	EQU	0C348H	; Sprung zu SN-ERROR
  355         C356      ERROO	EQU	0C356H	; Ausgabe Fehlercode
  356         C442      LIN13	EQU	0C442H	; Zeiger auf Zeile mit naechstgroesserer Nummer stellen
  357         C44D      ULER	EQU	0C44DH	; Sprung zu UL-ERROR
  358         C450      LIN6	EQU	0C450H	; Zeile in Programm einsortieren	
  359         C48A      LIN10	EQU	0C48AH
  360         C493      LIN11	EQU	0C493H
  361         C4BB      ZPOIT	EQU	0C4BBH	; Zeiger auf Anfang naechste Zeile stellen
  362         C4BE      ZPOIT1	EQU	0C4BEH
  363         C641      NEW1	EQU	0C641H	; BASIC-Programm loeschen
  364         C689      CPREG	EQU	0C689H
  365         C8B7      DLI22	EQU	0C8B7H	; Ansprung Tokenverarbeitung
  366         C8BD      TCHAR	EQU	0C8BDH	; naechstes Zeichen holen
  367         C8BE      TCHAR1	EQU	0C8BEH
  368         C8CC      CPSTX	EQU	0C8CCH	; erwartetes Zeichen folgt als DB ..
  369         C8D6      CPCOMM	EQU	0C8D6H	; Komma?
  370         C8DB      CPBRGT	EQU	0C8DBH	; Klammer zu?
  371         C967      FCER	EQU	0C967H	; Sprung zu FC-ERROR
  372         C96F      EPRVL3	EQU	0C96FH	; Wert bestimmen
  373         C96C      EPRVL4	EQU	0C96CH
  374         C986      DCHEX	EQU	0C986H	; Zeilennummer pruefen und in Hexzahl wandeln
  375         C987      DCHEX1	EQU	0C987H
  376         CB03      PRINT2	EQU	0CB03H
  377         CD36      SNALY6	EQU	0CD36H
  378         CD3A      SNALY	EQU	0CD3AH
  379         CDE1      SNLY14	EQU	0CDE1H	; Syntax-Check '('
  380         CDF3      SNLY16	EQU	0CDF3H	; Syntax-Check ')'
  381         D0C0      POS1	EQU	0D0C0H
  382         D17B      STADTB	EQU	0D17BH
  383         D17E      SADTB1	EQU	0D17EH
  384         D1A9      SLEN3	EQU	0D1A9H
  385         D1E1      STROP	EQU	0D1E1H	; String-Arithmetik
  386         D2F2      STRMV1	EQU	0D2F2H
  387         D302      STRZS3	EQU	0D302H
  388         D330      LEN1	EQU	0D330H	; Laenge holen
  389         D33F      ASC1	EQU	0D33FH
  390         D421      ARGVL1	EQU	0D421H	; Parameter abholen
  391         D424      ARGVL2	EQU	0D424H
  392         D6AE      SGN1	EQU	0D6AEH
  393         D834      NUMKON	EQU	0D834H
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  11
EQU47   INC

  394         DCB2      CASS1	EQU	0DCB2H	; Dateiname aufbereiten
  395         DDC8      TESTCO	EQU	0DDC8H
  396         DDD5      CO	EQU	0DDD5H	; Ausgabe eines Zeichens (ASCII)
  397         DDE4      CI	EQU	0DDE4H	; Eingabe eines Zeichens (ASCII)
  398         DE25      OUTCHL	EQU	0DE25H	; Ausgabe zu Kanal
  399         DE5F      INCHNL	EQU	0DE5FH	; Eingabe von Kanal
  188                   
  189                   	.PHASE	0C000H
  190                   
  191                   	INCLUDE	CC47.INC	; ROM-C (C000-CFFF)
    1                   ;*****************************************
    2                   ;**	CAOS 4.7	ROM C		**
    3                   ;**					**
    4                   ;**	Adresse:  C000h bis CFFFh	**
    5                   ;**					**
    6                   ;**	letzte Aenderung: 10.04.2019	**
    7                   ;*****************************************
    8                   
    9                   ;	ORG	0C000H
   10                   
   11                   ;
   12                   ; IRM-Defaulttabelle:
   13                   ;
   14 C000  F4BF        KCTAB1:	DW	NOOP		; Hardcopy-Adresse
   15 C002  00          WIN0:	DB	0		; WINNR
   16 C003  0000        	DW	0		; WINON
   17 C005  2028        	DW	2028H		; WINLG
   18 C007  0000        	DW	0		; CURSO
   19 C009  00          	DB	0		; STBT
   20 C00A  39          	DB	39H		; COLOR
   21 C00B  E269        	DW	SCRLPG		; WEND
   22 C00D  EE00        WIN1:	DW	LARGE		; CCTL0
   23 C00F  FE00        	DW	SMALL		; CCTL1
   24 C011  EE00        	DW	LARGE		; CCTL2
   25 C013  FE00        	DW	SMALL		; CCTL3
   26 C015  01C4        	DW	STACK		; SYSP
   27 C017  AA00        	DW	SUT_IRM		; SUTAB
   28 C019  FC8F        	DW	CRTTAB		; CTAB
   29 C01B  D3 88       	OUT	(PIOAD),A	; NCAOS
   30 C01D  C3 F012     	JP	0F012H
   31 C020  F005        	DW	OUTT1		; OUTAB = CRT (0)
   32 C022  F00E        	DW	INTT1		; INTAB = KBD (4)
   33 C024  C3 F4BF     	JP	NOOP		; UOUT1
   34 C027  C3 F4BF     	JP	NOOP		; UIN1
   35 C02A  C3 F4BF     	JP	NOOP		; UOUT2
   36 C02D  C3 F4BF     	JP	NOOP		; UIN2
   37 C030  DC82        	DW	0DC82H		; IOERR (BASIC)
   38 C032  B200        	DW	VRAM0		; VRAM=0B200H (Bild 0)
   39                   
   40 C034  47 0C       KCTAB2:	DB	47H,0CH		; CTC2 (blinken)
   41 C036  EDB5        	DW	ESCTAB		; L3TAB (Tabeller der ESC-Routinen)
   42 C038  0E          	DB	14		; L3SIZ (0-D)
   43 C039  05          	DB	5		; COUNT
   44 C03A  00          	DB	0		; HCPZ
   45 C03B  A801        	DW	0A801H		; INTV1
   46 C03D  08          	DB	8		; INTV1L
   47 C03E  A809        	DW	0A809H		; INTV2
   48 C040  09          	DB	9		; INTV2L
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  12
CC47    INC

   49 C041  EE          	DB	11101110b	; HCPZ2 (8 Bit, Senden ein)
   50 C042  C3 F4BF     	JP	NOOP		; OFILT
   51 C045  25          	DB	'%'		; PROMPT
   52 C046  FF          	DB	0FFH		; LINTYP
   53 C047  EFD8        	DW	0EFD8H		; CUMUST
   54 C049  AA94        	DW	JOYIRM		; JOYTAB
   55                   
   56                   ; Modulschaltzustaende (interne Module):
   57                   
   58 C04B  03          KCTAB3:	DB	3	; RAM0
   59 C04C  01          	DB	1	; IRM
   60 C04D  00          	DB	0	; USER-ROMC
   61 C04E  03          	DB	3	; RAM8
   62 C04F  03          	DB	3	; RAM4
   63 C050  00          	DB	0	; CAOSC
   64 C051              KCTAB4:
   65                   ;
   66                   ; Grundinitialisierung ohne Speicher loeschen, ausser:
   67                   ; VRAM0/1, Kassettenpuffer, Monitor-RAM, Modulsteuerwortspeicher
   68                   ; Joystick wird hier neu initialisiert (bei RESET nicht)
   69                   ;
   70                   ;	DW	7F7Fh
   71                   ;	DB	'NEW ',1	; Menuewort versteckt, IRM ein
   72                   ;	DI
   73                   ;	LD	SP,MODST+100H	; Loeschbereich AD00h..B8FFh
   74                   ;	LD	BC,600h		; Anzahl = 6 * 256 Wort = 0C00h
   75                   ;	JR	PWRC0
   76                   ;
   77                   ; Power-ON Initialisierung:
   78                   ;
   79 C051  F3          PWRONC:	DI
   80 C052  31 C000     	LD	SP,0C000H	; Loeschbereich 0..BFFFh
   81 C055  01 6000     	LD	BC,6000H	; Anzahl = 60h * 256 Wort = C000h
   82 C058  61          PWRC0:	LD	H,C
   83 C059  69          	LD	L,C		; HL=0
   84 C05A  E5          PWRC1:	PUSH	HL		; schnelles Speicher loeschen
   85 C05B  0D          	DEC	C
   86 C05C  20 FC       	JR	NZ,PWRC1
   87 C05E  10 FA       	DJNZ	PWRC1
   88         0000      if SYSROM
   91                   endif
   92 C060  31 01C4     	LD	SP,STACK	; System-Stack setzen
   93 C063  0E 80       	LD	C,80h		; alle Module abschalten (B=0 von DJNZ)
   94 C065  ED 69       PWRC2:	OUT	(C),L		; L=0 vom vorhergehenden Speicherloeschen
   95                   				; war vorher ED 71 = OUT (C),0
   96 C067  10 FC       	DJNZ	PWRC2
   97 C069  CD C091     	CALL	SYSI		; Systeminitialisierung (Rueckkehr mit EI)
   98 C06C  21 D959     	LD	HL,JOYTBD	; vorbereitete Joystick-Tabelle
   99 C06F  11 AA94     	LD	DE,JOYIRM	; JOYTAB-Standardadresse im IRM
  100 C072  01 000C     	LD	BC,12
  101 C075  ED B0       	LDIR			; Tabelle in den IRM kopieren
  102 C077  AF          	XOR	A		; Fenster Nr. 0
  103 C078  32 B79B     PWRC3:	LD	(WINNR),A	; Nr. eintragen
  104 C07B  CD C5E7     	CALL	WCOPY		; Fenstervektorspeicher initialisieren
  105 C07E  3C          	INC	A
  106 C07F  FE 0A       	CP	10		; fuer 10 Fenster (0-9)
  107 C081  38 F5       	JR	C,PWRC3
  108 C083  CD F961     	CALL	ESC3		; Anzeige Bild 0, Zugriff Bild 1
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  13
CC47    INC

  109 C086  3E 0C       	LD	A,0CH
  110 C088  CD E08C     	CALL	CRT		; Bild 1: CLS
  111 C08B  CD F957     	CALL	ESC1		; Anzeige+Zugriff Bild 0
  112 C08E  C3 F170     	JP	PWR4		; weiter im ROM-F
  113                   ;
  114                   ; System-Initialisierung (bei PWRON und RESET):
  115                   ;
  116 C091  F3          SYSI:	DI
  117 C092  ED 5E       	IM	2
  118 C094  21 D925     	LD	HL,IOTAB1	; PIO A,B und Ausgabe-Ports 84H/86H
  119 C097  CD F558     	CALL	INIMEX		; initialisieren
  120 C09A  DD 21 01F0  	LD	IX,1F0H
  121 C09E  DD 36 01 28 	LD	(IX+1),28H	; OUT84-Merker
  122         0000      if SYSROM
  127                   else
  128 C0A2  DD 36 04 E3 	LD	(IX+4),0E3H	; OUT86-Merker
  129                   endif
  130 C0A6  DD 36 08 80 	LD	(IX+8),80H	; Defaultbelegung (Kassette, kein CAPS-Lock)
  131 C0AA  11 B799     	LD	DE,HCADR
  132 C0AD  21 C000     	LD	HL,KCTAB1	; Defaulttabelle
  133 C0B0  01 0034     	LD	BC,KCTAB2-KCTAB1; fuer IRM-Arbeitszellen
  134 C0B3  ED B0       	LDIR			; 1. Teil in IRM kopieren
  135 C0B5  1E DB       	LD	E,LOW(CTCMD)	; (D war 0B7h)
  136 C0B7  0E 17       	LD	C,KCTAB3-KCTAB2	; (B war 0)
  137 C0B9  ED B0       	LDIR			; 2. Teil in IRM kopieren
  138 C0BB  11 B800     	LD	DE,MODST	; Modulsteuerbytespeicher
  139 C0BE  3A B804     	LD	A,(MODST+4)	; RAM4 aktueller Schaltzustand
  140 C0C1  E6 04       	AND	4		; RAM4-Ebene herausloesen
  141 C0C3  0E 06       	LD	C,KCTAB4-KCTAB3	; (B war 0)
  142 C0C5  ED B0       	LDIR			; 3. Teil in IRM kopieren
  143 C0C7  21 B804     	LD	HL,MODST+4
  144 C0CA  B6          	OR	(HL)		; RAM4 bisherige Ebene wieder einbauen
  145 C0CB  77          	LD	(HL),A
  146                   
  147                   ; CAOS 4.6 - SUTAB vom ROM in den IRM kopieren:
  148                   
  149 C0CC  11 AA00     	ld	de,SUT_IRM	; SUTAB im IRM
  150 C0CF  21 D851     	ld	hl,SUTB		; SUTAB im ROM
  151 C0D2  01 0094     	ld	BC,SUEND-SUTB	; Laenge
  152 C0D5  ED B0       	LDIR			; SUTAB zur Nutzung in den IRM kopieren
  153                   
  154                   ; Interrupt hier bereits freigegeben, damit Treiber-Initialisierung
  155                   ; Interrupts aktivieren kann (z.B. USB-Tastatur)?
  156                   ; aber: die CAOS-ISR-Tabelle ist noch nicht kopiert worden!
  157                   ;
  158                   ;	EI
  159                   
  160                   ; CAOS 4.6 - Device-Treibertabellen erzeugen
  161                   
  162 C0D7  11 A900     	LD	DE,DEVTAB	; Treibertabelle(n) im IRM aufbauen
  163 C0DA  3E 08       	LD	A,8		; fuer 8 Treiber
  164 C0DC  21 D8E5     DINIT:	LD	HL,DRV0		; zunaechst den Kassettentreiber
  165 C0DF  01 0020     	LD	BC,32		; je 32 Byte (Groesse festgeschrieben)
  166 C0E2  ED B0       	LDIR			; kopieren
  167 C0E4  3D          	DEC	A		; alle 8 Treiber auf Kassette initialisieren
  168 C0E5  20 F5       	JR	NZ,DINIT
  169 C0E7  32 A900     	LD	(DEVTAB),A	; Tape-Treiber mit '0' aktivieren
  170 C0EA  11 A920     	LD	DE,DEVTAB+32	; folgende Treiber als Nr. 1 eintragen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  14
CC47    INC

  171         0000      if turbo
  174                   endif
  175                   
  176                   ; Suche D004/D008 mit CAOS-Betriebsart (Treiber 1):
  177                   
  178 C0ED  01 FC80     	LD	BC,0FC80H	; Modulsteckplatz FC
  179 C0F0  ED 78       	IN	A,(C)
  180 C0F2  FE A7       	CP	0A7H		; Floppy vorhanden?
  181 C0F4  20 15       	JR	NZ,NODISK
  182 C0F6  3E 04       	LD	A,4		; nur Kopplung einschalten
  183 C0F8  32 B8FC     	LD	(MODST+0FCH),A	; in Modulsteuerbytespeicher eintragen
  184 C0FB  ED 79       	OUT	(C),A		; und schalten
  185 C0FD  01 B3F3     	LD	BC,UROK		; 0B3F3H
  186 C100  ED 78       	IN	A,(C)
  187 C102  FE 05       	CP	5		; CAOS-Betriebsart?
  188 C104  20 05       	JR	NZ,NODISK
  189                   ;	LD	HL,DRV1		; Floppy-Treiber
  190 C106  01 0020     	LD	BC,32
  191 C109  ED B0       	LDIR			; in Treibertabelle kopieren
  192                   
  193                   ; Suche USB- bzw. GIDE-Modul mit Treiber:
  194                   ;	DE	zeigt auf DEVTAB wo naechster Treiber hin kommt
  195                   
  196 C10B  06 08       NODISK:	LD	B,8		; ab Steckplatz 8 suchen
  197 C10D  0E 80       	LD	C,80H		; I/O-Adresse Modulsteuerung
  198 C10F  ED 78       USB1:	IN	A,(C)		; Kennbyte lesen
  199 C111  FE FD       	CP	0FDH		; Kennung M052?
  200 C113  28 09       	JR	Z,USB2
  201 C115  FE F9       	CP	0F9h		; Kennung M064?
  202 C117  28 05       	JR	Z,USB2
  203 C119  04          USB4:	INC	B		; naechster Steckplatz
  204 C11A  20 F3       	JR	NZ,USB1
  205 C11C  18 34       	JR	NOUSB		; Kein passendes Modul gefunden!
  206                   	;
  207 C11E  C5          USB2:	PUSH	BC		; Steckplatz B merken
  208 C11F  68          	LD	L,B
  209 C120  CD C362     	call	SLOT1		; Modul auf 4000h einblenden
  210                   ;	ld	hl,4000h
  211 C123  7E          	ld	a,(hl)		; ROM-Inhalt 1. Byte
  212 C124  23          	inc	hl
  213 C125  BE          	cp	(hl)		; ROM-Inhalt 2. Byte
  214 C126  20 1A       	jr	nz,USB3		; Kennung 1+2 nicht identisch
  215 C128  FE 46       	cp	46h
  216 C12A  20 16       	jr	nz,USB3		; Kennung falsch
  217 C12C  23          	inc	hl		; SWITCH-AUS in Treibertabelle
  218 C12D  7B          	ld	a,e
  219 C12E  07          	rlca
  220 C12F  07          	rlca
  221 C130  07          	rlca			; Nr. des naechsten Treibers
  222 C131  12          	ld	(de),a		; Treibernummer eintragen in DEVTAB+0
  223 C132  13          	inc	de
  224 C133  E3          	EX	(SP),HL		; H=Steckplatz
  225 C134  7C          	ld	a,H
  226 C135  12          	ld	(de),a		; Steckplatz eintragen in DEVTAB+1
  227 C136  13          	inc	de
  228 C137  E3          	EX	(SP),HL
  229 C138  01 001E     	LD	BC,32-2
  230 C13B  ED B0       	LDIR			; restliche Treibertabelle aus ROM kopieren
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  15
CC47    INC

  231 C13D  21 FFE3     	ld	hl,-1Dh
  232 C140  19          	ADD	HL,DE		; zurueck zu SWITCH-EIN des Moduls
  233 C141  7E          	ld	A,(HL)		; SWITCH-EIN
  234                   
  235 C142  C1          USB3:	POP	BC		; B = Steckplatz, C=80h
  236 C143  C5          	PUSH	BC
  237 C144  D5          	PUSH	DE		; Zeiger in DEVTAB retten
  238                   	; kein Befehl beeinflusst das Z-Flag !
  239 C145  CC ED6D     	CALL	Z,JROM		; Treiber gefunden: INIT im Modul-ROM aufrufen
  240 C148  CD C37B     	CALL	SLOT0		; alle Modulzustaende regenerieren
  241 C14B  D1          	POP	DE		; DEVTAB
  242 C14C  C1          	POP	BC		; B = Steckplatz, C=80h
  243 C14D  7A          	LD	A,D
  244 C14E  FE AA       	CP	1+High(DEVTAB)	; 0AAh
  245 C150  20 C7       	JR	NZ,USB4		; weitere Module suchen bis DEVTAB voll ist
  246                   
  247         0000      if turbo
  250                   else
  251 C152  3A A920     NOUSB:	LD	A,(DEVTAB+32)	; Treiber 1 vorhanden?
  252 C155  FE 01       	CP	1
  253                   endif
  254 C157  CC D5F2     	CALL	Z,SET_DD	; dann aktivieren!
  255                   
  256 C15A  3E 01       	LD	A,1		; Standardwert fuer IXH- und I-Register
  257                   ;
  258                   ; CAOS-UP zur Verlagerung des IX-Arbeitsbereiches
  259                   ;
  260 C15C  21 D965     SIXC:	LD	HL,ISRTAB	; ISR-Tabelle im ROM
  261 C15F  F3          	DI
  262 C160  32 B7D7     	LD	(MIXIT),A	; neuer Wert fuer IXH- und I-Register
  263 C163  ED 47       	LD	I,A		; I-Register aktualisieren
  264 C165  ED 5E       	IM	2
  265 C167  1E E0       	LD	E,0E0H
  266 C169  57          	LD	D,A
  267 C16A  01 0010     	LD	BC,16		; Interrupttabelle fuer 8 Interrupts
  268 C16D  ED B0       	LDIR			; kopieren aus dem ROM nach xxE0h bis xxF0h
  269 C16F  DD 66 01    	LD	H,(IX+1)
  270 C172  DD 6E 04    	LD	L,(IX+4)	; alte Merker mitnehmen
  271 C175  DD 7E 08    	LD	A,(IX+8)
  272 C178  D5          	PUSH	DE		; neuer Wert fuer IX = xxF0h
  273 C179  DD E1       	POP	IX
  274 C17B  DD 77 08    	LD	(IX+8),A
  275 C17E  DD 74 01    	LD	(IX+1),H	; mitgenommene Merker neu eintragen
  276 C181  DD 75 04    	LD	(IX+4),L
  277 C184  DD 36 0E 0F 	LD	(IX+14),LOW(KTAB) ; Tastaturtabelle
  278 C188  DD 36 0F FC 	LD	(IX+15),HIGH(KTAB)
  279 C18C  DD 36 09 7F 	LD	(IX+9),7FH	; Standard-Prologbyte
  280 C190  21 D93F     	LD	HL,IOTAB2	; PIO A,B und CTC
  281 C193  CD F558     	CALL	INIMEX		; Ports neu initialisieren
  282 C196  21 ED9D     	LD	HL,CENINI
  283 C199  CD F558     	CALL	INIMEX		; M021 initialisieren
  284 C19C  CD F546     	CALL	KPUFF		; Kassettenpuffer (IX+5 und IX+6) definieren
  285 C19F  FB          	EI
  286 C1A0  C9          	RET
  287                   
  288                   ; Systemcheck oder Modulkontrollanzeige (interne Module):
  289                   
  290 C1A1              SYSTC:
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  16
CC47    INC

  291                   ;	PUSH	DE
  292 C1A1  2E FF       	LD	L,-1		; mit Steckplatz 0 beginnen, vorher aber ROM E
  293         0000      if SYSROM
  301                   else
  302 C1A3  CD F0CF     	CALL	OSTR
  303 C1A6  2D 2D 20 2D 	DB	'-- -- -- CAOSE',0
  304                   endif
  305 C1B5  DB 88       	IN	A,(PIOAD)
  306 C1B7  E6 01       	AND	1		; CY=0, Z=?
  307 C1B9  18 3B       	JR	WONOF1
  308                   
  309 C1BB  3E 01       SYST0:	LD	A,1		; lesen
  310 C1BD  CD C39C     	CALL	MODUC
  311 C1C0  CD D34E     	CALL	LHD		; Anzeige Steckplatz, Kennbyte, Steuerbyte
  312                   
  313 C1C3  7D          	LD	A,L		; nach Steckplatz verzweigen
  314 C1C4  A7          	AND	A
  315 C1C5  20 12       	JR	NZ,SYST1
  316                   ; 0
  317 C1C7  CD F0CF     	CALL	OSTR
  318 C1CA  52 41 4D 30 	DB	'RAM0',0
  319 C1CF  DB 88       	IN	A,(PIOAD)
  320 C1D1  E6 0F       	AND	00001111b
  321 C1D3  FE 08       	CP	00001000b	; CY=NOT(Bit 3)
  322 C1D5  CB 4F       	BIT	1,A		; Schaltzustand
  323 C1D7  18 1D       	JR	WONOF1
  324                   ; 1
  325 C1D9  3D          SYST1:	DEC	A
  326 C1DA  20 1C       	JR	NZ,SYST2
  327 C1DC  CD F0CF     	CALL	OSTR
  328 C1DF  42 49 4C 44 	DB	'BILD ',0
  329 C1E5  DD 7E 01    	LD	A,(IX+1)
  330 C1E8  E6 04       	AND	00000100b	; Zugriffs-Bit
  331 C1EA  0F          	RRCA		
  332 C1EB  0F          	RRCA
  333 C1EC  C6 30       	ADD	A,'0'
  334 C1EE  CD F3D5     	CALL	OCHR		; Bildnummer
  335 C1F1  3A B801     	LD	A,(MODST+1)
  336 C1F4  E6 01       	AND	1		; IRM on?
  337 C1F6              WONOF1:
  338         0000      if RAM1MB
  340                   else
  341 C1F6  18 72       	JR	SYST6
  342                   endif
  343                   ; 2
  344 C1F8  3D          SYST2:	DEC	A
  345 C1F9  20 1C       	JR	NZ,SYST3
  346 C1FB  CD F0CF     	CALL	OSTR
  347 C1FE  55 53 45 52 	DB	'USER ',0
  348 C204  DD 7E 04    	LD	A,(IX+4)
  349         0000      if SYSROM
  356                   else
  357 C207  07          	RLCA			; Bits 5,6
  358 C208  07          	RLCA
  359 C209  07          	RLCA			; nach Bits 0,1
  360 C20A  E6 03       	AND	3
  361 C20C  EE 33       	XOR	'3'
  362                   endif
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  17
CC47    INC

  363 C20E  CD F3D5     	CALL	OCHR		; Ebene ausgeben
  364 C211  DB 88       	IN	A,(PIOAD)
  365 C213  E6 80       	AND	10000000b	; CY=0, Z=NOT(Bit 7)
  366 C215  18 53       	JR	SYST6
  367                   ; 3
  368 C217  3D          SYST3:	DEC	A
  369 C218  20 1E       	JR	NZ,SYST4
  370 C21A  CD F0CF     	CALL	OSTR
  371 C21D  52 41 4D 38 	DB	'RAM8 ',0
  372         0000      if RAM1MB
  378                   endif
  379 C223  DD 7E 01    	LD	A,(IX+1)
  380 C226  0F          	RRCA			; Bits 4,5,6,7
  381 C227  0F          	RRCA
  382 C228  0F          	RRCA
  383 C229  0F          	RRCA			; nach 0,1,2,3
  384                   ;	AND	0FH		; redundant: bereits in AHEX0
  385 C22A  D6 02       	SUB	2
  386 C22C  CD F3CD     	CALL	AHEX0		; Ebene ausgeben
  387 C22F  DB 89       	IN	A,(PIOBD)
  388 C231  CB 6F       	BIT	5,A		; Schaltzustand
  389 C233  07          	RLCA			; Schreibschutz (Bit 6)
  390 C234  07          	RLCA			; ins Carry-Flag rotieren
  391 C235  3F          	CCF			; und invertieren
  392 C236  18 32       syst7:	JR	SYST6
  393                   ; 4
  394 C238  3D          SYST4:	DEC	A
  395 C239  20 21       	JR	NZ,SYST5
  396 C23B  CD F0CF     	CALL	OSTR
  397 C23E  52 41 4D 34 	DB	'RAM4',0
  398 C243  CD F3BC     	CALL	SPACE
  399 C246  3A B804     	LD	A,(MODST+4)
  400 C249  0F          	RRCA
  401 C24A  0F          	RRCA			; Bit 2
  402 C24B  E6 01       	AND	1
  403 C24D  C6 30       	ADD	A,'0'
  404 C24F  CD F3D5     	CALL	OCHR		; Ebene 0/1
  405 C252  DD 7E 04    	LD	A,(IX+4)
  406 C255  CB 47       	BIT	0,A		; Schaltzustand
  407 C257  0F          	RRCA			; Schreibschutz (Bit 1)
  408 C258  0F          	RRCA			; ins Carry-Flag rotieren
  409 C259  3F          	CCF			; und invertieren
  410 C25A  18 0E       	JR	SYST6
  411                   ; 5
  412 C25C  CD F0CF     SYST5:	CALL	OSTR
  413 C25F  43 41 4F 53 	DB	'CAOSC',0
  414 C265  3A B805     	LD	A,(MODST+5)
  415 C268  E6 01       	AND	1
  416 C26A  CD D32D     SYST6:	CALL	WONOF
  417 C26D  2C          	INC	L		; Steckplatz+1
  418 C26E  3E 06       	LD	A,6
  419 C270  BD          	CP	L
  420 C271  C2 C1BB     	JP	NZ,SYST0	; bei 06 abbrechen
  421 C274  C9          	RET
  422                   
  423                   ; Modulkontrollanzeige (externe Module):
  424                   
  425 C275  AF          MODULC:	XOR	A
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  18
CC47    INC

  426 C276  D3 91       	OUT	(91h),A		; M008 PIO-B Daten
  427 C278  DB 91       	IN	A,(91h)
  428 C27A  A7          	AND	A
  429 C27B  20 16       	JR	NZ,MODC1
  430 C27D  CD F0CF     	CALL	OSTR
  431 C280  2D 2D 20 2D 	DB	'-- -- -- JOY/CEN'
  432 C290  0D 0A 00    	DB	0Dh,0Ah,0
  433 C293  2E 07       MODC1:	LD	L,7		; ab Platz 7
  434 C295  E5          MODC2:	PUSH	HL
  435 C296  3E 01       	LD	A,1		; lesen
  436 C298  CD C39C     	CALL	MODUC
  437 C29B  7C          	LD	A,H
  438 C29C  3C          	INC	A		; Kennbyte=FFh?
  439 C29D  28 36       	JR	Z,MODC8		; kein ext. Modul
  440                   
  441 C29F  CD D34E     	CALL	LHD		; Anzeige Steckplatz, Kennbyte, Steuerbyte
  442                   
  443 C2A2  4C          	LD	C,H
  444 C2A3  7C          	ld	a,h
  445 C2A4  FE F3       	cp	0f3h		; M062?
  446 C2A6  28 32       	jr	z,M062		; Test ob RAM- oder ROM-Version
  447 C2A8  FE FB       	cp	0fbh		; Software-Modul?
  448 C2AA  28 45       	jr	z,slot		; Inhalt analysieren!
  449 C2AC  FE FD       	cp	0fdh		; M052?
  450 C2AE  CA C315     	jp	z,M052		; Test, welche Variante vorliegt
  451 C2B1  21 CFAE     	ld	hl,muser
  452 C2B4  FE C0       	cp	0c0h
  453 C2B6  38 04       	jr	c,MODC3		; kleiner als C0
  454 C2B8  FE D8       	cp	0d8h
  455 C2BA  38 13       	jr	c,MODC6		; USER-Modul von C0-D7
  456 C2BC  21 CE72     MODC3:	LD	HL,MTAB
  457 C2BF  7E          MODC4:	LD	A,(HL)
  458 C2C0  23          	INC	HL
  459 C2C1  FE FF       	CP	0FFH		; Tabelle durchsucht?
  460 C2C3  28 0A       	JR	Z,MODC6
  461 C2C5  B9          	CP	C		; Strukturbyte in Tabelle MTAB?
  462 C2C6  28 07       	JR	Z,MODC6		; Text gefunden
  463 C2C8  7E          MODC5:	LD	A,(HL)
  464 C2C9  23          	INC	HL
  465 C2CA  A7          	AND	A		; Stringende?
  466 C2CB  20 FB       	JR	NZ,MODC5
  467 C2CD  18 F0       	JR	MODC4
  468                   	;
  469 C2CF  CD F906     MODC6:	CALL	ZKOUT		; Modulname
  470 C2D2  CD F4DB     MODC7:	CALL	CRLF
  471 C2D5  E1          MODC8:	POP	HL
  472 C2D6  2C          	INC	L		; Steckplatz+1
  473 C2D7  20 BC       	JR	NZ,MODC2	; bis FFh
  474 C2D9  C9          	RET
  475                   ;
  476                   ; Test, ob M062 als 8*8K ROM oder 4*8K RAM vorliegt.
  477                   ; Zur Unterscheidung wird ein RAM-Test durchgefuehrt
  478                   ;
  479                   ; PE:	L=Steckplatz	H=Kennbyte = 0FBH
  480                   ;
  481 C2DA  CD C362     M062:	call	SLOT1		; Modul auf 4000h einblenden
  482                   ;	ld	hl,4000h	; RAM-Inhalt lesen
  483 C2DD  7E          	ld	a,(hl)
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  19
CC47    INC

  484 C2DE  34          	inc	(hl)		; Inhalt veraendern
  485 C2DF  BE          	cp	(hl)		; RAM oder ROM
  486 C2E0  77          	ld	(hl),a		; regenerieren
  487 C2E1  21 CFC4     	ld	hl,M062B	; ROM
  488 C2E4  28 03       	jr	z,SLOT2
  489 C2E6  21 CFBB     	ld	hl,M062A	; RAM
  490 C2E9  CD F906     SLOT2:	call	zkout		; Testergebnis anzeigen
  491 C2EC  CD C37B     SLOT3:	call	SLOT0		; Modulzustaende nach Tabelle regenerieren
  492 C2EF  18 E1       	jr	MODC7		; weiter suchen auf naechstem Steckplatz
  493                   ;
  494                   ; Suche nach Inhalt der Softwaremodule M012, M026, M027 usw.
  495                   ; Es wird das erste Menwort gesucht, und dieses als Name angezeigt!
  496                   ; PE:	L=Steckplatz	H=Kennbyte = 0FBH
  497                   ;
  498 C2F1  CD C362     slot:	call	SLOT1		; Modul auf 4000h einblenden
  499                   ;	ld	hl,4000h	; Suchbereich Beginn
  500 C2F4  11 CFAD     	ld	de,MTAB2	; Vergleichskette 0-String
  501 C2F7  01 2000     	ld	bc,2000h	; 8K durchsuchen
  502 C2FA  CD F357     	call	zs0		; erstes Menuewort suchen
  503 C2FD  38 05       	jr	c,SLOT4		; Menuewort gefunden
  504 C2FF  21 CFA5     	ld	hl,mtab1	; ansonsten als "Software" anzeigen
  505 C302  18 07       	jr	SLOT6
  506                   	;
  507 C304  2B          SLOT4:	dec	hl
  508 C305  7E          	ld	a,(hl)
  509 C306  FE 7F       	cp	7fh		; zurueck bis zu Prologbyte
  510 C308  20 FA       	jr	nz,SLOT4
  511 C30A  23          SLOT5:	inc	hl
  512 C30B  7E          SLOT6:	ld	a,(hl)
  513 C30C  FE 20       	cp	20h		; Epilog?
  514 C30E  38 DC       	jr	c,SLOT3		; ja
  515 C310  CD F3D5     	call	ochr		; Menuewort anzeigen
  516 C313  18 F5       	jr	SLOT5
  517                   ;
  518                   ; Testen welche Variante des M052 vorliegt. Dazu werden die Datenports von der
  519                   ; Netzwerk-PIO gelesen und falls ein Wert ungleich FFh kommt, von einem
  520                   ; Kombimodul mit USB+Netzwerk ausgegangen.
  521                   ; M052-Portadressen: 28h..2Bh Netzwerk-PIO / 2Ch..2Fh USB-PIO
  522                   ;
  523                   ; PE:	L=Steckplatz	H=Kennbyte = 0FDH
  524                   
  525 C315  26 B8       M052:	LD	H,HIGH(MODST)	; Modulsteuerbytespeicher
  526 C317  7E          	ld	a,(hl)		; aktueller Zustand
  527 C318  CB D7       	set	2,a		; PIO's ein
  528 C31A  45          	ld	b,l		; Steckplatz
  529 C31B  0E 80       	ld	c,80h
  530 C31D  ED 79       	out	(c),a		; PIO's des M052 einschalten
  531 C31F  21 CFB3     	ld	hl,M052A
  532 C322  DB 28       	in	a,(28h)		; M052 PIO NET Daten A
  533 C324  3C          	inc	a
  534 C325  20 08       	jr	nz,M052N1	; Netzwerk-PIO gefunden
  535 C327  DB 29       	in	a,(29h)		; M052 PIO NET Daten B
  536 C329  3C          	inc	a
  537 C32A  20 03       	jr	nz,M052N1	; Netzwerk-PIO gefunden
  538 C32C  21 CFB7     	ld	hl,M052B
  539 C32F  18 B8       M052N1:	JR	SLOT2		; Modulname anzeigen, Schaltzustaende regen.
  540                   
  541                   ; Module lesen und schalten (Menuewort):
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  20
CC47    INC

  542                   
  543 C331  53          SWIC:	LD	D,E		; Steuerbyte
  544 C332  FE 01       	CP	1
  545 C334  F5          	PUSH	AF
  546 C335  28 0D       	JR	Z,SWI3		; nur lesen
  547 C337  2D          	DEC	L
  548 C338  20 09       	JR	NZ,SWI2		; nicht IRM
  549 C33A  2C          	INC	L
  550 C33B  26 B8       	LD	H,HIGH(MODST)	; Modulsteuerbytespeicher
  551 C33D  5E          	LD	E,(HL)		; altes Steuerbyte lesen
  552 C33E  72          	LD	(HL),D		; neues Steuerbyte eintragen
  553 C33F  26 FF       	LD	H,0FFH		; Kennung internes Modul
  554 C341  18 05       	JR	SWI4
  555                   	;
  556 C343  2C          SWI2:	INC	L
  557 C344  CD C39C     SWI3:	CALL	MODUC		; lesen/schalten
  558 C347  5F          	LD	E,A
  559 C348  CD F3B8     SWI4:	CALL	ALSPC		; Steckplatz L anzeigen
  560 C34B  7C          	LD	A,H
  561 C34C  CD F3B9     	CALL	AHSPC		; Kennbyte Modul
  562 C34F  7B          	LD	A,E
  563 C350  CD F3C4     	CALL	AHEX		; Steuerbyte alt
  564 C353  F1          	POP	AF
  565 C354  28 09       	JR	Z,SWI5		; das war nur lesen
  566 C356  3E 09       	LD	A,9
  567 C358  CD F7B5     	CALL	CSTBT		; Pfeil nach rechts anzeigen
  568 C35B  7A          	LD	A,D
  569 C35C  CD F3C4     	CALL	AHEX		; Steuerbyte neu
  570 C35F  C3 F4DB     SWI5:	JP	CRLF
  571                   ;
  572                   ; Modul auf Adresse 4000h einblenden
  573                   ; (fuer M012, M026, M027, M052 und M062)
  574                   ; PE:	L =	Steckplatz
  575                   ; PA:	HL = 4000h fuer folgende Operationen
  576                   ; VR:	AF, BC, HL
  577                   ;
  578 C362  01 0880     SLOT1:	LD	BC,0880h	; alle Module von 8 bis L abschalten
  579 C365  AF          slo1:	XOR	A		; Modul abschalten
  580 C366  ED 79       	OUT	(C),A		; war vorher ED 71 = OUT (C),0
  581 C368  04          	inc	b		; naechster Steckplatz
  582 C369  7D          	ld	a,l		; Steckplatz, der zu untersuchen ist
  583 C36A  B8          	cp	b		; Steckplatz erreicht?
  584 C36B  20 F8       	jr	nz,slo1
  585 C36D  3E 41       	ld	a,41h		; Modul auf 4000h einschalten
  586 C36F  ED 79       	out	(c),a
  587                   	RESIXA	0,4		; RES 0,(IX+4),A
    1 C371  DD CB 04    	 DB	0DDh,0CBh,4
    2 C374  87          	 DB	0 SHL 3 OR 10000111b
  588 C375  D3 86       	OUT	(PORT2),A	; RAM4 aus!
  589 C377  21 4000     	LD	HL,4000h	; Uebergabe der zu untersuchenden Adresse
  590 C37A  C9          	RET
  591                   ;
  592                   ; Modulzustand regenerieren laut Modulsteuerbytetabelle
  593                   ; (erforderlich falls Modulsuche Aenderungen gemacht hat)
  594                   ; PE:	-
  595                   ; PA:	-
  596                   ; VR:	AF, HL, D
  597                   ;
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  21
CC47    INC

  598 C37B  21 B804     SLOT0:	ld	hl,modst+4	; beginnend ab RAM4
  599 C37E  56          slo0:	ld	d,(hl)		; gespeicherter Schaltzustand
  600 C37F  E5          	push	hl
  601 C380  3E 02       	ld	a,2		; schalten
  602 C382  CD C39C     	call	MODUC		; Schaltzustaende nach Tabelle regenerieren
  603 C385  E1          	pop	hl
  604 C386  2C          	inc	l		; naechster Steckplatz
  605 C387  20 F5       	jr	nz,slo0		; bis FFh
  606 C389  C9          	ret
  607                   ;
  608                   ; V.24-Modul suchen und einschalten:
  609                   ;
  610                   ; PE:	B	Steckplatz ab dem gesucht wird
  611                   ; PA:	B	Steckplatz des Moduls
  612                   ;	CY = 1	kein M003 vorhanden
  613                   ; VR:	AF, BC, D, HL
  614                   ;
  615 C38A  0E 80       V24SU:	LD	C,80h
  616 C38C  ED 78       V24S1:	IN	A,(C)
  617 C38E  FE EE       	CP	0EEH		; M003?
  618 C390  28 05       	JR	Z,V24S2		; ja
  619 C392  04          	INC	B
  620 C393  20 F7       	JR	NZ,V24S1
  621 C395  37          	SCF			; nicht gefunden
  622 C396  C9          	RET
  623                   	;
  624 C397  68          V24S2:	LD	L,B		; Steckplatz
  625 C398  3E 02       	LD	A,2		; Schalten
  626 C39A  16 01       	LD	D,1		; EIN
  627                   
  628                   ; Module schalten:
  629                   ;
  630                   ; PE:	A=1	Modultyp lesen (Register L)
  631                   ;	A=2	Modul schalten (Register D und L)
  632                   ;	L	Modulsteckplatz
  633                   ;	D	Modulsteuerbyte neu
  634                   ; PA:	H	Modultyp (Strukturbyte)
  635                   ;	D	Modulsteuerbyte neu
  636                   ;	A	Modulsteuerbyte alt
  637                   ; VR:	AF, D, H, BC
  638                   
  639 C39C  26 B8       MODUC:	LD	H,HIGH(MODST)	; Modulsteuerbytespeicher
  640 C39E  0E 80       	LD	C,80H		; I/O-Adresse
  641 C3A0  45          	LD	B,L		; Steckplatz
  642 C3A1  FE 02       	CP	2		; 2 Parameter?
  643 C3A3  7E          	LD	A,(HL)		; urspruenglicher Schaltzustand
  644 C3A4  30 04       	JR	NC,MODU1	; Module schalten
  645 C3A6  56          	LD	D,(HL)		; Schaltzustand aus Steuerbytespeicher lesen
  646 C3A7  ED 60       RSTRB:	IN	H,(C)		; Strukturbyte aus Modul lesen
  647 C3A9  C9          	RET
  648                   
  649                   	;Modul schalten
  650 C3AA  F5          MODU1:	PUSH	AF		; alter Zustand
  651 C3AB  72          	LD	(HL),D		; neues Steuerbyte eintragen
  652 C3AC  67          	LD	H,A		; fuer 2. RAM4
  653 C3AD  7D          	LD	A,L
  654 C3AE  FE 06       	CP	6		; interne Module?
  655 C3B0  38 05       	JR	C,MODU2
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  22
CC47    INC

  656 C3B2  ED 51       	OUT	(C),D		; Steuerbyte an Modul senden
  657 C3B4  F1          	POP	AF		; urspruenglicher Schaltzustand
  658 C3B5  18 F0       	JR	RSTRB		; und noch das Strukturbyte lesen
  659                   
  660                   	;interne Module
  661 C3B7  04          MODU2:	INC	B		; Steckplatz
  662 C3B8  F3          	DI			; damit PIO nicht von einer ISR geaendert wird
  663 C3B9  DB 88       	IN	A,(PIOAD)
  664 C3BB  10 0D       	DJNZ	MODU3		; 0: RAM0?
  665 C3BD  E6 F5       	AND	11110101b
  666 C3BF  67          	LD	H,A
  667 C3C0  7A          	LD	A,D
  668 C3C1  0F          	RRCA			; Bits 0,1 auf 7,0 rotieren
  669 C3C2  E6 81       	AND	10000001b	; CY = 0
  670 C3C4  17          	RLA			; 0 einfuegen, CY = Bit 7
  671 C3C5  17          	RLA			; Bit 0 = CY
  672 C3C6  07          	RLCA			; auf Bits 1,3 rotieren
  673 C3C7  B4          	OR	H
  674 C3C8  18 25       	JR	OUT88
  675                   
  676 C3CA  10 0A       MODU3:	DJNZ	MODU4		; 1: IRM?
  677 C3CC  E6 FB       	AND	11111011b
  678 C3CE  CB 42       	BIT	0,D
  679 C3D0  28 1D       	JR	Z,OUT88
  680 C3D2  F6 04       	OR	00000100b
  681 C3D4  18 19       	JR	OUT88
  682                   
  683 C3D6  10 1B       MODU4:	DJNZ	MODU5		; 2: ROMC?
  684 C3D8  7A          	LD	A,D
  685         0000      if SYSROM
  693                   else
  694 C3D9  2F          	CPL			; negieren
  695 C3DA  07          	RLCA			; Bits 4..5 auf 5..6 rotieren
  696 C3DB  E6 60       	AND	01100000b	; ausfiltern (2 Ebenen)
  697 C3DD  67          	LD	H,A
  698                   ;	DI
  699 C3DE  DD 7E 04    	LD	A,(IX+4)
  700 C3E1  E6 9F       	AND	10011111b
  701                   endif
  702 C3E3  B4          	OR	H		; einbauen
  703 C3E4  DD 77 04    	LD	(IX+4),A
  704 C3E7  D3 86       	OUT	(PORT2),A
  705                   ;	EI
  706 C3E9  7A          	LD	A,D
  707 C3EA  0F          	RRCA			; CY = Bit 0
  708 C3EB  DB 88       	IN	A,(PIOAD)
  709 C3ED  17          	RLA			; als Bit 0 einschieben
  710 C3EE  0F          	RRCA			; und auf Bit 7 rotieren
  711 C3EF  D3 88       OUT88:	OUT	(PIOAD),A
  712 C3F1  18 23       	JR	STBFF
  713                   
  714 C3F3  10 26       MODU5:	DJNZ	MODU6		; 3: RAM8?
  715 C3F5  3E 03       	LD	A,00000011b	; on/off und Schreibschutz aus Steuerbyte
  716 C3F7  A2          	AND	D
  717 C3F8  0F          	RRCA			; Bits 0..1 auf 5..6 rotieren
  718 C3F9  0F          	RRCA
  719 C3FA  0F          	RRCA
  720 C3FB  67          	LD	H,A		; in H merken
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  23
CC47    INC

  721                   ;	DI
  722 C3FC  DB 89       	IN	A,(PIOBD)
  723 C3FE  E6 9F       	AND	10011111b
  724 C400  B4          	OR	H		; on/off und Schreibschutz neu einstellen
  725 C401  D3 89       	OUT	(PIOBD),A
  726                   ;	EI
  727 C403  7A          	LD	A,D
  728 C404  07          	RLCA			; Bits 2..5 auf 4..7 rotieren
  729 C405  07          	RLCA
  730         0000      if RAM1MB
  732                   endif
  733 C406  C6 20       	ADD	A,20h		; Segment-Verschiebung
  734 C408  E6 F0       	AND	0F0h		; nur Bit 4-7 benutzen
  735 C40A  67          	LD	H,A
  736                   ;	DI
  737 C40B  DD 7E 01    	LD	A,(IX+1)
  738 C40E  E6 0F       	AND	0Fh		; Bit 4-7 ruecksetzen
  739 C410  B4          	OR	H		; RAM8-Segment gemaess Steuerbyte einbauen
  740 C411  D3 84       	OUT	(PORT1),A
  741 C413  DD 77 01    	LD	(IX+1),A
  742         0000      if RAM1MB
  753                   endif
  754 C416  FB          STBFF:	EI
  755 C417  F1          	POP	AF		; urspruenglicher Zustand
  756 C418  26 FF       	LD	H,0FFh		; internes Modul melden
  757 C41A  C9          	RET
  758                   
  759 C41B  10 F9       MODU6:	DJNZ	STBFF		; 5=CAOSC
  760 C41D  7A          	LD	A,D		; 4=RAM4
  761 C41E  AC          	XOR	H
  762 C41F  E6 04       	AND	4		; Aenderung?
  763                   ;	DI
  764 C421  28 3F       	JR	Z,RAM41
  765 C423  DD 7E 04    	LD	A,(IX+4)
  766 C426  F6 03       	OR	3
  767 C428  D3 86       	OUT	(PORT2),A	; RAM4 on
  768 C42A  D5          	PUSH	DE
  769 C42B  E5          	PUSH	HL
  770 C42C  DB 88       	IN	A,(PIOAD)
  771 C42E  F5          	PUSH	AF
  772 C42F  CB 87       	RES	0,A
  773 C431  D3 88       	OUT	(PIOAD),A	; CAOSE off
  774 C433  DD 7E 01    	LD	A,(IX+1)
  775 C436  F5          	PUSH	AF
  776 C437  E6 F9       	AND	11111001b
  777 C439  2E 03       	LD	L,3		; 3 IRM-Ebenen
  778 C43B  01 1000     	LD	BC,1000H	; 800H frei!
  779 C43E  11 4000     	LD	DE,4000H
  780 C441  C6 02       R4IS:	ADD	A,2
  781 C443  D3 84       	OUT	(PORT1),A	; IRM-Ebene
  782 C445  67          	LD	H,A
  783 C446  E5          	PUSH	HL
  784 C447  21 A800     	LD	HL,0A800H
  785 C44A  1A          R4MV:	LD	A,(DE)
  786 C44B  ED A0       	LDI
  787 C44D  2B          	DEC	HL
  788 C44E  77          	LD	(HL),A
  789 C44F  23          	INC	HL
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  24
CC47    INC

  790 C450  EA C44A     	JP	PE,R4MV
  791 C453  E1          	POP	HL
  792 C454  7C          	LD	A,H
  793 C455  06 18       	LD	B,18H		; jetzt 1800H!
  794 C457  2D          	DEC	L
  795 C458  20 E7       	JR	NZ,R4IS
  796 C45A  F1          	POP	AF
  797 C45B  D3 84       	OUT	(PORT1),A	; IRM wie zuvor
  798 C45D  F1          	POP	AF
  799 C45E  D3 88       	OUT	(PIOAD),A	; CAOSE on
  800 C460  E1          	POP	HL
  801 C461  D1          	POP	DE
  802 C462  DD 7E 04    RAM41:	LD	A,(IX+4)
  803 C465  AA          	XOR	D
  804 C466  E6 FC       	AND	11111100b	; Bits 0..1: a = (0 XOR d) = d
  805 C468  AA          	XOR	D		; Bits 2..7: a = (a XOR d) XOR d
  806 C469  DD 77 04    	LD	(IX+4),A
  807 C46C  D3 86       	OUT	(PORT2),A
  808 C46E  18 A6       	JR	STBFF
  809                   
  810                   ; F-Taste belegen:
  811                   
  812 C470  21 B900     KEYC:	LD	HL,FTASTE	; 0B900H
  813 C473  A7          	AND	A
  814 C474  20 07       	JR	NZ,KEY0
  815 C476  06 9C       	LD	B,9CH
  816 C478  77          KEYCL:	LD	(HL),A		; loeschen
  817 C479  2C          	INC	L
  818 C47A  10 FC       	DJNZ	KEYCL
  819 C47C  C9          	RET
  820                   	;
  821 C47D  FE 10       KEY0:	CP	15+1
  822 C47F  D0          	RET	NC		; nur F1 bis FF
  823 C480  47          	LD	B,A
  824 C481  F6 F0       	OR	0F0H
  825 C483  4F          	LD	C,A
  826 C484  7E          KEY1:	LD	A,(HL)		; B Dummys auszaehlen
  827 C485  2C          	INC	L
  828 C486  C8          	RET	Z
  829 C487  A7          	AND	A
  830 C488  20 FA       	JR	NZ,KEY1
  831 C48A  10 F8       	DJNZ	KEY1
  832 C48C  7D          	LD	A,L
  833 C48D  FE 9C       	CP	9CH
  834 C48F  D0          	RET	NC
  835 C490  ED 5B B7A0  	LD	DE,(CURSO)
  836 C494  CD C54D     	CALL	KEYDI		; praesentieren
  837 C497  CD F3F0     KEY2:	CALL	INTB
  838 C49A  FE 13       	CP	13H
  839 C49C  20 03       	JR	NZ,KEY3
  840 C49E  04          	INC	B		; Umschaltung
  841 C49F  18 F6       	JR	KEY2
  842                   	;
  843 C4A1  CB 40       KEY3:	BIT	0,B
  844 C4A3  28 0D       	JR	Z,KEY4		; interpretieren
  845 C4A5  FE 03       	CP	3
  846 C4A7  28 70       	JR	Z,KEY12		; BRK=Abbruch
  847 C4A9  FE 0D       	CP	CR
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  25
CC47    INC

  848 C4AB  28 0A       	JR	Z,KEY5		; Enter=belegen
  849 C4AD  CD F3D5     	CALL	OCHR
  850 C4B0  18 E5       	JR	KEY2
  851                   	;
  852 C4B2  CD F7B5     KEY4:	CALL	CSTBT
  853 C4B5  18 E0       	JR	KEY2
  854                   	;
  855 C4B7  E5          KEY5:	PUSH	HL		; Pos. in Puffer
  856 C4B8  CD E068     	CALL	DABR
  857 C4BB  EB          	EX	DE,HL
  858 C4BC  CD F4EB     	CALL	RHEX		; Fn lesen
  859 C4BF  E1          	POP	HL
  860 C4C0  38 06       	JR	C,KERR		; Formatfehler
  861 C4C2  3A B797     	LD	A,(NUMVX)
  862 C4C5  B9          	CP	C		; geaendert!
  863 C4C6  28 06       	JR	Z,KEY6
  864 C4C8  CD F4DB     KERR:	CALL	CRLF
  865 C4CB  C3 F4D1     	JP	ERRM
  866                   	;
  867 C4CE  13          KEY6:	INC	DE
  868 C4CF  13          	INC	DE
  869 C4D0  06 9B       	LD	B,9BH
  870 C4D2  2F          	CPL
  871 C4D3  A7          	AND	A
  872 C4D4  28 21       	JR	Z,KEY8		; KEY F
  873 C4D6  3C          	INC	A
  874 C4D7  47          	LD	B,A
  875 C4D8  4D          	LD	C,L
  876 C4D9  7E          KEY7:	LD	A,(HL)
  877 C4DA  2C          	INC	L
  878 C4DB  28 EB       	JR	Z,KERR		; Puffer voll!
  879 C4DD  A7          	AND	A
  880 C4DE  20 F9       	JR	NZ,KEY7
  881 C4E0  10 F7       	DJNZ	KEY7		; Ende suchen
  882 C4E2  2D          	DEC	L
  883 C4E3  7D          	LD	A,L
  884 C4E4  FE 9C       	CP	9CH
  885 C4E6  30 E0       	JR	NC,KERR		; Puffer voll!
  886 C4E8  44          	LD	B,H
  887 C4E9  C5          	PUSH	BC
  888 C4EA  91          	SUB	C
  889 C4EB  4F          	LD	C,A
  890 C4EC  06 00       	LD	B,0
  891 C4EE  D5          	PUSH	DE
  892 C4EF  11 B99B     	LD	DE,0B99BH
  893 C4F2  ED B8       	LDDR			; Rest hinter
  894 C4F4  43          	LD	B,E
  895 C4F5  D1          	POP	DE
  896 C4F6  E1          	POP	HL
  897 C4F7  4F          KEY8:	LD	C,A
  898 C4F8  2D          KEY9:	DEC	L
  899 C4F9  7E          	LD	A,(HL)
  900 C4FA  A7          	AND	A
  901 C4FB  20 FB       	JR	NZ,KEY9		; zurueck bis 0
  902 C4FD  2C          KEY10:	INC	L
  903 C4FE  1A          	LD	A,(DE)
  904 C4FF  13          	INC	DE
  905 C500  77          	LD	(HL),A		; belegen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  26
CC47    INC

  906 C501  B7          	OR	A
  907 C502  28 08       	JR	Z,KEY11
  908 C504  78          	LD	A,B
  909 C505  95          	SUB	L
  910 C506  20 F5       	JR	NZ,KEY10
  911 C508  36 00       	LD	(HL),0
  912 C50A  18 BC       	JR	KERR
  913                   	;
  914 C50C  79          KEY11:	LD	A,C
  915 C50D  A7          	AND	A
  916 C50E  28 09       	JR	Z,KEY12		; KEY F
  917 C510  04          	INC	B
  918 C511  2C          	INC	L
  919 C512  5D          	LD	E,L
  920 C513  54          	LD	D,H
  921 C514  68          	LD	L,B
  922 C515  06 00       	LD	B,0
  923 C517  ED B0       	LDIR			; Rest nach vorn
  924 C519  C3 F4DB     KEY12:	JP	CRLF
  925                   
  926                   ; Anzeige belegter F-Tasten:
  927                   
  928 C51C  21 B901     KEYLIC:	LD	HL,FTASTE+1
  929 C51F  01 00F1     	LD	BC,0F1H
  930 C522  7E          KEYLC1:	LD	A,(HL)
  931 C523  A7          	AND	A
  932 C524  28 07       	JR	Z,KEYLC2
  933 C526  CD C54D     	CALL	KEYDI		; Belegung
  934 C529  CD F4DB     	CALL	CRLF
  935 C52C  04          	INC	B		; Zaehler
  936 C52D  2C          KEYLC2:	INC	L
  937 C52E  7D          	LD	A,L
  938 C52F  FE 9C       	CP	9CH
  939 C531  30 03       	JR	NC,KEYLC3
  940 C533  0C          	INC	C
  941 C534  20 EC       	JR	NZ,KEYLC1	; F1 bis FF
  942 C536  04          KEYLC3:	INC	B
  943 C537  05          	DEC	B
  944 C538  C0          	RET	NZ
  945 C539  CD F0CF     	CALL	OSTR
  946 C53C  46 2D 54 61 	DB	'F-Tasten leer'
  947 C549  0D 0A 00    	DB	CR,LF,0
  948 C54C  C9          	RET
  949                   
  950 C54D  3E 02       KEYDI:	LD	A,2
  951 C54F  CD F3D5     	CALL	OCHR		; Zeile loeschen
  952 C552  79          	LD	A,C
  953 C553  CD F0CC     	CALL	AHOSTR		; Fn
  954 C556  20 3A 00    	DB	' :',0
  955 C559  7E          KEYD1:	LD	A,(HL)
  956 C55A  B7          	OR	A
  957 C55B  C8          	RET	Z
  958 C55C  CD F7B5     	CALL	CSTBT
  959 C55F  23          	INC	HL
  960 C560  7D          	LD	A,L
  961 C561  FE 9C       	CP	9CH
  962 C563  D0          	RET	NC
  963 C564  18 F3       	JR	KEYD1
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  27
CC47    INC

  964                   
  965                   ; COLOR-Menuewort:
  966                   
  967 C566  A7          COLRC:	AND	A		; Anzahl Parameter
  968 C567  20 17       	JR	NZ,SETCO	; 1 oder 2 -> Farben einstellen
  969 C569  3A B7A3     	LD	A,(COLOR)	; 0 = aktuelle Farben anzeigen
  970 C56C  6F          	LD	L,A
  971 C56D  0F          	RRCA
  972 C56E  0F          	RRCA
  973 C56F  0F          	RRCA
  974 C570  E6 1F       	AND	1FH
  975 C572  CD F3B9     	CALL	AHSPC		; Anzeige Vordergrundfarbe
  976 C575  7D          	LD	A,L
  977 C576  E6 07       	AND	7
  978 C578  CD F3C4     	CALL	AHEX		; Anzeige Hintergrundfarbe
  979 C57B  CD F4DB     	CALL	CRLF
  980 C57E  18 18       	JR	COLRC2
  981                   
  982                   ; COLOR-Unterprogramm = Farbe setzen (aus L und E)
  983                   
  984 C580  3E 1F       SETCO:	LD	A,1FH		; 1 oder 2 
  985 C582  A5          	AND	L		; Maske fuer Vordergrundfarbe
  986 C583  17          	RLA
  987 C584  17          	RLA
  988 C585  17          	RLA
  989 C586  6F          	LD	L,A
  990 C587  3A B781     	LD	A,(ARGN)
  991 C58A  FE 02       	CP	2		; auch Hintergrund einstellen?
  992 C58C  7B          	LD	A,E		; neue Hintergrundfarbe
  993 C58D  30 03       	JR	NC,COLRC1
  994 C58F  3A B7A3     	LD	A,(COLOR)	; alte Hintergrundfarbe
  995 C592  E6 07       COLRC1:	AND	7
  996 C594  B5          	OR	L
  997 C595  32 B7A3     	LD	(COLOR),A	; neuer Farbwert
  998 C598  C3 FB9C     COLRC2:	JP	COFF
  999                   
 1000                   ; WINDOW-Menuewort
 1001                   
 1002 C59B  A7          WINDC:	AND	A		; Kein Argument?
 1003 C59C  28 20       	JR	Z,WINC0		; Standardfenster initialisieren
 1004 C59E  3D          	DEC	A		; 1 Arg?
 1005 C59F  7D          	LD	A,L		; nr
 1006 C5A0  28 28       	JR	Z,WINAKC	; Aufruf No.L
 1007 C5A2  65          	LD	H,L		; za
 1008 C5A3  69          	LD	L,C		; sa
 1009 C5A4  53          	LD	D,E		; zn
 1010 C5A5  3A B788     	LD	A,(ARG4)
 1011 C5A8  5F          	LD	E,A		; sn
 1012 C5A9  3A B781     	LD	A,(ARGN)
 1013 C5AC  FE 04       	CP	4
 1014 C5AE  38 0B       	JR	C,WINCJE	; 2..3 Arg
 1015 C5B0  3E 00       	LD	A,0
 1016 C5B2  28 03       	JR	Z,WINC1		; 4 Arg
 1017 C5B4  3A B78A     	LD	A,(ARG5)	; nr
 1018 C5B7  CD C5FA     WINC1:	CALL	WININC
 1019 C5BA  D0          	RET	NC
 1020 C5BB  C3 F4D1     WINCJE:	JP	ERRM
 1021                   
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  28
CC47    INC

 1022 C5BE  11 B79B     WINC0:	LD	DE,WINNR	; von Fensternummer
 1023 C5C1  21 C002     	LD	HL,WIN0		; bis WEND-Adresse
 1024 C5C4  01 000B     	LD	BC,WIN1-WIN0	; mit Standardwerten aus ROM
 1025 C5C7  ED B0       	LDIR			; Fenster 0 neu initialisieren
 1026 C5C9  C9          	RET
 1027                   
 1028                   ; definiertes Fenster aufrufen:
 1029                   ; PE:	A	Fensternummer 0..9
 1030                   ; PA:	CY=1	Fehler
 1031                   ; VR:	AF,BC,DE,HL
 1032                   
 1033 C5CA  CD C5E7     WINAKC:	CALL	WCOPY		; aktuelles Fenster retten
 1034 C5CD  32 B79B     	LD	(WINNR),A	; neue Fensternummer
 1035 C5D0  CD C5DA     	CALL	PART		; Adresse Vektorspeicher in DE
 1036 C5D3  D8          	RET	C		; Nr. ausserhalb
 1037 C5D4  EB          	EX	DE,HL
 1038 C5D5  11 B79C     	LD	DE,WINON	; gespeichertes Fenster laden
 1039 C5D8  18 1A       	JR	WCOP1
 1040                   
 1041                   ; Testet A und berechnet Position in Fenstervektorspeicher
 1042                   ; PE:	A	Fensternummer 0-9
 1043                   ; PA:	CY=1	Nr. zu gross
 1044                   ;	DE	Adresse im Fenstervektorspeicher
 1045                   
 1046 C5DA  C6 F6       PART:	ADD	A,-10
 1047 C5DC  D8          	RET	C		; zu gross
 1048 C5DD  87          	ADD	A,A	; *2
 1049 C5DE  5F          	LD	E,A
 1050 C5DF  87          	ADD	A,A	; *4
 1051 C5E0  87          	ADD	A,A	; *8
 1052 C5E1  83          	ADD	A,E	; *10
 1053 C5E2  5F          	LD	E,A
 1054 C5E3  16 B9       	LD	D,High(WNDFN)	; Adresse im Fenstervektorspeicher
 1055 C5E5  A7          	AND	A		; CY=0
 1056 C5E6  C9          	RET
 1057                   
 1058                   ; aktuelles Fenster (WINNR) in Fenstervektorspeicher retten
 1059                   ; PE:	A	Fensternummer 0..9
 1060                   ; PA:	CY=1	Nr. zu gross
 1061                   ;	BC=0
 1062                   
 1063 C5E7  F5          WCOPY:	PUSH	AF
 1064 C5E8  3A B79B     	LD	A,(WINNR)	; aktuelle Fensternummer
 1065 C5EB  CD C5DA     	CALL	PART		; Adresse berechnen
 1066 C5EE  38 3D       	JR	C,WINIE		; Fehler
 1067 C5F0  F1          	POP	AF
 1068 C5F1  21 B79C     	LD	HL,WINON	; ab Fensteranfang 10 Byte retten
 1069 C5F4  01 000A     WCOP1:	LD	BC,10		; Laenge Fenstervektor
 1070 C5F7  ED B0       	LDIR
 1071 C5F9  C9          	RET
 1072                   
 1073                   ; Initialisierung eines Fensters
 1074                   ; PE:	A	Fensternummer 0..9
 1075                   ;	HL	Fensteranfang
 1076                   ;	DE	Fenstrergroesse
 1077                   ; PA:	CY=1	Fehler
 1078                   ; VR:	AF,BC,DE,HL
 1079                   
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  29
CC47    INC

 1080 C5FA  F5          WININC:	PUSH	AF
 1081 C5FB  FE 0A       	CP	10		; Fensternummer
 1082 C5FD  30 2E       	JR	NC,WINIE	; nur 10 Fenster moeglich
 1083 C5FF  7A          	LD	A,D		; Zeilen
 1084 C600  A7          	AND	A
 1085 C601  28 2A       	JR	Z,WINIE		; Zeilenanzahl=0 -> ERROR
 1086 C603  84          	ADD	A,H
 1087 C604  38 27       	JR	C,WINIE		; Anzahl+Anfang>256 -> ERROR
 1088 C606  FE 21       	CP	33
 1089 C608  30 23       	JR	NC,WINIE	; Anzahl+Anfang>32 -> ERROR
 1090 C60A  7B          	LD	A,E		; Spalten
 1091 C60B  A7          	AND	A
 1092 C60C  28 1F       	JR	Z,WINIE		; Spaltenanzahl=0 -> ERROR
 1093 C60E  85          	ADD	A,L
 1094 C60F  38 1C       	JR	C,WINIE		; Anzahl+Anfang>256 -> ERROR
 1095 C611  FE 29       	CP	41
 1096 C613  30 18       	JR	NC,WINIE	; Anzahl+Anfang>40 -> ERROR
 1097 C615  F1          	POP	AF
 1098 C616  D5          	PUSH	DE
 1099 C617  E5          	PUSH	HL
 1100 C618  CD C5E7     	CALL	WCOPY		; aktuelles Fenster retten
 1101 C61B  E1          	POP	HL
 1102 C61C  D1          	POP	DE
 1103 C61D  22 B79C     	LD	(WINON),HL	; Fensteranfang
 1104 C620  ED 53 B79E  	LD	(WINLG),DE	; Fenstergroesse
 1105 C624  ED 43 B7A0  	LD	(CURSO),BC	; BC=0
 1106 C628  32 B79B     	LD	(WINNR),A	; Fensternummer
 1107 C62B  A7          	AND	A		; CY=0
 1108 C62C  C9          	RET
 1109                   	;
 1110 C62D  F1          WINIE:	POP	AF		; Fehlerende
 1111 C62E  37          	SCF
 1112 C62F  C9          	RET
 1113                   
 1114                   ; Linie zeichnen					**3E**
 1115                   ; von (ARG1)/(ARG2) nach (ARG3)/(ARG4)
 1116                   
 1117 C630  ED 5B B784  LINEC:	 LD	DE,(ARG2)	; YANF
 1118 C634  2A B788     	 LD	HL,(ARG4)	; YEND
 1119 C637  D9          	 EXX
 1120 C638  ED 5B B782  	LD	DE,(ARG1)	; XANF
 1121 C63C  D5          	PUSH	DE
 1122 C63D  2A B786     	LD	HL,(ARG3)	; XEND
 1123 C640  3E 08       	LD	A,8		; X=Master
 1124 C642  B7          	OR	A
 1125 C643  ED 52       	SBC	HL,DE		; HL=XSTEPS
 1126 C645  30 06       	JR	NC,LINC1	; vorwaerts
 1127 C647  19          	ADD	HL,DE
 1128 C648  EB          	EX	DE,HL
 1129 C649  F6 01       	OR	1		; rueckwaerts
 1130 C64B  ED 52       	SBC	HL,DE
 1131 C64D  D9          LINC1:	 EXX
 1132 C64E  D5          	 PUSH	DE		; YANF
 1133 C64F  ED 52       	 SBC	HL,DE		; HL'=YSTEPS
 1134 C651  30 06       	 JR	NC,LINC2	; steigend
 1135 C653  19          	 ADD	HL,DE
 1136 C654  EB          	 EX	DE,HL
 1137 C655  F6 02       	 OR	2		; fallend
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  30
CC47    INC

 1138 C657  ED 52       	 SBC	HL,DE
 1139 C659  E5          LINC2:	 PUSH	HL		; YSTEPS
 1140 C65A  D9          	 EXX			; HL=XSTEPS
 1141 C65B  C1          	POP	BC		; BC=YSTEPS
 1142 C65C  E5          	PUSH	HL
 1143 C65D  ED 42       	SBC	HL,BC		; flach/steil?
 1144 C65F  E1          	POP	HL
 1145 C660  C5          	PUSH	BC
 1146 C661  30 05       	JR	NC,LINC3	; flach
 1147 C663  E3          	EX	(SP),HL
 1148 C664  CB 9F       	RES	3,A		; X=Slave
 1149 C666  CB D7       	SET	2,A		; Y=Master
 1150 C668  E5          LINC3:	PUSH	HL		; HL=MAX(STEPS)
 1151 C669  44          	LD	B,H
 1152 C66A  4D          	LD	C,L		; Pixelzaehler
 1153 C66B  D9          	 EXX
 1154 C66C  C1          	 POP	BC		; BC'=MAX(...)
 1155 C66D  D1          	 POP	DE		; DE'=MIN(...)
 1156 C66E  60          	 LD	H,B
 1157 C66F  69          	 LD	L,C
 1158 C670  CB 3C       	 SRL	H		; Slave mit 1/2
 1159 C672  CB 1D       	 RR 	L		; HL=1/2*MAX(...)
 1160 C674  D9          	 EXX
 1161 C675  D1          	POP	DE		; DE=YANF
 1162 C676  E1          	POP	HL		; HL=XANF
 1163                   
 1164                   ; Hauptschleife
 1165                   ; AF Bitregister
 1166                   ; HL lfd. X-Koordinate	HL' Slave
 1167                   ; DE lfd. Y-Koordinate	DE' -Master
 1168                   ; BC Punktezaehler	BC' +Master
 1169                   
 1170 C677  F5          LINCS:	PUSH	AF
 1171 C678  08          	EX	AF,AF'		; Bitreg merken
 1172 C679  F1          	POP	AF
 1173 C67A  E5          	PUSH	HL
 1174 C67B  21 B7ED     	LD	HL,LINTYP
 1175 C67E  CB 06       	RLC	(HL)
 1176 C680  E1          	POP	HL
 1177 C681  DC C71E     	CALL	C,POINT		; Punkt setzen
 1178 C684  D9          	 EXX
 1179 C685  A7          	 AND	A
 1180 C686  ED 52       	 SBC	HL,DE		; -Master subtrahieren
 1181 C688  30 01       	 JR	NC,LINC4	; kein Uebertrag - kein Sprung!
 1182 C68A  09          	 ADD	HL,BC		; +Master addieren (CY bleibt =1)
 1183 C68B  D9          LINC4:	 EXX
 1184 C68C  30 02       	JR	NC,LINC5
 1185 C68E  F6 0C       	OR	0CH		; X und Y!
 1186 C690  CB 5F       LINC5:	BIT	3,A		; X?
 1187 C692  28 07       	JR	Z,LINC6
 1188 C694  23          	INC	HL
 1189 C695  CB 47       	BIT	0,A
 1190 C697  28 02       	JR	Z,LINC6
 1191 C699  2B          	DEC	HL
 1192 C69A  2B          	DEC	HL
 1193 C69B  CB 57       LINC6:	BIT	2,A		; Y?
 1194 C69D  28 07       	JR	Z,LINC7
 1195 C69F  13          	INC	DE
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  31
CC47    INC

 1196 C6A0  CB 4F       	BIT	1,A
 1197 C6A2  28 02       	JR	Z,LINC7
 1198 C6A4  1B          	DEC	DE
 1199 C6A5  1B          	DEC	DE
 1200 C6A6  78          LINC7:	LD	A,B
 1201 C6A7  B1          	OR	C		; letzter Punkt?
 1202 C6A8  C8          	RET	Z	; CY=0
 1203 C6A9  0B          	DEC	BC
 1204 C6AA  08          	EX	AF,AF'		; Bitreg
 1205 C6AB  18 CA       	JR	LINCS
 1206                   
 1207                   ; Kreis zeichnen					**3F**
 1208                   
 1209 C6AD  3A B786     CIRCLC:	LD	A,(ARG3)	; Radius R
 1210 C6B0  4F          	LD	C,A
 1211 C6B1  51          	LD	D,C
 1212 C6B2  CD D2DB     	CALL	MULC		; BA=C*D
 1213 C6B5  60          	LD	H,B
 1214 C6B6  6F          	LD	L,A		; HL = R*R
 1215 C6B7  54          	LD	D,H
 1216 C6B8  5D          	LD	E,L		; DE = HL
 1217 C6B9  79          	LD	A,C
 1218 C6BA  06 00       	LD	B,0		; BC=Radius
 1219 C6BC  CB 21       	SLA	C
 1220 C6BE  CB 10       	RL	B		; BC=Radius*2
 1221 C6C0  0B          	DEC	BC
 1222 C6C1  C5          	PUSH	BC
 1223 C6C2  01 0001     	LD	BC,1
 1224 C6C5  D9          	EXX
 1225 C6C6  4F          	 LD	C,A
 1226 C6C7  06 00       	 LD	B,0		; BC=Radius
 1227                   ;
 1228 C6C9  E5          CLOOP:	 PUSH	HL
 1229 C6CA  21 B7ED     	 LD	HL,LINTYP	; Linientype beruecksichtigen
 1230 C6CD  CB 06       	 RLC	(HL)		; CY=1 wenn Punkt zu setzen ist
 1231 C6CF  E1          	 POP	HL
 1232 C6D0  30 06       	 JR	NC,CIRN		; keinen Punkt setzen
 1233 C6D2  CD C6F8     	 CALL	QUA		; und jeweils 8
 1234 C6D5  CD C6F8     	 CALL	QUA		; Punkte setzen
 1235 C6D8  D9          CIRN:	EXX
 1236 C6D9  A7          	AND	A
 1237 C6DA  ED 42       	SBC	HL,BC
 1238 C6DC  03          	INC	BC
 1239 C6DD  03          	INC	BC
 1240 C6DE  ED 52       	SBC	HL,DE
 1241 C6E0  19          	ADD	HL,DE
 1242 C6E1  D9          	EXX
 1243 C6E2  30 0C       	 JR	NC,CIR3
 1244 C6E4  D9          	EXX
 1245 C6E5  E3          	EX	(SP),HL
 1246 C6E6  EB          	EX	DE,HL
 1247 C6E7  A7          	AND	A
 1248 C6E8  ED 52       	SBC	HL,DE
 1249 C6EA  1B          	DEC	DE
 1250 C6EB  1B          	DEC	DE
 1251 C6EC  EB          	EX	DE,HL
 1252 C6ED  E3          	EX	(SP),HL
 1253 C6EE  D9          	EXX
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  32
CC47    INC

 1254 C6EF  0D          	 DEC	C
 1255 C6F0  04          CIR3:	 INC	B
 1256 C6F1  79          	 LD	A,C
 1257 C6F2  B8          	 CP	B
 1258 C6F3  30 D4       	 JR	NC,CLOOP
 1259 C6F5  F1          	POP	AF
 1260 C6F6  B7          	OR	A	; CY=0 (wegen BASIC erforderlich)
 1261 C6F7  C9          	RET
 1262                   
 1263                   ; setzt 4 Punkte um Mittelpunkt
 1264                   
 1265 C6F8  78          QUA:	LD	A,B
 1266 C6F9  41          	LD	B,C
 1267 C6FA  4F          	LD	C,A
 1268 C6FB  AF          	XOR	A
 1269 C6FC  57          	LD	D,A
 1270 C6FD  2A B784     	LD	HL,(ARG2)	; Y-Mittelpunkt
 1271 C700  E5          	PUSH	HL
 1272 C701  59          	LD	E,C
 1273 C702  19          	ADD	HL,DE		; oberhalb vom Mittelpunkt
 1274 C703  CD C70C     	CALL	UPP		; 2 Punkte setzen
 1275 C706  AF          	XOR	A	; CY=0
 1276 C707  57          	LD	D,A
 1277 C708  E1          	POP	HL
 1278 C709  59          	LD	E,C
 1279 C70A  ED 52       	SBC	HL,DE		; unterhalb vom Mittelpunkt
 1280                   	;			; und reinlaufen
 1281 C70C  E5          UPP:	PUSH	HL
 1282 C70D  2A B782     	LD	HL,(ARG1)	; X-Mittelpunkt
 1283 C710  58          	LD	E,B
 1284 C711  A7          	AND	A	; CY=0
 1285 C712  ED 52       	SBC	HL,DE		; links vom Mittelpunkt
 1286 C714  D1          	POP	DE		; Y-Koordinate
 1287 C715  CD C71E     	CALL	POINT		; 1 Punkt setzen
 1288 C718  D5          	PUSH	DE
 1289 C719  57          	LD	D,A
 1290 C71A  58          	LD	E,B
 1291 C71B  19          	ADD	HL,DE
 1292 C71C  19          	ADD	HL,DE		; rechts vom Mittelpunkt
 1293 C71D  D1          	POP	DE		; und reinlaufen
 1294                   
 1295                   ;***************************************************************
 1296                   ; universelles Punkt(re)set-Programm
 1297                   ; PE:	HL	X-Koordinate
 1298                   ;	DE	Y-Koordinate
 1299                   ;	(FARB)	Bit 3...7 : Farbe
 1300                   ;		Bit 2=1   : Farbebene nicht aendern
 1301                   ;		Bit 1=1   : PRESET
 1302                   ;		Bit 0=1   : PXOR
 1303                   ; VR:	-
 1304                   
 1305 C71E  E5          POINT:	PUSH	HL
 1306 C71F  D5          	PUSH	DE
 1307 C720  C5          	PUSH	BC
 1308 C721  F5          	PUSH	AF
 1309 C722  CD C7CD     	CALL	CALXY		; Grafikposition berechnen
 1310 C725  D4 C72B     	CALL	NC,PUSET	; Punkt setzen wenn OK
 1311 C728  C3 E097     	JP	POP4		; POP	AF,BC,DE,HL   RET
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  33
CC47    INC

 1312                   	;
 1313 C72B  DD CB 01 5E PUSET:	BIT	3,(IX+1)	; HiRes?
 1314 C72F  28 29       	JR	Z,HIRES		; Punkt in Vordergrundfarbe setzen
 1315 C731  CB 4A       	BIT	1,D
 1316 C733  20 21       	JR	NZ,PUERA	; Punkt loeschen
 1317 C735  CB 42       	BIT	0,D
 1318 C737  20 03       	JR	NZ,PUXOR	; Punkt invertieren
 1319                   
 1320                   ; Punkt setzen:
 1321 C739  B6          	OR	(HL)		; Bit setzen
 1322 C73A  18 03       	JR	PUCOL
 1323                   
 1324                   ; Punkt invertieren:
 1325 C73C  AE          PUXOR:	XOR	(HL)		; alternierend
 1326 C73D  CB 82       	RES	0,D
 1327 C73F  77          PUCOL:	LD	(HL),A		; in Pixel-RAM eintragen
 1328 C740  CB 52       	BIT	2,D		; Bit 2 in CAOS 3.4 und ab CAOS 4.7 benutzt
 1329 C742  C0          	RET	NZ		; wenn Bit 2=1, dann Farbe nicht setzen
 1330 C743  DD 7E 01    	LD	A,(IX+1)
 1331 C746  5F          	LD	E,A
 1332 C747  EE 02       	XOR	2		; Farbebene
 1333 C749  F3          	DI
 1334 C74A  D3 84       	 OUT	(PORT1),A	; Umschaltung Farbebene
 1335 C74C  7E          	 LD	A,(HL)
 1336 C74D  E6 07       	 AND	7		; alte vFarbe loeschen
 1337 C74F  B2          	 OR	D		; neue vFarbe einbauen
 1338 C750  77          HIR2:	 LD	(HL),A		; und in Color-RAM eintragen
 1339 C751  7B          HIR3:	 LD	A,E
 1340 C752  D3 84       	 OUT	(PORT1),A	; zurueck zu Pixelebene
 1341 C754  FB          	EI
 1342 C755  C9          	RET
 1343                   
 1344                   ; Punkt loeschen:
 1345 C756  2F          PUERA:	CPL
 1346 C757  A6          	AND	(HL)		; loeschen
 1347 C758  77          	LD	(HL),A
 1348 C759  C9          	RET
 1349                   
 1350                   ; Punkt im HIRES-Modus setzen:
 1351 C75A  47          HIRES:	LD	B,A		; Bitmaske
 1352 C75B  B6          	OR	(HL)		; Bit setzen in
 1353 C75C  CB 5A       	BIT	3,D		; Pixelebene?
 1354 C75E  20 01       	JR	NZ,HIR1
 1355 C760  A8          	XOR	B		; wieder loeschen
 1356 C761  77          HIR1:	LD	(HL),A
 1357 C762  DD 7E 01    	LD	A,(IX+1)
 1358 C765  5F          	LD	E,A
 1359 C766  EE 02       	XOR	2		; Farbebene
 1360 C768  F3          	DI
 1361 C769  D3 84       	 OUT	(PORT1),A	; Umschaltung Farbebene
 1362 C76B  78          	 LD	A,B
 1363 C76C  B6          	 OR	(HL)		; Bit setzen in
 1364 C76D  CB 62       	 BIT	4,D		; Farbebene?
 1365 C76F  20 DF       	 JR	NZ,HIR2
 1366 C771  A8          	 XOR	B		; wieder loeschen
 1367 C772  18 DC       	 JR	HIR2
 1368                   
 1369                   ; Punkt setzen						**30**
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  34
CC47    INC

 1370                   
 1371 C774  E5          PUSEC:	PUSH	HL
 1372 C775  D5          	PUSH	DE
 1373 C776  C5          	push	bc		; B-Register bei HIRES benutzt
 1374 C777  CD C7C4     	CALL	CALHV		; Grafikposition berechnen
 1375 C77A  D4 C72B     	CALL	NC,PUSET	; Punkt setzen wenn OK
 1376 C77D  18 42       	JR	PUDEE
 1377                   
 1378                   ; Punkt loeschen (HIRES nur testen)			**2F**
 1379                   
 1380 C77F  E5          PUDEC:	PUSH	HL
 1381 C780  D5          	PUSH	DE
 1382 C781  C5          	push	bc		; B-Register bei HIRES benutzt
 1383 C782  CD C7C4     	CALL	CALHV		; Grafikposition berechnen
 1384 C785  38 3A       	JR	C,PUDEE		; ausserhalb
 1385 C787  DD CB 01 5E 	BIT	3,(IX+1)	; HiRes?
 1386 C78B  20 1E       	JR	NZ,PUDEL
 1387                   ; Punktfarbe HIRES ermitteln
 1388 C78D  16 00       	LD	D,0
 1389 C78F  47          	LD	B,A		; Bitmaske
 1390 C790  7E          	LD	A,(HL)
 1391 C791  A0          	AND	B		; Bit in Pixelebene gesetzt?
 1392 C792  28 02       	JR	Z,HIR4
 1393 C794  CB C2       	SET	0,D
 1394 C796  DD 7E 01    HIR4:	LD	A,(IX+1)
 1395 C799  5F          	LD	E,A
 1396 C79A  EE 02       	XOR	2		; Farbebene
 1397 C79C  F3          	DI
 1398 C79D  D3 84       	 OUT	(PORT1),A	; Umschaltung Farbebene
 1399 C79F  7E          	 LD	A,(HL)
 1400 C7A0  A0          	 AND	B		; Bit in Farbebene gesetzt?
 1401 C7A1  CD C751     	 CALL	HIR3		; zurueck zu Pixelebene
 1402 C7A4  28 02       	JR	Z,HIR5
 1403 C7A6  CB CA       	SET	1,D
 1404 C7A8  04          HIR5:	INC	B		; Z=0 (Bitmaske)
 1405 C7A9  18 15       	JR	HIR6		; Farbbyte uebergeben
 1406                   	;
 1407 C7AB  47          PUDEL:	LD	B,A		; Bitmaske
 1408 C7AC  4E          	LD	C,(HL)		; Pixel-RAM lesen
 1409 C7AD  2F          	CPL			; Bitmaske invertieren
 1410 C7AE  A1          	AND	C		; Bit loeschen
 1411 C7AF  77          	LD	(HL),A		; und in Pixel-RAM schreiben
 1412 C7B0  DD 7E 01    	LD	A,(IX+1)
 1413 C7B3  5F          	LD	E,A
 1414 C7B4  EE 02       	XOR	2
 1415 C7B6  F3          	DI
 1416 C7B7  D3 84       	 OUT	(PORT1),A	; Umschalten auf Color-RAM
 1417 C7B9  56          	 LD	D,(HL)		; Color-RAM lesen
 1418 C7BA  7B          	 LD	A,E
 1419 C7BB  D3 84       	 OUT	(PORT1),A	; zurueck zu Pixel-RAM
 1420 C7BD  FB          	EI
 1421 C7BE  78          	LD	A,B		; Bitmaske
 1422 C7BF  A1          	AND	C		; Z=1: Punkt war geloescht
 1423 C7C0  7A          HIR6:	LD	A,D		; Farbbyte
 1424 C7C1  C3 F3EC     PUDEE:	JP	POP3		; POP	BC,DE,HL   RET
 1425                   ;
 1426                   ; Grafikposition berechnen fuer Punktroutinen
 1427                   ; PE:	HL	X-Koordinate (Horizontalposition)
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  35
CC47    INC

 1428                   ;	DE	Y-Koordinate (Vertikal-  "	)
 1429                   ; PA:	HL	IRM-Adresse Pixel/Farbe
 1430                   ;	D	Farbwert
 1431                   ;	A	Bit-Maske
 1432                   ;	CY	Fehler (ausserhalb)
 1433                   ; VR:	AF,DE,HL
 1434                   ;
 1435 C7C4  2A B7D3     CALHV:	LD	HL,(HOR)
 1436 C7C7  ED 5B B7D5  	LD	DE,(VERT)
 1437 C7CB  16 00       	LD	D,0
 1438 C7CD  C5          CALXY:	PUSH	BC
 1439 C7CE  01 FDF8     	LD	BC,BITTAB
 1440 C7D1  7D          	LD	A,L
 1441 C7D2  E6 07       	AND	7
 1442 C7D4  81          	ADD	A,C
 1443 C7D5  4F          	LD	C,A		; Bit
 1444 C7D6  7D          	LD	A,L
 1445 C7D7  CB 3C       	SRL	H
 1446 C7D9  1F          	RRA
 1447 C7DA  CB 3C       	SRL	H
 1448 C7DC  1F          	RRA
 1449 C7DD  CB 3C       	SRL	H
 1450 C7DF  1F          	RRA			; Spalte
 1451 C7E0  FE 28       	CP	40
 1452 C7E2  30 11       	JR	NC,CALEN
 1453 C7E4  F6 80       	OR	80H		; IRM
 1454 C7E6  67          	LD	H,A
 1455 C7E7  3E FF       	LD	A,0FFH
 1456 C7E9  82          	ADD	A,D
 1457 C7EA  38 09       	JR	C,CALEN
 1458 C7EC  AB          	XOR	E		; CY=0, kein Fehler
 1459 C7ED  6F          	LD	L,A		; Zeile
 1460 C7EE  3A B7D6     	LD	A,(FARB)
 1461 C7F1  57          	LD	D,A
 1462 C7F2  0A          	LD	A,(BC)		; Bitmaske
 1463 C7F3  C1          	POP	BC
 1464 C7F4  C9          	RET
 1465                   	;
 1466 C7F5  C1          CALEN:	POP	BC
 1467 C7F6  37          	SCF			; CY=1, Fehler: ausserhalb
 1468 C7F7  C9          	RET
 1469                   ;
 1470                   ; MENU-HACK damit DISPLAY immer mit D abgekuerzt werden kann
 1471                   ;
 1472 C7F8  7F7F        	DW	7F7FH
 1473 C7FA  44 20       	DB	'D '		; verstecktes Menuewort
 1474 C7FC  03          	DB	3
 1475                   
 1476                   ; Anzeige Speicherbereich:
 1477                   ; HL=Adresse, E=Listblocklaenge
 1478                   ; C=Anzahl Bytes pro Zeile
 1479                   ; A=Anzahl Argumente
 1480                   
 1481 C7FD  FE 03       DISPC:	CP	3
 1482 C7FF  30 08       	JR	NC,DISP1
 1483 C801  0E 08       	LD	C,8		; default = 8 Bytes/Zeile
 1484 C803  FE 02       	CP	2
 1485 C805  30 02       	JR	NC,DISP1
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  36
CC47    INC

 1486 C807  1E 04       	LD	E,4		; default = 4 Zeilen
 1487 C809  D5          DISP1:	PUSH	DE
 1488 C80A  CD D7A6     DISP2:	CALL	DPMEMO		; 1 Zeile anzeigen
 1489 C80D  CD F4DB     	CALL	CRLF
 1490 C810  CD E37C     	CALL	BRKT
 1491 C813  38 06       	JR	C,DISP4
 1492 C815  1D          	DEC	E
 1493 C816  20 F2       	JR	NZ,DISP2	; E*
 1494 C818  CD F3F0     DISP3:	CALL	INTB		; Warten auf Tastenbetaetigung
 1495 C81B  D1          DISP4:	POP	DE
 1496 C81C  FE 03       	CP	3		; BRK?
 1497 C81E  C8          	RET	Z
 1498 C81F  FE 0F       	CP	0FH
 1499 C821  20 05       	JR	NZ,DISP5
 1500 C823  CD F3D5     	CALL	OCHR		; Hardcopy
 1501 C826  18 F0       	JR	DISP3
 1502                   	;
 1503 C828  FE 13       DISP5:	CP	13H		; STOP?
 1504 C82A  20 DD       	JR	NZ,DISP1
 1505 C82C  18 07       	JR	MODI1
 1506                   
 1507                   ; Anzeige/Veraendern Speicherbereich
 1508                   ; HL=Adresse, E=Anzahl Bytes pro Zeile
 1509                   ; A=Anzahl Argumente
 1510                   
 1511 C82E  4B          MODIC:	LD	C,E		; Breite
 1512 C82F  FE 02       	CP	2		; 2 Argumente?
 1513 C831  30 02       	JR	NC,MODI1
 1514 C833  0E 01       	LD	C,1		; Standardbreite
 1515 C835  CD D7A6     MODI1:	CALL	DPMEMO		; 1 Zeile anzeigen
 1516 C838  3E 05       	LD	A,5
 1517 C83A  32 B7A0     	LD	(CURSO),A
 1518 C83D  CD F499     	CALL	INLIN		; Eingabe
 1519 C840  D8          	RET	C		; BRK
 1520 C841  E5          	PUSH	HL
 1521 C842  CD F4EB     	CALL	RHEX		; Adresse erfassen
 1522 C845  7E          	LD	A,(HL)
 1523 C846  E1          	POP	HL
 1524 C847  38 56       	JR	C,MODI9		; Fehler
 1525 C849  A7          	AND	A
 1526 C84A  28 E9       	JR	Z,MODI1
 1527 C84C  2A B797     	LD	HL,(NUMVX)
 1528 C84F  E5          MODI2:	PUSH	HL
 1529 C850  CD F4EB     	CALL	RHEX		; Datenbyte
 1530 C853  7E          	LD	A,(HL)
 1531 C854  A7          	AND	A		; kein Zeichen
 1532 C855  23          	INC	HL		; einlesbar?
 1533 C856  7E          	LD	A,(HL)
 1534 C857  E1          	POP	HL
 1535 C858  28 04       	JR	Z,MODI4
 1536 C85A  CD FB70     MODI3:	CALL	LDMAE		; eintragen
 1537 C85D  23          	INC	HL
 1538 C85E  1A          MODI4:	LD	A,(DE)
 1539 C85F  FE 2E       	CP	'.'		; Abschluss?
 1540 C861  C8          	RET	Z
 1541 C862  FE 2C       	CP	','		; 1 Zeichen?
 1542 C864  20 05       	JR	NZ,MODI5
 1543 C866  13          	INC	DE
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  37
CC47    INC

 1544 C867  1A          	LD	A,(DE)		; vom Video-RAM
 1545 C868  13          	INC	DE
 1546 C869  18 EF       	JR	MODI3		; eintragen
 1547                   	;
 1548 C86B  FE 3A       MODI5:	CP	':'		; Rueckschritt?
 1549 C86D  20 06       	JR	NZ,MODI6
 1550 C86F  06 00       	LD	B,0
 1551 C871  ED 42       	SBC	HL,BC		; C Bytes zurueck
 1552 C873  18 C0       	JR	MODI1
 1553                   	;
 1554 C875  FE 2F       MODI6:	CP	'/'		; neue Adresse?
 1555 C877  20 0B       	JR	NZ,MODI0
 1556 C879  13          	INC	DE
 1557 C87A  CD F4EB     	CALL	RHEX		; Adresse erfassen
 1558 C87D  38 20       	JR	C,MODI9		; Fehler
 1559 C87F  2A B797     	LD	HL,(NUMVX)
 1560 C882  18 B1       	JR	MODI1
 1561                   	;
 1562 C884  FE 27       MODI0:	CP	27H		; Zeichenkette?
 1563 C886  20 10       	JR	NZ,MODI8
 1564 C888  13          	INC	DE
 1565 C889  1A          MODI7:	LD	A,(DE)		; Zeichen holen
 1566 C88A  13          	INC	DE
 1567 C88B  A7          	AND	A		; Dummy-Ende?
 1568 C88C  28 A7       	JR	Z,MODI1
 1569 C88E  FE 27       	CP	27H		; Ende Kette?
 1570 C890  28 CC       	JR	Z,MODI4
 1571 C892  CD FB70     	CALL	LDMAE		; eintragen
 1572 C895  23          	INC	HL
 1573 C896  18 F1       	JR	MODI7
 1574                   	;
 1575 C898  A7          MODI8:	AND	A		; Ende Zeile?
 1576 C899  28 9A       	JR	Z,MODI1
 1577 C89B  FE 20       	CP	' '		; Leerzeichen?
 1578 C89D  28 B0       	JR	Z,MODI2
 1579 C89F  CD F4D1     MODI9:	CALL	ERRM		; sonst ERROR
 1580 C8A2  18 91       	JR	MODI1
 1581                   
 1582                   ; Initialisierung der Druckerausgabe:
 1583                   ;
 1584                   ; PE:	(ARGN)	0..5 Argumente	(0 = M003 ab Steckplatz 7 suchen)
 1585                   ;	(ARG1)	Steckplatz	(0 = M021)
 1586                   ;	(ARG2)	SIO-Kanal	(0..1 = A, 2 = B)
 1587                   ;	(ARG3)	User-Kanal	(2 = UOUT1, 3 = UOUT2)
 1588                   ;	(ARG4)	ShCLR-Reaktion	(0 = keine, 1 = Protokoll, 2 = Hardcopy)
 1589                   ;	(ARG5)	Druckertyp	(0..12)
 1590                   ; PA:	-
 1591                   ; VR:	AF, BC, DE, HL
 1592                   ;
 1593 C8A4  CD F5FF     LSTC:	CALL	LARG		; Arg's laden
 1594 C8A7  CD C8EF     	CALL	LSTCA		; Druckerinitialisierung (intern)
 1595 C8AA  DA F4D1     	JP	C,ERRM
 1596 C8AD  3E 0D       	LD	A,CR		; CR+LF drucken
 1597 C8AF  CD B7E9     	CALL	OFILT
 1598 C8B2  3E 0A       	LD	A,LF
 1599 C8B4  C3 B7E9     	JP	OFILT
 1600                   
 1601 C8B7  3A B7E1     LSTC1:	LD	A,(HCPZ)	; bisheriges Steuerbyte
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  38
CC47    INC

 1602 C8BA  E6 F0       	AND	0F0h		; Druckertyp uebernehmen
 1603 C8BC  0F          	RRCA			; und auf Bits 1..4 rotieren
 1604 C8BD  0F          	RRCA
 1605 C8BE  0F          	RRCA
 1606 C8BF  18 3D       	JR	LSTC6
 1607                   
 1608                   ; M021
 1609 C8C1  CD C95C     LSTC2:	CALL	USRARG		; Steuerwort aus Argumenten bilden (CY war 0)
 1610 C8C4  AF          	XOR	A
 1611 C8C5  D3 91       	OUT	(91h),A		; M021 PIO-B Daten
 1612 C8C7  DB 91       	IN	A,(91h)
 1613 C8C9  C6 FF       	ADD	A,-1		; 0 zurueckgelesen?
 1614 C8CB  D8          	RET	C		; sonst kein M021 vorhanden
 1615 C8CC  C5          	PUSH	BC
 1616 C8CD  21 FA11     	LD	HL,M021PR
 1617 C8D0  18 57       	JR	LSTC7
 1618                   
 1619                   ; M003:
 1620 C8D2  2E 07       LSTC3:	LD	L,7		; ab Steckplatz 7
 1621 C8D4  CD C952     LSTC4:	CALL	SIOARG		; Steuerwort aus Argumenten bilden
 1622 C8D7  C5          	PUSH	BC		; Adresse ShCLR-Reaktionsprogramm
 1623 C8D8  45          	LD	B,L
 1624 C8D9  CD C38A     	CALL	V24SU		; M003 suchen und einschalten
 1625 C8DC  50          	LD	D,B		; Steckplatz in D zurueckgeben
 1626 C8DD  38 70       	JR	C,IOEPOP	; nicht gefunden
 1627 C8DF  3A B7E4     	LD	A,(INTV1L)
 1628 C8E2  47          	LD	B,A
 1629 C8E3  2A B7E2     	LD	HL,(INTV1)
 1630 C8E6  7B          	LD	A,E		; Steuerbyte
 1631 C8E7  CD C9DA     	CALL	INISIO
 1632 C8EA  21 FA29     	LD	HL,V24PR
 1633 C8ED  18 3A       	JR	LSTC7
 1634                   
 1635                   ; Initialisierung der Druckerausgabe (intern):
 1636                   ;
 1637                   ; PE:	A	0..5 Argumente	(0 = M003 ab Steckplatz 7 suchen)
 1638                   ;	L	Steckplatz	(0 = M021)
 1639                   ;	E	SIO-Kanal	(0..1 = A, 2 = B)
 1640                   ;	C	User-Kanal	(2 = UOUT1, 3 = UOUT2)
 1641                   ;	(ARG4)	ShCLR-Reaktion	(0 = keine, 1 = Protokoll, 2 = Hardcopy)
 1642                   ;	(ARG5)	Druckertyp	(0..12)
 1643                   ; PA:	D	Steckplatz M003	(nur gueltig fuer A = 0)
 1644                   ;	CY	Fehlerstatus	(0 = OK, 1 = Fehler)
 1645                   ; VR:	AF, BC, DE, HL
 1646                   ;
 1647 C8EF  67          LSTCA:	LD	H,A		; Anzahl Argumente
 1648 C8F0  3E 05       	LD	A,5
 1649 C8F2  BC          	CP	H		; (ARGN) <= 5?
 1650 C8F3  D8          	RET	C		; mehr als 5 Argumente!
 1651 C8F4  20 C1       	JR	NZ,LSTC1	; Druckertyp erhalten
 1652 C8F6  3A B78A     LSTC5:	LD	A,(ARG5)	; neuer Druckertyp
 1653 C8F9  FE 0D       	CP	13		; (ARG5) < 13?
 1654 C8FB  30 53       	JR	NC,IOERET
 1655 C8FD  87          	ADD	A,A		; 0 fuer Bit 3 einschieben
 1656 C8FE  57          LSTC6:	LD	D,A
 1657 C8FF  7C          	LD	A,H
 1658 C900  A7          	AND	A		; Steckplatz angegeben?
 1659 C901  28 CF       	JR	Z,LSTC3		; nein, M003 ab Steckplatz 7 suchen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  39
CC47    INC

 1660 C903  7D          	LD	A,L
 1661 C904  A7          	AND	A		; Steckplatz = 0?
 1662 C905  28 BA       	JR	Z,LSTC2		; M021
 1663 C907  C5          	PUSH	BC
 1664 C908  45          	LD	B,L
 1665 C909  0E 80       	LD	C,80h
 1666 C90B  ED 78       	IN	A,(C)
 1667 C90D  C1          	POP	BC
 1668 C90E  D6 EE       	SUB	0EEh		; M003?
 1669 C910  28 C2       	JR	Z,LSTC4
 1670 C912  3D          	DEC	A		; M001?
 1671 C913  20 3B       	JR	NZ,IOERET
 1672                   
 1673                   ; M001:
 1674 C915  CD C95C     	CALL	USRARG		; Steuerwort aus Argumenten bilden (CY war 0)
 1675 C918  C5          	PUSH	BC		; Adresse ShCLR-Reaktionsprogramm
 1676 C919  3E 02       	LD	A,2
 1677 C91B  16 01       	LD	D,1
 1678 C91D  CD C39C     	CALL	MODUC		; M001 einschalten
 1679 C920  21 D94D     	LD	HL,DIOINI
 1680 C923  CD CA0D     	CALL	IMEXDI		; PIO konfigurieren
 1681 C926  21 FA00     	LD	HL,M001PR
 1682 C929  22 B7EA     LSTC7:	LD	(OFILT + 1),HL
 1683 C92C  E1          	POP	HL
 1684 C92D  22 B799     	LD	(HCADR),HL	; ShCLR-Reaktionsprogramm setzen
 1685 C930  7B          	LD	A,E
 1686 C931  32 B7E1     	LD	(HCPZ),A	; Steuerbyte eintragen
 1687 C934  21 F9EF     	LD	HL,PRINT
 1688 C937  01 F4BF     	LD	BC,NOOP
 1689 C93A  A7          	AND	A		; CY = 0
 1690                   ;
 1691                   ; Eintragen der Sprungadressen eines I/O-Kanals:
 1692                   ;
 1693                   ; PE:	E = Steuerwort
 1694                   ;	BC = Sprungadresse fuer Eingabe
 1695                   ;	HL = Sprungadresse fuer Ausgabe
 1696                   ; PA:	-
 1697                   ; VR:	F
 1698                   ;
 1699 C93B  CB 4B       SETUIO:	BIT	1,E		; Ausgabekanal #2 oder #3?
 1700 C93D  20 08       	JR	NZ,SETU2
 1701 C93F  22 B7BE     	LD	(UOUT1+1),HL
 1702 C942  ED 43 B7C1  	LD	(UIN1+1),BC
 1703 C946  C9          	RET
 1704                   	;
 1705 C947  22 B7C4     SETU2:	LD	(UOUT2+1),HL
 1706 C94A  ED 43 B7C7  	LD	(UIN2+1),BC
 1707 C94E  C9          	RET
 1708                   
 1709 C94F  E1          IOEPOP:	POP	HL
 1710 C950  37          IOERET:	SCF
 1711 C951  C9          	RET
 1712                   
 1713                   ; Auswertung der Argumente 2..4 fuer I/O-Initialisierung:
 1714                   ;
 1715                   ; PE:	H	Argumentzahl
 1716                   ;	E	SIO-Kanal	(0..1 = A, 2 = B)
 1717                   ;	C	User-Kanal	(2 = UOUT1, 3 = UOUT2)
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  40
CC47    INC

 1718                   ;	(ARG4)	ShCLR-Reaktion
 1719                   ;	D	bisheriges Steuerwort
 1720                   ; PA:	E	Steuerwort	(3 neue Bits von rechts einrotiert)
 1721                   ;	BC	Adresse ShCLR-Reaktionsprogramm
 1722                   ;	CY	Fehlerstatus	(0 = OK, 1 = Fehler)
 1723                   ; VR:	AF, BC, DE, SP
 1724                   ;
 1725                   ; Stack-Unwinding: Im Fehlerfall wird die eigentliche Ruecksprungadresse vom
 1726                   ; Stack genommen, und dann ein RET ausgefuehrt.  Die aufrufende Routine darf
 1727                   ; keine Daten auf dem Stack zu liegen haben!
 1728                   ;
 1729 C952  3E 01       SIOARG:	LD	A,1
 1730 C954  BC          	CP	H		; mehr als 1 Argument?
 1731 C955  30 05       	JR	NC,USRARG	; nein, SIO-Kanal nicht angegeben
 1732 C957  1D          	DEC	E		; (ARG2): SIO-Kanal
 1733 C958  93          	SUB	E		; 1 <= (ARG2) <= 2?
 1734 C959  38 F4       	JR	C,IOEPOP
 1735 C95B  BB          	CP	E		; CY = 1 wenn K2
 1736 C95C  5A          USRARG:	LD	E,D		; bisheriges Steuerbyte
 1737 C95D  CB 13       	RL	E		; Bit 2 neu einschieben
 1738 C95F  3E 02       	LD	A,2
 1739 C961  57          	LD	D,A
 1740 C962  BC          	CP	H		; mehr als 2 Argumente?
 1741 C963  30 06       	JR	NC,NOARG3	; nein. I/O-Kanal nicht angegeben
 1742 C965  79          	LD	A,C		; (ARG3): User-I/O-Kanal
 1743 C966  92          	SUB	D
 1744 C967  BA          	CP	D		; 2 <= (ARG3) <= 3?
 1745 C968  30 E5       	JR	NC,IOEPOP
 1746 C96A  0F          	RRCA			; CY = 1 wenn User-Kanal #3
 1747 C96B  CB 13       NOARG3:	RL	E		; Bit 1 einschieben
 1748 C96D  01 F4BF     	LD	BC,NOOP
 1749 C970  14          	INC	D		; D = 3
 1750 C971  7A          	LD	A,D
 1751 C972  BC          	CP	H		; mehr als 3 Argumente?
 1752 C973  30 0D       	JR	NC,NOARG4	; nein, ShCLR-Reaktion nicht angegeben
 1753 C975  3A B788     	LD	A,(ARG4)	; Reaktion auf ShCLR
 1754 C978  A7          	AND	A		; (ARG4) = 0?
 1755 C979  28 07       	JR	Z,NOARG4
 1756 C97B  92          	SUB	D		; 0 <= (ARG4) <= 2?
 1757 C97C  30 D1       	JR	NC,IOEPOP
 1758 C97E  01 F9C2     	LD	BC,HCPGM
 1759 C981  0F          	RRCA			; CY = 1 wenn Hardcopy
 1760 C982  CB 13       NOARG4:	RL	E		; Bit 0 einschieben
 1761 C984  C9          	RET
 1762                   
 1763                   ; Initialisierung V.24-Duplexbetrieb:
 1764                   ;
 1765                   ; PE:	(ARGN)	0..3 Argumente	(0 = M003 ab Steckplatz 7 suchen)
 1766                   ;	(ARG1)	Steckplatz
 1767                   ;	(ARG2)	SIO-Kanal	(0..1 = A, 2 = B)
 1768                   ;	(ARG3)	User-Kanal	(2 = UOUT1, 3 = UOUT2)
 1769                   ; PA:	CY	Fehlerstatus	(0 = OK, 1 = Fehler)
 1770                   ; VR:	AF, BC, DE, HL
 1771                   ;
 1772 C985  CD F5FF     V24DC:	CALL	LARG		; Arg's laden
 1773 C988  67          	LD	H,A
 1774 C989  3E 03       	LD	A,3
 1775 C98B  BC          	CP	H		; (ARGN) <= 3?
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  41
CC47    INC

 1776 C98C  D8          	RET	C		; mehr als 3 Argumente -> Fehler
 1777 C98D  16 00       	LD	D,0		; Steuerwort zunaechst leer
 1778 C98F  CD C952     	CALL	SIOARG		; Steuerwort aus Argumenten 2-4 bilden
 1779 C992  E5          	PUSH	HL
 1780 C993  3A B7E7     	LD	A,(INTV2L)	; Laenge Duplexinitialisierung
 1781 C996  47          	LD	B,A
 1782 C997  2A B7E5     	LD	HL,(INTV2)	; Duplexinitialisierung
 1783 C99A  23          	INC	HL
 1784 C99B  18 17       	JR	V24DC5
 1785                   
 1786 C99D  3E 80       V24DC1:	LD	A,10000000b	; Empfangseinstellungen (7/8 Bit)
 1787 C99F  18 10       	JR	V24DC3
 1788                   
 1789 C9A1  7E          V24DC2:	LD	A,(HL)		; Initialisierungsdaten lesen
 1790 C9A2  E6 07       	AND	00000111b	; Registerauswahl?
 1791 C9A4  28 11       	JR	Z,V24DC6	; nein
 1792 C9A6  23          	INC	HL
 1793 C9A7  FE 03       	CP	3		; WR3?
 1794 C9A9  28 F2       	JR	Z,V24DC1
 1795 C9AB  FE 05       	CP	5		; WR5?
 1796 C9AD  20 05       	JR	NZ,V24DC5
 1797 C9AF  3E 68       	LD	A,01101000b	; Sendeeinstellungen (5-8 Bit, ein/aus)
 1798 C9B1  A6          V24DC3:	AND	(HL)		; benoetigte Bits abtrennen
 1799 C9B2  B3          	OR	E		; und in Steuerbyte einbauen
 1800 C9B3  5F          V24DC4:	LD	E,A
 1801 C9B4  05          V24DC5:	DEC	B
 1802 C9B5  28 98       	JR	Z,IOEPOP	; fehlendes Initialisierungsbyte
 1803 C9B7  23          V24DC6:	INC	HL
 1804 C9B8  10 E7       	DJNZ	V24DC2
 1805                   
 1806 C9BA  E1          	POP	HL
 1807 C9BB  7C          	LD	A,H
 1808 C9BC  06 07       	LD	B,7		; Suche ab Steckplatz 7
 1809 C9BE  A7          	AND	A		; Steckplatz angegeben?
 1810 C9BF  28 01       	JR	Z,V24DC7
 1811 C9C1  45          	LD	B,L		; angegebener Steckplatz
 1812 C9C2  CD C38A     V24DC7:	CALL	V24SU		; M003 suchen und einschalten
 1813 C9C5  D8          	RET	C		; Modul nicht gefunden
 1814 C9C6  21 FA41     	LD	HL,V24OT
 1815 C9C9  01 FA4C     	LD	BC,V24IN
 1816 C9CC  CD C93B     	CALL	SETUIO		; I/O-Sprungadressen eintragen
 1817 C9CF  3A B7E7     V24DC8:	LD	A,(INTV2L)
 1818 C9D2  47          	LD	B,A
 1819 C9D3  2A B7E5     	LD	HL,(INTV2)
 1820 C9D6  7B          	LD	A,E		; Duplex-Steuerbyte
 1821 C9D7  32 B7E8     	LD	(HCPZ2),A	; eintragen
 1822                   
 1823                   ; SIO-Initialisierung:
 1824                   ;
 1825                   ; PE:	HL	Initialisierungstabelle
 1826                   ;	B	Laenge der Tabelle (>= 3)
 1827                   ;	A	Steuerbyte
 1828                   ; PA:	CY = 0
 1829                   ; VR:	AF, BC, HL
 1830                   ;
 1831 C9DA  E6 04       INISIO:	AND	00000100b
 1832 C9DC  0F          	RRCA
 1833 C9DD  0F          	RRCA
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  42
CC47    INC

 1834 C9DE  C6 0C       	ADD	A,0Ch		; CTC-Port
 1835 C9E0  4F          	LD	C,A
 1836 C9E1  78          	LD	A,B
 1837 C9E2  06 02       	LD	B,2		; 2 Byte fuer CTC-Initialisierung
 1838 C9E4  90          	SUB	B
 1839 C9E5  F3          	DI
 1840 C9E6  ED B3       	OTIR			; CTC initialisieren
 1841 C9E8  47          	LD	B,A
 1842 C9E9  0D          	DEC	C		; SIO-Steuerport
 1843 C9EA  0D          	DEC	C
 1844 C9EB  ED B3       	OTIR			; SIO initialisieren
 1845 C9ED  FB          	EI
 1846 C9EE  A7          	AND	A		; CY = 0
 1847 C9EF  C9          	RET
 1848                   
 1849                   ; V.24-Modul initialisieren:
 1850                   ;	-Tabellen in IRM kopieren
 1851                   ;	-M003 suchen und einschalten
 1852                   ;	-M003-Steckplatz merken
 1853                   
 1854 C9F0  21 D824     V24INI:	LD	HL,V24TAB	; vorbereitete V24-Tabelle
 1855 C9F3  11 A800     	LD	DE,V24PL	; Steckplatz (A800H)
 1856 C9F6  01 0012     	LD	BC,V24UMT - V24TAB
 1857 C9F9  ED B0       	LDIR			; in IRM kopieren
 1858 C9FB  AF          	XOR	A
 1859 C9FC  CD C8EF     	CALL	LSTCA		; SIO-A: Druckerinitialisierung
 1860 C9FF  D8          	RET	C		; kein M003 gefunden
 1861 CA00  7A          	LD	A,D
 1862 CA01  32 A800     	LD	(V24PL),A	; Steckplatz eintragen
 1863 CA04  21 FA41     	LD	HL,V24OT	; Duplex-Ausgaberoutine
 1864 CA07  22 B7C4     	LD	(UOUT2 + 1),HL	; fuer User-Kanal #3 eintragen
 1865 CA0A  21 D836     	LD	HL,V24UMT	; SIO-B: Empfangs-Interrupt
 1866                   
 1867                   ; Initialisierung mehrerer Ports mit Sperren von Interrupts:
 1868                   ;
 1869                   ; PE:	HL	Initialisierungstabelle
 1870                   ;	(HL)	Anzahl der Kanaele
 1871                   ; PA:	-
 1872                   ; VR:	F, D, HL
 1873                   ;
 1874 CA0D  56          IMEXDI:	LD	D,(HL)		; Anzahl Kanaele
 1875 CA0E  23          	INC	HL
 1876 CA0F  C3 F561     	JP	INIME		; Ports initialisieren
 1877                   
 1878                   ; allgemeine Druckroutine
 1879                   
 1880 CA12  F5          PRINTC:	PUSH	AF
 1881 CA13  3A B7E1     	LD	A,(HCPZ)
 1882 CA16  CB 7F       	BIT	7,A
 1883 CA18  28 29       	JR	Z,PRINT3	; Drucker
 1884                   	;Schreibmaschine
 1885 CA1A  E6 F0       	AND	0F0H
 1886 CA1C  FE 90       	CP	90H
 1887 CA1E  28 17       	JR	Z,S6005
 1888 CA20  FE A0       	CP	0A0H
 1889 CA22  20 1F       	JR	NZ,PRINT3
 1890 CA24  F1          S6010:	POP	AF
 1891 CA25  E5          	PUSH	HL
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  43
CC47    INC

 1892 CA26  C5          	PUSH	BC
 1893 CA27  21 D975     	LD	HL,ZIBM
 1894 CA2A  01 0007     	LD	BC,7
 1895 CA2D  ED B1       	CPIR
 1896 CA2F  20 0F       	JR	NZ,PRINT1
 1897 CA31  0E 06       	LD	C,6
 1898 CA33  09          	ADD	HL,BC
 1899 CA34  7E          	LD	A,(HL)
 1900 CA35  18 09       	JR	PRINT1
 1901                   
 1902 CA37  F1          S6005:	POP	AF
 1903 CA38  FE 7E       	CP	7EH
 1904 CA3A  20 08       	JR	NZ,PRINT4
 1905 CA3C  3E 83       	LD	A,83H
 1906 CA3E  18 04       	JR	PRINT4
 1907 CA40  C1          PRINT1:	POP	BC
 1908 CA41  E1          	POP	HL
 1909 CA42  F5          	PUSH	AF
 1910 CA43  F1          PRINT3:	POP	AF
 1911 CA44  FE 09       PRINT4:	CP	9		; CUR
 1912 CA46  28 0D       	JR	Z,PRINT5
 1913 CA48  F5          	PUSH	AF
 1914 CA49  3A B7A2     	LD	A,(STBT)
 1915 CA4C  CB 5F       	BIT	3,A		; Steuerzeichen
 1916 CA4E  28 0E       	JR	Z,PRINT7	; ausfuehren
 1917 CA50  F1          	POP	AF
 1918 CA51  FE 7F       	CP	7FH		; und 7Fh
 1919 CA53  20 02       	JR	NZ,PRINT6
 1920 CA55  3E 20       PRINT5:	LD	A,20H		; nach SPC
 1921 CA57  FE 20       PRINT6:	CP	20H		; und Steuerzeichen
 1922 CA59  30 04       	JR	NC,PRINT8
 1923 CA5B  3E 5F       	LD	A,'_'		; nach '_' wandeln
 1924 CA5D  F5          	PUSH	AF
 1925 CA5E  F1          PRINT7:	POP	AF
 1926 CA5F  C3 B7E9     PRINT8:	JP	OFILT		; in IRM
 1927                   
 1928                   ; ShCLR-Reaktionsprogramm
 1929                   
 1930 CA62  E5          HCPGMC:	PUSH	HL
 1931 CA63  D5          	PUSH	DE
 1932 CA64  3A B7E1     	LD	A,(HCPZ)
 1933 CA67  CB 47       	BIT	0,A		; Hardcopy?
 1934 CA69  20 2E       	JR	NZ,COPIES
 1935                   
 1936                   ; Protokollfunktion
 1937                   
 1938 CA6B  2A B7B9     	LD	HL,(OUTAB)
 1939 CA6E  5F          	LD	E,A		; E = (HCPZ)
 1940 CA6F  7E          	LD	A,(HL)
 1941 CA70  A7          	AND	A		; CRT?
 1942 CA71  20 12       	JR	NZ,PROTO2
 1943 CA73  CB 4B       	BIT	1,E		; USER1/2?
 1944 CA75  21 F9EC     	LD	HL,ECHO		; CRT+PRINT
 1945 CA78  11 F00B     	LD	DE,ZEI3		; UP 03H = UOUT2
 1946 CA7B  20 12       	JR	NZ,PROTO3
 1947 CA7D  11 F008     	LD	DE,ZEI2		; UP 02H = UOUT1
 1948 CA80  22 B7BE     PROTO4:	LD	(UOUT1+1),HL
 1949 CA83  18 0D       	JR	PROTO5
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  44
CC47    INC

 1950                   	;
 1951 CA85  21 F9EF     PROTO2:	LD	HL,PRINT	; Protokoll deaktivieren
 1952 CA88  11 F005     	LD	DE,OUTT1	; UP 00H = CRT
 1953 CA8B  FE 02       	CP	2
 1954 CA8D  28 F1       	JR	Z,PROTO4
 1955 CA8F  22 B7C4     PROTO3:	LD	(UOUT2+1),HL	; Sprungadresse der Routine
 1956 CA92  ED 53 B7B9  PROTO5:	LD	(OUTAB),DE	; und Zeiger setzen
 1957 CA96  D1          	POP	DE
 1958 CA97  E1          	POP	HL
 1959 CA98  C9          	RET
 1960                   
 1961                   ; Hard- oder Screencopy
 1962                   
 1963 CA99  C5          COPIES:	PUSH	BC
 1964 CA9A  F5          	PUSH	AF
 1965 CA9B  E6 F0       	AND	0F0H
 1966 CA9D  F2 CAC4     	JP	P,HCOPYC	; Hardcopy
 1967                   
 1968                   ; Screencopy
 1969                   
 1970 CAA0  2A B7CB     	LD	HL,(VRAM)
 1971 CAA3  06 20       	LD	B,32
 1972 CAA5  0E 28       SCOPY1:	LD	C,40
 1973 CAA7  7E          SCOPY2:	LD	A,(HL)
 1974 CAA8  23          	INC	HL
 1975 CAA9  FE 20       	CP	20H
 1976 CAAB  30 02       	JR	NC,SCOPY4
 1977 CAAD  3E 20       	LD	A,' '		; statt Steuerzeichen
 1978 CAAF  CD F9EF     SCOPY4:	CALL	PRINT
 1979 CAB2  0D          	DEC	C		; 40 Spalten
 1980 CAB3  20 F2       	JR	NZ,SCOPY2
 1981 CAB5  3E 0D       	LD	A,CR
 1982 CAB7  CD CA44     	CALL	PRINT4
 1983 CABA  3E 0A       	LD	A,LF
 1984 CABC  CD CA44     	CALL	PRINT4
 1985 CABF  10 E4       	DJNZ	SCOPY1		; 32 Zeilen
 1986 CAC1  C3 E097     HCEND:	JP	POP4		; POP	AF,BC,DE,HL   RET
 1987                   
 1988 CAC4              HCOPYC:	;..nach Typ verzweigen
 1989 CAC4  E6 F0       	AND	0F0H
 1990 CAC6  FE 10       	CP	10H
 1991 CAC8  CA CB92     	JP	Z,K6314		; ESC/P breit
 1992 CACB  FE 20       	CP	20H
 1993 CACD  CA CBD0     	JP	Z,K6311		; mit ANSI
 1994 CAD0  FE 30       	CP	30H
 1995 CAD2  CA CBFE     	JP	Z,K6312		; ANSI breit
 1996 CAD5  FE 50       	CP	50H
 1997 CAD7  28 3B       	JR	Z,HCMIN		; ESC/P2 (Mini)
 1998 CAD9  FE 70       	CP	70H
 1999 CADB  28 67       	JR	Z,ESCP2		; ESC/P2 24 Nadel
 2000                   
 2001                   ; K6313, K6304, ESC/P2 mit 8 Nadeln
 2002                   
 2003 CADD  26 00       K6313:	LD	H,0		; Zeile 0
 2004 CADF  CD CC9D     K6313a:	CALL	PRZK		; Grafik init
 2005 CAE2  2E 00       	LD	L,0		; Spalte 0
 2006 CAE4  0E 08       K6313b:	LD	C,8		; 8 Nadeln
 2007 CAE6  CD CCC3     	CALL	CBYTES
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  45
CC47    INC

 2008 CAE9  E5          	PUSH	HL
 2009 CAEA  06 08       K6313c:	LD	B,8
 2010 CAEC  21 B700     	LD	HL,CASS
 2011 CAEF  CB 16       K6313d:	RL 	(HL)
 2012 CAF1  17          	RLA
 2013 CAF2  23          	INC	HL
 2014 CAF3  10 FA       	DJNZ	K6313d
 2015 CAF5  CD B7E9     	CALL	OFILT
 2016 CAF8  0D          	DEC	C
 2017 CAF9  20 EF       	JR	NZ,K6313c	; naechster Cursor
 2018 CAFB  E1          	POP	HL
 2019 CAFC  2C          	INC	L
 2020 CAFD  3E 28       	LD	A,40
 2021 CAFF  BD          	CP	L
 2022 CB00  20 E2       	JR	NZ,K6313b
 2023 CB02  7C          	LD	A,H
 2024 CB03  C6 08       	ADD	A,8		; naechste Zeile
 2025 CB05  67          	LD	H,A
 2026 CB06  30 D7       	JR	NC,K6313a
 2027 CB08  3E 0D       HCCRLF:	LD	A,CR
 2028 CB0A  CD B7E9     	CALL	OFILT
 2029 CB0D  3E 0A       	LD	A,LF
 2030 CB0F  CD B7E9     	CALL	OFILT
 2031 CB12  18 AD       	JR	HCEND
 2032                   
 2033                   ; ESC/P2 Miniformat
 2034                   
 2035 CB14  21 0000     HCMIN:	LD	HL,0		; Zeile=0, Spalte=0
 2036 CB17  CD CC9D     MINIa:	CALL	PRZK
 2037 CB1A  0E 18       MINIb:	LD	C,24		; 24 Pixel
 2038 CB1C  CD CCC3     	CALL	CBYTES
 2039 CB1F  CD CC7E     	CALL	S3PRS
 2040 CB22  20 F6       	JR	NZ,MINIb
 2041 CB24  7C          	LD	A,H
 2042 CB25  C6 18       	ADD	A,24
 2043 CB27  67          	LD	H,A
 2044 CB28  2E 00       	LD	L,0		; Spalte=0
 2045 CB2A  FE F0       	CP	240
 2046 CB2C  20 E9       	JR	NZ,MINIa
 2047 CB2E  CD CC9D     	CALL	PRZK
 2048 CB31  0E 10       MINIc:	LD	C,16
 2049 CB33  CD CCC3     	CALL	CBYTES
 2050 CB36  06 08       	LD	B,8
 2051 CB38  AF          	XOR	A
 2052 CB39  12          MINId:	LD	(DE),A		; 8 Nadeln frei
 2053 CB3A  13          	INC	DE
 2054 CB3B  10 FC       	DJNZ	MINId
 2055 CB3D  CD CC7E     	CALL	S3PRS
 2056 CB40  20 EF       	JR	NZ,MINIc
 2057 CB42  18 C4       	JR	HCCRLF
 2058                   
 2059                   ; ESC/P2 mit 24 Nadeln
 2060                   
 2061 CB44  26 00       ESCP2:	LD	H,0		; Zeile 0
 2062 CB46  CD CC9D     ESCP2a:	CALL	PRZK
 2063 CB49  2E 00       	LD	L,0		; Spalte 0
 2064 CB4B  06 08       ESCP2b:	LD	B,8		; 8 Pixel
 2065 CB4D  E5          	PUSH	HL
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  46
CC47    INC

 2066 CB4E  CD E04C     	CALL	PADR
 2067 CB51  11 B700     	LD	DE,CASS
 2068 CB54  7E          ESCP2c:	LD	A,(HL)
 2069 CB55  12          	LD	(DE),A
 2070 CB56  13          	INC	DE
 2071 CB57  12          	LD	(DE),A		; 3 mal ablegen
 2072 CB58  13          	INC	DE
 2073 CB59  12          	LD	(DE),A
 2074 CB5A  13          	INC	DE
 2075 CB5B  2C          	INC	L
 2076 CB5C  10 F6       	DJNZ	ESCP2c
 2077 CB5E  0E 08       	LD	C,8
 2078 CB60  06 18       ESCP2d:	LD	B,24		; 3*8 Bytes
 2079 CB62  21 B700     	LD	HL,CASS
 2080 CB65  CB 16       ESCP2e:	RL	(HL)
 2081 CB67  CB 13       	RL	E
 2082 CB69  CB 12       	RL	D
 2083 CB6B  17          	RLA
 2084 CB6C  23          	INC	HL
 2085 CB6D  10 F6       	DJNZ	ESCP2e		; Wandlung
 2086 CB6F  77          	LD	(HL),A
 2087 CB70  06 03       	LD	B,3		; 3 mal drucken
 2088 CB72  7E          ESCP2f:	LD	A,(HL)
 2089 CB73  CD B7E9     	CALL	OFILT		; 1.
 2090 CB76  7A          	LD	A,D
 2091 CB77  CD B7E9     	CALL	OFILT		; 2.
 2092 CB7A  7B          	LD	A,E
 2093 CB7B  CD B7E9     	CALL	OFILT		; 3. Byte
 2094 CB7E  10 F2       	DJNZ	ESCP2f
 2095 CB80  0D          	DEC	C
 2096 CB81  20 DD       	JR	NZ,ESCP2d
 2097 CB83  E1          	POP	HL
 2098 CB84  2C          	INC	L
 2099 CB85  3E 28       	LD	A,40		; Zeilenende?
 2100 CB87  BD          	CP	L
 2101 CB88  20 C1       	JR	NZ,ESCP2b
 2102 CB8A  7C          	LD	A,H
 2103 CB8B  C6 08       	ADD	A,8
 2104 CB8D  67          	LD	H,A
 2105 CB8E  30 B6       	JR	NC,ESCP2a
 2106 CB90  18 3B       	JR	JHCRLF
 2107                   
 2108                   ; ESC/P 9-Nadeln (breit)
 2109                   
 2110 CB92  26 00       K6314:	LD	H,0
 2111 CB94  CD CC9D     K6314a:	CALL	PRZK
 2112 CB97  2E 00       	LD	L,0
 2113 CB99  06 04       K6314b:	LD	B,4
 2114 CB9B  E5          	PUSH	HL
 2115 CB9C  CD E04C     	CALL	PADR
 2116 CB9F  11 B700     	LD	DE,CASS
 2117 CBA2  7E          K6314c:	LD	A,(HL)
 2118 CBA3  12          	LD	(DE),A
 2119 CBA4  13          	INC	DE
 2120 CBA5  12          	LD	(DE),A
 2121 CBA6  13          	INC	DE
 2122 CBA7  2C          	INC	L
 2123 CBA8  10 F8       	DJNZ	K6314c		; 4*
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  47
CC47    INC

 2124 CBAA  0E 08       	LD	C,8
 2125 CBAC  06 08       K6314d:	LD	B,8
 2126 CBAE  21 B700     	LD	HL,CASS
 2127 CBB1  CB 16       K6314e:	RL 	(HL)
 2128 CBB3  17          	RLA
 2129 CBB4  23          	INC	HL
 2130 CBB5  10 FA       	DJNZ	K6314e
 2131 CBB7  CD B7E9     	CALL	OFILT
 2132 CBBA  CD B7E9     	CALL	OFILT
 2133 CBBD  0D          	DEC	C
 2134 CBBE  20 EC       	JR	NZ,K6314d
 2135 CBC0  E1          	POP	HL
 2136 CBC1  2C          	INC	L
 2137 CBC2  3E 28       	LD	A,40
 2138 CBC4  BD          	CP	L
 2139 CBC5  20 D2       	JR	NZ,K6314b
 2140 CBC7  7C          	LD	A,H
 2141 CBC8  C6 04       	ADD	A,4
 2142 CBCA  67          	LD	H,A
 2143 CBCB  30 C7       	JR	NC,K6314a
 2144 CBCD  C3 CB08     JHCRLF:	JP	HCCRLF
 2145                   
 2146                   ; ANSI-Drucker
 2147                   
 2148 CBD0  CD CC9D     K6311:	CALL	PRZK
 2149 CBD3  06 2A       	LD	B,256/6
 2150 CBD5  21 0000     	LD	HL,0
 2151 CBD8  0E 06       K6311a:	LD	C,6
 2152 CBDA  CD CCC3     	CALL	CBYTES
 2153 CBDD  CD CC2A     	CALL	SPRS		; 6*8-Feld ausg.
 2154 CBE0  20 F6       	JR	NZ,K6311a
 2155 CBE2  3E 06       	LD	A,6		; 6 Pixel tiefer
 2156 CBE4  84          	ADD	A,H
 2157 CBE5  67          	LD	H,A
 2158 CBE6  2E 00       	LD	L,0
 2159 CBE8  CD CC9D     	CALL	PRZK
 2160 CBEB  05          	DEC	B
 2161 CBEC  20 EA       	JR	NZ,K6311a
 2162 CBEE  0E 04       K6311b:	LD	C,256 MOD 6	; den Rest
 2163 CBF0  CD CCC3     	CALL	CBYTES
 2164 CBF3  AF          	XOR	A
 2165 CBF4  12          	LD	(DE),A		; letzte beiden
 2166 CBF5  13          	INC	DE		; Zeilen leeren
 2167 CBF6  12          	LD	(DE),A
 2168 CBF7  CD CC2A     	CALL	SPRS
 2169 CBFA  20 F2       	JR	NZ,K6311b
 2170 CBFC  18 CF       	JR	JHCRLF
 2171                   
 2172                   ; ANSI breit
 2173                   
 2174 CBFE  CD CC9D     K6312:	CALL	PRZK
 2175 CC01  06 55       	LD	B,256/3
 2176 CC03  21 0000     	LD	HL,0
 2177 CC06  0E 03       K6312a:	LD	C,3
 2178 CC08  CD CCD1     	CALL	CBYTS2
 2179 CC0B  CD CC53     	CALL	S2PRS
 2180 CC0E  20 F6       	JR	NZ,K6312a
 2181 CC10  24          	INC	H
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  48
CC47    INC

 2182 CC11  24          	INC	H
 2183 CC12  24          	INC	H
 2184 CC13  2E 00       	LD	L,0
 2185 CC15  CD CC9D     	CALL	PRZK
 2186 CC18  10 EC       	DJNZ	K6312a
 2187 CC1A  0E 04       K6312b:	LD	C,256 MOD 6	; den Rest
 2188 CC1C  CD CCD1     	CALL	CBYTS2
 2189 CC1F  AF          	XOR	A
 2190 CC20  12          	LD	(DE),A
 2191 CC21  13          	INC	DE
 2192 CC22  12          	LD	(DE),A
 2193 CC23  CD CC53     	CALL	S2PRS
 2194 CC26  20 F2       	JR	NZ,K6312b
 2195 CC28  18 A3       	JR	JHCRLF
 2196                   
 2197                   ; 8* 6-Nadel-Sprosse ausgeben
 2198                   
 2199 CC2A  E5          SPRS:	PUSH	HL
 2200 CC2B  C5          	PUSH	BC
 2201 CC2C  2E 80       	LD	L,80H
 2202 CC2E  06 00       SPRS1:	LD	B,0
 2203 CC30  11 B700     	LD	DE,CASS
 2204 CC33  1A          SPRS2:	LD	A,(DE)
 2205 CC34  A5          	AND	L		; CY=0
 2206 CC35  28 01       	JR	Z,SPRS3
 2207 CC37  37          	SCF			; CY=1
 2208 CC38  CB 10       SPRS3:	RL 	B
 2209 CC3A  13          	INC	DE
 2210 CC3B  3E 06       	LD	A,6		; fuer 6 Bit
 2211 CC3D  BB          	CP	E
 2212 CC3E  20 F3       	JR	NZ,SPRS2	; ob. Nadel war 0
 2213 CC40  A7          	AND	A		; unt. Nadel = 0
 2214 CC41  CB 10       	RL 	B
 2215 CC43  78          	LD	A,B
 2216 CC44  CD B7E9     	CALL	OFILT
 2217 CC47  CB 0D       	RRC	L
 2218 CC49  F2 CC2E     	JP	P,SPRS1
 2219 CC4C  C1          	POP	BC
 2220 CC4D  E1          	POP	HL
 2221 CC4E  2C          	INC	L
 2222 CC4F  3E 28       	LD	A,40
 2223 CC51  BD          	CP	L
 2224 CC52  C9          	RET
 2225                   
 2226                   ; 8* 6-Nadel-Sprosse doppelt out
 2227                   
 2228 CC53  E5          S2PRS:	PUSH	HL
 2229 CC54  C5          	PUSH	BC
 2230 CC55  2E 80       	LD	L,80H
 2231 CC57  06 00       S2PR1:	LD	B,0
 2232 CC59  11 B700     	LD	DE,CASS		; Kassetten-Puffer
 2233 CC5C  1A          S2PR2:	LD	A,(DE)
 2234 CC5D  A5          	AND	L
 2235 CC5E  28 01       	JR	Z,S2PR3
 2236 CC60  37          	SCF
 2237 CC61  CB 10       S2PR3:	RL 	B
 2238 CC63  13          	INC	DE
 2239 CC64  3E 06       	LD	A,6
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  49
CC47    INC

 2240 CC66  BB          	CP	E
 2241 CC67  20 F3       	JR	NZ,S2PR2
 2242 CC69  78          	LD	A,B
 2243 CC6A  17          	RLA			; untere beiden
 2244 CC6B  17          	RLA			; Nadeln tot
 2245 CC6C  CD B7E9     	CALL	OFILT
 2246 CC6F  CD B7E9     	CALL	OFILT
 2247 CC72  CB 0D       	RRC	L
 2248 CC74  F2 CC57     	JP	P,S2PR1
 2249 CC77  C1          	POP	BC
 2250 CC78  E1          	POP	HL
 2251 CC79  2C          	INC	L
 2252 CC7A  3E 28       	LD	A,40
 2253 CC7C  BD          	CP	L
 2254 CC7D  C9          	RET
 2255                   
 2256                   ; 8* 24-Nadel-Sprosse ausgeben
 2257                   
 2258 CC7E  E5          S3PRS:	PUSH	HL
 2259 CC7F  1E 08       	LD	E,8
 2260 CC81  0E 03       S3PR1:	LD	C,3		; 24 Nadeln = 3 Byte
 2261 CC83  21 B700     	LD	HL,CASS
 2262 CC86  06 08       S3PR2:	LD	B,8
 2263 CC88  CB 16       S3PR3:	RL	(HL)
 2264 CC8A  17          	RLA
 2265 CC8B  23          	INC	HL
 2266 CC8C  10 FA       	DJNZ	S3PR3		; Wandlung
 2267 CC8E  CD B7E9     	CALL	OFILT
 2268 CC91  0D          	DEC	C
 2269 CC92  20 F2       	JR	NZ,S3PR2
 2270 CC94  1D          	DEC	E
 2271 CC95  20 EA       	JR	NZ,S3PR1
 2272 CC97  E1           	POP	HL
 2273 CC98  2C          	INC	L
 2274 CC99  3E 28       	LD	A,40
 2275 CC9B  BD          	CP	L
 2276 CC9C  C9          	RET
 2277                   
 2278                   ; Druckerinitialisierung entsprechend HCPZ
 2279                   
 2280 CC9D  E5          PRZK:	PUSH	HL
 2281 CC9E  C5          	PUSH	BC
 2282 CC9F  AF          	XOR	A
 2283 CCA0  21 B7E1     	LD	HL,HCPZ
 2284 CCA3  ED 6F       	RLD
 2285 CCA5  4F          	LD	C,A		; Druckertyp
 2286 CCA6  ED 67       	RRD
 2287 CCA8  0C          	INC	C
 2288 CCA9  21 D7C5     	LD	HL,C6313
 2289 CCAC  46          PRZK1:	LD	B,(HL)		; Laenge
 2290 CCAD  0D          	DEC	C
 2291 CCAE  28 09       	JR	Z,PRZK2
 2292 CCB0  04          	INC	B
 2293 CCB1  7D          	LD	A,L
 2294 CCB2  80          	ADD	A,B
 2295 CCB3  6F          	LD	L,A
 2296 CCB4  30 F6       	JR	NC,PRZK1
 2297 CCB6  24          	INC	H
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  50
CC47    INC

 2298 CCB7  18 F3       	JR	PRZK1
 2299 CCB9  23          PRZK2:	INC	HL
 2300 CCBA  7E          	LD	A,(HL)
 2301 CCBB  CD B7E9     	CALL	OFILT
 2302 CCBE  10 F9       	DJNZ	PRZK2
 2303 CCC0  C1          POP2:	POP	BC
 2304 CCC1  E1          	POP	HL
 2305 CCC2  C9          	RET
 2306                   
 2307                   ; C Bytes zum Puffer
 2308                   
 2309 CCC3  E5          CBYTES:	PUSH	HL
 2310 CCC4  C5          	PUSH	BC
 2311 CCC5  CD E04C     	CALL	PADR
 2312 CCC8  11 B700     	LD	DE,CASS
 2313 CCCB  06 00       	LD	B,0
 2314 CCCD  ED B0       	LDIR
 2315 CCCF  18 EF       	JR	POP2	; POP BC, HL	RET
 2316                   
 2317                   ; C Bytes zum Puffer & doppeln
 2318                   
 2319 CCD1  E5          CBYTS2:	PUSH	HL
 2320 CCD2  CD E04C     	CALL	PADR
 2321 CCD5  11 B700     	LD	DE,CASS
 2322 CCD8  7E          C2BYTL:	LD	A,(HL)
 2323 CCD9  12          	LD	(DE),A
 2324 CCDA  13          	INC	DE
 2325 CCDB  12          	LD	(DE),A
 2326 CCDC  13          	INC	DE
 2327 CCDD  2C          	INC	L
 2328 CCDE  0D          	DEC	C
 2329 CCDF  20 F7       	JR	NZ,C2BYTL
 2330 CCE1  E1          	POP	HL
 2331 CCE2  C9          	RET
 2332                   
 2333                   ; Byteausgabe von Datentraeger (BASIC-Schnittstelle)	**38**
 2334                   
 2335                   ; Zunaechst Puffer fuellen und nur wenn Puffer voll ist in die
 2336                   ; MBOUT-Routine(n) des eingestellten Treibers springen
 2337                   
 2338                   ; PE:	A	Datenbyte
 2339                   ;	D	Steuerbyte
 2340                   ;		Bit 3 = 1 INIT (Block 01)
 2341                   ;		Bit 6 = 1 Close (Block FF)
 2342                   ;	HL	Name nur bei INIT (Adresszeiger 11 Byte)
 2343                   ; PA:	CY=1	Fehler
 2344                   ; VR:	AF,DE,HL
 2345                   ;
 2346 CCE3  5A          MBOC:	LD	E,D		; Steuerbyte
 2347 CCE4  57          	LD	D,A		; Datenbyte
 2348 CCE5  D5          	PUSH	DE
 2349 CCE6  C5          	PUSH	BC
 2350 CCE7  CB 5B       	BIT	3,E		; Init?
 2351 CCE9  28 32       	JR	Z,NOINIT
 2352 CCEB  DD CB 07 CE 	SET	1,(IX+7)	; INIT merken
 2353 CCEF  3E D5       	LD	A,'U'+80H
 2354 CCF1  BE          	CP	(HL)		; List-Ausgabe?
 2355 CCF2  D5          	PUSH	DE
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  51
CC47    INC

 2356 CCF3  11 00A0     	LD	DE,160		; kurze Vortonlaenge normal
 2357 CCF6  20 03       	JR	NZ,NOHIU
 2358 CCF8  11 0500     	LD	DE,1280		; bei 'U' gedehnt
 2359         0000      if turbo
 2364                   endif
 2365 CCFB  ED 53 B7D8  NOHIU:	LD	(VORTN),DE
 2366 CCFF  CD D78A     	CALL	BNAME		; Dateiname konvertieren/merken fuer ISRO
 2367 CD02  11 B700     	LD	DE,CASS		; Kassettenpuffer
 2368 CD05  CD ED97     	CALL	DEV1		; Kassette?
 2369 CD08  20 05       	JR	NZ,MBONN	; nein
 2370 CD0A  01 000B     	LD	BC,11		; Laenge Dateiname + Typ
 2371 CD0D  ED B0       	LDIR			; bei TAPE zunaechst mit Name fuellen
 2372 CD0F  EB          MBONN:	EX	DE,HL		; HL jetzt Zeiger in Puffer
 2373 CD10  D1          	POP	DE
 2374 CD11  72          	LD	(HL),D		; 1. Datenbyte eintragen
 2375 CD12  2C          	INC	L
 2376 CD13  7D          MBOC1:	LD	A,L
 2377 CD14  32 B7DA     MBOC0:	LD	(DTPTR),A	; Zeiger neu setzen
 2378 CD17  A7          MBOCE:	AND	A		; CY=0 / kein Fehler (zusaetzlich ab CAOS 4.7)
 2379 CD18  C1          MBCERR:	POP	BC
 2380 CD19  D1          	POP	DE
 2381 CD1A  CB 9B       	RES	3,E		; Init zuruecksetzen
 2382 CD1C  C9          	RET
 2383                   	;
 2384 CD1D  2A B7DA     NOINIT:	LD	HL,(DTPTR)	; Zeiger holen
 2385 CD20  26 B7       	LD	H,High(CASS)	; und mit Kassettenpuffer verbinden
 2386 CD22  72          	LD	(HL),D		; Datenbyte eintragen
 2387 CD23  CB 73       	BIT	6,E		; Close?
 2388 CD25  20 26       	JR	NZ,MCLOS	; letzten Block schreiben
 2389 CD27  2C          	INC	L		; Zeiger auf naechstes Byte
 2390 CD28  F2 CD13     	JP	P,MBOC1		; Puffer noch nicht voll
 2391 CD2B  DD CB 07 4E 	BIT	1,(IX+7)	; steht INIT noch aus?
 2392 CD2F  20 08       	JR	NZ,MBOC2	; ja, dann erst einmal den Vorblock ausgeben!
 2393 CD31  CD CE5E     	CALL	MBLO		; Datenblock ausgeben
 2394 CD34  38 E2       	JR	C,MBCERR	; BRK oder Fehler -> IO-Error
 2395 CD36  AF          MBOC6:	XOR	A		; Zeiger auf Puffer-Anfang
 2396 CD37  18 DB       	JR	MBOC0
 2397                   	;
 2398 CD39  DD CB 07 8E MBOC2:	RES	1,(IX+7)	; INIT ruecksetzen
 2399 CD3D  21 B7F5     	LD	HL,FNAME	; Dateiname fuer Ausgabe
 2400 CD40  CD E4C9     	CALL	PV7
 2401 CD43  02          	DB	2		; Vorblock ausgeben mit ISRO
 2402 CD44  38 D2       	JR	C,MBCERR	; Fehler
 2403 CD46  CD CE6A     	CALL	MBLNR		; Blocknummer anzeigen, BRK-Test
 2404 CD49  38 CD       	JR	C,MBCERR	; BRK
 2405 CD4B  18 E9       	JR	MBOC6		; Zeiger auf leeren Puffer stellen
 2406                   	;
 2407 CD4D  DD CB 07 4E MCLOS:	BIT	1,(IX+7)	; steht noch INIT aus?
 2408 CD51  28 09       	JR	Z,MBOC3		; nein, nur noch der Endeblock
 2409 CD53  21 B7F5     	LD	HL,FNAME	; Dateiname fuer Ausgabe
 2410 CD56  CD E4C9     	CALL	PV7
 2411 CD59  02          	DB	2		; sonst erst noch ISRO ausfuehren
 2412 CD5A  18 04       	JR	MBOC4		; und danach sofort Close
 2413                   	;
 2414 CD5C  CD CE5E     MBOC3:	CALL	MBLO		; Datenblock ausgeben
 2415 CD5F  D8          	RET	C		; BRK oder Fehler
 2416 CD60  ED 4B B7D8  MBOC4:	LD	BC,(VORTN)
 2417 CD64  CD E4C9     	CALL	PV7
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  52
CC47    INC

 2418 CD67  03          	DB	3		; Endeblock ausgeben mit CSRO
 2419 CD68  F5          	PUSH	AF		; CY=1 bei Fehler
 2420 CD69  CD F4DB     	CALL	CRLF
 2421 CD6C  F1          	POP	AF		; Fehlerflag
 2422 CD6D  18 A9       	JR	MBCERR		; fertig
 2423                   ;
 2424 CD6F  CD E4C9     MBICL:	CALL	PV7
 2425 CD72  05          	DB	5		; Dateieingabe stoppen mit CSRI
 2426 CD73  DD CB 07 AE 	RES	5,(IX+7)	; 'U'-Merker ruecksetzen
 2427 CD77  18 9F       MBICE:	JR	MBCERR		; fertig
 2428                   
 2429                   ; Byteeingabe von Datenraeger (BASIC-Schnittstelle)	**37**
 2430                   
 2431                   ; Zunaechst Daten aus Puffer entnehmen und nur wenn Puffer leer ist in die
 2432                   ; MBIN-Routine(n) des eingestellten Treibers springen
 2433                   
 2434                   ; PE:	D	Steuerbyte
 2435                   ;		Bit 3 = 1 INIT (Block 01)
 2436                   ;		Bit 6 = 1 Close (Block FF)
 2437                   ;	HL	Name nur bei INIT (Adresszeiger 11 Byte)
 2438                   ; PA:	A	Datenbyte
 2439                   ;	CY=1	Fehler
 2440                   ; VR:	AF, DE, HL
 2441                   ;
 2442 CD79  5A          MBIC:	LD	E,D		; Steuerbyte
 2443                   ;	LD	D,A		; Datenbyte (PA!)
 2444 CD7A  D5          	PUSH	DE
 2445 CD7B  C5          	PUSH	BC
 2446 CD7C  CB 73       	BIT	6,E		; Close?
 2447 CD7E  20 EF       	JR	NZ,MBICL	; ja, Bandeingabe stoppen
 2448 CD80  CB 5B       	BIT	3,E		; Init?
 2449 CD82  28 67       	JR	Z,MBIU		; nein, Datenbyte holen
 2450 CD84  E5          	PUSH	HL
 2451 CD85  CD D78A     	CALL	BNAME		; Dateiname konvertieren/merken fuer ISRI
 2452 CD88  21 B7F5     	LD	HL,FNAME	; konvertierter Dateiname
 2453 CD8B  CD E4C9     	CALL	PV7
 2454 CD8E  04          	DB	4		; Block 01h einlesen mit ISRI
 2455 CD8F  E1          MBIC1:	POP	HL
 2456 CD90  DA CE46     MBIC2:	JP	C,JBLERR	; Fehler: '*'
 2457 CD93  DD 7E 02    	LD	A,(IX+2)	; gelesener Block
 2458 CD96  FE 01       	CP	1
 2459 CD98  C2 CE46     	JP	NZ,JBLERR	; Fehler: '*'
 2460 CD9B  DD CB 07 BE 	RES	7,(IX+7)	; Kopfblock geladen
 2461 CD9F  DD 34 03    	INC	(IX+3)		; naechster erwarteter Block
 2462 CDA2  11 B700     	LD	DE,CASS		; Daten stehen jetzt im Kassettenpuffer
 2463 CDA5  CD ED97     	CALL	DEV1		; Kassette?
 2464 CDA8  20 36       	JR	NZ,MBINN	; nein
 2465 CDAA  06 0B       	LD	B,11		; Laenge des Dateinamens bei Tape im Kassettenpuffer
 2466 CDAC  1A          	LD	A,(DE)		; vorangestellter Dateityp: 1. Zeichen testen
 2467 CDAD  FE D5       	CP	'U'+80H		; hohes 'U'?
 2468 CDAF  20 04       	JR	NZ,MBIC3
 2469 CDB1  DD CB 07 EE 	SET	5,(IX+7)	; merken zur Blocknummernausgabeunterdrueckung
 2470 CDB5  C6 29       MBIC3:	ADD	A,29H
 2471 CDB7  30 0D       	JR	NC,MBIC4
 2472 CDB9  1A          	LD	A,(DE)		; geschuetzte BASIC-Programme
 2473 CDBA  D6 04       	SUB	4		; als ungeschuetzt anzeigen
 2474 CDBC  12          	LD	(DE),A		; 1. Zeichen vom Dateityp
 2475 CDBD  13          	INC	DE
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  53
CC47    INC

 2476 CDBE  12          	LD	(DE),A		; 2. Zeichen vom Dateityp
 2477 CDBF  13          	INC	DE
 2478 CDC0  12          	LD	(DE),A		; 3. Zeichen vom Dateityp
 2479 CDC1  32 035E     	LD	(DATFLG),A	; <=hier LIST/EDIT/BYE-Schutz setzen
 2480                   ;	SET	6,(IX+7)	; Das war ein RESET-Schutz bei CAOS 3.1
 2481 CDC4  1B          	DEC	DE
 2482 CDC5  1B          	DEC	DE		; DE wieder auf Anfang Kassettenpuffer
 2483 CDC6  1A          MBIC4:	LD	A,(DE)		; Name aus Kassettenpuffer
 2484 CDC7  CD E08C     	CALL	CRT		; anzeigen
 2485 CDCA  BE          	CP	(HL)		; stimmt Name?
 2486 CDCB  28 04       	JR	Z,MBIC5
 2487 CDCD  DD CB 07 FE 	SET	7,(IX+7)	; nein-merken
 2488 CDD1  23          MBIC5:	INC	HL
 2489 CDD2  13          	INC	DE
 2490 CDD3  10 F1       	DJNZ	MBIC4
 2491 CDD5  CD F4DB     	CALL	CRLF
 2492 CDD8  DD CB 07 7E 	BIT	7,(IX+7)	; war der Name korrekt?
 2493 CDDC  37          	SCF			; Fehlerflag
 2494 CDDD  C2 CD18     	JP	NZ,MBCERR	; Name falsch -> ?IO ERROR
 2495 CDE0  EB          MBINN:	EX	DE,HL
 2496 CDE1  56          MBIC6:	LD	D,(HL)		; Datenbyte aus Kassettenpuffer entnehmen
 2497 CDE2  2C          	INC	L		; Zeiger auf naechstes Byte
 2498 CDE3  7D          	LD	A,L
 2499 CDE4  32 B7DA     	LD	(DTPTR),A	; Zeiger neu setzen
 2500 CDE7  7A          	LD	A,D		; Datenbyte in A bereitstellen
 2501 CDE8  C3 CD17     	JP	MBOCE		; fertig
 2502                   
 2503                   ; Datenbyte holen
 2504                   
 2505 CDEB  2A B7DA     MBIU:	LD	HL,(DTPTR)	; Zeiger
 2506 CDEE  26 B7       	LD	H,HIGH(CASS)	; in Kassettenpuffer
 2507 CDF0  CB 7D       	BIT	7,L		; Pufferende erreicht?
 2508 CDF2  28 ED       	JR	Z,MBIC6		; Daten aus Puffer entnehmen
 2509 CDF4  CD E4C9     MBIU1:	CALL	PV7
 2510 CDF7  01          	DB	1		; einen Block lesen mit MBI
 2511 CDF8  38 36       	JR	C,MERR		; Lesefehler
 2512 CDFA  3E FF       	LD	A,0FFH
 2513 CDFC  DD BE 02    	CP	(IX+2)		; Block FF?
 2514 CDFF  28 1A       	JR	Z,MBIU3		; FF immer als korrekt durchgehen lassen
 2515 CE01  DD 7E 03    	LD	A,(IX+3)
 2516 CE04  DD BE 02    	CP	(IX+2)		; erwarteter Block?
 2517 CE07  28 12       	JR	Z,MBIU3		; ja, stimmt!
 2518 CE09  3E 2A       	LD	A,'*'
 2519 CE0B  CD E08C     	CALL	CRT		; nicht erwarteter Block
 2520 CE0E  CD F0C9     	CALL	BNROST		; Blocknummer anzeigen
 2521 CE11  19 00       	DB	19H,0
 2522 CE13  CD E37C     MBIU2:	CALL	BRKT		; Abbruch mit BRK?
 2523 CE16  30 DC       	JR	NC,MBIU1	; weiter versuchen
 2524 CE18  C3 CD18     JMBERR:	JP	MBCERR		; BRK => IO-ERROR
 2525                   	;
 2526 CE1B  DD 34 03    MBIU3:	INC	(IX+3)		; naechsten Block erwarten
 2527 CE1E  3D          	DEC	A
 2528 CE1F  DD CB 07 6E 	BIT	5,(IX+7)	; Blocknummer unterdruecken?
 2529 CE23  20 06       	JR	NZ,MBIU4	; ja
 2530 CE25  CD F0C9     	CALL	BNROST		; ansonsten Blocknummer ausgeben
 2531 CE28  3E 19 00    	DB	'>',19H,0	; ein ">" anhaengen und zum Zeilenanfang
 2532 CE2B  21 B700     MBIU4:	LD	HL,CASS		; Pufferbeginn
 2533 CE2E  18 B1       	JR	MBIC6		; jetzt Datenbyte entnehmen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  54
CC47    INC

 2534                   	;
 2535 CE30  CD ED97     MERR:	CALL	DEV1		; Kassette?
 2536 CE33  20 14       	JR	NZ,JBLE1	; nein, Abbruch bei anderen Devices
 2537 CE35  CD F0CF     	CALL	OSTR
 2538 CE38  09 09 09 09 	DB	9,9,9,9,'?',0	; Fehler im Block
 2539 CE3E  CD F0C9     	CALL	BNROST		; mit Blocknummer anzeigen
 2540 CE41  0D 0A 00    	DB	CR,LF,0
 2541 CE44  18 CD       	JR	MBIU2		; BRK testen, sonst weiter versuchen
 2542                   	;
 2543 CE46  CD ED97     JBLERR:	CALL	DEV1		; Kassette?
 2544 CE49  37          JBLE1:	SCF			; Fehlerkennung
 2545 CE4A  20 CC       	JR	NZ,JMBERR	; Abbruch wenn nicht Kassette
 2546 CE4C  CD F0CF     	CALL	OSTR
 2547 CE4F  2A 08 00    	DB	'*',8,0		; nicht erwarteter 1. Block
 2548 CE52  CD E37C     	CALL	BRKT
 2549 CE55  38 C1       	JR	C,JMBERR	; BRK => IO-ERROR
 2550 CE57  CD E4C9     	CALL	PV7
 2551 CE5A  01          	DB	1		; Block erneut lesen mit MBI
 2552 CE5B  C3 CD90     	JP	MBIC2
 2553                   
 2554                   ; Datenblock ausgeben innerhalb der Byte-Routinen
 2555                   ; PA:	CY=1	Fehler
 2556                   
 2557 CE5E  ED 4B B7D8  MBLO:	LD	BC,(VORTN)	; Vortonlaenge
 2558 CE62  CD E4C9     	CALL	PV7
 2559 CE65  00          	DB	0		; Block ausgeben mit MBO
 2560 CE66  D8          	RET	C		; Fehler
 2561 CE67  CD E4C0     	CALL	CLC		; Puffer loeschen fuer naechsten Block
 2562 CE6A  CD F0C9     MBLNR:	CALL	BNROST		; Blocknummer anzeigen
 2563 CE6D  19 00       	DB	19H,0		; zum Zeilenanfang
 2564 CE6F  C3 E37C     	JP	BRKT		; falls BRK, dann CY=1 => IO-ERROR
 2565                   
 2566                   ; Tabelle der Modulnamen:
 2567                   
 2568 CE72  00 56 41 52 MTAB:	DB	000h,'VARIABEL',0	; M042 (Tim Henning)
 2569 CE7C  01 53 54 41 	DB	001H,'START-ROM',0	; M033 Typestar
 2570 CE87  70 33 32 4B 	DB	070H,'32K EPROM',0	; M045
 2571 CE92  71 36 34 4B 	DB	071H,'64K EPROM',0	; M046
 2572 CE9D  72 31 32 38 	DB	072H,'128K EPROM',0	; M047
 2573 CEA9  73 32 35 36 	DB	073H,'256K EPROM',0	; M048
 2574                   ;	DB	074H,'512K EPROM',0	; M049 reserviert!
 2575                   ;	DB	075H,'1M EPROM',0	; M050 reserviert!
 2576 CEB5  77 36 34 4B 	DB	077H,'64K RAM',0	; M032 - 64k-Variante
 2577 CEBE  78 31 32 38 	DB	078H,'128K RAM',0	; M036
 2578 CEC8  79 32 35 36 	DB	079H,'256K RAM',0	; M032 - 256k-Variante
 2579 CED2  7A 35 31 32 	DB	07AH,'512K RAM',0	; M034
 2580 CEDC  7B 31 4D 20 	DB	07BH,'1M RAM',0		; M035, M035x4
 2581                   ;	DB	07CH,'32K EEPROM',0	; reserviert!
 2582                   ;	DB	07DH,'64K EEPROM',0	; reserviert!
 2583                   ;	DB	07EH,'128K EEPROM',0	; reserviert!
 2584                   ;	DB	07FH,'256K EEPROM',0	; reserviert!
 2585 CEE4  A7 46 4C 4F 	DB	0A7H,'FLOPPY',0		; D004, D008
 2586                   ;	DB	0D8h,'A/D&I2C',0	; M054 (reserviert fuer Thomas Schramm)
 2587 CEEC  D9 45 50 52 	DB	0D9H,'EPROMMER 32K',0	; M030 (fuer 2k-32k EPROMs)
 2588 CEFA  DA 50 49 4F 	DB	0DAH,'PIO-3',0		; M002
 2589 CF01  DB 45 50 52 	DB	0DBH,'EPROMMER 64K',0	; M030 (fuer 1k-64k EPROMs)
 2590 CF0F  DC 53 4F 55 	DB	0DCH,'SOUND',0		; M066 (Soundmodul, Rene Nitzsche)
 2591 CF16  E3 44 41 55 	DB	0E3H,'DAU1',0		; M029
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  55
CC47    INC

 2592 CF1C  E7 41 44 55 	DB	0E7H,'ADU1',0		; M010
 2593 CF22  EC 53 43 41 	DB	0ECH,'SCANNER',0	; M051 (KC-Club)
 2594 CF2B  EE 56 2E 32 	DB	0EEH,'V.24',0		; M003, M053
 2595 CF31  EF 44 49 47 	DB	0EFH,'DIGITAL I/O',0	; M001
 2596 CF3E  F0 38 4B 20 	DB	0F0H,'8K CMOS-RAM',0	; M120
 2597 CF4B  F1 31 36 4B 	DB	0F1H,'16K CMOS-RAM',0	; M122
 2598 CF59  F2 33 32 4B 	DB	0F2H,'32K CMOS-RAM',0	; M124
 2599                   ;	DB	0F3H,'8*8K EPROM',0	; M062-RAM/ROM       (Sonderbehandlung!)
 2600 CF67  F4 31 36 4B 	DB	0F4H,'16K RAM',0	; M022
 2601 CF70  F5 33 32 4B 	DB	0F5H,'32K RAM',0	; M024
 2602 CF79  F6 36 34 4B 	DB	0F6H,'64K RAM',0	; M011
 2603 CF82  F7 38 4B 20 	DB	0F7H,'8K ROM',0		; M025, M040
 2604 CF8A  F8 31 36 4B 	DB	0F8H,'16K ROM',0	; M028, M040, M041
 2605 CF93  F9 47 49 44 	DB	0F9H,'GIDE',0		; M064 (Mario Leubner, 2016)
 2606                   ;	DB	0FBH,'8K SOFTWARE',0	; M012, M026, M027   (Sonderbehandlung!)
 2607 CF99  FC 42 41 53 	DB	0FCH,'BASIC',0		; M006
 2608                   ;	DB	0FDH,'USB+NET',0	; M052               (Sonderbehandlung!)
 2609 CFA0  FF 3F 3F 3F 	DB	0FFH,'???',0		; unbekanntes Modul
 2610 CFA5  53 4F 46 54 MTAB1:	DB	'SOFTWARE'		; Standardanzeige falls ohne Menuewort
 2611 CFAD  00          MTAB2:	DB	0
 2612                   
 2613 CFAE  55 53 45 52 MUSER:	DB	'USER',0		; M005 (USER-Module C0-D7)
 2614                   	;
 2615 CFB3  4E 45 54 2B M052A:	DB	'NET+'			; M052 (USB+Netzwerk, 32K EEPROM 4 * 8K)
 2616 CFB7  55 53 42 00 M052B:	DB	'USB',0			; M052 (nur USB, 8K EEPROM)
 2617                   	;
 2618 CFBB  34 2A 38 4B M062A:	DB	'4*8K RAM',0		; M062-RAM (E. Mueller)
 2619 CFC4  38 2A 38 4B M062B:	DB	'8*8K EPROM',0		; M062-ROM (E. Mueller)
 2620                   
 2621                   	ABSFILL	0D000h,<ROM-C-Ende>
    7 CFCF  FF FF FF FF 	  DS	0D000h - $,0FFh
  192                   
  193                   	INCLUDE	CD47.INC	; ROM-D (D000-DAB7)
    1                   ;*****************************************
    2                   ;**	CAOS 4.7	ROM D		**
    3                   ;**					**
    4                   ;**	Adresse:  D000h bis DAB7h	**
    5                   ;**					**
    6                   ;**	letzte Aenderung: 03.03.2019	**
    7                   ;*****************************************
    8                   
    9                   ;	ORG	0D000H
   10         0000      if turbo
  156                   endif
  157                   
  158                   ;*******************************************************************************
  159                   ;	DEVICE-Treiber fuer Kassette (ab CAOS 4.7 im ROM-D)
  160                   ;*******************************************************************************
  161                   
  162                   ; Zeitkonstanten fuer TAPE-Schreiben:
  163                   
  164                   			; Vorton	"1"-Bits
  165         005D      ZKKAT	EQU	93	; Trennzeichen	Vollschwingung ca.  557 Hz
  166         0017      ZKKA0	EQU	23	; "0"		Vollschwingung ca. 1950 Hz
  167         002F      ZKKA1	EQU	47	; "1"		Vollschwingung ca. 1050 Hz
  168                   ;
  169                   ; Zeitkonstanten fuer TAPE-Lesen:
  170                   ;
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  56
CD47    INC

  171         00A3      IKEZK	EQU	163	; Zeitkonstante fuer CTC
  172         005D      IKEGN	EQU	93	; Erkennung Nullbit
  173         00BA      IKEG1	EQU	186	; Erkennung Einsbit
  174                   
  175                   ; Initialisierung Bandausgabe:				**08**
  176                   ; PA:	CY=0	(kein Fehler bei Bandausgabe)
  177                   
  178 D000  F3          TISRO:	DI
  179 D001  DB 88       	IN	A,(PIOAD)
  180 D003  F6 60       	OR	01100000b	; Motor+LED ein
  181 D005  CD E458     	CALL	ISRO1		; Initialisierung
  182 D008  DD 36 02 00 	LD	(IX+2),0	; Block 1 (Vorblock)
  183 D00C  01 1000     	LD	BC,4096		; langer Vorton
  184                   
  185                   ; Ausgabe 1 Block					**01**
  186                   ; PE:	BC	Laenge Vorton
  187                   
  188 D00F  DD 34 02    TMBO:	INC	(IX+2)
  189 D012  3E 87       	LD	A,10000111b	; EI,ZG16,Res
  190 D014  F3          	DI
  191 D015  D3 8D       	OUT	(CTC1),A
  192 D017  3E 2F       	LD	A,ZKKA1		; Vorton "1"
  193 D019  D3 8D       	OUT	(CTC1),A
  194 D01B  FB          	EI
  195 D01C  5F          	LD	E,A		; E=47 (ZK Vorton)
  196 D01D  CD D062     MBO1:	CALL	BITOUT		; Vorton ausgeben
  197 D020  ED A1       	CPI
  198 D022  EA D01D     	JP	PE,MBO1		; BC mal
  199 D025  CD D060     	CALL	ZTON		; Trennzeichen
  200 D028  DD 7E 02    	LD	A,(IX+2)
  201 D02B  CD D04D     	CALL	BYTOT		; Blocknummer
  202 D02E  DD 6E 05    	LD	L,(IX+5)
  203 D031  DD 66 06    	LD	H,(IX+6)	; Blockanfang
  204 D034  06 80       	LD	B,128		; Zaehler
  205 D036  7E          BLKOT:	LD	A,(HL)
  206 D037  CD D04D     	CALL	BYTOT		; 128 Datenbyte ausgeben
  207 D03A  79          	LD	A,C
  208 D03B  86          	ADD	A,(HL)		; Pruefsumme
  209 D03C  4F          	LD	C,A		; nebenher berechnen in Register C
  210 D03D  23          	INC	HL
  211 D03E  10 F6       	DJNZ	BLKOT
  212 D040  CD D04D     	CALL	BYTOT		; Pruefsumme ausgeben
  213                   
  214                   ; Bei einer Halbschwingung als Endimpuls aendert sich mit jedem Block die
  215                   ; Polaritaet der Signale. Das ist bei allen CAOS-Versionen so ausser CAOS 4.5.
  216                   ; Eventuell ist das ja besser - deshalb ab CAOS 4.6 wieder eine Halbschwingung
  217                   ; als Endimpuls. (bemerkt von Micha im Forum am 02.02.2015)
  218                   
  219 D043  CD D065     	CALL	HBITOT		; Trennzeichen (2. Halbschwingung)
  220 D046  5D          	LD	E,L
  221 D047  54          	LD	D,H		; DE=HL (Pufferende+1)
  222 D048  3E 03       	LD	A,3		; CTC stoppen
  223 D04A  D3 8D       	OUT	(CTC1),A
  224 D04C  C9          	RET
  225                   
  226                   ; Ausgabe eines Bytes auf Kassette
  227                   ; PE:	A	Datenbyte
  228                   ; PA:	CY=0
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  57
CD47    INC

  229                   ;	E	Zeitkonstante fuer Trennzeichen
  230                   ; VR:	AF, E
  231                   
  232 D04D  C5          BYTOT:	PUSH	BC
  233 D04E  4F          	LD	C,A
  234 D04F  06 08       	LD	B,8		; 8 Bit ausgeben
  235 D051  CB 09       BYTOUT:	RRC	C		; mit Bit 0 beginnend
  236 D053  1E 17       	LD	E,ZKKA0
  237 D055  D4 D062     	CALL	NC,BITOUT	; CY=0 / Nullbit ausgeben
  238 D058  1E 2F       	LD	E,ZKKA1	
  239 D05A  DC D062     	CALL	C,BITOUT	; CY=1 / Einsbit ausgeben
  240 D05D  10 F2       	DJNZ	BYTOUT		; 8x wiederholen
  241 D05F  C1          	POP	BC
  242 D060  1E 5D       ZTON:	LD	E,ZKKAT		; ZK Trennzeichen
  243                   
  244                   ; Ausgabe einer Vollschwingung
  245                   ; PE:	E	Zeitkonstante
  246                   
  247 D062  CD D065     BITOUT:	CALL	HBITOT		; Aufrufen und reinlaufen
  248 D065  DD 73 00    HBITOT:	LD	(IX),E		; Zeitkonstante -> (IX)
  249 D068  DD 7E 00    HBIT1:	LD	A,(IX)		; Warten bis Zeitkonstante von
  250 D06B  A7          	AND	A		; Interruptroutine zurueckgesetzt
  251 D06C  20 FA       	JR	NZ,HBIT1
  252 D06E  C9          	RET
  253                   
  254                   ; Initialisierung Bandeingabe				**0A**
  255                   ; PE:	HL	Dateiname
  256                   ; PA:	CY=1	Fehler
  257                   ;	CY=0	Block korrekt gelesen
  258                   ; VR:	AF,BC
  259                   
  260 D06F  CD E44D     TISRI:	CALL	ISRI1		; Motor ein, LED aus
  261                   
  262                   ; Einen Block einlesen:					**05**
  263                   ; PA:	CY=1	Fehler
  264                   ;	CY=0	Block korrekt gelesen
  265                   ; VR:	AF,BC
  266                   
  267 D072  3E 83       TMBI:	LD	A,10000011b
  268 D074  D3 8A       	OUT	(PIOAS),A	; EI an PIO A (Kassette)
  269 D076  E5          	PUSH	HL
  270 D077  D5          	PUSH	DE
  271 D078  06 16       MBI1:	LD	B,22
  272 D07A  CD D0CD     MBI2:	CALL	STOP1		; Lesen einer Vollschwingung
  273 D07D  38 F9       	JR	C,MBI1		; kein Einsbit ?
  274 D07F  FE BA       	CP	IKEG1		; Einsbit ?
  275 D081  CD D0C2     	CALL	LEDOO		; LED on/off
  276 D084  38 F2       	JR	C,MBI1
  277 D086  10 F2       	DJNZ	MBI2		; 22 korrekte Schwingungen abwarten
  278 D088  06 02       MBI3:	LD	B,2
  279 D08A  AF          MBI4:	XOR	A
  280 D08B  CD D0D1     	CALL	STOP2		; Lesen einer Halbschwingung
  281 D08E  FE 5D       	CP	IKEGN		; Nullbit ?
  282 D090  30 F6       	JR	NC,MBI3
  283 D092  10 F6       	DJNZ	MBI4		; Warten auf ein komplettes Nullbit
  284 D094  DD 6E 05    	LD	L,(IX+5)	; Blockpuffer
  285 D097  DD 66 06    	LD	H,(IX+6)
  286 D09A  CD D0E2     	CALL	BYTIN		; Blocknummer lesen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  58
CD47    INC

  287 D09D  38 1B       	JR	C,MBI5		; Stoerung
  288 D09F  DD 77 02    	LD	(IX+2),A	; Blocknummer eintragen
  289 D0A2  06 80       	LD	B,128		; Blocklaenge
  290 D0A4  1E 00       	LD	E,0		; Pruefsumme=0
  291 D0A6  CD D0E2     BLKIN:	CALL	BYTIN		; Datenbyte lesen
  292 D0A9  38 0F       	JR	C,MBI5		; Stoerung
  293 D0AB  77          	LD	(HL),A
  294 D0AC  83          	ADD	A,E		; Pruefsumme berechnen
  295 D0AD  5F          	LD	E,A
  296 D0AE  23          	INC	HL
  297 D0AF  10 F5       	DJNZ	BLKIN
  298 D0B1  6F          	LD	L,A		; berechnete Pruefsumme
  299 D0B2  CD D0E2     	CALL	BYTIN		; Vergleichspruefsumme einlesen
  300 D0B5  38 03       	JR	C,MBI5		; Stoerung
  301 D0B7  95          	SUB	L		; Pruefsumme richtig?
  302 D0B8  C6 FF       	ADD	A,-1		; CY:=/Z
  303 D0BA  D1          MBI5:	POP	DE
  304 D0BB  E1          	POP	HL
  305 D0BC  F3          	DI
  306 D0BD  3E 03       	LD	A,3		; DI an PIO A
  307 D0BF  D3 8A       	OUT	(PIOAS),A
  308 D0C1  FB          	EI
  309 D0C2  DB 88       LEDOO:	IN	A,(PIOAD)	; LED ein/aus
  310 D0C4  CB EF       	SET	5,A		; je nach CY
  311 D0C6  30 02       	JR	NC,MBI6
  312 D0C8  CB AF       	RES	5,A
  313 D0CA  D3 88       MBI6:	OUT	(PIOAD),A
  314 D0CC  C9          	RET
  315                   ;
  316                   ; 1 Bit (Vollschwingung) einlesen:
  317                   ; PA:	A	Zeitwert
  318                   ;	CY=0	Einsbit
  319                   ;	CY=1	Nullbit
  320                   ; VR:	AF, C
  321                   ;
  322 D0CD  AF          STOP1:	XOR	A		; mit 0 beginnen
  323 D0CE  CD D0D1     	CALL	STOP2		; erst aufrufen, dann reinlaufen
  324 D0D1  4F          STOP2:	LD	C,A		; 'Zeit' der 1. Halbschwingung in C merken
  325 D0D2  DD 36 00 00 	LD	(IX),0
  326 D0D6  DB 88       STOP21:	IN	A,(PIOAD)
  327 D0D8  D3 88       	OUT	(PIOAD),A	; PIO-Logik freigeben
  328                   ;	LD	A,(IX)		; CTC-Stand von Interrupt
  329                   ;	OR	A		; eingetragen?
  330 D0DA  AF          	XOR	A
  331 D0DB  DD B6 00    	OR	(IX)		; CTC-Stand von Interrupt eingetragen
  332 D0DE  28 F6       	JR	Z,STOP21	; Warten auf 2. Halbschwingung
  333 D0E0  81          	ADD	A,C		; beide 'Zeiten' addieren
  334 D0E1  C9          	RET
  335                   
  336                   ; Einlesen eines Bytes von Kassette
  337                   ; PA:	A	Byte
  338                   ;	CY=1	Trennzeichen, Stoerung
  339                   ; VR:	AF, C, D
  340                   
  341 D0E2  16 80       BYTIN:	LD	D,80H		; D=Bitschieberegister und Zaehler (Bit 7)
  342 D0E4  CD D0CD     IB1:	CALL	STOP1		; Bit Eingabe
  343 D0E7  38 03       	JR	C,IB2		; Nullbit ?
  344 D0E9  FE BA       	CP	IKEG1		; Einsbit
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  59
CD47    INC

  345 D0EB  D8          	RET	C		; CY=1: Trennzeichen
  346 D0EC  3F          IB2:	CCF
  347 D0ED  CB 1A       	RR 	D		; Bit einschieben
  348 D0EF  30 F3       	JR	NC,IB1		; bis 8 Bit abgearbeitet sind
  349 D0F1  CD D0CD     	CALL	STOP1		; Trennzeichen (mit CY-Rueckmeldung)
  350 D0F4  7A          	LD	A,D		; Byte in A
  351 D0F5  C9          	RET
  352                   
  353                   ;*******************************************************************************
  354                   ;	DEVICE-Treiber fuer Floppy D004/D008 (ab CAOS 4.6)
  355                   ;*******************************************************************************
  356                   
  357                   ; Eingabedatei oeffnen und Block 01 einlesen		**0A**
  358                   ; PE:	HL	Dateiname
  359                   ; PA:	CY=1	Fehler
  360                   
  361 D0F6  DD 36 02 00 FISRI:	LD	(IX+2),0	; 1. Block lesen
  362 D0FA  DD 36 03 01 	LD	(IX+3),1	; erwarteter Block = 1
  363 D0FE  CD D194     	CALL	NAMOUT		; Dateiname ausgeben zum D004
  364 D101  3E 09       	LD	A,9		; Lesen oeffnen
  365 D103  21          	DB	21h		; LD HL,nn
  366                   
  367                   ; Einlesen Datenblock 128 Byte				**05**
  368                   ; PE:	(IX+3)	erwartete Blocknummer
  369                   ; PA:	(IX+2)	gelesene Blocknummer
  370                   ;	CY=1	Lesefehler
  371                   ; VR:	AF,BC
  372                   
  373 D104  3E 01       FMBI:	LD	A,1		; Lesen normal
  374 D106  CD D14A     	CALL	STEUER
  375 D109  D8          	RET	C		; Fehler
  376 D10A  0D          	DEC	C		; STBYT1 -> FDATA (80F2H)
  377 D10B  E5          	PUSH	HL
  378 D10C  DD 6E 05    	LD	L,(IX+5)
  379 D10F  DD 66 06    	LD	H,(IX+6)	; Kassettenpuffer
  380 D112  ED 78       FMBI1:	IN	A,(C)
  381 D114  CD FB70     	CALL	LDMAE		; Daten in Speicher ablegen
  382 D117  23          	INC	HL
  383 D118  04          	INC	B
  384 D119  20 F7       	JR	NZ,FMBI1	; CY von allen Befehlen nach RET C unbeeinflusst
  385 D11B  E1          	POP	HL
  386                   ;	LD	A,(IX+3)	; erwarteten Block
  387                   ;	LD	(IX+2),A	; als gelesenen Block melden
  388 D11C  DD 34 02    	INC	(IX+2)		; Blocknummer erhoehen
  389 D11F  C9          	RET
  390                   
  391                   ; Eingabedatei schliessen				**0B**
  392                   ; PE:
  393                   ; PA:	CY=1	bei Fehler
  394                   
  395 D120  3E 41       FCSRI:	LD	A,41H		; READ - close
  396 D122  18 26       	JR	STEUER
  397                   
  398                   ; Ausgabedatei oeffnen und ersten Block 01h ausgeben	**08**
  399                   ; PE:	Kassettenpuffer mit Daten des Vorblocks
  400                   ;	HL	Dateiname
  401                   ; PA:	CY=1	Fehler
  402                   ; VR:	AF,BC,DE,HL
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  60
CD47    INC

  403                   
  404 D124  DD 36 02 00 FISRO:	LD	(IX+2),0	; mit Block 1 beginnen
  405                   ;	LD	L,(IX+5)	; HL = Dateiname im Kassettenpuffer
  406                   ;	LD	H,(IX+6)
  407 D128  CD D194     	CALL	NAMOUT		; Dateiname ausgeben zum D004
  408 D12B  3E 0B       	LD	A,0BH		; Schreiben oeffnen
  409 D12D  21          	DB	21h		; LD HL,nn
  410                   
  411                   ; Ausgabe Datenblock 128 Byte				**01**
  412                   ; PE:	Datenblock im Kassettenpuffer
  413                   ; PA:	CY=1	Fehler
  414                   ; VR:	AF,BC,DE,HL
  415                   
  416 D12E  3E 03       FMBO:	LD	A,3		; Schreiben normal
  417 D130  DD 34 02    	INC	(IX+2)		; Blocknummer erhoehen
  418 D133  DD 6E 05    	LD	L,(IX+5)	; Kassettenpuffer
  419 D136  DD 66 06    	LD	H,(IX+6)
  420 D139  01 80F2     	LD	BC,FDATA	; 80F2H
  421 D13C  1E 80       	LD	E,128
  422 D13E  08          	EX	AF,AF'		; Kommando in A' merken
  423 D13F  CD FB80     FMBO1:	 CALL	LDAME		; Daten aus Speicher holen
  424 D142  ED 79       	 OUT	(C),A		; und in Koppel-RAM schreiben
  425 D144  23          	 INC	HL
  426 D145  04          	 INC	B
  427 D146  1D          	 DEC	E
  428 D147  20 F6       	 JR	NZ,FMBO1
  429 D149  08          	EX	AF,AF'		; Kommando zurueck nach A
  430                   ;
  431                   ; Steuerbyte 1 ausgeben, bei Fehler: Fehlercode/-text anzeigen
  432                   ; PE:	A	Kommando-Steuerbyte
  433                   ; PA:	A	Antwort von DEP
  434                   ;	CY=1	Fehler aufgetreten
  435                   ; VR:	AF,BC
  436                   ;
  437 D14A  01 80F3     STEUER:	LD	BC,STBYT1	; 80F3H
  438 D14D  ED 79       STEU0:	OUT	(C),A
  439 D14F  C5          STEU1:	PUSH	BC
  440 D150  3E 01       	LD	A,1		; 6ms
  441 D152  CD E2A3     	CALL	WAIT		; warten
  442 D155  C1          	POP	BC
  443 D156  ED 78       	IN	A,(C)
  444 D158  A7          	AND	A		; CY-Flag=0
  445 D159  CB 47       	BIT	0,A
  446 D15B  20 F2       	JR	NZ,STEU1	; fertig?
  447 D15D  CB 7F       	BIT	7,A		; Bit 7 gesetzt?
  448 D15F  C8          	RET	Z		; kein Fehler
  449 D160  01 83F1     FLERR:	LD	BC,DEPVER	; 83F1H
  450 D163  ED 78       	IN	A,(C)
  451 D165  FE 20       	CP	20H		; DEP ab 2.0?
  452 D167  30 0D       	JR	NC,FLER1	; ja
  453 D169  01 81F3     	LD	BC,FCODE	; 81F3H
  454 D16C  ED 78       	IN	A,(C)		; Fehlernummer
  455 D16E  CD F3C4     	CALL	AHEX		; anzeigen
  456 D171  CD F4D1     	CALL	ERRM
  457 D174  37          FLER3:	SCF			; CY=1: Fehler
  458 D175  C9          	RET
  459                   	;
  460 D176  06 00       FLER1:	LD	B,HIGH(ERRTX)	; 00F1H = Fehlertext von DEP 2.0
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  61
CD47    INC

  461 D178  ED 78       FLER2:	IN	A,(C)
  462 D17A  04          	INC	B
  463 D17B  A7          	AND	A
  464 D17C  28 F6       	JR	Z,FLER3		; 00=Ende
  465 D17E  CD F3D5     	CALL	OCHR
  466 D181  18 F5       	JR	FLER2
  467                   
  468                   ; Steuerbyte 2 ausgeben
  469                   
  470 D183  01 80F1     STEUB2:	LD	BC,STBYT2	; 80F1H
  471 D186  18 C5       	JR	STEU0
  472                   
  473                   ; Ausgabedatei schliessen und Endeblock FFh ausgeben	**09**
  474                   ; PE:	Datenblock im Kassettenpuffer
  475                   ; PA:	CY=1	bei Fehler
  476                   ; VR:	AF,BC,DE,HL
  477                   
  478 D188  DD 36 02 FE FCSRO:	LD	(IX+2),0FEH	; Nr. letzter Block
  479 D18C  CD D12E     	CALL	FMBO		; Datenblock ausgeben
  480 D18F  D8          	RET	C		; Fehler
  481 D190  3E 43       	LD	A,43H		; write close
  482 D192  18 B6       	JR	STEUER
  483                   
  484                   ; Dateiname ausgeben
  485                   ; PE:	HL	Dateiname, Ende mit 00 (max. 12 Zeichen)
  486                   ;	D	Maske FFh (Trennzeichen=0) oder DFh (Trennzeichen=SPC oder 0)
  487                   ; VR:	AF,BC,E,HL
  488                   
  489 D194  11 FF0C     NAMOUT:	LD	DE,0FF0Ch	; D=Maske, E=max. Laenge Dateiname 8.3 (12)
  490 D197  01 82F3     NAMO1:	LD	BC,DIRBUF	; 82F3H
  491 D19A  7E          NAMO2:	LD	A,(HL)
  492 D19B  ED 79       	OUT	(C),A		; Dateiname zum D004 ausgeben
  493 D19D  A2          	AND	D		; war das ein Trennzeichen?
  494 D19E  28 01       	JR	Z,NAMO3
  495 D1A0  23          	INC	HL		; naechstes Zeichen solange kein Trennzeichen
  496 D1A1  04          NAMO3:	INC	B
  497 D1A2  1D          	DEC	E
  498 D1A3  20 F5       	JR	NZ,NAMO2
  499 D1A5  C9          	RET
  500                   ;
  501                   ; Name ein-, ausgeben: (fuer RENAME)
  502                   ; PE:	DE	Zeiger auf Dateinamen, wenn 0 dann Eingabe
  503                   ; PA:	CY=1	BRK
  504                   ;	DE	Zeiger auf Zeichen nach Dateinamen (2. Name bei REN)
  505                   ;
  506 D1A6  CD F56A     FNAM1:	CALL	NAMHL		; Dateiname eingeben
  507 D1A9  D8          	RET	C		; BRK
  508 D1AA  11 DF0C     FNAM2:	LD	DE,0DF0Ch	; D=Maske, E=max. Laenge Dateiname 8.3 (12)
  509 D1AD  CD D197     	CALL	NAMO1		; ausgeben zum D004	
  510 D1B0  EB          	EX	DE,HL		; Zeiger jetzt wieder in DE
  511 D1B1  13          	INC	DE		; Trennzeichen uebergehen
  512 D1B2  C9          	RET
  513                   
  514                   ; CAOS-D-Teil der Pixelausgaberoutine WPIX
  515                   
  516 D1B3  79          WPIXD:	LD	A,C
  517 D1B4  01 DC00     	LD	BC,0DC00H
  518 D1B7  87          	ADD	A,A
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  62
CD47    INC

  519 D1B8  38 2C       	JR	C,WPX02		; 80..FF
  520 D1BA  05          	DEC	B
  521 D1BB  FE 40       	CP	40H
  522 D1BD  38 27       	JR	C,WPX02		; 00..1F
  523 D1BF  06 ED       	LD	B,0EEH-1	; Grossbuchstaben
  524 D1C1  FE B6       	CP	2*5BH
  525 D1C3  38 21       	JR	C,WPX02		; 20..5A
  526 D1C5  FE BC       	CP	2*5EH
  527 D1C7  38 0C       	JR	C,WPX01		; 5B..5D
  528 D1C9  FE C0       	CP	2*60H
  529 D1CB  38 19       	JR	C,WPX02		; 5E..5F
  530 D1CD  28 06       	JR	Z,WPX01		; 60
  531 D1CF  06 FC       	LD	B,0FEH-2	; Kleinbuchstaben
  532 D1D1  FE F6       	CP	2*7BH
  533 D1D3  38 11       	JR	C,WPX02		; 61..7A
  534 D1D5  01 DAB8     WPX01:	LD	BC,0DAB8H	; Zusatztabelle
  535 D1D8  D6 B6       	SUB	2*5BH
  536 D1DA  FE 06       	CP	6
  537 D1DC  38 08       	JR	C,WPX02		; 5B..5D
  538 D1DE  D6 04       	SUB	4
  539 D1E0  FE 06       	CP	6
  540 D1E2  28 02       	JR	Z,WPX02		; 60
  541 D1E4  D6 34       	SUB	34H
  542 D1E6  6F          WPX02:	LD	L,A
  543 D1E7  26 00       	LD	H,0
  544 D1E9  29          	ADD	HL,HL		; *4
  545 D1EA  C3 E0CB     	JP	WPX07		; Zurueck zu CAOS-E
  546                   
  547                   ; Rolle Fenster fuer Scrollroutine
  548                   
  549 D1ED  E5          MOVELN:	PUSH	HL
  550 D1EE  D5          	PUSH	DE
  551 D1EF  C5          	PUSH	BC
  552 D1F0  F5          	PUSH	AF
  553 D1F1  08          	EX	AF,AF'
  554 D1F2  F5          	PUSH	AF
  555 D1F3  79          	LD	A,C		; BC: Pixelzeilen
  556 D1F4  08          	EX	AF,AF'
  557 D1F5  3A B79E     	LD	A,(WINLG)	; Spalten
  558 D1F8  E5          MOLN1:	PUSH	HL
  559 D1F9  D5          	PUSH	DE
  560 D1FA  ED A0       MOLN2:	LDI			; zeichenweise
  561 D1FC  ED A0       	LDI
  562 D1FE  ED A0       	LDI
  563 D200  ED A0       	LDI
  564 D202  ED A0       	LDI
  565 D204  ED A0       	LDI
  566 D206  ED A0       	LDI
  567 D208  ED A0       	LDI
  568 D20A  EA D1FA     	JP	PE,MOLN2
  569 D20D  D1          	POP	DE
  570 D20E  E1          	POP	HL
  571 D20F  24          	INC	H		; neue Spalte
  572 D210  14          	INC	D
  573 D211  08          	EX	AF,AF'
  574 D212  4F          	LD	C,A
  575 D213  08          	EX	AF,AF'
  576 D214  3D          	DEC	A		; Spaltenzaehler
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  63
CD47    INC

  577 D215  20 E1       	JR	NZ,MOLN1
  578 D217  08          	EX	AF,AF'
  579 D218  F1          	POP	AF
  580 D219  08          	EX	AF,AF'
  581 D21A  C3 E097     	JP	POP4		; POP	AF,BC,DE,HL   RET
  582                   
  583                   ; Loeschen einer Zeile
  584                   ; HL: Adresse, C: Laenge, A: Byte
  585                   
  586 D21D  41          CLLINE:	LD	B,C
  587 D21E  55          CLL1:	LD	D,L		; L retten
  588 D21F  77          	LD	(HL),A		; zeichenweise
  589 D220  2C          	INC	L		; ohne Schleife
  590 D221  77          	LD	(HL),A
  591 D222  2C          	INC	L
  592 D223  77          	LD	(HL),A
  593 D224  2C          	INC	L
  594 D225  77          	LD	(HL),A
  595 D226  2C          	INC	L
  596 D227  77          	LD	(HL),A
  597 D228  2C          	INC	L
  598 D229  77          	LD	(HL),A
  599 D22A  2C          	INC	L
  600 D22B  77          	LD	(HL),A
  601 D22C  2C          	INC	L
  602 D22D  77          	LD	(HL),A
  603 D22E  6A          	LD	L,D		; L holen
  604 D22F  24          	INC	H
  605 D230  10 EC       	DJNZ	CLL1
  606 D232  C9          	RET
  607                   
  608                   ; CAOS-D-Teil der Scrollroutine SCRLPG
  609                   
  610 D233  3A B79E     SCRLD:	LD	A,(WINLG)	; Spalten
  611 D236  4F          	LD	C,A
  612 D237  06 00       	LD	B,0
  613 D239  3A B79F     	LD	A,(WINLG+1)	; Zeilen
  614 D23C  3D          	DEC	A		; nur 1 Zeile?
  615 D23D  28 3A       	JR	Z,SCRL3		; nur CLLN
  616 D23F  D5          	PUSH	DE
  617 D240  F5          	PUSH	AF
  618 D241  50          	LD	D,B		; DE=0
  619 D242  58          	LD	E,B		; Cursor links/oben
  620 D243  CD E068     	CALL	DABR
  621 D246  EB          	EX	DE,HL
  622 D247  21 0028     SCRL1:	LD	HL,40		; 1 Zeile tiefer
  623 D24A  19          	ADD	HL,DE
  624 D24B  E5          	PUSH	HL
  625 D24C  C5          	PUSH	BC
  626 D24D  ED B0       	LDIR			; im VRAM eine Zeile rollen
  627 D24F  C1          	POP	BC
  628 D250  D1          	POP	DE
  629 D251  3D          	DEC	A
  630 D252  20 F3       	JR	NZ,SCRL1	; A-mal rollen
  631 D254  F1          	POP	AF
  632 D255  87          	ADD	A,A
  633 D256  87          	ADD	A,A
  634 D257  87          	ADD	A,A		; *8: Pixelzeile
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  64
CD47    INC

  635 D258  4F          	LD	C,A
  636 D259  50          	LD	D,B		; B war 0
  637 D25A  58          	LD	E,B		; DE=0
  638 D25B  CD E042     	CALL	PADR1
  639 D25E  EB          	EX	DE,HL		; DE=Pixeladresse
  640 D25F  2E 08       	LD	L,8		; H war 0
  641 D261  19          	ADD	HL,DE
  642 D262  3A B7A2     	LD	A,(STBT)
  643 D265  1F          	RRA
  644 D266  1F          	RRA
  645 D267  38 0B       	JR	C,SCRL2		; Farbe AUS
  646 D269  F5          	PUSH	AF
  647 D26A  CD F987     	CALL	ESC9
  648 D26D  CD D1ED     	CALL	MOVELN
  649 D270  CD F987     	CALL	ESC9
  650 D273  F1          	POP	AF
  651 D274  17          SCRL2:	RLA			; Pixel AUS?
  652 D275  D4 D1ED     	CALL	NC,MOVELN
  653 D278  D1          	POP	DE
  654 D279  15          SCRL3:	DEC	D
  655                   
  656                   ; CAOS-D-Teil der Zeilenloeschroutine CLLN (Shift-DEL)
  657                   
  658 D27A  1E 00       CLLND:	LD	E,0		; Cursor auf Spalte 0
  659 D27C  CD E068     	CALL	DABR		; ausserhalb?
  660 D27F  D8          	RET	C		; (Selbstschutz)
  661 D280  3A B79E     	LD	A,(WINLG)
  662 D283  47          	LD	B,A		; Spalten
  663 D284  4F          	LD	C,A
  664 D285  AF          	XOR	A
  665 D286  77          CLLN1:	LD	(HL),A		; VRAM loeschen
  666 D287  23          	INC	HL
  667 D288  10 FC       	DJNZ	CLLN1
  668 D28A  CD E042     	CALL	PADR1
  669 D28D  D8          	RET	C
  670 D28E  D5          	PUSH	DE
  671 D28F  DD CB 01 5E 	BIT	3,(IX+1)
  672 D293  3A B7A2     	LD	A,(STBT)
  673 D296  20 04       	JR	NZ,CLLALT	; LORES
  674 D298  CB 77       	BIT	6,A
  675 D29A  20 1C       	JR	NZ,CLLHR	; HRG-Modus
  676 D29C  0F          CLLALT:	RRCA			; Pixel AUS?
  677 D29D  5F          	LD	E,A		; nach E merken
  678 D29E  38 06       	JR	C,CLLN2
  679 D2A0  AF          	XOR	A
  680 D2A1  E5          	PUSH	HL
  681 D2A2  CD D21D     	CALL	CLLINE		; Pixel loeschen
  682 D2A5  E1          	POP	HL
  683 D2A6  CB 0B       CLLN2:	RRC	E		; Farbe AUS?
  684 D2A8  38 0C       	JR	C,CLLN3
  685 D2AA  CD F987     	CALL	ESC9
  686 D2AD  3A B7A3     	LD	A,(COLOR)
  687 D2B0  CD D21D     CLLCOL:	CALL	CLLINE		; Farbe setzen
  688 D2B3  CD F987     	CALL	ESC9
  689 D2B6  D1          CLLN3:	POP	DE
  690 D2B7  C9          	RET
  691                   
  692 D2B8  3A B7A3     CLLHR:	LD	A,(COLOR)
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  65
CD47    INC

  693 D2BB  E6 03       	AND	00000011b	; Paper, CY=0
  694 D2BD  1F          	RRA
  695 D2BE  3D          	DEC	A		; NEG ohne Veraenderung von CY
  696 D2BF  2F          	CPL
  697 D2C0  5F          	LD	E,A		; E = FFh * Bit 1 (Farbe)
  698 D2C1  9F          	SBC	A,A		; A = FFh * Bit 0 (Pixel)
  699 D2C2  E5          	PUSH	HL
  700 D2C3  CD D21D     	CALL	CLLINE
  701 D2C6  E1          	POP	HL
  702 D2C7  CD F987     	CALL	ESC9
  703 D2CA  7B          	LD	A,E		; Farbe
  704 D2CB  18 E3       	JR	CLLCOL
  705                   
  706                   ; Quadratwurzel 16Bit A=SQR(HL)				**40**
  707                   
  708 D2CD  AF          SQRC:	XOR	A		; A=0, CY=0
  709 D2CE  3D          	DEC	A		; A=FF
  710 D2CF  5F          	LD	E,A
  711 D2D0  57          	LD	D,A		; DE=FFFF
  712 D2D1  3C          SQR1:	INC	A		; mitzaehlen
  713 D2D2  13          	INC	DE
  714 D2D3  13          	INC	DE
  715 D2D4  ED 52       	SBC	HL,DE
  716 D2D6  30 F9       	JR	NC,SQR1
  717 D2D8  C3 FB9C     	JP	COFF		; -> COFF
  718                   
  719                   ; Multiplikation BA=C*D					**41**
  720                   
  721 D2DB  AF          MULC:	XOR	A		; Startwert 0
  722 D2DC  06 08       	LD	B,8		; 8 Bit Multiplikation/Rotation
  723 D2DE  CB 1A       	RR	D
  724 D2E0  30 01       MUL1:	JR	NC,MUL2		; Bit nicht gesetzt
  725 D2E2  81          	ADD	A,C		; aufaddieren
  726 D2E3  1F          MUL2:	RRA
  727 D2E4  CB 1A       	RR	D		; jetzt 16 Bit rotieren
  728 D2E6  10 F8       	DJNZ	MUL1		; und weiter addieren
  729 D2E8  47          	LD	B,A		; Ergebnis in
  730 D2E9  7A          	LD	A,D		; BA
  731 D2EA  C9          	RET
  732                   
  733                   ; Speicherschnellansicht
  734                   
  735 D2EB  7F7F        VIEW7F:	DW	7F7FH
  736 D2ED  76 69 65 77 	DB	'view'
  737 D2F1  03          	DB	3
  738 D2F2  7D          	LD	A,L
  739 D2F3  FE 10       	CP	10H
  740 D2F5  30 0C       	JR	NC,VIEW1	; L>0Fh
  741 D2F7  7C          	LD	A,H
  742 D2F8  A7          	AND	A
  743 D2F9  20 08       	JR	NZ,VIEW1	; H>0
  744 D2FB  21 B782     	LD	HL,ARG1
  745 D2FE  ED 6F       	RLD
  746 D300  66          	LD	H,(HL)
  747 D301  2E 00       	LD	L,0
  748 D303  11 8800     VIEW1:	LD	DE,8800H
  749 D306  01 2000     	LD	BC,2000H
  750 D309  CD FB80     VIEW2:	CALL	LDAME		; Byte holen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  66
CD47    INC

  751 D30C  12          	LD	(DE),A		; in IRM poken
  752 D30D  23          	INC	HL
  753 D30E  13          	INC	DE
  754 D30F  0D          	DEC	C
  755 D310  20 F7       	JR	NZ,VIEW2
  756 D312  10 F5       	DJNZ	VIEW2
  757 D314  3E 0B       VIEW3:	LD	A,0BH		; Zeile hoch
  758 D316  CD E08C     	CALL	CRT
  759 D319  3E 08       	LD	A,8
  760 D31B  32 B7A0     	LD	(CURSO),A
  761 D31E  CD D321     	CALL	VIEW4
  762 D321  3E 01       VIEW4:	LD	A,1
  763 D323  4F          VIEW5:	LD	C,A
  764 D324  CD F3C4     	CALL	AHEX		; HEX-Leiste
  765 D327  79          	LD	A,C
  766 D328  C6 22       	ADD	A,22H
  767 D32A  30 F7       	JR	NC,VIEW5
  768 D32C  C9          	RET
  769                   
  770                   ; Schreibe ON, ON* oder OFF fuer Systemcheck
  771                   ; PE:	Z=1	OFF
  772                   ;	Z=0 und CY=0 ON
  773                   ;	Z=0 und CY=1 ON*
  774                   
  775 D32D  28 14       WONOF:	JR	Z,WOF
  776 D32F  F5          	PUSH	AF
  777 D330  CD F0CF     	CALL	OSTR
  778 D333  20 4F 4E 00 	DB	' ON',0
  779 D337  F1          	POP	AF
  780 D338  3E 20       	LD	A,' '
  781 D33A  30 02       	JR	NC,WRR
  782 D33C  3E 2A       	LD	A,'*'		; Schreibschutz anzeigen
  783 D33E  CD F3D5     WRR:	CALL	OCHR
  784 D341  18 08       	JR	WRLF
  785                   	;
  786 D343  CD F0CF     WOF:	CALL	OSTR
  787 D346  20 4F 46 46 	DB	' OFF',0
  788 D34B  C3 F4DB     WRLF:	JP	CRLF
  789                   
  790                   ; Anzeige Steckplatz, Kennbyte, Steuerbyte fuer Modulcheck
  791                   
  792 D34E  7D          LHD:	LD	A,L
  793 D34F  CD F3B9     	CALL	AHSPC		; Steckplatz
  794 D352  7C          	LD	A,H
  795 D353  CD F3B9     	CALL	AHSPC		; Kennbyte
  796 D356  7A          	LD	A,D
  797 D357  C3 F3B9     	JP	AHSPC		; Steuerbyte
  798                   
  799                   ; * * * *	ab hier DEVICE-Treiber-Funktionen (neu)	* * * *
  800                   
  801                   ;
  802                   ; Floppy-Treiber Funktion 0: Directory mit Maske
  803                   ; PE:	DE	Maske
  804                   ; PA:	HL	Anzahl passender Eintraege
  805                   ;
  806 D35A  EB          FDIR:	EX	DE,HL		; Maske aus Kommandozeile
  807 D35B  11 B700     	LD	DE,CASS
  808 D35E  01 000B     	LD	BC,11		; max. Laenge
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  67
CD47    INC

  809 D361  ED B0       	LDIR			; In Kassettenpuffer ablegen
  810 D363  AF          	XOR	A
  811 D364  12          	LD	(DE),A		; Abschluss Maske
  812 D365  32 B796     	LD	(NUMNX),A	; Zeilenzaehler fuer Anzeige
  813 D368  67          	ld	h,a
  814 D369  6F          	ld	l,a
  815 D36A  22 B797     	ld	(NUMVX),hl	; Zaehler fuer angezeigte Dateien
  816 D36D  3E 0D       	LD	A,0DH		; Directory oeffnen
  817 D36F  CD D14A     DIR1:	CALL	STEUER
  818 D372  CB 57       	BIT	2,A
  819 D374  20 40       	JR	NZ,DIR6		; Ende
  820 D376  06 82       	LD	B,HIGH(DIRBUF)	; 82F3H
  821 D378  21 B70C     	LD	HL,CASS+12
  822                   ;	AND	A		; CY=0
  823 D37B  16 03       	LD	D,3		; 3 Eintraege einlesen von DEP
  824 D37D  1E 0B       DIR2:	LD	E,11		; 11 Zeichen lang
  825 D37F  ED 78       DIR3:	IN	A,(C)		; Zeichen einlesen
  826 D381  F5          	PUSH	AF
  827 D382  E6 7F       	AND	7FH		; ohne Attribut
  828 D384  04          	INC	B
  829 D385  77          	LD	(HL),A		; ablegen
  830 D386  23          	INC	HL
  831 D387  7B          	LD	A,E
  832 D388  FE 03       	CP	3		; R/O-Byte?
  833 D38A  28 01       	JR	Z,DIR4
  834 D38C  F1          	POP	AF		; vom Stack nehmen wenn nicht das R/O-Byte
  835 D38D  1D          DIR4:	DEC	E
  836 D38E  20 EF       	JR	NZ,DIR3
  837 D390  36 00       	LD	(HL),0		; Ende-Kennung als 12. Byte
  838 D392  23          	INC	HL
  839 D393  04          	INC	B
  840 D394  F1          	POP	AF
  841 D395  77          	LD	(HL),A		; R/O-Byte als 13. Byte ablegen
  842 D396  23          	INC	HL
  843 D397  15          	DEC	D
  844 D398  20 E3       	JR	NZ,DIR2
  845                   
  846 D39A  21 B70C     	LD	HL,CASS+12	; 3 abgelegte DIR-Eintraege
  847 D39D  06 03       	LD	B,3		; 3 Eintraege testen/anzeigen
  848 D39F  E5          DIR5:	PUSH	HL
  849 D3A0  11 B700     	LD	DE,CASS		; die Vergleichsmaske
  850 D3A3  1A          	LD	A,(DE)
  851 D3A4  A7          	AND	A		; CY=0
  852 D3A5  C4 D428     	CALL	NZ,GLOB		; Vergleich mit Maske, falls angegeben
  853 D3A8  E1          	POP	HL
  854 D3A9  D4 D3D7     	CALL	NC,DIR7		; Anzeige eines passenden Eintrags
  855 D3AC  11 000D     	LD	DE,13
  856 D3AF  19          	ADD	HL,DE		; naechster Eintrag
  857 D3B0  10 ED       	DJNZ	DIR5		; bis alle 3 Eintraege abgearbeitet sind
  858 D3B2  3E 05       	LD	A,5		; DIR weiter
  859 D3B4  18 B9       	JR	DIR1
  860                   	;
  861 D3B6  3A B7A0     DIR6:	LD	A,(CURSO)
  862 D3B9  A7          	AND	A		; Cursor auf neuer Zeile?
  863 D3BA  C4 F4DB     	CALL	NZ,CRLF		; wenn nicht, dann jetzt ein Zeilenwechsel
  864                   
  865                   ; Nach Ende aller Dateien noch die Statusmeldung anzeigen:
  866                   
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  68
CD47    INC

  867 D3BD  3E 15       STAT:	LD	A,15H		; Status abfragen
  868 D3BF  CD D14A     	CALL	STEUER
  869 D3C2  1E 14       	LD	E,20
  870 D3C4  06 82       	LD	B,HIGH(DIRBUF)	; 82F3H
  871 D3C6  ED 78       STAT1:	IN	A,(C)
  872 D3C8  E6 7F       	AND	7FH		; Bit 7 abtrennen
  873 D3CA  04          	INC	B
  874 D3CB  F5          	PUSH	AF
  875 D3CC  CD F3D5     	CALL	OCHR
  876 D3CF  F1          	POP	AF
  877 D3D0  1D          	DEC	E
  878 D3D1  20 F3       	JR	NZ,STAT1
  879 D3D3  2A B797     	ld	hl,(NUMVX)	; Anzahl Dateien zurueck geben
  880 D3D6  C9          	RET
  881                   
  882                   ; einen DIR-Eintrag anzeigen:
  883                   
  884 D3D7  7E          DIR7:	LD	A,(HL)		; erstes Zeichen
  885 D3D8  FE 20       	CP	' '		; leer?
  886 D3DA  C8          	RET	Z		; dann kein Dateiname!
  887 D3DB  E5          	PUSH	HL		; DIR-Eintrag
  888 D3DC  3A B7A0     	LD	A,(CURSO)
  889 D3DF  FE 27       	CP	3*13		; wenn schon 3 Eintraege auf der Zeile stehen,
  890 D3E1  CC D400     	CALL	Z,DIR9		; dann auf neue Zeile wechseln
  891 D3E4  E1          	POP	HL
  892 D3E5  E5          	PUSH	HL
  893 D3E6  CD F906     	CALL	ZKOUT		; Dateiname anzeigen
  894 D3E9  3E 20       	LD	A,' '		; W/R
  895 D3EB  CB 7E       	BIT	7,(HL)
  896 D3ED  28 02       	JR	Z,DIR8
  897 D3EF  3E 2A       	LD	A,'*'		; R/O
  898 D3F1  CD F3D5     DIR8:	CALL	OCHR
  899 D3F4  CD F3BC     	CALL	SPACE
  900 D3F7  2A B797     	ld	hl,(NUMVX)
  901 D3FA  23          	inc	hl		; angezeigte Dateien mitzaehlen
  902 D3FB  22 B797     	ld	(NUMVX),HL
  903 D3FE  E1          	POP	HL
  904 D3FF  C9          	RET
  905                   
  906                   ; Neue Zeile bei DIR-Kommando / warten nach Bildschirmseite:
  907                   
  908 D400  21 B796     DIR9:	LD	HL,NUMNX	; Zeilenzaehler
  909 D403  34          	INC	(HL)		; Zeilen zaehlen
  910 D404  3A B79F     	LD	A,(WINLG+1)	; Anzahl Zeilen im Fenster
  911 D407  3D          	DEC	A		; eine Zeile zum ueberlappen der Anzeige lassen
  912 D408  96          	SUB	(HL)
  913 D409  20 04       	JR	NZ,DIR10
  914 D40B  77          	LD	(HL),A		; wieder von vorn zaehlen
  915 D40C  CD F3F6     	call	kbd		; Tastatureingabe abwarten
  916 D40F  C3 F4DB     DIR10:	JP	CRLF
  917                   ;
  918                   ; Floppy-Treiber Funktion 2: Datei loeschen
  919                   ; PE:	DE	Dateiname
  920                   ;	(DE)=0	Dateinamen werden abgefragt
  921                   ; PA:	CY=1	Fehler
  922                   ;
  923 D412  EB          FERA:	EX	DE,HL
  924 D413  7E          	LD	A,(HL)		; Parameter in Kommandozeile
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  69
CD47    INC

  925 D414  E6 DF       	AND	0DFH		; angegeben?
  926 D416  CC F567     	CALL	Z,NAME		; Dateiname abfragen falls nicht angegeben
  927 D419  3F          	CCF			; BRK nicht als Fehler anzeigen
  928 D41A  D0          	RET	NC		; Eingabe Dateiname mit BRK abgebrochen
  929 D41B  CD D194     	CALL	NAMOUT		; Dateiname ausgeben zum D004
  930 D41E  3E 11       	LD	A,11H		; Era
  931 D420  CD D14A     	CALL	STEUER		; mit Steuerbyte 1 im D004 anfordern
  932 D423  D8          	RET	C		; Fehler aufgetreten
  933 D424  18 97       	JR	STAT
  934                   
  935                   ; Vergleich mit DIR-Maske:
  936                   
  937 D426  23          MAT0:	INC	HL
  938 D427  13          MAT0E:	INC	DE
  939 D428              GLOB:	; Eintritt, HL=Name, DE=Maske
  940                   	; PA: CY=1: nicht gefunden
  941 D428  1A          	LD	A,(DE)
  942 D429  B6          	OR	(HL)		; Beide Ende?
  943 D42A  C8          	RET	Z		; -> OK
  944 D42B  1A          	LD	A,(DE)
  945 D42C  FE 2A       	CP	'*'
  946 D42E  28 16       	JR	Z,MAT0S
  947 D430  FE 01       	CP	1
  948 D432  D8          	RET	C		; M Ende
  949 D433  7E          	LD	A,(HL)
  950 D434  FE 01       	CP	1
  951 D436  D8          	RET	C		; N Ende
  952 D437  1A          	LD	A,(DE)
  953 D438  FE 3F       	CP	'?'
  954 D43A  28 EA       	JR	Z,MAT0		; Joker
  955 D43C  CB 6E       	BIT	5,(HL)
  956 D43E  CC F53D     	CALL	Z,UPCASE
  957 D441  BE          	CP	(HL)
  958 D442  28 E2       	JR	Z,MAT0
  959 D444  37          	SCF
  960 D445  C9          	RET
  961                   	;
  962 D446  E5          MAT0S:	PUSH	HL
  963 D447  D5          	PUSH	DE
  964 D448  CD D427     	CALL	MAT0E		; Rekursion!
  965 D44B  D1          	POP	DE
  966 D44C  E1          	POP	HL
  967 D44D  D0          	RET	NC		; -> OK
  968 D44E  7E          	LD	A,(HL)
  969 D44F  23          	INC	HL
  970 D450  B7          	OR	A
  971 D451  20 F3       	JR	NZ,MAT0S
  972 D453  37          	SCF
  973 D454  C9          	RET
  974                   ;
  975                   ; Floppy-Treiber Funktion 3: Datei umbenennen
  976                   ; PE:	DE	Zeiger auf Zeichenkette mit 2 Dateinamen
  977                   ;	(DE)=0	Dateinamen werden abgefragt
  978                   ; PA:	CY=1	Fehler
  979                   ;
  980 D455  1A          FREN:	LD	A,(DE)		; Parameter in Kommandozeile
  981 D456  E6 DF       	AND	0DFH		; angegeben?
  982 D458  20 13       	JR	NZ,REN1		; ja, dann diesen verwenden
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  70
CD47    INC

  983 D45A  CD F0CF     	CALL	OSTR
  984 D45D  41 6C 74 65 	DB	'Alter ',0
  985 D464  21 000C     	LD	HL,12
  986 D467  CD D1A6     	CALL	FNAM1		; Dateiname abfragen
  987 D46A  D8          	RET	C		; BRK
  988 D46B  18 04       	JR	REN2
  989                   	;
  990 D46D  EB          REN1:	EX	DE,HL		; Dateiname in HL
  991 D46E  CD D1AA     	CALL	FNAM2
  992 D471  3E 29       REN2:	LD	A,29H		; REN alter Dateiname
  993 D473  CD D14A     	CALL	STEUER
  994 D476  D8          	RET	C		; Fehler
  995 D477  1A          	LD	A,(DE)		; Parameter in Kommandozeile
  996 D478  E6 DF       	AND	0DFH		; 2. Dateiname angegeben?
  997 D47A  20 13       	JR	NZ,REN3		; ja, dann diesen verwenden
  998 D47C  CD F0CF     	CALL	OSTR
  999 D47F  4E 65 75 65 	DB	'Neuer ',0
 1000 D486  21 000C     	LD	HL,12
 1001 D489  CD D1A6     	CALL	FNAM1		; Dateiname abfragen
 1002 D48C  D8          	RET	C		; BRK
 1003 D48D  18 04       	JR	REN4
 1004                   	;
 1005 D48F  EB          REN3:	EX	DE,HL		; Dateiname in HL
 1006 D490  CD D1AA     	CALL	FNAM2
 1007 D493  3E 21       REN4:	LD	A,21H		; REN neuer Dateiname
 1008 D495  CD D14A     	CALL	STEUER		; Steuerbyte ausgeben
 1009 D498  D8          	RET	C		; Fehler
 1010 D499  CD F0CF     	CALL	OSTR
 1011 D49C  4F 4B 2E 0D 	DB	'OK.',CR,LF,0
 1012 D4A2  C9          	RET
 1013                   ;
 1014                   ; Anzeige einer beliebigen Text-Datei (nicht fuer TAPE-Modus)
 1015                   ;
 1016 D4A3  7F7F        TYPE7F:	DW	7F7FH
 1017 D4A5  54 59 50 45 	DB	'TYPE'
 1018 D4A9  1F          	DB	1FH		; Textargument zulaessig (Dateiname)
 1019 D4AA  CD D5C8     	CALL	TDUP1		; Dateiname in HL
 1020 D4AD  D8          	RET	C		; TAPE oder BRK
 1021 D4AE  CD E4C9     	CALL	PV7		; HL = Dateiname
 1022 D4B1  04          	DB	4		; ISRI (ersten Block einlesen)
 1023 D4B2  38 77       	JR	C,FCLOSE	; Fehler aufgetreten
 1024 D4B4  3A B710     	LD	A,(CASS+10h)	; Anzahl ARG in Vorblock
 1025 D4B7  FE 02       	CP	2
 1026 D4B9  38 1B       	JR	C,TYPE4		; kein Vorblock, da < 2
 1027 D4BB  FE 05       	CP	5
 1028 D4BD  30 17       	JR	NC,TYPE4	; kein Vorblock, da > 4
 1029 D4BF  18 0F       	JR	TYPE3		; Vorblock -> dann ersten Datenblock einlesen
 1030                   	;
 1031 D4C1  3E 0C       TYPE1:	LD	A,0CH		; CLS
 1032 D4C3  CD E08C     	CALL	CRT		; CRT, damit nicht zu Druckprotokoll!
 1033 D4C6  3E 0A       	LD	A,LF
 1034 D4C8  CD E08C     	CALL	CRT		; oben eine Zeile frei lassen
 1035 D4CB  7B          TYPE2:	LD	A,E
 1036 D4CC  FE 80       	CP	80h		; Ende Kassettenpuffer erreicht?
 1037 D4CE  20 09       	JR	NZ,TYPE5	; nein, weiter anzeigen
 1038 D4D0  CD E4C9     TYPE3:	CALL	PV7		; naechsten Block einlesen mit
 1039 D4D3  01          	DB	1		; MBI
 1040 D4D4  38 3F       	JR	C,TYPE10		; Fehler
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  71
CD47    INC

 1041 D4D6  11 B700     TYPE4:	LD	DE,CASS		; Kassettenpuffer zur Entnahme der Daten
 1042 D4D9  1A          TYPE5:	LD	A,(DE)		; Zeichen
 1043 D4DA  1C          	INC	E		; Zeiger auf naechstes Zeichen
 1044 D4DB  FE 03       	CP	3
 1045 D4DD  28 36       	JR	Z,TYPE10	; CAOS-Ende
 1046 D4DF  FE 1A       	CP	1AH
 1047 D4E1  28 32       	JR	Z,TYPE10	; CP/M-Ende
 1048 D4E3  FE 20       	CP	20H
 1049 D4E5  30 1C       	JR	NC,TYPE8	; ASCII-Zeichen
 1050 D4E7  FE 0A       	CP	LF
 1051 D4E9  28 18       	JR	Z,TYPE8
 1052 D4EB  FE 0D       	CP	CR
 1053 D4ED  28 14       	JR	Z,TYPE8
 1054 D4EF  FE 09       	CP	9		; TAB in Space umwandeln
 1055 D4F1  20 0E       	JR	NZ,TYPE7	; andere Steuerzeichen als Punkt anzeigen
 1056 D4F3  3E 20       TYPE6:	LD	A,' '
 1057 D4F5  CD F3D5     	CALL	OCHR
 1058 D4F8  3A B7A0     	LD	A,(CURSO)
 1059 D4FB  E6 07       	AND	7		; TAB-Stopp alle 8 Zeichen
 1060 D4FD  20 F4       	JR	NZ,TYPE6
 1061 D4FF  18 05       	JR	TYPE9
 1062                   	;
 1063 D501  3E 2E       TYPE7:	LD	A,'.'		; statt Steuerzeichen anzeigen
 1064 D503  CD F3D5     TYPE8:	CALL	OCHR
 1065 D506  3A B7A1     TYPE9:	LD	A,(CURSO+1)
 1066 D509  3C          	INC	A
 1067 D50A  21 B79F     	LD	HL,WINLG+1
 1068 D50D  BE          	CP	(HL)		; Seite voll?
 1069 D50E  20 BB       	JR	NZ,TYPE2
 1070 D510  CD D5E4     	CALL	TDUP2		; Eingabe abwarten
 1071 D513  20 AC       	JR	NZ,TYPE1	; auf neuer Seite weiter anzeigen
 1072 D515  CD F4DB     TYPE10:	CALL	CRLF		; noch eine neue Zeile nach dem Text
 1073 D518  18 11       	JR	FCLOSE		; Datei schliessen
 1074                   ;
 1075                   ; Hexadezimele Dateianzeige einer beliebigen Datei (nicht fuer TAPE-Modus)
 1076                   ;
 1077 D51A  7F7F        DUMP7F:	DW	7F7FH
 1078 D51C  44 55 4D 50 	DB	'DUMP'
 1079 D520  1F          	DB	1FH		; Textargument zulaessig (Dateiname)
 1080 D521  CD D5C8     	CALL	TDUP1		; Dateiname in HL
 1081 D524  D8          	RET	C		; TAPE oder BRK
 1082 D525  CD E4C9     	CALL	PV7		; HL = Dateiname
 1083 D528  04          	DB	4		; ISRI (ersten Block einlesen)
 1084 D529  30 25       	JR	NC,DUMP4	; kein Fehler aufgetreten
 1085 D52B  CD E4C9     FCLOSE:	CALL	PV7		; Datei schliessen
 1086 D52E  05          	DB	5		; CSRI
 1087 D52F  CD E4C0     	CALL	CLC		; Kassettenpuffer loeschen
 1088 D532  3A B780     	LD	A,(ARGC)	; urspruenglichen ROM-C Schaltzustand 
 1089 D535  32 B805     	LD	(MODST+5),A	; wieder eintragen
 1090 D538  C3 FB9C     	JP	COFF		; und so schalten -> DUMP-Ende
 1091                   	;
 1092 D53B  3E 0C       DUMP2:	LD	A,0CH		; CLS
 1093 D53D  CD E08C     	CALL	CRT		; CRT damit nicht zu Druckprotokoll!
 1094 D540  3E 0A       	LD	A,LF
 1095 D542  CD E08C     	CALL	CRT		; oben eine Zeile frei lassen
 1096 D545  7B          DUMP3:	LD	A,E
 1097 D546  FE 80       	CP	80h		; Ende Kassettenpuffer erreicht?
 1098 D548  20 09       	JR	NZ,DUMP5	; nein, weiter anzeigen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  72
CD47    INC

 1099 D54A  CD E4C9     	CALL	PV7		; naechsten Block einlesen mit
 1100 D54D  01          	DB	1		; MBI
 1101 D54E  38 DB       	JR	C,FCLOSE	; Fehler
 1102 D550  11 B700     DUMP4:	LD	DE,CASS		; Kassettenpuffer zur Entnahme der Daten
 1103 D553  EB          DUMP5:	EX	DE,HL
 1104 D554  CD F3BC     	CALL	SPACE		; Zeile mit Leerzeichen beginnen
 1105 D557  0E 08       	LD	C,8		; 8 Bytes
 1106 D559  CD D7A9     	CALL	DPME0		; Anzeigen mit der Display-Rutine
 1107 D55C  EB          	EX	DE,HL
 1108 D55D  CD F4DB     	CALL	CRLF		; neue Zeile
 1109 D560  3A B7A1     	LD	A,(CURSO+1)
 1110 D563  3C          	INC	A
 1111 D564  21 B79F     	LD	HL,WINLG+1
 1112 D567  BE          	CP	(HL)		; Seite voll?
 1113 D568  20 DB       	JR	NZ,DUMP3	; nein, weiter anzeigen
 1114 D56A  CD D5E4     	CALL	TDUP2		; Eingabe abwarten
 1115 D56D  28 BC       	JR	Z,FCLOSE	; BRK -> Datei schliessen und Ende
 1116 D56F  18 CA       	JR	DUMP2
 1117                   ;
 1118                   ; Abarbeitung von Kommandos aus einer Datei INITIAL.UUU wie F-Tastencode
 1119                   ; Laufwerksangabe wird hier nicht mehr unterstuetzt, das macht DEP 3.x
 1120                   ; Ablage und Abarbeitung auf Adresse 100h
 1121                   ; Dateigroesse max. 1 Block = 128 Byte !
 1122                   ;
 1123 D571  49 4E 49 54 UUU:	DB	'INITIAL.UUU',0	; Standard-Dateiname
 1124 D57D  7F7F        	DW	7F7FH
 1125 D57F  49 4E 49 54 	DB	'INIT'
 1126 D583  1F          	DB	1FH		; Textargument zulaessig (Dateiname)
 1127 D584  1A          	LD	A,(DE)		; Parameter in Kommandozeile
 1128 D585  E6 DF       	AND	0DFH		; angegeben?
 1129 D587  20 03       	JR	NZ,INIT1	; ja, diesen verwenden
 1130 D589  11 D571     	LD	DE,UUU		; ansonsten Standard-Dateiname INITIAL.UUU
 1131 D58C  CD D5C8     INIT1:	CALL	TDUP1		; Dateiname in HL
 1132 D58F  D8          	RET	C		; TAPE oder BRK
 1133 D590  CD E4C9     	CALL	PV7		; HL = Dateiname
 1134 D593  04          	DB	4		; ISRI (ersten Block einlesen)
 1135 D594  38 95       	JR	C,FCLOSE	; Fehler aufgetreten
 1136 D596  21 B700     	LD	HL,CASS		; Daten aus Kassettenpuffer
 1137 D599  11 A880     	LD	DE,INITU	; hier aufbereiten zur Abarbeitung (A880h)
 1138 D59C  7E          INIT2:	LD	A,(HL)		; Zeichen
 1139 D59D  A7          	AND	A
 1140 D59E  28 13       	JR	Z,INIT3		; 00 ignorieren
 1141 D5A0  FE 03       	CP	3
 1142 D5A2  28 15       	JR	Z,INIT4		; CAOS-Ende
 1143 D5A4  FE 0A       	CP	0AH
 1144 D5A6  28 0B       	JR	Z,INIT3		; LF ignorieren
 1145 D5A8  FE 1A       	CP	1AH
 1146 D5AA  28 0D       	JR	Z,INIT4		; CP/M-Ende
 1147 D5AC  12          	LD	(DE),A		; Zeichen ablegen
 1148 D5AD  1C          	INC	E		; Ziel +1
 1149 D5AE  7B          	LD	A,E
 1150 D5AF  FE 7F       	CP	7FH
 1151 D5B1  28 06       	JR	Z,INIT4		; Pufferende erreicht
 1152 D5B3  2C          INIT3:	INC	L		; Quelle +1
 1153 D5B4  7D          	LD	A,L
 1154 D5B5  FE 80       	CP	80H		; Pufferende?
 1155 D5B7  20 E3       	JR	NZ,INIT2	; weitere Zeichen bearbeiten
 1156 D5B9  AF          INIT4:	XOR	A
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  73
CD47    INC

 1157 D5BA  12          	LD	(DE),A		; Ende-Kennung anhaengen
 1158 D5BB  21 A880     	LD	HL,INITU	; Ablage hier (bei DEP 3.2/3.3 noch ab 100h)
 1159 D5BE  22 B7D1     	LD	(FTAST),HL	; Aktivierung als ob es
 1160 D5C1  DD CB 08 F6 	SET	6,(IX+8)	; eine Funktionstaste waere
 1161 D5C5  C3 D52B     	JP	FCLOSE		; Datei schliessen, CAOS ROM-C wie vorher
 1162                   ;
 1163                   ; UP1 fuer TYPE, DUMP, INIT, ERA: Vorbereitung fuer Datei oeffnen
 1164                   ; PA:	CY=1	Fehler (DEVICE=0 oder BRK)
 1165                   ;
 1166 D5C8  CD ED97     TDUP1:	CALL	DEV1		; DEVICE?
 1167 D5CB  37          	SCF			; Fehlerkennung
 1168 D5CC  C8          	RET	Z		; bei TAPE macht das keinen Sinn...
 1169 D5CD  EB          	EX	DE,HL
 1170 D5CE  7E          	LD	A,(HL)		; erstes Zeichen nach Menuewort holen
 1171 D5CF  E6 DF       	AND	0DFH
 1172 D5D1  CC F567     	CALL	Z,NAME		; Dateiname abfragen falls nicht angegeben
 1173 D5D4  D8          	RET	C		; mit BRK abgebrochen
 1174 D5D5  CD F546     	CALL	KPUFF		; Standardpuffer setzen
 1175 D5D8  3A B805     	LD	A,(MODST+5)	; Schaltzustand Moduladresse 5 (ROM C)
 1176 D5DB  32 B780     	LD	(ARGC),A	; hier merken (zeigt sonst USER-ROM-Zustand an)
 1177 D5DE  3E 01       	LD	A,1		; und voruebergehend fest einschalten
 1178 D5E0  32 B805     	LD	(MODST+5),A
 1179 D5E3  C9          	RET
 1180                   ;
 1181                   ; UP2 fuer TYPE+DUMP: Eingabe bei Seitenende
 1182                   ; PA:	Z=1	BRK
 1183                   ;
 1184 D5E4  CD F3F0     TDUP2:	CALL	INTB
 1185 D5E7  FE 03       	CP	3		; BRK?
 1186 D5E9  C8          	RET	Z		; ja, Datei schliessen und Ende
 1187 D5EA  FE 0F       	CP	0FH		; Hardcopy?
 1188 D5EC  C0          	RET	NZ
 1189 D5ED  CD F3D5     	CALL	OCHR		; Hardcopy zulassen
 1190 D5F0  18 F2       	JR	TDUP2
 1191                   
 1192                   ; DEVICE einstellen, abfragenn oder anzeigen
 1193                   ; PE:	A = Geraetecode 0...7
 1194                   ;		0	Kassette - Standard
 1195                   ;		1	Kassette - Turbo/FAST
 1196                   ;		2	Diskette - D004/D008
 1197                   ;		3	USB (M052)
 1198                   ;		3-7	Anwender-Treiber
 1199                   ;	A = 8		aktuellen Treiber abfragen (ohne Anzeige)
 1200                   ;	A = 9-FE	aktuellen Treiber anzeigen
 1201                   ;	A = FF		Auflisten aller Treiber
 1202                   ; PA:	CY=1	ausgewaehlter Treiber nicht aktiv
 1203                   ;   bei CY=0:	HL	Name des aktuellen Treibers
 1204                   ;	und	Z=1	Treiber ist Kassette
 1205                   ; VR:	AF,BC,DE,HL
 1206                   
 1207 D5F2  FE 08       SET_DD:	CP	8		; Treiber aendern oder nur Name abfragen?
 1208 D5F4  28 1D       	JR	Z,GETDRV	; Treiber nur abfragen
 1209 D5F6  30 26       	JR	NC,DLIST	; Treiber anzeigen
 1210 D5F8  4F          	ld	c,a		; Nr. zum Vergleich merken
 1211 D5F9  87          	ADD	A,A
 1212 D5FA  87          	ADD	A,A		; nach Bits 2..4
 1213 D5FB  DD AE 08    	XOR	(IX+8)
 1214 D5FE  E6 1C       	AND	00011100b	; Bits 0..1 und 5..7 zuruecksetzen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  74
CD47    INC

 1215 D600  DD AE 08    	XOR	(IX+8)		; a = (a XOR b) XOR b fuer Bits 2..4
 1216 D603  47          	ld	b,a		; vorbereiteter neuer Wert fuer IX+8
 1217 D604  E6 1C       	and	00011100b	; nur die Bits 2..4 ausfiltern
 1218 D606  87          	add	a,a
 1219 D607  87          	add	a,a		; *32
 1220 D608  87          	add	a,a
 1221 D609  26 A9       	ld	h,High(devtab)	; = A900H
 1222 D60B  6F          	ld	l,a
 1223 D60C  7E          	ld	a,(hl)
 1224 D60D  B9          	cp	c		; aktiver Treiber?
 1225 D60E  37          	SCF			; Fehlercode
 1226 D60F  C0          	ret	nz		; nein, dann nicht umstellen!
 1227 D610  DD 70 08    	LD	(IX+8),B	; neuen Treiber jetzt eintragen
 1228         0000      if turbo
 1241                   else
 1242                   ;	AND	A			; CY = 0
 1243                   endif
 1244 D613  CD ED90     GETDRV:	CALL	DEV		; aktuelle DEVICE-Nr. ermitteln
 1245 D616  F5          	push	af		; Z-Flag erhalten
 1246 D617  21 A904     	LD	HL,DEVTAB+4	; Zeiger auf String
 1247 D61A  B5          	or	l		; Treibernummer einbauen
 1248 D61B  6F          	ld	l,a		; HL zeigt jetzt auf den Namen
 1249 D61C  F1          	pop	af
 1250 D61D  C9          	ret
 1251                   
 1252                   ; aktuellen Treiber anzeigen (4 Zeichen):
 1253                   
 1254 D61E  3C          DLIST:	INC	A		; A=FFh?
 1255 D61F  28 0F       	jr	z,DLI3		; ja, dann alle Treiber auflisten
 1256 D621  CD D613     	CALL	GETDRV		; DEVICE abfragen
 1257 D624  06 04       DLI1:	ld	b,4		; 4 Zeichen
 1258 D626  7E          DLI2:	ld	a,(hl)
 1259 D627  23          	inc	hl
 1260 D628  FE 20       	cp	20h		; keine Steuerzeichen!
 1261 D62A  D4 F3D5     	call	nc,ochr		; Name des Treibers anzeigen
 1262 D62D  10 F7       	djnz	DLI2
 1263 D62F  C9          	ret
 1264                   
 1265                   ; alle Treiber auflisten:
 1266                   
 1267 D630  21 A900     DLI3:	ld	hl,devtab	; Treiber-Tabelle = A900h
 1268 D633  4D          	ld	c,l		; Beginne mit Treiber Nr. 0
 1269 D634  7E          DLI4:	ld	a,(hl)		; Treibernummer
 1270 D635  B9          	cp	c		; Treiber aktiviert?
 1271 D636  20 12       	jr	nz,DLI5
 1272 D638  23          	inc	hl
 1273 D639  23          	inc	hl
 1274 D63A  23          	inc	hl
 1275 D63B  23          	inc	hl		; Zeiger auf String
 1276 D63C  CD F3CD     	CALL	AHEX0		; Geraetenummer einstellig anzeigen
 1277 D63F  3E 3D       	LD	A,'='
 1278 D641  CD F3D5     	CALL	OCHR
 1279 D644  CD D624     	CALL	DLI1		; Treiber-Name anzeigen
 1280 D647  CD F4DB     	call	CRLF
 1281 D64A  7D          DLI5:	ld	a,l
 1282 D64B  F6 1F       	or	31
 1283 D64D  3C          	inc	a
 1284 D64E  6F          	ld	l,a		; weiter zum naechsten Treiber
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  75
CD47    INC

 1285 D64F  0C          	inc	c		; Nr. erhoehen
 1286 D650  79          	ld	a,c
 1287 D651  FE 08       	cp	8
 1288 D653  20 DF       	jr	nz,DLI4		; Bis alle 8 Treiber erreicht sind
 1289 D655  C9          	ret
 1290                   
 1291                   ; Laufwerkwechsel per ESC-D:
 1292                   
 1293 D656  CD F4DB     ESCDD:	CALL	CRLF		; neue Zeile
 1294 D659  CD D630     	CALL	DLI3		; Treiber auflisten
 1295 D65C  CD F0CF     DLI6:	CALL	OSTR
 1296 D65F  02 3F 00    	DB	2,'?',0		; Eingabeaufforderung anzeigen
 1297 D662  CD F3F6     	CALL	KBD		; Tastatureingabe
 1298 D665  FE 30       	CP	'0'
 1299 D667  38 F3       	JR	C,DLI6		; Eingabewert zu klein!
 1300 D669  FE 38       	CP	'8'
 1301 D66B  30 EF       	JR	NC,DLI6		; zu gross
 1302 D66D  F5          	push	af
 1303 D66E  E6 0F       	AND	0FH
 1304 D670  CD D5F2     	CALL	SET_DD		; Treiber einstellen
 1305 D673  30 03       	jr	nc,DLI7		; kein Fehler
 1306 D675  F1          	pop	af
 1307 D676  18 E4       	jr	DLI6		; wiederholen
 1308                   	;
 1309 D678  F1          DLI7:	pop	af
 1310 D679  CD E08C     	call	crt		; anzeigen
 1311 D67C  C3 F4DB     	jp	crlf		; neue Zeile
 1312                   ;
 1313                   ; Floppy-Treiber Funktion 1: Laufwerkwechsel (DEP 2.0)
 1314                   ; PE:	DE	Zeichenkette neues Laufwerk
 1315                   ;	(DE)=0	Anzeige aktuelles Laufwerk
 1316                   ; PA:	CY=1	Fehler
 1317                   ;
 1318 D67F  01 83F1     DRIVE:	LD	BC,DEPVER	; 083F1H
 1319 D682  ED 78       	IN	A,(C)
 1320 D684  FE 20       	CP	20H		; DEP ab 2.0?
 1321 D686  30 13       	JR	NC,DRIVE1	; OK, Laufwerkwechsel moeglich
 1322 D688  CD F0CF     	CALL	OSTR
 1323 D68B  4B 65 69 6E 	DB	'Kein DEP2!',7,CR,LF,0
 1324 D699  37          	SCF
 1325 D69A  C9          	RET
 1326                   	;
 1327 D69B  EB          DRIVE1:	EX	DE,HL		; LW-Zeichenkette jetzt in HL
 1328 D69C  7E          	LD	A,(HL)
 1329 D69D  E6 DF       	AND	0DFH
 1330 D69F  20 2D       	JR	NZ,DRIVE3	; mit Argument aufgerufen!
 1331 D6A1  CD F0CF     	CALL	OSTR
 1332 D6A4  44 72 69 76 	DB	'Drive:',0
 1333 D6AB  3E 01       	LD	A,1		; aktuell lesen
 1334 D6AD  CD D183     	CALL	STEUB2
 1335 D6B0  01 81F1     	LD	BC,LWANF	; 081F1H
 1336 D6B3  ED 78       	IN	A,(C)
 1337 D6B5  CD F3D5     	CALL	OCHR		; Laufwerk anzeigen
 1338 D6B8  04          	INC	B		; 082F1H
 1339 D6B9  ED 78       	IN	A,(C)		; aktueller User-Bereich
 1340 D6BB  E6 0F       	AND	0FH
 1341 D6BD  C4 F3CD     	CALL	NZ,AHEX0	; Userbereich hex anzeigen
 1342 D6C0  3E 06       	LD	A,6
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  76
CD47    INC

 1343 D6C2  32 B7A0     	LD	(CURSO),A
 1344 D6C5  CD F499     	CALL	INLIN		; Eingabe
 1345 D6C8  3F          	CCF
 1346 D6C9  D0          	RET	NC		; BRK
 1347 D6CA  21 0006     	LD	HL,6
 1348 D6CD  19          	ADD	HL,DE
 1349 D6CE  01 81F1     DRIVE3:	LD	BC,LWANF	; 081F1H
 1350 D6D1  7E          	LD	A,(HL)
 1351 D6D2  A7          	AND	A		; leer?
 1352 D6D3  C8          	RET	Z
 1353 D6D4  CD F53D     	CALL	UPCASE
 1354 D6D7  ED 79       	OUT	(C),A		; LW-Code
 1355 D6D9  23          	INC	HL
 1356 D6DA  7E          	LD	A,(HL)
 1357 D6DB  A7          	AND	A		; USER mit angegeben?
 1358 D6DC  3E 03       	LD	A,3		; nur LW anfordern
 1359 D6DE  28 10       	JR	Z,DRIVE5
 1360 D6E0  EB          	EX	DE,HL
 1361 D6E1  CD F4EB     	CALL	RHEX
 1362 D6E4  3E 00       	LD	A,0		; USER 0, weil
 1363 D6E6  38 03       	JR	C,DRIVE4	; keine HEX-Zahl
 1364 D6E8  3A B797     	LD	A,(NUMVX)
 1365 D6EB  04          DRIVE4:	INC	B		; 082F1H
 1366 D6EC  ED 79       	OUT	(C),A		; USER-Nr.
 1367 D6EE  3E 07       	LD	A,7		; LW+User anfordern
 1368 D6F0  CD D183     DRIVE5:	CALL	STEUB2		; Stack-Unwinding:
 1369 D6F3  C9          	RET			; nicht in JP umwandeln!
 1370                   
 1371                   ; Geraetetreiber-Funktion aufrufen
 1372                   ; PE:	A	Funktionsnummer
 1373                   ;		0 = DIR bzw. TAPELIST
 1374                   ;		1 = DRIVE oder CD
 1375                   ;		2 = ERA (Datei loeschen)
 1376                   ;		3 = REN (Datei umbenennen)
 1377                   ;		?? (SETWR, SETRO)
 1378                   ;	DE	Dateiname bzw. Maske
 1379                   ; PA:		entsprechend Treiber
 1380                   ; VR:	AF,BC,DE,HL
 1381                   
 1382 D6F4  E6 03       FKT_DD:	and	3		; nur Treiberfunktionen 0..3 definiert
 1383 D6F6  4F          	ld	c,a
 1384 D6F7  CD ED90     	CALL	DEV		; DEVICE-Nr. in Bit 2-4
 1385 D6FA  81          	add	a,c		; FKT-Nummer dazu
 1386 D6FB  81          	add	a,c
 1387 D6FC  4F          	ld	c,a
 1388 D6FD  06 00       	ld	b,0
 1389 D6FF  21 A918     	ld	HL,DEVTAB+24	; DIR-Kommando des jeweiligen Treibers
 1390 D702  09          	ADD	HL,BC
 1391 D703  7E          	LD	A,(HL)
 1392 D704  23          	INC	HL
 1393 D705  66          	LD	H,(HL)		; Aus Treibertabelle ermitteln
 1394 D706  6F          	LD	L,A
 1395 D707  E9          	JP	(HL)		; und anspringen
 1396                   ;
 1397                   ; TAPELIST = DIR-Kommando fuer Kassette
 1398                   ;
 1399 D708  CD F0CF     TLIST:	CALL	OSTR
 1400 D70B  54 61 70 65 	DB	'Tape-Directory:',CR,LF,0
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  77
CD47    INC

 1401 D71D  21 0000     	ld	hl,0
 1402 D720  22 B797     	ld	(NUMVX),hl	; Zaehler fuer angezeigte Dateien
 1403 D723  DB 88       	IN	A,(PIOAD)
 1404 D725  F6 60       	OR	01100000b	; Motor+LED ein
 1405 D727  D3 88       	OUT	(PIOAD),A
 1406 D729  3E 0A       	LD	A,10
 1407 D72B  CD E2A3     	CALL	WAIT		; 60ms warten (Bandanlauf)
 1408 D72E  CD F546     	CALL	KPUFF		; Standard-Puffer einstellen
 1409 D731  DD 36 03 01 TLW:	LD	(IX+3),1	; Block Nr. 1 erwarten
 1410 D735  CD E4C9     	CALL	PV7
 1411 D738  01          	DB	1		; MBI
 1412 D739  38 39       	JR	C,TLBRK		; Fehler aufgetreten
 1413 D73B  DD 7E 02    	LD	A,(IX+2)
 1414 D73E  3D          	DEC	A
 1415 D73F  28 08       	JR	Z,TL01		; Block Nr. 1 gefunden
 1416 D741  CD F0C9     	CALL	BNROST
 1417 D744  2A          	DB	'*'		; falsche Blocknummer
 1418 D745  19 00       	DB	19H,0
 1419 D747  18 2B       	JR	TLBRK
 1420                   	;
 1421 D749  CD F63C     TL01:	CALL	LUP3		; Name aus Vorblock anzeigen
 1422 D74C  2A B797     	ld	hl,(NUMVX)
 1423 D74F  23          	inc	hl		; angezeigte Dateien mitzaehlen
 1424 D750  22 B797     	ld	(NUMVX),HL
 1425 D753  3A B710     	LD	A,(CASS+10H)	; Anzahl der Argumente
 1426 D756  D6 02       	SUB	2
 1427 D758  FE 08       	CP	8		; 2 bis 10 Argumente?
 1428 D75A  30 15       	JR	NC,TLNO		; keine MC-Datei!
 1429 D75C  2A B711     	LD	HL,(CASS+11H)	; AADR
 1430 D75F  ED 5B B713  	LD	DE,(CASS+13H)	; EADR+1
 1431 D763  CD F4E2     	CALL	HLDE		; Anfangsadresse und Endadresse anzeigen
 1432 D766  2A B715     	LD	HL,(CASS+15H)	; SADR
 1433 D769  3A B710     	LD	A,(CASS+10H)
 1434 D76C  FE 03       	CP	3
 1435 D76E  D4 F3B4     	CALL	NC,HLHX		; Startadresse anzeigen
 1436 D771  CD F4DB     TLNO:	CALL	CRLF		; Zeilenvorschub nach Dateiname + Adressen
 1437 D774  CD E37C     TLBRK:	CALL	BRKT
 1438 D777  30 B8       	JR	NC,TLW		; wiederholen bis BRK gedrueckt wird
 1439 D779  DB 88       TLX:	IN	A,(PIOAD)
 1440 D77B  E6 9F       	AND	10011111b	; Motor+LED aus
 1441 D77D  D3 88       	OUT	(PIOAD),A
 1442 D77F  2A B797     	ld	hl,(NUMVX)	; Anzahl Dateien zurueck geben
 1443 D782  C9          	RET
 1444                   ;
 1445                   ; Kassette ein/aus (CD im Tape-Mode)
 1446                   ;
 1447 D783  DB 88       MOT:	IN	A,(PIOAD)
 1448 D785  EE 40       	XOR	01000000b	; Motor ein/aus
 1449 D787  D3 88       	OUT	(PIOAD),A
 1450 D789  C9          	RET
 1451                   ;
 1452                   ; BASIC-Dateiname ab NAME im Format 8.3 kopieren
 1453                   ;
 1454                   ; PE:	HL	Zeiger auf Dateiname im BASIC-Format = SSSName
 1455                   ;
 1456                   ; PA:	FNAME	Dateiname 8.3-Format = Name.SSS
 1457                   ;
 1458                   ; VR:	BC, AF
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  78
CD47    INC

 1459                   ;
 1460 D78A  E5          BNAME:	PUSH	HL
 1461 D78B  D5          	PUSH	DE
 1462 D78C  E5          	push	hl		; Beginn Dateityp merken
 1463 D78D  23          	inc	hl
 1464 D78E  23          	inc	hl
 1465 D78F  23          	inc	hl		; mit Name beginnen
 1466 D790  11 B7F5     	ld	de,FNAME	; Ablage Dateiname im IRM
 1467 D793  01 0008     	ld	bc,8
 1468 D796  ED B0       	ldir			; Name direkt kopieren
 1469 D798  E1          	pop	hl
 1470 D799  06 03       	ld	b,3
 1471 D79B  7E          bnam2:	ld	a,(hl)
 1472 D79C  23          	inc	hl
 1473 D79D  E6 7F       	and	7fh		; bei Dateityp Bit 7 ruecksetzen
 1474 D79F  12          	ld	(de),a
 1475 D7A0  13          	inc	de
 1476 D7A1  10 F8       	djnz	bnam2
 1477 D7A3  D1          	POP	DE
 1478 D7A4  E1          	POP	HL
 1479 D7A5  C9          	RET
 1480                   
 1481                   ; Ausgabe einer Displayzeile
 1482                   ; HL=Adresse, C=Anzahl Bytes
 1483                   
 1484 D7A6  CD F3B4     DPMEMO:	CALL	HLHX		; Adresse
 1485 D7A9  E5          DPME0:	PUSH	HL		; Hier Einsprung von DUMP-Routine
 1486 D7AA  41          	LD	B,C
 1487 D7AB  CD FB80     DPME1:	CALL	LDAME		; Byte holen
 1488 D7AE  23          	INC	HL
 1489 D7AF  CD F3B9     	CALL	AHSPC		; anzeigen
 1490 D7B2  10 F7       	DJNZ	DPME1		; C*
 1491 D7B4  E1          	POP	HL
 1492 D7B5  41          	LD	B,C
 1493 D7B6  3E 09       	LD	A,9
 1494 D7B8  CD F3D5     	CALL	OCHR		; CUR
 1495 D7BB  CD FB80     DPME2:	CALL	LDAME		; Byte holen
 1496 D7BE  23          	INC	HL
 1497 D7BF  CD F7B5     	CALL	CSTBT		; als ASCII
 1498 D7C2  10 F7       	DJNZ	DPME2		; C*
 1499 D7C4  C9          	RET
 1500                   
 1501                   ; Grafiksteuersequenzen fuer die Drucker
 1502                   
 1503 D7C5  0A          C6313:	DB	10		; Laenge
 1504 D7C6  0D 09       	DB	CR,9
 1505 D7C8  1B 4A 18    	DB	ESC,'J',24
 1506 D7CB  1B 2A 05    	DB	ESC,'*',5
 1507 D7CE  0140        	DW	320
 1508                   
 1509 D7D0  0A          C6314:	DB	10		; Laenge
 1510 D7D1  0D 09       	DB	CR,9
 1511 D7D3  1B 4A 18    	DB	ESC,'J',24
 1512 D7D6  1B 2A 05    	DB	ESC,'*',5
 1513 D7D9  0280        	DW	640
 1514                   
 1515 D7DB  0E          C6311:	DB	14		; Laenge
 1516 D7DC  1B 5B 30 31 	DB	ESC,'[01e'
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  79
CD47    INC

 1517 D7E1  1B 5B 31 32 	DB	ESC,'[12`'
 1518 D7E6  1B 4B       	DB	ESC,'K'
 1519 D7E8  0140        	DW	320
 1520                   
 1521 D7EA  0E          C6312:	DB	14		; Laenge
 1522 D7EB  1B 5B 30 31 	DB	ESC,'[01e'
 1523 D7F0  1B 5B 31 32 	DB	ESC,'[12`'
 1524 D7F5  1B 4B       	DB	ESC,'K'
 1525 D7F7  0280        	DW	640
 1526                   
 1527 D7F9  09          C6304:	DB	9		; Laenge
 1528 D7FA  0D 09       	DB	CR,9
 1529 D7FC  1B 4A 18    	DB	ESC,'J',24
 1530 D7FF  1B 4B       	DB	ESC,'K'
 1531 D801  0140        	DW	320
 1532                   
 1533 D803  0A          CMINI:	DB	10		; Laenge
 1534 D804  0D 09       	DB	CR,9
 1535 D806  1B 4A 18    	DB	ESC,'J',24
 1536 D809  1B 2A 27    	DB	ESC,'*',39
 1537 D80C  0140        	DW	320
 1538                   
 1539 D80E  0A          C24N1:	DB	10		; Laenge
 1540 D80F  0D 09       	DB	CR,9
 1541 D811  1B 4A 18    	DB	ESC,'J',24
 1542 D814  1B 2A 00    	DB	ESC,'*',0
 1543 D817  0140        	DW	320
 1544                   
 1545 D819  0A          C24N2:	DB	10		; Laenge
 1546 D81A  0D 09       	DB	CR,9
 1547 D81C  1B 4A 18    	DB	ESC,'J',24
 1548 D81F  1B 2A 27    	DB	ESC,'*',39
 1549 D822  03C0        	DW	960
 1550                   
 1551                   ; V.24-Tabellen, zum Kopieren in den IRM ab A800H:
 1552                   
 1553 D824  00          V24TAB:	DB	0		; Steckplatz M003 (Aktualisierung durch Suche)
 1554                   
 1555                   ; Kanal 1 - Druckerausgabe (9600 Baud)
 1556 D825  47          	DB	01000111b	; CTC: DI, Zaehler, neg. Flanke, RESET
 1557 D826  5B          	DB	91		; Zeitkonstante
 1558 D827  04 04       	DB	4,00000100b	; WR4: Vorteiler=1, 1 Stop-Bit, ohne Paritaet
 1559 D829  03 20       	DB	3,00100000b	; WR3: Empfaenger aus, CTS+DCD-Steuerung
 1560 D82B  05 6A       	DB	5,01101010b	; WR5: Sender ein, 8Bit, /DTR=1, RTS=1
 1561                   
 1562                   ; Kanal 2 - Duplex (1200 Baud)
 1563 D82D  47          	DB	01000111b	; CTC: DI, Zaehler, neg. Flanke, RESET
 1564 D82E  2E          	DB	46		; Zeitkonstante
 1565 D82F  18          	DB	00011000b	; Port-RESET
 1566 D830  04 44       	DB	4,01000100b	; WR4: Vorteiler=16, 1 Stop-Bit, ohne Paritaet
 1567 D832  03 E1       	DB	3,11100001b	; WR3: Empfaenger ein, 8Bit, CTS+DCD-Steuerung
 1568 D834  05 6A       	DB	5,01101010b	; WR5: Sender ein, 8Bit, /DTR=1, RTS=1
 1569                   
 1570                   ; Initialisierung SIO-B fuer Empfangs-Interrupt (1200 Baud):
 1571                   
 1572 D836  02          V24UMT:	DB	2		; 2 Ports
 1573 D837  0D 02       	 DB	0Dh,2		; CTC1
 1574 D839  47          	  DB	01000111b	; DI, Zaehler, neg. Flanke, ZK folgt, RESET
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  80
CD47    INC

 1575 D83A  2E          	  DB	46		; Zeitkonstante
 1576 D83B  0B 0B       V24INT:	 DB	0Bh,11		; SIO-B Steuerwort
 1577 D83D  18          	  DB	00011000b	; Port-RESET
 1578 D83E  02 E2       	  DB	2,0E2h		; WR2: INT-Vektor
 1579 D840  04 44       	  DB	4,01000100b	; WR4: Vorteiler=16, 1 Stop-Bit, ohne Paritaet
 1580 D842  03 E1       	  DB	3,11100001b	; WR3: Empfaenger ein, 8Bit, CTS/DCD-Steuerung
 1581 D844  05 EA       	  DB	5,11101010b	; WR5: Sender ein, 8Bit, /DTR=0 (bereit), RTS=1
 1582 D846  11 18       	  DB	11h,00011000b	; WR1: Interrupt bei Zeichenempfang
 1583                   
 1584                   ; Initialisierung SIO-B fuer Polling-Betrieb:
 1585                   
 1586 D848  0B 07       V24POL:	DB	0Bh,7		; SIO-B Steuerwort, 7 Byte
 1587 D84A  18          	 DB	00011000b	; Port RESET
 1588 D84B  04 44       	 DB	4,01000100b	; Vorteiler 16, 1 Stop-Bit, ohne Paritaet
 1589 D84D  03 E1       	 DB	3,11100001b	; Empfaenger ein, 8 Bit, CTS/DCD-Steuerung
 1590 D84F  05 6A       	 DB	5,01101010b	; Sender ein, 8 Bit, DTR aus, RTS ein
 1591                   ;
 1592                   ; Unterprogrammtabelle (wird seit CAOS 4.6 in IRM kopiert):
 1593                   ;
 1594 D851  E08C        SUTB:	DW	CRT	; 00
 1595 D853  E576        	DW	MBO	; 01
 1596 D855  B7BD        	DW	UOUT1	; 02
 1597 D857  B7C3        	DW	UOUT2	; 03
 1598 D859  F3F6        	DW	KBD	; 04
 1599 D85B  E57B        	DW	MBI	; 05
 1600 D85D  B7C0        	DW	UIN1	; 06
 1601 D85F  B7C6        	DW	UIN2	; 07
 1602 D861  E580        	DW	ISRO	; 08
 1603 D863  E585        	DW	CSRO	; 09
 1604 D865  E58A        	DW	ISRI	; 0A
 1605 D867  E58F        	DW	CSRI	; 0B
 1606 D869  E368        	DW	KBDS	; 0C
 1607 D86B  F166        	DW	BYE	; 0D
 1608 D86D  E373        	DW	KBDZ	; 0E
 1609 D86F  F7AF        	DW	COLR	; 0F
 1610 D871  F6C6        	DW	LOAD	; 10
 1611                   
 1612 D873  F6AF        	DW	VERIF	; 11
 1613 D875  F269        	DW	LOOP	; 12
 1614 D877  F389        	DW	NORM	; 13
 1615 D879  E2A3        	DW	WAIT	; 14
 1616 D87B  F5FF        	DW	LARG	; 15
 1617 D87D  F3F0        	DW	INTB	; 16
 1618 D87F  F499        	DW	INLIN	; 17
 1619 D881  F4EB        	DW	RHEX	; 18
 1620 D883  F4D1        	DW	ERRM	; 19
 1621 D885  F3B4        	DW	HLHX	; 1A
 1622 D887  F4E2        	DW	HLDE	; 1B
 1623 D889  F3C4        	DW	AHEX	; 1C
 1624 D88B  F35A        	DW	ZSUCH	; 1D
 1625 D88D  F38F        	DW	SOUT	; 1E
 1626 D88F  F39C        	DW	SIN	; 1F
 1627                   
 1628 D891  F38C        	DW	NOUT	; 20
 1629 D893  F399        	DW	NIN	; 21
 1630 D895  F520        	DW	GARG	; 22
 1631 D897  F0CF        	DW	OSTR	; 23
 1632 D899  F3D5        	DW	OCHR	; 24
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  81
CD47    INC

 1633 D89B  F822        	DW	CUCP	; 25
 1634 D89D  F104        	DW	MODU	; 26
 1635 D89F  F11D        	DW	JUMP	; 27
 1636 D8A1  E2D4        	DW	LDMA	; 28
 1637 D8A3  E2D6        	DW	LDAM	; 29
 1638 D8A5  E37C        	DW	BRKT	; 2A
 1639 D8A7  F3BC        	DW	SPACE	; 2B
 1640 D8A9  F4DB        	DW	CRLF	; 2C
 1641 D8AB  F3C0        	DW	HOME	; 2D
 1642 D8AD  F7DD        	DW	MODI	; 2E
 1643 D8AF  F858        	DW	PUDE	; 2F
 1644                   
 1645 D8B1  F850        	DW	PUSE	; 30
 1646 D8B3  FB96        	DW	SIXD	; 31
 1647 D8B5  E068        	DW	DABR	; 32
 1648 D8B7  E05C        	DW	TCIF	; 33
 1649 D8B9  E04C        	DW	PADR	; 34
 1650 D8BB  F90C        	DW	TON	; 35
 1651 D8BD  F585        	DW	SAVE	; 36
 1652                   	; bis hier in HC900-CAOS, CAOS 2.2 und 2.3 enthalten
 1653 D8BF  F871        	DW	MBIN	; 37 - Byteweise Eingabe fuer BASIC
 1654 D8C1  F879        	DW	MBOUT	; 38 - Byteweise Ausgabe fuer BASIC
 1655 D8C3  F81A        	DW	KEY	; 39
 1656 D8C5  F811        	DW	KEYLI	; 3A
 1657 D8C7  F7CC        	DW	DISP	; 3B
 1658 D8C9  F7F7        	DW	WININ	; 3C
 1659 D8CB  F7FF        	DW	WINAK	; 3D
 1660                   	; bis hier in CAOS 2.4 und 2.5 enthalten
 1661 D8CD  F868        	DW	LINE	; 3E
 1662 D8CF  F860        	DW	CIRCL	; 3F
 1663                   
 1664 D8D1  ED8A        	DW	SQR	; 40
 1665 D8D3  FBAC        	DW	MULT	; 41
 1666 D8D5  F7B5        	DW	CSTBT	; 42
 1667                   	; bis hier in HC901-CAOS enthalten
 1668 D8D7  F54F        	DW	INIEA	; 43
 1669 D8D9  F561        	DW	INIME	; 44
 1670 D8DB  F906        	DW	ZKOUT	; 45
 1671 D8DD  F1FC        	DW	MENU	; 46
 1672                   	; bis hier in CAOS 3.1, 3.3, 3.4 und OS/PI'88/'90 enthalten
 1673 D8DF  F9B9        	DW	V24OUT	; 47 - Initialisierung Druckerausgabe
 1674 D8E1  F9E1        	DW	V24DUP	; 48 - Initialisierung V.24-Duplexbetrieb
 1675                   	; bis hier in CAOS 4.1 bis 4.5 enthalten
 1676 D8E3  FBD7        	DW	SETDEV	; 49 - Speichergeraet einstellen/anzeigen
 1677 D8E5              SUEND:	; bis hier in CAOS 4.6 und 4.7 enthalten
 1678                   
 1679                   ; CAOS 4.6 - Sprungtabelle Treiber Nr. 0 - Kassette
 1680                   
 1681 D8E5  FF          DRV0:	DB	-1		; Kennung (Vorgabe = nicht aktiv)
 1682 D8E6  05          	DB	5		; Treiber befindet sich in CAOS ROM-C
 1683 D8E7  00 01       	DB	0,1		; SWITCH-Befehl aus/ein
 1684 D8E9  54 41 50 45 	DB	'TAPE'		; Name des Treibers
 1685 D8ED  D00F        	DW	TMBO		; 01 Ausgabe Datenblock 128 Byte
 1686 D8EF  D072        	DW	TMBI		; 05 Einlesen Datenblock 128 Byte
 1687 D8F1  D000        	DW	TISRO		; 08 Ausgabedatei oeffnen und ersten Block 01h ausgeben
 1688 D8F3  E476        	DW	TCSRO		; 09 Ausgabedatei schliessen und Endeblock FFh ausgeben
 1689 D8F5  D06F        	DW	TISRI		; 0A Eingabedatei oeffnen und Block 01 einlesen
 1690 D8F7  E47D        	DW	TCSRI		; 0B Eingabedatei schliessen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  82
CD47    INC

 1691 D8F9  F4BF        	DW	NOOP		;
 1692 D8FB  F4BF        	DW	NOOP		;
 1693 D8FD  D708        	DW	TLIST		; DIR = TAPELIST
 1694 D8FF  D783        	DW	MOT		; CD  = Kassette ein/aus (statt Laufwerkwechsel)
 1695 D901  F303        	DW	ERR1		; ERA - nicht vorgesehen
 1696 D903  F303        	DW	ERR1		; REN - nicht vorgesehen
 1697                   
 1698         0000      if turbo
 1723                   else
 1724                   
 1725                   ; CAOS 4.6 - Sprungtabelle Treiber Nr. 1 Diskette D004/D008
 1726                   
 1727 D905  01          DRV1:	DB	1		; Kennung (Treiber Nr. 1)
 1728                   endif
 1729 D906  05          	DB	5		; Treiber befindet sich in CAOS ROM-C
 1730 D907  00 01       	DB	0,1		; SWITCH-Befehl aus/ein
 1731 D909  44 49 53 4B 	DB	'DISK'		; Name des Treibers
 1732 D90D  D12E        	DW	FMBO		; 01 Ausgabe Datenblock 128 Byte
 1733 D90F  D104        	DW	FMBI		; 05 Einlesen Datenblock 128 Byte
 1734 D911  D124        	DW	FISRO		; 08 Ausgabedatei oeffnen und ersten Block 01h ausgeben
 1735 D913  D188        	DW	FCSRO		; 09 Ausgabedatei schliessen und Endeblock FFh ausgeben
 1736 D915  D0F6        	DW	FISRI		; 0A Eingabedatei oeffnen und Block 01 einlesen
 1737 D917  D120        	DW	FCSRI		; 0B Eingabedatei schliessen
 1738 D919  F4BF        	DW	NOOP		;
 1739 D91B  F4BF        	DW	NOOP		;
 1740 D91D  D35A        	DW	FDIR		; DIR = Verzeichnisanzeige mit Maske
 1741 D91F  D67F        	DW	DRIVE		; CD  = Laufwerkwechsel
 1742 D921  D412        	DW	FERA		; ERA = Datei loeschen
 1743 D923  D455        	DW	FREN		; REN = Datei umbenennen
 1744                   ;
 1745                   ; Portinitialisierungstabellen:
 1746                   ;
 1747         0000      if SYSROM
 1749                   else
 1750 D925  07          IOTAB1:	DB	7		; 7 Ports fuer Erstinitialisierung
 1751                   endif
 1752                   ; Bei Erstinitialisierung des PIO-Port-A muss sichergestellt werden, dass der
 1753                   ; CAOS-ROM-E immer im Zugriff bleibt. Im Einschaltzustand sind die PIO-Ports
 1754                   ; hochohmig und werden ueber Pull-Up-Widerstaende auf High gezogen, deshalb:
 1755                   ; 1. Interruptvektor einschreiben und PIO aus dem RESET-Zustand holen
 1756                   ;    (nur so wird das Ausgaberegister beschreibbar)
 1757                   ; 2. Datenwort einschreiben
 1758                   ; 3. Betriebsart Byte-Ausgabe einstellen um das Datenwort zu uebernehmen.
 1759                   ; Der RESET-Impuls zur D005-Tastatur wirkt nur, wenn die PIO bereits vorher
 1760                   ; auf Byte-Ausgabe initialisiert ist (also nur bei RESET, nicht bei POWER-ON)
 1761 D926  8A 01       	 DB	PIOAS,1		; PIO-A Steuerwort
 1762 D928  E4          	  DB	0E4h		; Interruptvektor
 1763                   
 1764 D929  88 02       	 DB	PIOAD,2		; PIO-A Daten
 1765 D92B  1F          	  DB	00011111b	; D005-Reset
 1766 D92C  0F          	  DB	00001111b	; IRM ein, RAM0 WR ein, CAOS-E ein, USER-ROM aus
 1767                   
 1768 D92D  8A 02       	 DB	PIOAS,2		; PIO-A Steuerwort
 1769 D92F  0F          	  DB	00001111b	; Byte-Ausgabemodus
 1770 D930  03          	  DB	00000011b	; DI
 1771                   
 1772 D931  8B 03       	 DB	PIOBS,3		; PIO-B Steuerwort
 1773 D933  E6          	  DB	0E6h		; Interruptvektor
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  83
CD47    INC

 1774 D934  0F          	  DB	00001111b	; Byte-Ausgabemodus
 1775 D935  83          	  DB	10000011b	; EI
 1776                   
 1777 D936  89 01       	 DB	PIOBD,1		; PIO-B Daten
 1778 D938  FF          	  DB	0FFh		; Daten
 1779                   
 1780 D939  84 01       	 DB	PORT1,1		; Ausgabeport 84h
 1781 D93B  28          	  DB	00101000b	; RAM8 0, LoRes
 1782         0000      iff SYSROM
 1783 D93C  86 01       	 DB	PORT2,1		; Ausgabeport 86h
 1784 D93E  E3          	  DB	11100011b	; RAM4 ein, USER-C 3, CAOS-C ein
 1785                   endif
 1786 D93F  04          IOTAB2:	DB	4		; 4 Ports initialisieren
 1787                   
 1788 D940  8A 01       	 DB	PIOAS,1		; PIO-A Steuerwort
 1789 D942  E4          	  DB	0E4h		; Interruptvektor
 1790                   
 1791 D943  8B 01       	 DB	PIOBS,1		; PIO-B Steuerwort
 1792 D945  E6          	  DB	0E6h		; Interruptvektor
 1793                   
 1794 D946  8C 01       	 DB	CTC0,1		; CTC Kanal 0
 1795 D948  E8          	  DB	0E8h		; Interruptvektor
 1796                   
 1797 D949  8E 02       	 DB	CTC2,2		; CTC Kanal 2: blinken
 1798 D94B  47          	  DB	01000111b	; DI, Zaehler, RESET
 1799 D94C  0C          	  DB	12		; Zeitkonstante
 1800                   
 1801                   ; Initialisierungstabelle fuer M001 als Centronics-Druckerschnittstelle:
 1802                   ;
 1803 D94D  03          DIOINI:	DB	3
 1804 D94E  06 02       	 DB	06h,2		; PIO-A Steuerwort
 1805 D950  CF          	  DB	11001111b	; Bitbetrieb
 1806 D951  00          	  DB	00000000b	; alles Ausgaenge
 1807 D952  07 02       	 DB	07h,2		; PIO-B Steuerwort
 1808 D954  CF          	  DB	11001111b	; Bitbetrieb
 1809 D955  FE          	  DB	11111110b	; Bit 0 Ausgang
 1810 D956  05 01       	 DB	05h,1		; PIO-B Daten
 1811 D958  01          	  DB	00000001b	; Strobe passiv
 1812                   
 1813                   ; Voreingestellte Zuordnung von Joystickfunktionen zu ASCII-Tastencodes
 1814                   ; Tabelle wird bei Power-On in den IRM kopiert, Bereich A894..A89F
 1815                   ; Hinweis: Fire2 ist beim M008 die primaere oder einzige Feuertaste
 1816                   ;
 1817 D959  02          JOYTBD:	DB	2		; Wartezyklen fuer Tastenwiederholung
 1818 D95A  0B          	DB	0Bh		; Up
 1819 D95B  0A          	DB	0Ah		; Down
 1820 D95C  0D          	DB	CR		; Fire+Fire2
 1821 D95D  08          	DB	08h		; Left
 1822 D95E  00          	DB	0		; Up+Left
 1823 D95F  00          	DB	0		; Down+Left
 1824 D960  0D          	DB	CR		; Fire
 1825 D961  09          	DB	09h		; Right
 1826 D962  00          	DB	0		; Up+Right
 1827 D963  00          	DB	0		; Down+Right
 1828 D964  20          	DB	' '		; Fire2
 1829                   ;
 1830                   ; Interrupttabelle (wird in den RAM kopiert):
 1831                   ;
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  84
CD47    INC

 1832 D965  E3D5        ISRTAB:	DW	ISRJ	; (IX-16) M008 PIO A: Joystick
 1833 D967  FA90        	DW	ISRSB	; (IX-14) M003 SIO B: V.24-Empfang
 1834 D969  E5A4        	DW	ISRPA	; (IX-12) PIO A: Kassette
 1835 D96B  E2ED        	DW	ISRPB	; (IX-10) PIO B: Tastatur
 1836 D96D  E5B3        	DW	IRET	; (IX-8)  CTC 0: frei (TEMO Schrittbetrieb)
 1837 D96F  E594        	DW	ISRC1	; (IX-6)  CTC 1: Kassette
 1838 D971  EDAC        	DW	ISRC2	; (IX-4)  CTC 2: Tondauer
 1839 D973  E2E1        	DW	ISRC3	; (IX-2)  CTC 3: Tastatur
 1840                   ;
 1841                   ; IBM-Kodierungen fuer allgemeine Druckroutine PRINTC
 1842                   ;
 1843 D975  7B 7C 7D 7E ZIBM:	DB	7BH,7CH,7DH,7EH
 1844 D979  5B 5C 5D    	DB	5BH,5CH,5DH
 1845 D97C  84 94 81 E1 	DB	84H,94H,81H,0E1H
 1846 D980  8E 99 9A    	DB	8EH,99H,9AH
 1847                   
 1848                   ; Anzeige der CAOS-Version mit Datum
 1849                   
 1850 D983  7F7F        HELP7F:	DW	7F7FH
 1851 D985  68 65 6C 70 	DB	'help'
 1852 D989  01          	DB	1
 1853 D98A  CD F0CF     	CALL	OSTR
 1854 D98D  20 4B 43 2D 	DB	' KC-Club CAOS 4.7 '
 1855         0000      if beta
 1857                   endif
 1858                   	DATUM			; Versionsdatum
    1 D99F  31 30 2E 30 	DB	'10.04.2019'	; Versionsdatum nur hier aendern!
 1859 D9A9  0D 0A 00    	DB	CR,LF,0
 1860 D9AC  C9          	RET
 1861                   
 1862                   	ABSFILL	0DAB8h,<ROM-D-Ende>
    7 D9AD  FF FF FF FF 	  DS	0DAB8h - $,0FFh
  194                   	INCLUDE	ZSIBM.INC	; IBM-Zeichensatz
    1                   ;*****************************************
    2                   ;**	CAOS 4.7 IBM-Zeichensatz	**
    3                   ;**					**
    4                   ;**	Adresse:  DAB8h bis DFFFh	**
    5                   ;**					**
    6                   ;**	letzte Aenderung: 05.02.2018	**
    7                   ;*****************************************
    8                   ;
    9                   ; 05.02.2018 geaendert (alle Zeichen links/oben und breite Pfeile):
   10                   ; Codes fuer 1Ah, 1Bh, 1Dh, E4h, E8h, EFh
   11                   
   12 DAB8  78 60 60 60 	DB	078H, 060H, 060H, 060H, 060H, 060H, 078H, 000H	; 5BH
   13 DAC0  C0 60 30 18 	DB	0C0H, 060H, 030H, 018H, 00CH, 006H, 002H, 000H	; 5CH
   14 DAC8  78 18 18 18 	DB	078H, 018H, 018H, 018H, 018H, 018H, 078H, 000H	; 5DH
   15 DAD0  30 30 18 00 	DB	030H, 030H, 018H, 000H, 000H, 000H, 000H, 000H	; 60H
   16 DAD8  1C 30 30 E0 	DB	01CH, 030H, 030H, 0E0H, 030H, 030H, 01CH, 000H	; 7BH
   17 DAE0  18 18 18 00 	DB	018H, 018H, 018H, 000H, 018H, 018H, 018H, 000H	; 7CH
   18 DAE8  E0 30 30 1C 	DB	0E0H, 030H, 030H, 01CH, 030H, 030H, 0E0H, 000H	; 7DH
   19 DAF0  76 DC 00 00 	DB	076H, 0DCH, 000H, 000H, 000H, 000H, 000H, 000H	; 7EH
   20 DAF8  00 10 38 6C 	DB	000H, 010H, 038H, 06CH, 0C6H, 0C6H, 0FEH, 000H	; 7FH
   21                   
   22 DB00  00 00 00 00 	DB	000H, 000H, 000H, 000H, 000H, 000H, 081H, 0FFH	; 00H
   23 DB08  7E 81 A5 81 	DB	07EH, 081H, 0A5H, 081H, 0BDH, 099H, 081H, 07EH	; 01H
   24 DB10  7E FF DB FF 	DB	07EH, 0FFH, 0DBH, 0FFH, 0C3H, 0E7H, 0FFH, 07EH	; 02H
   25 DB18  6C FE FE FE 	DB	06CH, 0FEH, 0FEH, 0FEH, 07CH, 038H, 010H, 000H	; 03H
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  85
ZSIBM   INC

   26 DB20  10 38 7C FE 	DB	010H, 038H, 07CH, 0FEH, 07CH, 038H, 010H, 000H	; 04H
   27 DB28  38 7C 38 FE 	DB	038H, 07CH, 038H, 0FEH, 0FEH, 07CH, 038H, 07CH	; 05H
   28 DB30  10 10 38 7C 	DB	010H, 010H, 038H, 07CH, 0FEH, 07CH, 038H, 07CH	; 06H
   29 DB38  00 00 18 3C 	DB	000H, 000H, 018H, 03CH, 03CH, 018H, 000H, 000H	; 07H
   30 DB40  FF FF E7 C3 	DB	0FFH, 0FFH, 0E7H, 0C3H, 0C3H, 0E7H, 0FFH, 0FFH	; 08H
   31 DB48  00 3C 66 42 	DB	000H, 03CH, 066H, 042H, 042H, 066H, 03CH, 000H	; 09H
   32 DB50  FF C3 99 BD 	DB	0FFH, 0C3H, 099H, 0BDH, 0BDH, 099H, 0C3H, 0FFH	; 0AH
   33 DB58  0F 07 0F 7D 	DB	00FH, 007H, 00FH, 07DH, 0CCH, 0CCH, 0CCH, 078H	; 0BH
   34 DB60  3C 66 66 66 	DB	03CH, 066H, 066H, 066H, 03CH, 018H, 07EH, 018H	; 0CH
   35 DB68  3F 33 3F 30 	DB	03FH, 033H, 03FH, 030H, 030H, 070H, 0F0H, 0E0H	; 0DH
   36 DB70  7F 63 7F 63 	DB	07FH, 063H, 07FH, 063H, 063H, 067H, 0E6H, 0C0H	; 0EH
   37 DB78  99 5A 3C E7 	DB	099H, 05AH, 03CH, 0E7H, 0E7H, 03CH, 05AH, 099H	; 0FH
   38                   
   39 DB80  80 E0 F8 FE 	DB	080H, 0E0H, 0F8H, 0FEH, 0F8H, 0E0H, 080H, 000H	; 10H
   40 DB88  02 0E 3E FE 	DB	002H, 00EH, 03EH, 0FEH, 03EH, 00EH, 002H, 000H	; 11H
   41 DB90  18 3C 7E 18 	DB	018H, 03CH, 07EH, 018H, 018H, 07EH, 03CH, 018H	; 12H
   42 DB98  66 66 66 66 	DB	066H, 066H, 066H, 066H, 066H, 000H, 066H, 000H	; 13H
   43 DBA0  7B DB DB 7B 	DB	07BH, 0DBH, 0DBH, 07BH, 01BH, 01BH, 01BH, 000H	; 14H
   44 DBA8  3C 66 38 6C 	DB	03CH, 066H, 038H, 06CH, 06CH, 038H, 0CCH, 078H	; 15H
   45 DBB0  00 00 00 00 	DB	000H, 000H, 000H, 000H, 07EH, 07EH, 07EH, 000H	; 16H
   46 DBB8  18 3C 7E 18 	DB	018H, 03CH, 07EH, 018H, 07EH, 03CH, 018H, 0FFH	; 17H
   47 DBC0  18 3C 7E 18 	DB	018H, 03CH, 07EH, 018H, 018H, 018H, 018H, 000H	; 18H
   48 DBC8  18 18 18 18 	DB	018H, 018H, 018H, 018H, 07EH, 03CH, 018H, 000H	; 19H
   49 DBD0  00 08 0C FE 	DB	000H, 008H, 00CH, 0FEH, 0FEH, 00CH, 008H, 000H	; 1AH
   50 DBD8  00 20 60 FE 	DB	000H, 020H, 060H, 0FEH, 0FEH, 060H, 020H, 000H	; 1BH
   51 DBE0  00 00 C0 C0 	DB	000H, 000H, 0C0H, 0C0H, 0C0H, 0FEH, 000H, 000H	; 1CH
   52 DBE8  00 24 66 FF 	DB	000H, 024H, 066H, 0FFH, 0FFh, 066H, 024H, 000H	; 1DH neu
   53 DBF0  00 18 3C 7E 	DB	000H, 018H, 03CH, 07EH, 0FFH, 0FFH, 000H, 000H	; 1EH
   54 DBF8  00 FF FF 7E 	DB	000H, 0FFH, 0FFH, 07EH, 03CH, 018H, 000H, 000H	; 1FH
   55                   
   56 DC00  78 CC C0 C0 	DB	078H, 0CCH, 0C0H, 0C0H, 0CCH, 078H, 010H, 070H	; 80H neu
   57 DC08  00 CC 00 CC 	DB	000H, 0CCH, 000H, 0CCH, 0CCH, 0CCH, 076H, 000H	; 81H neu
   58 DC10  1C 00 78 CC 	DB	01CH, 000H, 078H, 0CCH, 0FCH, 0C0H, 078H, 000H	; 82H
   59 DC18  78 84 78 0C 	DB	078H, 084H, 078H, 00CH, 07CH, 0CCH, 076H, 000H	; 83H neu
   60 DC20  6C 00 78 0C 	DB	06CH, 000H, 078H, 00CH, 07CH, 0CCH, 076H, 000H	; 84H neu
   61 DC28  E0 00 78 0C 	DB	0E0H, 000H, 078H, 00CH, 07CH, 0CCH, 076H, 000H	; 85H neu
   62 DC30  30 30 78 0C 	DB	030H, 030H, 078H, 00CH, 07CH, 0CCH, 076H, 000H	; 86H neu
   63 DC38  00 78 CC C0 	DB	000H, 078H, 0CCH, 0C0H, 0CCH, 078H, 010H, 070H	; 87H neu
   64 DC40  78 84 78 CC 	DB	078H, 084H, 078H, 0CCH, 0FCH, 0C0H, 078H, 000H	; 88H neu
   65 DC48  CC 00 78 CC 	DB	0CCH, 000H, 078H, 0CCH, 0FCH, 0C0H, 078H, 000H	; 89H
   66 DC50  E0 00 78 CC 	DB	0E0H, 000H, 078H, 0CCH, 0FCH, 0C0H, 078H, 000H	; 8AH
   67 DC58  D8 00 70 30 	DB	0D8H, 000H, 070H, 030H, 030H, 030H, 078H, 000H	; 8BH neu
   68 DC60  70 88 70 30 	DB	070H, 088H, 070H, 030H, 030H, 030H, 078H, 000H	; 8CH neu
   69 DC68  E0 00 70 30 	DB	0E0H, 000H, 070H, 030H, 030H, 030H, 078H, 000H	; 8DH neu
   70 DC70  CC 30 78 CC 	DB	0CCH, 030H, 078H, 0CCH, 0FCH, 0CCH, 0CCH, 000H	; 8EH
   71 DC78  78 84 30 78 	DB	078H, 084H, 030H, 078H, 0CCH, 0FCH, 0CCH, 000H	; 8FH neu
   72                   
   73 DC80  1C 00 FC 60 	DB	01CH, 000H, 0FCH, 060H, 078H, 060H, 0FCH, 000H	; 90H
   74 DC88  00 00 6C 92 	DB	000H, 000H, 06CH, 092H, 09EH, 090H, 07EH, 000H	; 91H neu
   75 DC90  3E 78 D8 FE 	DB	03EH, 078H, 0D8H, 0FEH, 0D8H, 0D8H, 0DEH, 000H	; 92H neu
   76 DC98  78 84 00 78 	DB	078H, 084H, 000H, 078H, 0CCH, 0CCH, 078H, 000H	; 93H neu
   77 DCA0  00 CC 00 78 	DB	000H, 0CCH, 000H, 078H, 0CCH, 0CCH, 078H, 000H	; 94H
   78 DCA8  00 E0 00 78 	DB	000H, 0E0H, 000H, 078H, 0CCH, 0CCH, 078H, 000H	; 95H
   79 DCB0  78 84 00 CC 	DB	078H, 084H, 000H, 0CCH, 0CCH, 0CCH, 076H, 000H	; 96H neu
   80 DCB8  00 E0 00 CC 	DB	000H, 0E0H, 000H, 0CCH, 0CCH, 0CCH, 076H, 000H	; 97H neu
   81 DCC0  00 CC 00 CC 	DB	000H, 0CCH, 000H, 0CCH, 0CCH, 07CH, 00CH, 0F8H	; 98H
   82 DCC8  C6 38 6C C6 	DB	0C6H, 038H, 06CH, 0C6H, 0C6H, 06CH, 038H, 000H	; 99H
   83 DCD0  CC 00 CC CC 	DB	0CCH, 000H, 0CCH, 0CCH, 0CCH, 0CCH, 078H, 000H	; 9AH
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  86
ZSIBM   INC

   84 DCD8  00 10 7C D6 	DB	000H, 010H, 07CH, 0D6H, 0D0H, 0D6H, 07CH, 010H	; 9BH neu
   85 DCE0  38 6C 64 F0 	DB	038H, 06CH, 064H, 0F0H, 060H, 0E6H, 0FCH, 000H	; 9CH
   86 DCE8  66 66 3C 7E 	DB	066H, 066H, 03CH, 07EH, 018H, 07EH, 018H, 018H	; 9DH
   87 DCF0  F8 CC CC FA 	DB	0F8H, 0CCH, 0CCH, 0FAH, 0C6H, 0CFH, 0C6H, 0C7H	; 9EH
   88 DCF8  0E 1B 18 3C 	DB	00EH, 01BH, 018H, 03CH, 018H, 018H, 0D8H, 070H	; 9FH
   89                   
   90 DD00  1C 00 78 0C 	DB	01CH, 000H, 078H, 00CH, 07CH, 0CCH, 076H, 000H	; A0H neu
   91 DD08  38 00 70 30 	DB	038H, 000H, 070H, 030H, 030H, 030H, 078H, 000H	; A1H
   92 DD10  00 1C 00 78 	DB	000H, 01CH, 000H, 078H, 0CCH, 0CCH, 078H, 000H	; A2H
   93 DD18  00 1C 00 CC 	DB	000H, 01CH, 000H, 0CCH, 0CCH, 0CCH, 076H, 000H	; A3H neu
   94 DD20  00 F8 00 F8 	DB	000H, 0F8H, 000H, 0F8H, 0CCH, 0CCH, 0CCH, 000H	; A4H
   95 DD28  FC 00 CC EC 	DB	0FCH, 000H, 0CCH, 0ECH, 0FCH, 0DCH, 0CCH, 000H	; A5H
   96 DD30  00 3C 6C 6C 	DB	000H, 03CH, 06CH, 06CH, 03EH, 000H, 07EH, 000H	; A6H
   97 DD38  00 38 6C 6C 	DB	000H, 038H, 06CH, 06CH, 038H, 000H, 07CH, 000H	; A7H
   98 DD40  30 00 30 18 	DB	030H, 000H, 030H, 018H, 00CH, 0CCH, 078H, 000H	; A8H
   99 DD48  00 00 00 7E 	DB	000H, 000H, 000H, 07EH, 060H, 060H, 000H, 000H	; A9H
  100 DD50  00 00 00 7E 	DB	000H, 000H, 000H, 07EH, 006H, 006H, 000H, 000H	; AAH
  101 DD58  C3 C6 CC DE 	DB	0C3H, 0C6H, 0CCH, 0DEH, 033H, 066H, 0CCH, 00FH	; ABH
  102 DD60  C3 C6 CC DB 	DB	0C3H, 0C6H, 0CCH, 0DBH, 037H, 06FH, 0CFH, 003H	; ACH
  103 DD68  30 00 30 30 	DB	030H, 000H, 030H, 030H, 078H, 078H, 030H, 000H	; ADH
  104 DD70  00 33 66 CC 	DB	000H, 033H, 066H, 0CCH, 066H, 033H, 000H, 000H	; AEH
  105 DD78  00 CC 66 33 	DB	000H, 0CCH, 066H, 033H, 066H, 0CCH, 000H, 000H	; AFH
  106                   
  107 DD80  22 88 22 88 	DB	022H, 088H, 022H, 088H, 022H, 088H, 022H, 088H	; B0H
  108 DD88  55 AA 55 AA 	DB	055H, 0AAH, 055H, 0AAH, 055H, 0AAH, 055H, 0AAH	; B1H
  109 DD90  77 DD 77 DD 	DB	077H, 0DDH, 077H, 0DDH, 077H, 0DDH, 077H, 0DDH	; B2H neu
  110 DD98  18 18 18 18 	DB	018H, 018H, 018H, 018H, 018H, 018H, 018H, 018H	; B3H
  111 DDA0  18 18 18 F8 	DB	018H, 018H, 018H, 0F8H, 018H, 018H, 018H, 018H	; B4H
  112 DDA8  18 18 F8 18 	DB	018H, 018H, 0F8H, 018H, 0F8H, 018H, 018H, 018H	; B5H
  113 DDB0  36 36 36 F6 	DB	036H, 036H, 036H, 0F6H, 036H, 036H, 036H, 036H	; B6H
  114 DDB8  00 00 00 FE 	DB	000H, 000H, 000H, 0FEH, 036H, 036H, 036H, 036H	; B7H
  115 DDC0  00 00 F8 18 	DB	000H, 000H, 0F8H, 018H, 0F8H, 018H, 018H, 018H	; B8H
  116 DDC8  36 36 F6 06 	DB	036H, 036H, 0F6H, 006H, 0F6H, 036H, 036H, 036H	; B9H
  117 DDD0  36 36 36 36 	DB	036H, 036H, 036H, 036H, 036H, 036H, 036H, 036H	; BAH
  118 DDD8  00 00 FE 06 	DB	000H, 000H, 0FEH, 006H, 0F6H, 036H, 036H, 036H	; BBH
  119 DDE0  36 36 F6 06 	DB	036H, 036H, 0F6H, 006H, 0FEH, 000H, 000H, 000H	; BCH
  120 DDE8  36 36 36 FE 	DB	036H, 036H, 036H, 0FEH, 000H, 000H, 000H, 000H	; BDH
  121 DDF0  18 18 F8 18 	DB	018H, 018H, 0F8H, 018H, 0F8H, 000H, 000H, 000H	; BEH
  122 DDF8  00 00 00 F8 	DB	000H, 000H, 000H, 0F8H, 018H, 018H, 018H, 018H	; BFH
  123                   
  124 DE00  18 18 18 1F 	DB	018H, 018H, 018H, 01FH, 000H, 000H, 000H, 000H	; C0H
  125 DE08  18 18 18 FF 	DB	018H, 018H, 018H, 0FFH, 000H, 000H, 000H, 000H	; C1H
  126 DE10  00 00 00 FF 	DB	000H, 000H, 000H, 0FFH, 018H, 018H, 018H, 018H	; C2H
  127 DE18  18 18 18 1F 	DB	018H, 018H, 018H, 01FH, 018H, 018H, 018H, 018H	; C3H
  128 DE20  00 00 00 FF 	DB	000H, 000H, 000H, 0FFH, 000H, 000H, 000H, 000H	; C4H
  129 DE28  18 18 18 FF 	DB	018H, 018H, 018H, 0FFH, 018H, 018H, 018H, 018H	; C5H
  130 DE30  18 18 1F 18 	DB	018H, 018H, 01FH, 018H, 01FH, 018H, 018H, 018H	; C6H
  131 DE38  36 36 36 37 	DB	036H, 036H, 036H, 037H, 036H, 036H, 036H, 036H	; C7H
  132 DE40  36 36 37 30 	DB	036H, 036H, 037H, 030H, 03FH, 000H, 000H, 000H	; C8H
  133 DE48  00 00 3F 30 	DB	000H, 000H, 03FH, 030H, 037H, 036H, 036H, 036H	; C9H
  134 DE50  36 36 F7 00 	DB	036H, 036H, 0F7H, 000H, 0FFH, 000H, 000H, 000H	; CAH
  135 DE58  00 00 FF 00 	DB	000H, 000H, 0FFH, 000H, 0F7H, 036H, 036H, 036H	; CBH
  136 DE60  36 36 37 30 	DB	036H, 036H, 037H, 030H, 037H, 036H, 036H, 036H	; CCH
  137 DE68  00 00 FF 00 	DB	000H, 000H, 0FFH, 000H, 0FFH, 000H, 000H, 000H	; CDH
  138 DE70  36 36 F7 00 	DB	036H, 036H, 0F7H, 000H, 0F7H, 036H, 036H, 036H	; CEH
  139 DE78  18 18 FF 00 	DB	018H, 018H, 0FFH, 000H, 0FFH, 000H, 000H, 000H	; CFH
  140                   
  141 DE80  36 36 36 FF 	DB	036H, 036H, 036H, 0FFH, 000H, 000H, 000H, 000H	; D0H
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  87
ZSIBM   INC

  142 DE88  00 00 FF 00 	DB	000H, 000H, 0FFH, 000H, 0FFH, 018H, 018H, 018H	; D1H
  143 DE90  00 00 00 FF 	DB	000H, 000H, 000H, 0FFH, 036H, 036H, 036H, 036H	; D2H
  144 DE98  36 36 36 3F 	DB	036H, 036H, 036H, 03FH, 000H, 000H, 000H, 000H	; D3H
  145 DEA0  18 18 1F 18 	DB	018H, 018H, 01FH, 018H, 01FH, 000H, 000H, 000H	; D4H
  146 DEA8  00 00 1F 18 	DB	000H, 000H, 01FH, 018H, 01FH, 018H, 018H, 018H	; D5H
  147 DEB0  00 00 00 3F 	DB	000H, 000H, 000H, 03FH, 036H, 036H, 036H, 036H	; D6H
  148 DEB8  36 36 36 FF 	DB	036H, 036H, 036H, 0FFH, 036H, 036H, 036H, 036H	; D7H
  149 DEC0  18 18 FF 18 	DB	018H, 018H, 0FFH, 018H, 0FFH, 018H, 018H, 018H	; D8H
  150 DEC8  18 18 18 F8 	DB	018H, 018H, 018H, 0F8H, 000H, 000H, 000H, 000H	; D9H
  151 DED0  00 00 00 1F 	DB	000H, 000H, 000H, 01FH, 018H, 018H, 018H, 018H	; DAH
  152 DED8  FF FF FF FF 	DB	0FFH, 0FFH, 0FFH, 0FFH, 0FFH, 0FFH, 0FFH, 0FFH	; DBH
  153 DEE0  00 00 00 00 	DB	000H, 000H, 000H, 000H, 0FFH, 0FFH, 0FFH, 0FFH	; DCH
  154 DEE8  F0 F0 F0 F0 	DB	0F0H, 0F0H, 0F0H, 0F0H, 0F0H, 0F0H, 0F0H, 0F0H	; DDH
  155 DEF0  0F 0F 0F 0F 	DB	00FH, 00FH, 00FH, 00FH, 00FH, 00FH, 00FH, 00FH	; DEH
  156 DEF8  FF FF FF FF 	DB	0FFH, 0FFH, 0FFH, 0FFH, 000H, 000H, 000H, 000H	; DFH
  157                   
  158 DF00  00 00 76 DC 	DB	000H, 000H, 076H, 0DCH, 0CCH, 0DCH, 076H, 000H	; E0H
  159 DF08  3C 66 66 6C 	DB	03CH, 066H, 066H, 06CH, 066H, 066H, 06CH, 0F0H	; E1H
  160 DF10  FE 62 60 60 	DB	0FEH, 062H, 060H, 060H, 060H, 060H, 0F0H, 000H	; E2H
  161 DF18  00 FE 6C 6C 	DB	000H, 0FEH, 06CH, 06CH, 06CH, 06CH, 06EH, 000H	; E3H
  162 DF20  FC C4 60 30 	DB	0FCH, 0C4H, 060H, 030H, 060H, 0C4H, 0FCH, 000H	; E4H neu
  163 DF28  00 00 7E D8 	DB	000H, 000H, 07EH, 0D8H, 0D8H, 0D8H, 070H, 000H	; E5H
  164 DF30  00 00 CC CC 	DB	000H, 000H, 0CCH, 0CCH, 0CCH, 0F6H, 0C0H, 0C0H	; E6H neu
  165 DF38  00 7E D8 18 	DB	000H, 07EH, 0D8H, 018H, 018H, 018H, 018H, 000H	; E7H
  166 DF40  78 30 78 CC 	DB	078H, 030H, 078H, 0CCH, 0CCH, 078H, 030H, 078H	; E8H neu
  167 DF48  38 6C C6 FE 	DB	038H, 06CH, 0C6H, 0FEH, 0C6H, 06CH, 038H, 000H	; E9H
  168 DF50  38 6C C6 C6 	DB	038H, 06CH, 0C6H, 0C6H, 06CH, 06CH, 0EEH, 000H	; EAH
  169 DF58  1C 30 18 7C 	DB	01CH, 030H, 018H, 07CH, 0CCH, 0CCH, 078H, 000H	; EBH
  170 DF60  00 6C FE 92 	DB	000H, 06CH, 0FEH, 092H, 0FEH, 06CH, 000H, 000H	; ECH neu
  171 DF68  03 7E CC DE 	DB	003H, 07EH, 0CCH, 0DEH, 0F6H, 066H, 0FCH, 080H	; EDH neu
  172 DF70  3C 60 C0 FC 	DB	03CH, 060H, 0C0H, 0FCH, 0C0H, 060H, 03CH, 000H	; EEH neu
  173 DF78  78 CC CC CC 	DB	078H, 0CCH, 0CCH, 0CCH, 0CCH, 0CCH, 0CCH, 000H	; EFH neu
  174                   
  175 DF80  00 7E 00 7E 	DB	000H, 07EH, 000H, 07EH, 000H, 07EH, 000H, 000H	; F0H
  176 DF88  18 18 7E 18 	DB	018H, 018H, 07EH, 018H, 018H, 000H, 07EH, 000H	; F1H
  177 DF90  30 18 0C 18 	DB	030H, 018H, 00CH, 018H, 030H, 000H, 07EH, 000H	; F2H
  178 DF98  0C 18 30 18 	DB	00CH, 018H, 030H, 018H, 00CH, 000H, 07EH, 000H	; F3H
  179 DFA0  0E 1B 1B 18 	DB	00EH, 01BH, 01BH, 018H, 018H, 018H, 018H, 018H	; F4H
  180 DFA8  18 18 18 18 	DB	018H, 018H, 018H, 018H, 018H, 0D8H, 0D8H, 070H	; F5H
  181 DFB0  18 18 00 7E 	DB	018H, 018H, 000H, 07EH, 000H, 018H, 018H, 000H	; F6H
  182 DFB8  00 76 DC 00 	DB	000H, 076H, 0DCH, 000H, 076H, 0DCH, 000H, 000H	; F7H
  183 DFC0  38 6C 6C 38 	DB	038H, 06CH, 06CH, 038H, 000H, 000H, 000H, 000H	; F8H
  184 DFC8  00 00 00 18 	DB	000H, 000H, 000H, 018H, 018H, 000H, 000H, 000H	; F9H
  185 DFD0  00 00 00 00 	DB	000H, 000H, 000H, 000H, 018H, 000H, 000H, 000H	; FAH
  186 DFD8  0F 0C 0C 0C 	DB	00FH, 00CH, 00CH, 00CH, 0CCH, 06CH, 03CH, 01CH	; FBH
  187 DFE0  78 6C 6C 6C 	DB	078H, 06CH, 06CH, 06CH, 06CH, 000H, 000H, 000H	; FCH
  188 DFE8  70 18 30 60 	DB	070H, 018H, 030H, 060H, 078H, 000H, 000H, 000H	; FDH
  189 DFF0  00 00 3C 3C 	DB	000H, 000H, 03CH, 03CH, 03CH, 03CH, 000H, 000H	; FEH
  190 DFF8  FF 81 81 81 	DB	0FFH, 081H, 081H, 081H, 081H, 081H, 081H, 0FFH	; FFH
  195                   
  196                   	INCLUDE	CE47.INC	; ROM-E (E000-EDFF)
    1                   ;*****************************************
    2                   ;**	CAOS 4.7	ROM E		**
    3                   ;**					**
    4                   ;**	Adresse:  E000h bis EDFFh	**
    5                   ;**					**
    6                   ;**	letzte Aenderung: 24.02.2020	**
    7                   ;*****************************************
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  88
CE47    INC

    8                   
    9                   ;	ORG	0E000H
   10                   
   11 E000  C3 F166     	JP	BYE		; Tasten-RESET
   12 E003  C3 E5B6     	JP	BEXP1		; BASIC-Erweiterung 1 - Token starten
   13 E006  C3 E5D3     	JP	BEXP2		; BASIC-Erweiterung 2
   14 E009  C3 EBBA     	JP	BEXP3		; BASIC-Erweiterung 3
   15 E00C  FCCF        	DW	TOKTAB		; Token-Tabelle der Erweiterungen
   16 E00E  C3 F88A     BASIO:	JP	BASPV		; BASIC Programmverteiler
   17                   
   18 E011  7F7F        	DW	7F7FH
   19 E013  42 41 53 49 	DB	'BASIC'
   20 E018  11          	DB	11H
   21 E019  CD E02F     	CALL	BASON
   22 E01C  C3 C00D     	JP	PRIST		; BASIC-Kaltstart
   23                   
   24 E01F  7F7F        	DW	7F7FH
   25 E021  52 45 42 41 	DB	'REBASIC'
   26 E028  11          	DB	11H
   27 E029  CD E02F     	CALL	BASON
   28 E02C  C3 C08C     	JP	SECST		; BASIC-Warmstart
   29                   
   30                   ; BASIC vorbereiten:
   31                   
   32 E02F  16 00       BASON:	LD	D,0
   33 E031  2E 05       	LD	L,5		; SWITCH 5 0
   34 E033  CD F102     	CALL	MODUSW		; CAOS-C aus
   35 E036  16 C1       	LD	D,0C1H		; SWITCH 2 C1
   36 E038  CD F100     	CALL	MODUL2		; BASIC-Ebene einschalten
   37 E03B  C3 F03F     	JP	SCROFF		; IRM aus
   38                   
   39                   ; CRT-Treiber:
   40                   
   41 E03E  ED 5B B7A0  PADR0:	LD	DE,(CURSO)
   42 E042  2A B79C     PADR1:	LD	HL,(WINON)
   43 E045  19          	ADD	HL,DE
   44 E046  CB 24       	SLA	H
   45 E048  CB 24       	SLA	H
   46 E04A  CB 24       	SLA	H
   47                   ;_____________________________________________________________
   48                   ;							**34**
   49                   ; Berechne Pixel- und Farbadresse aus Zeichenposition
   50                   ; PE:	H	Vertikalposition (0 ... FFH)
   51                   ;	L	Horizontalposition (0 ... 27H)
   52                   ; PA:	HL	Zeichen- und Farbadresse*
   53                   ;	CY=1	Position ausserhalb
   54                   ; VR:	F, HL, DE STACK: 1
   55                   
   56 E04C  F5          PADR:	PUSH	AF
   57 E04D  7D          	LD	A,L		; Spalte
   58 E04E  6C          	LD	L,H		; Pixelzeile
   59 E04F  FE 28       	CP	28H
   60 E051  30 06       	JR	NC,IAD2		; zu gross
   61 E053  F6 80       	OR	80H
   62 E055  67          	LD	H,A		; HL=Pixeladresse
   63 E056  F1          	POP	AF
   64 E057  A7          	AND	A		; CY=0
   65 E058  C9          	RET
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  89
CE47    INC

   66 E059  F1          IAD2:	POP	AF
   67 E05A  37          	SCF			; CY=1
   68 E05B  C9          	RET
   69                   ;_____________________________________________________________
   70                   ;							**33**
   71                   ; Test Cursor im Fenster
   72                   ; PE:	D	Zeile der Cursorposition
   73                   ;	E	Spalte der Cursorposition
   74                   ; PA:	CY=1	Cursor ausserhalb
   75                   ; VR:	AF
   76                   
   77 E05C  3A B79E     TCIF:	LD	A,(WINLG)
   78 E05F  3D          	DEC	A
   79 E060  93          	SUB	E		; Cursor-Spalte
   80 E061  D8          	RET	C
   81 E062  3A B79F     	LD	A,(WINLG+1)
   82 E065  3D          	DEC	A
   83 E066  92          	SUB	D		; Cursor-Zeile
   84 E067  C9          	RET
   85                   ;_____________________________________________________________
   86                   ;							**32**
   87                   ; Berechnung der VRAM-Adresse der Cursorposition
   88                   ; im gerade eingestellten Fenster und Bild
   89                   ; PE:	D	Zeile auf Bildschirm
   90                   ;	E	Spalte auf Bildschirm
   91                   ; PA:	CY=1	ausserhalb (Fehler)
   92                   ;	HL	Adresse im Speicher
   93                   ; VR:	F, HL
   94                   
   95 E068  F5          DABR:	PUSH	AF
   96 E069  CD E05C     	CALL	TCIF
   97 E06C  38 EB       	JR	C,IAD2
   98 E06E  3A B79C     	LD	A,(WINON)
   99 E071  83          	ADD	A,E		; Cursor-Spalte
  100 E072  D5          	PUSH	DE
  101 E073  5F          	LD	E,A		; absolut
  102 E074  3A B79D     	LD	A,(WINON+1)
  103 E077  82          	ADD	A,D		; Cursor-Zeile
  104 E078  87          	ADD	A,A
  105 E079  87          	ADD	A,A
  106 E07A  87          	ADD	A,A		; *8
  107 E07B  6F          	LD	L,A		; Pixelzeile
  108 E07C  26 00       	LD	H,0
  109 E07E  54          	LD	D,H		; D=0
  110 E07F  29          	ADD	HL,HL
  111 E080  29          	ADD	HL,HL		; *4
  112 E081  19          	ADD	HL,DE		; *5, zus. *40
  113 E082  5F          	LD	E,A
  114 E083  3A B7CC     	LD	A,(VRAM+1)
  115 E086  57          	LD	D,A
  116 E087  19          	ADD	HL,DE
  117 E088  D1          	POP	DE
  118 E089  F1          	POP	AF
  119 E08A  A7          	AND	A
  120 E08B  C9          	RET
  121                   ;_____________________________________________________________
  122                   ;							**00**
  123                   ; Zeichenausgabe auf Bildschirm
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  90
CE47    INC

  124                   ; PE:	A	Zeichencode (ASCII)
  125                   ; PA:	-
  126                   ; VR:	-
  127                   
  128 E08C  E5          CRT:	PUSH	HL
  129 E08D  D5          	PUSH	DE
  130 E08E  C5          	PUSH	BC
  131 E08F  F5          	PUSH	AF
  132 E090  CD E178     	CALL	PCHR
  133 E093  ED 53 B7A0  	LD	(CURSO),DE
  134 E097  F1          POP4:	POP	AF
  135 E098  C1          	POP	BC
  136 E099  D1          	POP	DE
  137 E09A  E1          	POP	HL
  138 E09B  C9          	RET
  139                   
  140                   ; Zeichen auf Grafikbildschirm sichtbar machen
  141                   ; PE:	DE, A, STBT
  142                   
  143 E09C  E5          WPIX:	PUSH	HL
  144 E09D  D5          	PUSH	DE
  145 E09E  C5          	PUSH	BC
  146 E09F  F5          	PUSH	AF
  147 E0A0  4F          	LD	C,A		; Zeichen
  148 E0A1  2A B79C     	LD	HL,(WINON)
  149 E0A4  19          	ADD	HL,DE
  150 E0A5  EB          	EX	DE,HL		; DE:absolute Cursorposition
  151 E0A6  7B          	LD	A,E
  152 E0A7  FE 28       	CP	28H
  153 E0A9  30 EC       	JR	NC,POP4		; ausserhalb!
  154 E0AB  21 B7A2     	LD	HL,STBT
  155 E0AE  CB 6E       	BIT	5,(HL)		; IBM?
  156 E0B0  20 63       	JR	NZ,WPX14
  157 E0B2  79          	LD	A,C
  158 E0B3  21 B7A6     	LD	HL,CCTL0
  159 E0B6  87          	ADD	A,A		; *2
  160 E0B7  30 02       	JR	NC,WPX04
  161 E0B9  2E AA       	LD	L,LOW(CCTL2)
  162 E0BB  D6 40       WPX04:	SUB	40H
  163 E0BD  F2 E0C4     	JP	P,WPX06		; CCTL0/2
  164 E0C0  2C          	INC	L
  165 E0C1  2C          	INC	L		; CCTL1/3
  166 E0C2  EE C0       	XOR	0C0H
  167 E0C4  4E          WPX06:	LD	C,(HL)
  168 E0C5  2C          	INC	L		; BC=(CCTL)
  169 E0C6  46          	LD	B,(HL)
  170 E0C7  87          	ADD	A,A		; *4
  171 E0C8  6F          	LD	L,A
  172 E0C9  26 00       	LD	H,0
  173 E0CB  29          WPX07:	ADD	HL,HL		; *8
  174 E0CC  09          	ADD	HL,BC		; HL=Pixelmuster
  175 E0CD  7A          	LD	A,D
  176 E0CE  87          	ADD	A,A
  177 E0CF  87          	ADD	A,A
  178 E0D0  87          	ADD	A,A
  179 E0D1  53          	LD	D,E
  180 E0D2  5F          	LD	E,A
  181 E0D3  CB FA       	SET	7,D		; DE=IRM-Adresse
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  91
CE47    INC

  182 E0D5  ED 4B B7A2  	LD	BC,(STBT)
  183 E0D9  CB 49       	BIT	1,C
  184 E0DB  20 16       	JR	NZ,WPIXNC	; Farbe AUS
  185 E0DD  CD F987     	CALL	ESC9
  186 E0E0  DD CB 01 5E 	BIT	3,(IX+1)
  187 E0E4  20 04       	JR	NZ,WPIXA	; LORES
  188 E0E6  CB 71       	BIT	6,C
  189 E0E8  20 38       	JR	NZ,WPIXH1	; HRG-Modus
  190 E0EA  78          WPIXA:	LD	A,B		; Farbe
  191 E0EB  43          	LD	B,E
  192 E0EC  CD E168     	CALL	WCOLOR		; 8 Farbbytes
  193 E0EF  58          	LD	E,B
  194 E0F0  CD F987     WPIXHE:	CALL	ESC9
  195 E0F3  CB 41       WPIXNC:	BIT	0,C
  196 E0F5  20 12       	JR	NZ,WPX11	; Pixel AUS
  197 E0F7  DD CB 01 5E 	BIT	3,(IX+1)
  198 E0FB  20 04       	JR	NZ,WPIXB	; LORES
  199 E0FD  CB 71       	BIT	6,C
  200 E0FF  20 2C       	JR	NZ,WPIXH2	; HRG-Modus
  201 E101  CB 51       WPIXB:	BIT	2,C
  202 E103  CC E147     	CALL	Z,WPIXEL	; normal
  203 E106  C4 E15A     	CALL	NZ,WPIXI	; invers
  204 E109  CB 69       WPX11:	BIT	5,C		; IBM?
  205 E10B  28 8A       	JR	Z,POP4		; nein
  206 E10D  F1          	POP	AF
  207 E10E  DD 77 04    	LD	(IX+4),A	; CAOS-C
  208 E111  D3 86       	OUT	(PORT2),A	; wie vorher
  209 E113  18 82       	JR	POP4		; POP	AF,BC,DE,HL   RET
  210                   
  211 E115  DD 7E 04    WPX14:	LD	A,(IX+4)	; CAOS-C-Schaltzustand
  212 E118  F5          	PUSH	AF		; merken
  213                   	SETIXA	7,4		; SET 7,(IX+4),A
    1 E119  DD CB 04    	 DB	0DDh,0CBh,4
    2 E11C  FF          	 DB	7 SHL 3 OR 11000111b
  214 E11D  D3 86       	OUT	(PORT2),A	; CAOS-C ein
  215 E11F  C3 D1B3     	JP	WPIXD		; Springe zu CAOS-D-Block
  216                   
  217                   ; Farbebene im HRG-Modus
  218 E122  78          WPIXH1:	LD	A,B
  219 E123  0F          	RRCA
  220 E124  E5          	PUSH	HL
  221 E125  D5          	PUSH	DE
  222 E126  CD E137     	CALL	WPHRG
  223 E129  D1          	POP	DE
  224 E12A  E1          	POP	HL
  225 E12B  18 C3       	JR	WPIXHE
  226                   
  227                   ; Pixelebene im HRG-Modus
  228 E12D  78          WPIXH2:	LD	A,B
  229 E12E  E5          	PUSH	HL
  230 E12F  D5          	PUSH	DE
  231 E130  CD E137     	CALL	WPHRG
  232 E133  D1          	POP	DE
  233 E134  E1          	POP	HL
  234 E135  18 D2       	JR	WPX11
  235                   
  236                   ; Reaktion im HRG-Modus
  237 E137  E6 09       WPHRG:	AND	00001001b	; Bits 0,3
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  92
CE47    INC

  238 E139  28 2D       	JR	Z,WCOLOR	; beide 0: Ebene ruecksetzen
  239 E13B  EA E166     	JP	PE,COLFF	; beide 1: Ebene setzen
  240 E13E  CB 51       	BIT	2,C
  241 E140  28 02       	JR	Z,WPHN
  242 E142  EE 09       	XOR	00001001b	; invers
  243 E144  3D          WPHN:	DEC	A
  244 E145  28 13       	JR	Z,WPIXI		; Pixel invers
  245 E147  C5          WPIXEL:	PUSH	BC
  246 E148  ED A0       	LDI			; 8 Pixelbytes kopieren
  247 E14A  ED A0       	LDI			; ohne Schleife - schneller!
  248 E14C  ED A0       	LDI
  249 E14E  ED A0       	LDI
  250 E150  ED A0       	LDI
  251 E152  ED A0       	LDI
  252 E154  ED A0       	LDI
  253 E156  ED A0       	LDI
  254 E158  C1          	POP	BC
  255 E159  C9          	RET
  256                   
  257 E15A  C5          WPIXI:	PUSH	BC
  258 E15B  06 08       	LD	B,8		; 8 Pixelmuster
  259 E15D  7E          WPIXI1:	LD	A,(HL)		; invers
  260 E15E  2F          	CPL
  261 E15F  12          	LD	(DE),A
  262 E160  23          	INC	HL
  263 E161  1C          	INC	E
  264 E162  10 F9       	DJNZ	WPIXI1
  265 E164  C1          	POP	BC
  266 E165  C9          	RET
  267                   
  268 E166  3E FF       COLFF:	LD	A,0FFH
  269 E168  12          WCOLOR:	LD	(DE),A		; 8 Farbbytes
  270 E169  1C          	INC	E
  271 E16A  12          	LD	(DE),A
  272 E16B  1C          	INC	E
  273 E16C  12          	LD	(DE),A
  274 E16D  1C          	INC	E
  275 E16E  12          	LD	(DE),A
  276 E16F  1C          	INC	E
  277 E170  12          	LD	(DE),A
  278 E171  1C          	INC	E
  279 E172  12          	LD	(DE),A
  280 E173  1C          	INC	E
  281 E174  12          	LD	(DE),A
  282 E175  1C          	INC	E
  283 E176  12          	LD	(DE),A
  284 E177  C9          	RET
  285                   
  286                   ; CRT-Grundprogramm mit Auswertung von ESC-Sequenzen
  287                   
  288 E178  ED 5B B7A0  PCHR:	LD	DE,(CURSO)
  289 E17C  21 B7A2     	LD	HL,STBT
  290 E17F  CB 66       	BIT	4,(HL)		; ESC aktiv?
  291 E181  28 22       	JR	Z,PCHR3
  292 E183  CB A6       CRT1:	RES	4,(HL)		; ESC quittieren
  293 E185  FE 30       	CP	'0'
  294 E187  D8          	RET	C		; ESC-Folgecode kleiner als '0'
  295 E188  FE 3A       	CP	'9'+1
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  93
CE47    INC

  296 E18A  30 04       	JR	NC,PCHR1	; ESC-Folgecode groesser als '9'
  297 E18C  D6 30       	SUB	'0'
  298 E18E  18 0A       	JR	PCHR2		; ESC-Routine aus der Tabelle ermitteln
  299                   	;
  300 E190  FE 41       PCHR1:	CP	'A'
  301 E192  D8          	RET	C		; ESC-Folgecode zwischen '9' und 'A'
  302 E193  CB AF       	RES	5,A		; upcase
  303 E195  FE 5B       	CP	'Z'+1
  304 E197  D0          	RET	NC		; ESC-Folgecode groesser als 'Z'
  305 E198  D6 37       	SUB	'A'-10
  306 E19A  21 B7DF     PCHR2:	LD	HL,L3SIZ	; Tabelle
  307 E19D  BE          	CP	(HL)		; lang genug?
  308 E19E  D0          	RET	NC
  309 E19F  87          	ADD	A,A		; *2
  310 E1A0  2A B7DD     	LD	HL,(L3TAB)	; Tabelle der ESC-Funktionen
  311 E1A3  18 0C       	JR	PCHR4		; klar zum Ansprung
  312                   	;
  313 E1A5  FE 20       PCHR3:	CP	20H		; Steuerfunktion?
  314 E1A7  30 18       	JR	NC,PCHR5
  315 E1A9  CB 5E       	BIT	3,(HL)		; darstellen?
  316 E1AB  20 14       	JR	NZ,PCHR5
  317 E1AD  87          	ADD	A,A		; *2
  318 E1AE  2A B7B2     	LD	HL,(CTAB)	; Tabelle der CRT-Funktionen
  319 E1B1  4F          PCHR4:	LD	C,A
  320 E1B2  06 00       	LD	B,0
  321 E1B4  09          	ADD	HL,BC
  322 E1B5  7E          	LD	A,(HL)
  323 E1B6  23          	INC	HL
  324 E1B7  66          	LD	H,(HL)
  325 E1B8  6F          	LD	L,A
  326 E1B9  E9          JPHL:	JP	(HL)		; anspringen
  327                   
  328                   ; Tabulatorschritt mit Code 05h bzw. ESC '0'
  329 E1BA  7B          ESC0:	LD	A,E		; Tabulator
  330 E1BB  F6 07       	OR	7		; 8er Schrittweite
  331 E1BD  3C          	INC	A
  332 E1BE  5F          	LD	E,A
  333 E1BF  18 09       	JR	CUR1
  334                   	;
  335 E1C1  CD E068     PCHR5:	CALL	DABR
  336 E1C4  D8          	RET	C		; ausserhalb
  337 E1C5  77          	LD	(HL),A		; ASCII in VRAM eintragen
  338 E1C6  CD E09C     	CALL	WPIX		; Zeichen darstellen
  339 E1C9  1C          CUR:	INC	E		; Cursor nach rechts
  340 E1CA  3A B79E     CUR1:	LD	A,(WINLG)
  341 E1CD  3D          	DEC	A
  342 E1CE  BB          	CP	E		; Zeilenende?
  343 E1CF  D0          	RET	NC
  344                   
  345                   ; Neue Zeile mit Code 1Eh
  346 E1D0  1E 00       NL:	LD	E,0		; Cursor ganz nach links
  347 E1D2  14          CUD:	INC	D		; naechste Zeile
  348 E1D3  3A B79F     	LD	A,(WINLG+1)
  349 E1D6  BA          	CP	D
  350 E1D7  C0          	RET	NZ
  351 E1D8  2A B7A4     	LD	HL,(WEND)
  352 E1DB  E9          	JP	(HL)		; PAGE oder SCROLL
  353                   
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  94
CE47    INC

  354                   ; Aufruf der Hardcopy-Routine mit Code 0Fh
  355 E1DC  2A B799     HCOPY:	LD	HL,(HCADR)	; ShCLR
  356 E1DF  E9          	JP	(HL)
  357                   ;
  358                   ; Cursor nach links:
  359                   ;
  360 E1E0  7B          CUL:	LD	A,E		; Spalte
  361 E1E1  A7          	AND	A		; ganz links?
  362 E1E2  28 02       	JR	Z,CUL1
  363 E1E4  1D          	DEC	E		; eine Position nach links gehen
  364 E1E5  C9          	RET
  365                   	;
  366 E1E6  7A          CUL1:	LD	A,D		; Zeile
  367 E1E7  A7          	AND	A		; ganz oben?
  368 E1E8  C8          	RET	Z
  369 E1E9  15          	DEC	D		; eine Zeile nach oben gehen
  370 E1EA  3A B79E     CEL:	LD	A,(WINLG)	; Spalten im aktuellen Fenster
  371 E1ED  3D          	DEC	A		; letzte Spalte
  372 E1EE  5F          	LD	E,A		; Cursor auf letzte Spalte setzen
  373 E1EF  C9          	RET
  374                   ;
  375                   ; Cursor nach oben:
  376                   ;
  377 E1F0  7A          CUU:	LD	A,D		; Zeile
  378 E1F1  A7          	AND	A		; bereits ganz oben?
  379 E1F2  C8          	RET	Z
  380 E1F3  15          	DEC	D		; eine Zeile nach oben gehen
  381 E1F4  C9          	RET
  382                   
  383 E1F5  21 E264     PAGEM:	LD	HL,HOMEPG	; ShCUU
  384 E1F8  22 B7A4     WADR:	LD	(WEND),HL
  385 E1FB  C9          	RET
  386                   
  387 E1FC  21 E269     SCROL:	LD	HL,SCRLPG	; ShCUD
  388 E1FF  18 F7       	JR	WADR
  389                   
  390                   ; Zeichen nach links loeschen mit Code 01h
  391 E201  CD E1E0     CLR:	CALL	CUL		; Cursor nach links
  392                   
  393                   ; Zeichen unter Cursor loeschen mit Code 1Fh
  394 E204  D5          DEL:	PUSH	DE		; Cursor retten
  395 E205  CD E068     	CALL	DABR
  396 E208  7E          	LD	A,(HL)
  397 E209  A7          	AND	A		; Ende?
  398 E20A  28 29       	JR	Z,POPDE
  399 E20C  E5          	PUSH	HL		; VRAM
  400 E20D  D5          DEL1:	PUSH	DE		; Cursor
  401 E20E  1C          	INC	E		; naechste Spalte
  402 E20F  CD E068     	CALL	DABR		; raus?
  403 E212  30 08       	JR	NC,DEL2
  404 E214  1E 00       	LD	E,0		; ja, wie NL
  405 E216  14          	INC	D
  406 E217  CD E068     	CALL	DABR		; raus?
  407 E21A  38 10       	JR	C,DEL3		; ja-wie Ende
  408 E21C  7E          DEL2:	LD	A,(HL)
  409 E21D  A7          	AND	A		; Ende?
  410 E21E  28 0C       	JR	Z,DEL3
  411 E220  42          	LD	B,D
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  95
CE47    INC

  412 E221  4B          	LD	C,E		; BC:=DE
  413 E222  D1          	POP	DE		; DE=links davon
  414 E223  E3          	EX	(SP),HL		; HL=VRAM links
  415 E224  77          	LD	(HL),A		; eintragen
  416 E225  CD E09C     	CALL	WPIX		; zeichnen
  417 E228  50          	LD	D,B
  418 E229  59          	LD	E,C		; DE:=BC
  419 E22A  18 E1       	JR	DEL1		; von vorn
  420                   
  421 E22C  D1          DEL3:	POP	DE
  422 E22D  E1          	POP	HL
  423 E22E  36 00       	LD	(HL),0
  424 E230  3E 20       	LD	A,' '
  425 E232  CD E09C     	CALL	WPIX
  426 E235  D1          POPDE:	POP	DE
  427 E236  C9          	RET
  428                   
  429 E237  D5          INS:	PUSH	DE		; Cursor
  430 E238  3E 20       	LD	A,' '
  431 E23A  CD E068     	CALL	DABR
  432 E23D  46          INS1:	LD	B,(HL)		; VRAM
  433 E23E  77          	LD	(HL),A		; neues Zeichen
  434 E23F  CD E09C     	CALL	WPIX		; zeichnen
  435 E242  78          	LD	A,B
  436 E243  A7          	AND	A		; Dummy?
  437 E244  28 0E       	JR	Z,INS2
  438 E246  1C          	INC	E		; CUR
  439 E247  CD E068     	CALL	DABR		; raus?
  440 E24A  30 F1       	JR	NC,INS1
  441 E24C  1E 00       	LD	E,0		; wie NL
  442 E24E  14          	INC	D
  443 E24F  CD E068     	CALL	DABR		; raus?
  444 E252  30 E9       	JR	NC,INS1
  445 E254  D1          INS2:	POP	DE		; wenn ja Schluss
  446 E255  C9          	RET
  447                   
  448                   ; Bildschirm loeschen mit Code 0Ch (ShHOME)
  449 E256  3A B79F     CLS:	LD	A,(WINLG+1)	; Anzahl Zeilen
  450 E259  16 00       	LD	D,0		; Zeile 0
  451 E25B  F5          CLS1:	PUSH	AF
  452 E25C  CD E278     	CALL	CLLN		; Zeile loeschen
  453 E25F  F1          	POP	AF
  454 E260  14          	INC	D
  455 E261  3D          	DEC	A
  456 E262  20 F7       	JR	NZ,CLS1		; A Zeilen
  457                   
  458                   ; Cursor in Home-Position mit Code 10h
  459 E264  16 00       HOMEPG:	LD	D,0		; Zeile 0
  460 E266  1E 00       CBL:	LD	E,0		; Spalte 0
  461 E268  C9          	RET
  462                   
  463                   ; Scrollroutine
  464 E269  DD 7E 04    SCRLPG:	LD	A,(IX+4)	; CAOS-C-Schaltzustand
  465 E26C  F5          	PUSH	AF		; merken
  466                   	SETIXA	7,4		; SET 7,(IX+4),A
    1 E26D  DD CB 04    	 DB	0DDh,0CBh,4
    2 E270  FF          	 DB	7 SHL 3 OR 11000111b
  467 E271  D3 86       	OUT	(PORT2),A	; CAOS-C ein
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  96
CE47    INC

  468 E273  CD D233     	CALL	SCRLD		; weiter im CAOS-D-Segment
  469 E276  18 0D       	JR	CCRES
  470                   
  471                   ; Zeile loeschen mit Code 02h (ShDEL)
  472 E278  DD 7E 04    CLLN:	LD	A,(IX+4)	; CAOS-C-Schaltzustand
  473 E27B  F5          	PUSH	AF		; merken
  474                   	SETIXA	7,4		; SET 7,(IX+4),A
    1 E27C  DD CB 04    	 DB	0DDh,0CBh,4
    2 E27F  FF          	 DB	7 SHL 3 OR 11000111b
  475 E280  D3 86       	OUT	(PORT2),A	; CAOS-C ein
  476 E282  CD D27A     	CALL	CLLND		; weiter im CAOS-D-Segment
  477 E285  F1          CCRES:	POP	AF
  478 E286  DD 77 04    	LD	(IX+4),A	; CAOS-C
  479 E289  D3 86       	OUT	(PORT2),A	; wie vorher
  480 E28B  C9          	RET
  481                   
  482 E28C  01 0A0F     BEEP:	LD	BC,0A0FH	; B=Dauer, C=Lautstaerke
  483 E28F  21 0030     	LD	HL,48		; HL=Tonhoehe 1
  484 E292  D5          	PUSH	DE
  485 E293  5C          	LD	E,H		; E=0 (keine Tonhoehe 2)
  486 E294  CD F915     	CALL	TON2
  487 E297  3E 1E       	LD	A,30
  488 E299  CD E2A3     	CALL	WAIT		; 30*6ms=180ms
  489 E29C  3E 03       	LD	A,3
  490 E29E  D3 8C       	OUT	(CTC0),A
  491 E2A0  3E 10       	LD	A,16		; 16*6ms=96ms
  492 E2A2  D1          	POP	DE
  493                   ;_____________________________________________________________
  494                   ;							**14**
  495                   ; Warteschleife ohne Interrupt
  496                   ; PE:	A	Zeitwert t = (A) * 6 ms
  497                   ; PA:	-
  498                   ; VR:	AF, B
  499                   
  500 E2A3  47          WAIT:	LD	B,A
  501 E2A4  AF          	XOR	A
  502 E2A5  CD E2AB     WAIT1:	CALL	WTUP
  503 E2A8  10 FB       	DJNZ	WAIT1
  504 E2AA  C9          	RET
  505                   ;
  506                   ; Zeitschleife 1
  507                   ;
  508 E2AB  3D          WTUP:	DEC	A		; UP fuer WAIT
  509 E2AC  C8          	RET	Z
  510 E2AD  F5          	PUSH	AF
  511 E2AE  F1          	POP	AF
  512 E2AF  18 FA       	JR	WTUP
  513                   ;
  514                   ; Ton fuer Tastenclick
  515                   ;
  516 E2B1  01 0307     CLIK:	LD	BC,0307H	; B=Dauer, C=Lautstaerke
  517 E2B4  21 0024     	LD	HL,36		; HL=Tonhoehe 1
  518 E2B7  D5          	PUSH	DE
  519 E2B8  5C          	LD	E,H		; E=0 (Tonhoehe 2)
  520 E2B9  CD F915     	CALL	TON2		; Ton ausgeben
  521 E2BC  D1          	POP	DE
  522 E2BD  C9          	RET
  523                   
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  97
CE47    INC

  524 E2BE  21 B7A3     ESC8:	LD	HL,COLOR	; Farbtausch
  525 E2C1  7E          	LD	A,(HL)
  526 E2C2  E6 07       	AND	00000111b	; Hintergrund
  527 E2C4  07          	RLCA
  528 E2C5  07          	RLCA
  529 E2C6  07          	RLCA
  530 E2C7  4F          	LD	C,A
  531 E2C8  7E          	LD	A,(HL)
  532 E2C9  E6 38       	AND	00111000b	; Vordergrund
  533 E2CB  0F          	RRCA
  534 E2CC  0F          	RRCA
  535 E2CD  0F          	RRCA
  536 E2CE  B1          	OR	C
  537 E2CF  4F          	LD	C,A
  538 E2D0  7E          	LD	A,(HL)
  539 E2D1  E6 C0       	AND	11000000b	; Attribute
  540 E2D3  B1          	OR	C
  541                   ;_____________________________________________________________
  542                   ;							**28**
  543                   ; LD (HL),A fuer PV4-PV6
  544                   ; PE:	A	Byte
  545                   ;	HL	Adresse
  546                   ; PA:	-
  547                   ; VR:	-
  548                   
  549 E2D4  77          LDMA:	LD	(HL),A
  550 E2D5  C9          	RET
  551                   ;_____________________________________________________________
  552                   ;							**29**
  553                   ; LD A,(HL) fuer PV4-PV6
  554                   ; PE:	HL	Adresse
  555                   ; PA:	A	Byte auf Adresse (HL)
  556                   ; VR:	A
  557                   
  558 E2D6  7E          LDAM:	LD	A,(HL)
  559 E2D7  C9          	RET
  560                   
  561 E2D8  DD 7E 08    CLICK:	LD	A,(IX+8)	; ShINS
  562 E2DB  EE 20       	XOR	20H
  563 E2DD  DD 77 08    	LD	(IX+8),A
  564 E2E0  C9          	RET
  565                   ;
  566                   ;*__*__*__*__*__*__*__*__*__*__*__*__*__
  567                   ;
  568                   ;	=== KBD-Treiber ===
  569                   
  570                   ; Z E I T I N T E R R U P T
  571                   ;
  572                   ; ISR CTC Kanal 3 (Tastatur)
  573                   ; Taste losgelassen
  574                   ;
  575 E2E1  FB          ISRC3:	EI
  576 E2E2  F5          	PUSH	AF
  577 E2E3  3E 23       	LD	A,23H	  	; DI, ZG256, Reset
  578 E2E5  D3 8F       	OUT	(CTC3),A
  579 E2E7  DD 36 0D 00 	LD	(IX+13),0	; Zeichen tot
  580 E2EB  18 5A       	JR	TST5		; freigeben
  581                   ;
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  98
CE47    INC

  582                   ;*__*__*__*__*__*__*__*__*__*__*__*__*__
  583                   ;
  584                   ; Keyboard-Interrupt-Routine
  585                   ; Zeitkonstanten:
  586                   ;
  587         008F      TCTZK	EQU	143	; 8FH
  588         0065      TGE0	EQU	101	; 65H
  589         0042      TGE1	EQU	66	; 42H
  590         0014      FEHL1	EQU	20
  591         0078      FEHL2	EQU	120
  592                   ;
  593                   ; T A S T A T U R I N T E R R U P T
  594                   ;
  595                   ; ISR PIO Kanal B (Tastatur)
  596                   ; Taste gedrueckt
  597                   ;
  598 E2ED  F5          ISRPB:	PUSH	AF
  599 E2EE  DB 8F       	IN	A,(CTC3)	; gemessene Zeit
  600 E2F0  F5          	PUSH	AF
  601 E2F1  3E A7       	LD	A,0A7H		; EI, ZG256, Reset
  602 E2F3  D3 8F       	OUT	(CTC3),A
  603 E2F5  3E 8F       	LD	A,TCTZK		; Zeitkonstante
  604 E2F7  D3 8F       	OUT	(CTC3),A
  605 E2F9  F1          	POP	AF
  606 E2FA  FB          	EI
  607 E2FB  FE 14       	CP	FEHL1		; neue Betaetigung? (Zeitinterrupt ausgeloest)
  608 E2FD  38 48       	JR	C,TST5		; oder zu lang
  609 E2FF  FE 78       	CP	FEHL2
  610 E301  30 44       	JR	NC,TST5		; zu kurz
  611 E303  FE 65       	CP	TGE0		; Diskriminator
  612 E305  30 04       	JR	NC,TST1		; 0-Bit
  613 E307  C6 BE       	ADD	A,-TGE1		; 1-Bit
  614 E309  30 06       	JR	NC,TST2		; Stop-Bit
  615 E30B  DD CB 0C 1E TST1:	RR	(IX+12)		; Bit einschieben
  616 E30F  18 36       	JR	TST5
  617                   	;
  618 E311  E5          TST2:	PUSH	HL
  619 E312  D5          	PUSH	DE
  620 E313  DD 7E 0C    	LD	A,(IX+12)	; Wortregister
  621 E316  1F          	RRA			; 7bit-Scancode
  622 E317  EE 01       	XOR	1		; Startbit invertieren
  623                   ;
  624                   ; in CAOS 5.0/6.0 wird Shift-BRK hier zu Soft-Reset abgefragt
  625                   ; das koennte hier so aussehen:
  626                   ;
  627                   ;	CP	61		; Scancode Shift-BRK
  628                   ;	JR	NZ,IBRK
  629                   ;IBRK:	CALL	IRET		; Interrupts freigeben
  630                   ;	JP	BYE		; Sprung zu RESET
  631                   ;IBRK:
  632 E319  DD 6E 0E    	LD	L,(IX+14)
  633 E31C  DD 66 0F    	LD	H,(IX+15)	; aktuelle KTAB-Adresse
  634 E31F  16 00       	LD	D,0
  635 E321  5F          	LD	E,A
  636 E322  19          	ADD	HL,DE		; Position in KTAB
  637 E323  7E          	LD	A,(HL)		; ASCII holen
  638 E324  DD CB 08 7E 	BIT	7,(IX+8)	; CAPS aktiv?
  639 E328  20 07       	JR	NZ,TST3		; 1=nein
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page  99
CE47    INC

  640 E32A  FE 40       	CP	40H
  641 E32C  FA E331     	JP	M,TST3		; Befehl aus CAOS 3.4 uebernommen
  642 E32F  EE 20       	XOR	20H		; klein<=>gross
  643 E331  57          TST3:	LD	D,A		; Code merken
  644 E332  DD BE 0D    	CP	(IX+13)		; gleicher Code wie zuvor?
  645 E335  20 17       	JR	NZ,TST6		; nein
  646 E337  21 B7E0     	LD	HL,COUNT
  647 E33A  CD E386     	CALL	IRMGET
  648 E33D  DD BE 0A    	CP	(IX+10)		; FastRepeat?
  649 E340  38 1C       	JR	C,TST7
  650 E342  DD 34 0A    	INC	(IX+10)		; Zeit abwarten
  651 E345  D1          TST4:	POP	DE
  652 E346  E1          	POP	HL
  653 E347  DB 89       TST5:	IN	A,(PIOBD)	; PIO-Logik
  654 E349  D3 89       	OUT	(PIOBD),A	; freigeben
  655 E34B  F1          	POP	AF
  656 E34C  ED 4D       	RETI
  657                   
  658 E34E  DD 36 0A 00 TST6:	LD	(IX+10),0	; neuer Code
  659 E352  FE 16       	CP	16H		; CAPS?
  660 E354  20 09       	JR	NZ,TST8
  661 E356  DD 7E 08    	LD	A,(IX+8)
  662 E359  EE 80       	XOR	80H		; CAPS on/off
  663 E35B  DD 77 08    	LD	(IX+8),A
  664 E35E  7A          TST7:	LD	A,D		; Code
  665 E35F  DD 77 0D    TST8:	LD	(IX+13),A	; eintragen
  666 E362  DD CB 08 C6 	SET	0,(IX+8)	; gueltig machen
  667 E366  18 DD       	JR	TST4
  668                   ;_____________________________________________________________
  669                   ;							**0C**
  670                   ; Tastaturabfrage ohne Quittung
  671                   
  672 E368  B7          KBDS:	OR	A		; CY=0
  673 E369  DD CB 08 46 	BIT	0,(IX+8)	; Code gueltig?
  674 E36D  C8          	RET	Z		; nein
  675 E36E  DD 7E 0D    	LD	A,(IX+13)	; Tastencode holen
  676 E371  37          	SCF			; und mit CY=1 zurueck melden
  677 E372  C9          	RET
  678                   ;_____________________________________________________________
  679                   ;							**0E**
  680                   ; Tastaturabfrage mit Quittung
  681                   
  682 E373  CD E368     KBDZ:	CALL	KBDS		; Tastaturabfrage
  683 E376  D0          	RET	NC		; keine Taste gedrueckt
  684 E377  DD CB 08 86 	RES	0,(IX+8)	; Taste quittieren
  685 E37B  C9          	RET
  686                   ;_____________________________________________________________
  687                   ;							**2A**
  688                   ; Test auf BRK-Anforderung
  689                   
  690 E37C  CD E368     BRKT:	CALL	KBDS		; Tastaturabfrage
  691 E37F  D0          	RET	NC		; keine Taste gedrueckt
  692 E380  FE 03       	CP	3		; war das die BRK-Taste?
  693 E382  37          	SCF			; CY=1
  694 E383  C8          	RET	Z		; ja, BRK erkannt
  695 E384  A7          	AND	A		; CY=0
  696 E385  C9          	RET
  697                   ;
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 100
CE47    INC

  698                   ; Arbeitszelle aus IRM lesen (innerhalb eines Interrupt)
  699                   ; PE:	HL	Adresse
  700                   ; PA:	A	Inhalt
  701                   ; VR:	A
  702                   ;
  703 E386  D5          IRMGET:	PUSH	DE
  704 E387  DB 88       	IN	A,(PIOAD)
  705 E389  5F          	LD	E,A		; IRM-Schaltzustand in Reg. E merken
  706 E38A  CB D7       	SET	2,A		; IRM on!
  707 E38C  F3          	DI			; damit Stack nicht genutzt wird!
  708 E38D  D3 88       	OUT	(PIOAD),A
  709 E38F  56          	LD	D,(HL)		; Arbeitszelle lesen
  710 E390  7B          	LD	A,E
  711 E391  D3 88       	OUT	(PIOAD),A	; IRM wie zuvor
  712 E393  FB          	EI
  713 E394  7A          	LD	A,D		; Wert nach A uebergeben
  714 E395  D1          	POP	DE
  715 E396  C9          	RET
  716                   ;
  717                   ; ISR fuer Fremdtastatur an SIO-B
  718                   ;
  719 E397  F5          ISRT:	PUSH	AF
  720 E398  E5          	PUSH	HL
  721 E399  D5          	PUSH	DE
  722 E39A  C5          	PUSH	BC
  723 E39B  21 A800     	LD	HL,V24PL	; Steckplatz M003
  724 E39E  CD E386     	CALL	IRMGET		; aus IRM lesen, Rueckkehr mit EI
  725 E3A1  47          	LD	B,A		; Steckplatz M003 holen
  726 E3A2  0E 80       	LD	C,80H
  727 E3A4  3E 01       	LD	A,1
  728 E3A6  ED 79       	OUT	(C),A		; Modul einschalten
  729 E3A8  DB 09       	IN	A,(9)		; empfangenen Code abholen
  730 E3AA  5F          	LD	E,A		; Code in Reg. E merken
  731 E3AB  A7          	AND	A
  732 E3AC  28 0E       	JR	Z,IST2		; Code 0 (Taste losgelassen)
  733 E3AE  DD BE 0D    	CP	(IX+13)		; 2x gleicher Tastencode?
  734 E3B1  3E 00       	LD	A,0		; kein Repeat
  735 E3B3  20 07       	JR	NZ,IST2
  736 E3B5  21 B7E0     	LD	HL,COUNT	; Repeat-Counter
  737 E3B8  CD E386     	CALL	IRMGET		; aus IRM lesen
  738 E3BB  3C          	INC	A		; sofort aktivieren
  739 E3BC  DD 77 0A    IST2:	LD	(IX+10),A	; repeat setzen
  740 E3BF  7B          	LD	A,E		; gemerkten
  741 E3C0  DD 77 0D    	LD	(IX+13),A	; Code eintragen
  742 E3C3  A7          	AND	A		; Code=0 ?
  743 E3C4  28 04       	JR	Z,IST3		; ja
  744 E3C6  DD CB 08 C6 	SET	0,(IX+8)	; sonst aktivieren
  745 E3CA  26 B8       IST3:	LD	H,HIGH(MODST)	; Modulsteuerbytespeicher
  746 E3CC  68          	LD	L,B		; Steckplatz
  747 E3CD  CD E386     	CALL	IRMGET		; Schaltzustand vor ISR ermitteln
  748 E3D0  ED 79       	OUT	(C),A		; und wiederherstellen
  749 E3D2  C1          	POP	BC
  750 E3D3  18 48       	JR	IPOP3		; POP DE,HL,AF; RETI
  751                   
  752                   ;	=== Joystick-Treiber fuer M008/M021 ===
  753                   
  754 E3D5  F5          ISRJ:	PUSH	AF
  755 E3D6  DB 90       	IN	A,(90h)		; M008 PIO A Daten
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 101
CE47    INC

  756 E3D8  FB          	EI
  757 E3D9  2F          	CPL
  758 E3DA  E5          	PUSH	HL
  759 E3DB  D5          	PUSH	DE
  760 E3DC  E6 3F       	AND	00111111b	; Achsbewegung und/oder Feuertaste?
  761 E3DE  28 42       	JR	Z,ISRJ4
  762 E3E0  FE 10       	CP	00010000b	; Feuertaste?
  763 E3E2  38 06       	JR	C,ISRJ1
  764 E3E4  E6 30       	AND	00110000b	; Ignoriere Achse: Feuertasten haben Vorrang
  765 E3E6  0F          	RRCA			; Nutze Luecken zwischen den Achsrichtungen in
  766 E3E7  0F          	RRCA			; der Tastaturcode-Tabelle fuer Feuertasten
  767 E3E8  EE 0F       	XOR	00001111b	; A=0000xx11
  768 E3EA  C5          ISRJ1:	PUSH	BC
  769 E3EB  4F          	LD	C,A		; Tabellenindex
  770 E3EC  06 00       	LD	B,0
  771 E3EE  DB 88       	IN	A,(PIOAD)
  772 E3F0  57          	LD	D,A
  773 E3F1  F6 04       	OR	00000100b	; IRM ein
  774 E3F3  F3          	DI
  775 E3F4  D3 88       	OUT	(PIOAD),A
  776 E3F6  2A B7F0     	LD	HL,(JOYTAB)	; Adresse der Codetabelle fuer Joystick
  777 E3F9  5E          	LD	E,(HL)		; Wartezyklen waehrend Tastenwiederholung
  778 E3FA  09          	ADD	HL,BC		; Tastaturcode nachschlagen
  779 E3FB  6E          	LD	L,(HL)
  780 E3FC  3A B7E0     	LD	A,(COUNT)	; Wartezyklen vor erster Wiederholung
  781 E3FF  67          	LD	H,A		; (entsprechend Abfragerate der Tastatur)
  782 E400  7A          	LD	A,D
  783 E401  D3 88       	OUT	(PIOAD),A	; IRM-Zustand wiederherstellen
  784 E403  FB          	EI
  785 E404  C1          	POP	BC
  786 E405  3E 4F       	LD	A,01001111b	; Byte-Eingabemodus (mit Strobe-Interrupt)
  787 E407  D3 92       	OUT	(92h),A		; M008 PIO A Steuerwort
  788 E409  7D          	LD	A,L
  789 E40A  A7          	AND	A		; Tastencode zugewiesen?
  790 E40B  28 10       	JR	Z,IPOP3
  791 E40D  DD BE 0D    	CP	(IX+13)		; neuer Tastencode?
  792 E410  28 28       	JR	Z,ISRJ5
  793 E412  DD 77 0D    	LD	(IX+13),A	; Tastencode eintragen
  794 E415  AF          	XOR	A
  795 E416  DD CB 08 C6 ISRJ2:	SET	0,(IX+8)	; gueltig markieren
  796 E41A  DD 77 0A    ISRJ3:	LD	(IX+10),A	; Zaehler zuruecksetzen
  797 E41D  D1          IPOP3:	POP	DE
  798 E41E  E1          	POP	HL
  799 E41F  F1          	POP	AF
  800 E420  ED 4D       	RETI
  801                   
  802 E422  DD BE 0A    ISRJ4:	CP	(IX+10)		; vorheriger Code war neu? (A war 0)
  803 E425  3C          	INC	A
  804 E426  30 F2       	JR	NC,ISRJ3	; dann zum Entprellen einen Zyklus warten
  805 E428  21 ED9E     	LD	HL,JOYINI
  806 E42B  F3          	DI
  807 E42C  CD F54F     	CALL	INIEA		; Ruhestellung: Strobe-Interrupt wieder aus
  808 E42F  FB          	EI
  809 E430  AF          	XOR	A
  810 E431  DD 77 0D    	LD	(IX+13),A	; Tastencode loeschen
  811 E434  DD CB 08 86 	RES	0,(IX+8)	; ungueltig markieren
  812 E438  18 E0       	JR	ISRJ3
  813                   
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 102
CE47    INC

  814 E43A  7C          ISRJ5:	LD	A,H		; Wartezyklen vor erster Wiederholung
  815 E43B  87          	ADD	A,A		; an Abfragerate des Joysticks anpassen
  816 E43C  87          	ADD	A,A		; (COUNT sollte kleiner als 64 sein)
  817 E43D  BB          	CP	E		; weniger als waehrend Wiederholung?
  818 E43E  30 01       	JR	NC,ISRJ6
  819 E440  7B          	LD	A,E		; Zaehlerende = max(A,E)
  820 E441  67          ISRJ6:	LD	H,A
  821 E442  DD 7E 0A    	LD	A,(IX+10)
  822 E445  BC          	CP	H		; Zaehlerende erreicht?
  823 E446  3C          	INC	A
  824 E447  38 D1       	JR	C,ISRJ3
  825 E449  7C          	LD	A,H		; Zaehler = Endwert - Wartezyklen
  826 E44A  93          	SUB	E
  827 E44B  18 C9       	JR	ISRJ2		; erneut gueltig markieren
  828                   ;
  829                   ; Initialisierung vor Kassetten-I/O
  830                   ;
  831 E44D  DD 36 03 01 ISRI1:	LD	(IX+3),1	; 1. Block lesen
  832 E451  F3          	DI
  833 E452  DB 88       	IN	A,(PIOAD)
  834 E454  F6 40       	OR	01000000b	; Motor ein
  835 E456  E6 DF       	AND	11011111b	; LED aus
  836 E458  D3 88       ISRO1:	OUT	(PIOAD),A
  837 E45A  FB          	EI
  838 E45B  2A B7A4     	LD	HL,(WEND)	; Page/Scroll-Modus
  839 E45E  22 B7CF     	LD	(ZWEND),HL	; hier merken
  840 E461  CD F38C     	CALL	NOUT		; CRT-Ausgabe (kein Drucker!)
  841 E464  22 B7CD     	LD	(ZOTAB),HL	; alten Zeiger hier merken
  842 E467  CD E1F5     	CALL	PAGEM		; Page Mode
  843 E46A  3E 03       TOFF:	LD	A,3		; CTC Stop
  844 E46C  D3 8C       	OUT	(CTC0),A	; Tonhoehe Kanal 1
  845 E46E  D3 8D       	OUT	(CTC1),A	; Tonhoehe Kanal 2
  846 E470  DD CB 08 8E 	RES	1,(IX+8)	; Ton ist jetzt aus
  847 E474  18 1D       	JR	CSRO2
  848                   ;_____________________________________________________________
  849                   ;							**09**
  850                   ; Abschluss Bandausgabe
  851                   ; PA:	CY=0
  852                   
  853 E476  DD 36 02 FE TCSRO:	LD	(IX+2),0FEH	; FFH = Kennung Ende-Block
  854 E47A  CD D00F     	CALL	TMBO		; Block auf Kassette ausgeben
  855                   ;_____________________________________________________________
  856                   ;							**0B**
  857                   ; Abschluss Bandeingabe
  858                   ; PA:	CY=0
  859                   
  860 E47D  2A B7CD     TCSRI:	LD	HL,(ZOTAB) 	; intern
  861 E480  22 B7B9     	LD	(OUTAB),HL
  862 E483  2A B7CF     	LD	HL,(ZWEND)	; grosses
  863 E486  22 B7A4     	LD	(WEND),HL	; Ruecksetzen
  864                   ;	CALL	CLC		; Puffer loeschen (VR: HL)
  865 E489  DB 88       	IN	A,(PIOAD)
  866 E48B  E6 9F       	AND	10011111b	; Motor, LED aus
  867 E48D  D3 88       	OUT	(PIOAD),A
  868                   ;	CALL	CRLF		; VR: AF
  869 E48F  DD CB 08 86 	RES	0,(IX+8)	; kein Tastencode im Puffer
  870 E493  DD CB 01 5E CSRO2:	BIT	3,(IX+1)	; HiRes?
  871 E497  28 06       	JR	Z,CSRO3
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 103
CE47    INC

  872 E499  DB 89       	IN	A,(PIOBD)	; nein
  873 E49B  CB FF       	SET	7,A		; Blinken ein
  874 E49D  D3 89       	OUT	(PIOBD),A
  875 E49F  DD CB 08 4E CSRO3:	BIT	1,(IX+8)	; neuer Ton?
  876 E4A3  20 FA       	JR	NZ,CSRO3	; Ende abwarten
  877 E4A5  DB 88       	IN	A,(PIOAD)
  878 E4A7  6F          	LD	L,A		; Schaltzustand IRM merken
  879 E4A8  CB D7       	SET	2,A		; IRM on
  880 E4AA  F3          	DI			; Interrupt verbieten wegen Stacknutzung
  881 E4AB  D3 88       	OUT	(PIOAD),A
  882 E4AD  3A B7DB     	LD	A,(CTCMD)	; CTC2-Modus
  883 E4B0  E6 60       	AND	01100000b	; nur Zaehler/Zeitgeber und Vorteiler verwenden
  884 E4B2  F6 07       	OR	00000111b	; immer RESET, Zeitkonstante laden
  885 E4B4  D3 8E       	OUT	(CTC2),A	; Blinken
  886 E4B6  3A B7DC     	LD	A,(BLINK)	; ZK laden
  887 E4B9  D3 8E       	OUT	(CTC2),A
  888 E4BB  7D          	LD	A,L
  889 E4BC  D3 88       	OUT	(PIOAD),A	; IRM wie zuvor einstellen
  890 E4BE  FB          	EI			; Interrupt wieder ein
  891 E4BF  C9          	RET
  892                   ;
  893                   ; Kassettenpuffer loeschen:
  894                   ; PA:	DE = CASS
  895                   ;	A = 0
  896                   ; VR:	DE,A
  897                   ;
  898 E4C0  11 B780     CLC:	LD	DE,CASS+80H
  899 E4C3  AF          	XOR	A
  900 E4C4  1D          CLC1:	DEC	E
  901 E4C5  12          	LD	(DE),A
  902 E4C6  20 FC       	JR	NZ,CLC1
  903 E4C8  C9          	RET
  904                   
  905                   ; Aufruf Treiberroutinen aehnlich PV1 mit CALL PV7, DB nr.
  906                   ; Nr.	 0 = MBO
  907                   ;	 1 = MBI
  908                   ;	 2 = ISRO
  909                   ;	 3 = CSRO
  910                   ;	 4 = ISRI
  911                   ;	 5 = CSRI
  912                   ;	 6 = MBIN - nicht mehr erforderlich
  913                   ;	 7 = MBOUT - nicht mehr erforderlich
  914                   ;	 8 = DIR
  915                   ;	 9 = CD
  916                   ;	10 = ERA
  917                   ;	11 = REN
  918                   ; PE:	entsprechend der aufgerufenen Routine
  919                   ; PA:	entsprechend der aufgerufenen Routine
  920                   ; VR:	-
  921                   ;										auf Stack liegt:
  922 E4C9  E5          PV7:	push	hl		;						RET,HL
  923 E4CA  21 E53A     	ld	hl,moff		; Module ausschalten nach Aufruf der Routine
  924 E4CD  E3          	ex	(sp),hl		;						RET,MOFF
  925 E4CE  E5          	PUSH	HL		; HL auf Stack					RET,MOFF,HL
  926 E4CF  F3          	DI
  927 E4D0  E1          	POP	HL		; und wieder bereinigen				RET,MOFF ,hl
  928 E4D1  E1          	POP	HL		; HL = MOFF					RET ,moff,hl
  929 E4D2  E1          	POP	HL		; HL = RET-Adresse wo CALL herkommt		- ,ret,moff,hl
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 104
CE47    INC

  930 E4D3  23          	INC	HL		; nr uebergehen
  931 E4D4  E5          	PUSH	HL		; neue RET-Adresse nach Datenbyte		RET ,moff,hl
  932 E4D5  2B          	DEC	HL		; (HL)=nr
  933 E4D6  3B          	DEC	SP
  934 E4D7  3B          	DEC	SP		;						RET,MOFF ,hl
  935 E4D8  3B          	DEC	SP
  936 E4D9  3B          	DEC	SP		; PUSH HL bleibt uebrig				RET,MOFF,HL
  937 E4DA  FB          	EI			; und HL zeigt auf Datenbyte
  938                   
  939                   ; 1. Sprungadresse von Treiber berechnen aus Nr. und IX+8
  940                   
  941 E4DB  F5          	PUSH	AF		;						RET,MOFF,HL,AF
  942 E4DC  7E          	LD	A,(HL)		; Nr. der Routine
  943 E4DD  FE 0C       	cp	12		; Treiberfunktion > 11?
  944 E4DF  38 03       	JR	C,PV71
  945 E4E1  F1          	POP	AF		; Abbruch bei Fehler
  946 E4E2  E1          	POP	HL
  947 E4E3  C9          	RET
  948                   	;
  949 E4E4  87          PV71:	ADD	A,A		; 2 Byte je Sprungadresse
  950 E4E5  C6 08       	ADD	A,8		; 8 Byte Kopfdaten uebergehen
  951 E4E7  6F          	LD	L,A		; Aufrufadresse der Treiber-Routine
  952 E4E8  CD ED90     	CALL	DEV		; DEVICE-Nr. in Bit 2-4
  953                   ;	RLCA
  954                   ;	RLCA
  955                   ;	RLCA			; Device-Nr. 0, 20h, 40h, ... E0h in Bit 5-7
  956 E4EB  B5          	OR	L		; Adresse einbauen in Bit 0-4
  957 E4EC  6F          	LD	L,A
  958 E4ED  26 A9       	LD	H,High(DEVTAB)	; (HL)=Sprungadresse
  959 E4EF  7E          	LD	A,(HL)		; Sprungadresse Low
  960 E4F0  23          	INC	HL
  961 E4F1  66          	LD	H,(HL)		; Sprungadresse High
  962 E4F2  6F          	LD	L,A		; HL=Sprungadresse der Routine
  963 E4F3  F1          	POP	AF		;						RET,MOFF,HL
  964 E4F4  E3          	EX	(SP),HL		; Sprungadresse auf Stack			RET,MOFF,JPADR
  965                   
  966                   ; 1. Module passend schalten nach IX+8 (DEVTAB+1 = Steckplatz, DEVTAB+3 = EIN)
  967                   
  968 E4F5  E5          	PUSH	HL
  969 E4F6  D5          	PUSH	DE
  970 E4F7  C5          	PUSH	BC
  971 E4F8  F5          	PUSH	AF
  972                   
  973 E4F9  26 A9       	LD	H,High(DEVTAB)
  974 E4FB  CD ED90     	CALL	DEV		; DEVICE-Nr. in Bit 2-4
  975                   ;	RLCA
  976                   ;	RLCA
  977                   ;	RLCA			; Device-Nr. 0, 20h, 40h, ... E0h in Bit 5-7
  978 E4FE  F6 01       	OR	1		; DEVTAB+1
  979 E500  6F          	LD	L,A
  980 E501  5E          	LD	E,(HL)		; Steckplatz
  981                   
  982                   	; hier alle davor liegenden Speichermodule ausschalten?
  983                   
  984 E502  16 B8       	LD	D,High(MODST)
  985 E504  1A          	LD	A,(DE)		; aktueller Schaltzustand
  986 E505  2C          	INC	L
  987 E506  77          	LD	(HL),A		; als Schaltzustand AUS in DEVTAB+2 eintragen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 105
CE47    INC

  988 E507  2C          	INC	L		; DEVTAB+3
  989                   
  990 E508  7E          	LD	A,(HL)		; Steuerbyte EIN
  991 E509  12          	LD	(DE),A		; in MODST eintragen
  992 E50A  57          	LD	D,A		; Steuerbyte
  993                   ;	LD	D,(HL)		; Steuerbyte EIN
  994                   
  995 E50B  7B          	LD	A,E		; Steckplatz
  996 E50C  1E 00       	LD	E,0		; AUS fuer CAOS-C
  997 E50E  FE 05       	CP	5		; CAOS-ROM-C?
  998 E510  20 02       	JR	NZ,MO1
  999 E512  1E 80       	LD	E,80h		; EIN fuer CAOS-C
 1000 E514  FE 07       MO1:	CP	7
 1001 E516  38 05       	JR	C,MO2		; intenes Modul
 1002 E518  0E 80       	LD	C,80h
 1003 E51A  47          	LD	B,A
 1004 E51B  ED 51       	OUT	(C),D		; Steuerbyte zu Modul senden
 1005                   
 1006 E51D  DB 88       MO2:	IN	A,(PIOAD)	; SWITCH 2 0:
 1007 E51F  E6 7F       	AND	7Fh		; USER-ROM C immer aus!
 1008 E521  D3 88       	OUT	(PIOAD),A
 1009                   
 1010 E523  21 B805     	LD	HL,MODST+5	; SWITCH 5
 1011 E526  DD 7E 04    	LD	A,(IX+4)
 1012 E529  E6 80       	AND	80h		; aktueller Schaltzustand CAOS-ROM
 1013 E52B  B6          	OR	(HL)		; in Modulsteuerbyte Bit 7 einbauen
 1014 E52C  77          	LD	(HL),A		; und dort merken
 1015 E52D  DD 7E 04    	LD	A,(IX+4)	; SWITCH 5 0:
 1016 E530  E6 7F       	AND	7Fh		; CAOS-ROM C aus
 1017 E532  B3          	OR	E		; oder EIN falls Programm dort steht!
 1018 E533  DD 77 04    	LD	(IX+4),A	; CAOS-C
 1019 E536  D3 86       	OUT	(PORT2),A
 1020                   
 1021 E538  18 39       	JR	MSW		; Routine aufrufen
 1022                   
 1023                   ; 3. Module nach Treiberaufruf wieder schalten wie zuvor
 1024                   
 1025 E53A  E5          MOFF:	PUSH	HL
 1026 E53B  D5          	PUSH	DE
 1027 E53C  C5          	PUSH	BC
 1028 E53D  F5          	PUSH	AF
 1029                   
 1030                   	; hier alle davor liegenden Speichermodule wieder einschalten?
 1031                   
 1032 E53E  21 B802     	LD	HL,MODST+2	; SWITCH 2 n
 1033 E541  56          	LD	D,(HL)		; aktuelles Steuerbyte
 1034 E542  CD F102     	CALL	MODUSW		; USER-ROM wie vorher schalten
 1035                   
 1036 E545  26 A9       	LD	H,High(DEVTAB)
 1037 E547  CD ED90     	CALL	DEV		; DEVICE-Nr. in Bit 5-7 (0, 20h, 40h ...)
 1038 E54A  F6 02       	OR	2		; DEVTAB+2
 1039 E54C  6F          	LD	L,A
 1040 E54D  56          	LD	D,(HL)		; Steuerbyte fuer AUS
 1041 E54E  2D          	DEC	L
 1042 E54F  7E          	LD	A,(HL)		; Steckplatz
 1043                   
 1044 E550  6F          	LD	L,A		; Steckplatz in L
 1045 E551  FE 05       	CP	5		; CAOS-ROM C?
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 106
CE47    INC

 1046 E553  28 09       	jr	z,m4
 1047 E555  CD F102     	CALL	MODUSW		; Modul ausschalten (falls nicht CAOS-ROM C)
 1048 E558  3A B805     	ld	a,(modst+5)	; vorheriger Schaltzustand CAOS-C
 1049 E55B  E6 01       	and	1		; ohne Merkbit 7
 1050 E55D  57          	ld	d,a
 1051 E55E  21 B805     m4:	LD	HL,MODST+5	; SWITCH 5 n
 1052 E561  7E          	LD	A,(HL)		; vorheriger Schaltzustand in Bit 7
 1053 E562  72          	LD	(HL),D		; urspruenglicher Schaltzustand vor PV7
 1054 E563  E6 80       	AND	80h		; nur Bit 7 betrachten
 1055 E565  DD 7E 04    	LD	A,(IX+4)
 1056 E568  CB BF       	RES	7,A		; CAOS-C aus
 1057 E56A  28 02       	JR	Z,M5		; es war auch aus!
 1058 E56C  CB FF       	SET	7,A		; CAOS-C ein
 1059 E56E  DD 77 04    M5:	LD	(IX+4),A	; vorherigen Schaltzustand CAOS-ROM-C herstellen
 1060 E571  D3 86       	OUT	(PORT2),A	; CAOS-C wie vor Aufruf PV7
 1061                   
 1062 E573  C3 E097     MSW:	JP	POP4
 1063                   
 1064                   ; ********	DEVICE-Routinen mit Modulschaltung aufrufen	********
 1065                   ;_____________________________________________________________
 1066                   ;							**01**
 1067                   ; Einen Block ausgeben:
 1068                   ; PE:	BC	Laenge Vorton
 1069                   ;	(IX+2)	Block-Nr. -1
 1070                   ; PA:	DE=HL	Pufferende + 1
 1071                   ;	(IX+2)	Block-Nr.
 1072                   ; VR:	AF,BC,DE,HL
 1073                   
 1074 E576  CD E4C9     MBO:	CALL	PV7
 1075 E579  00          	DB	0
 1076 E57A  C9          	RET
 1077                   ;_____________________________________________________________
 1078                   ;							**05**
 1079                   ; Einen Block einlesen:
 1080                   ; PE:	IX+5/6	Pufferadresse
 1081                   ; PA:	CY=1	Fehler
 1082                   ; VR:	AF,BC
 1083                   
 1084 E57B  CD E4C9     MBI:	CALL	PV7
 1085 E57E  01          	DB	1
 1086 E57F  C9          	RET
 1087                   ;_____________________________________________________________
 1088                   ;							**08**
 1089                   ; Initialisierung Bandausgabe / Datei zum Schreiben oeffnen:
 1090                   ; PE:	Kassettenpuffer mit Daten des Vorblocks
 1091                   ;	HL	Dateiname
 1092                   ; PA:	CY=1	Fehler
 1093                   ; VR:	AF,BC,DE,HL
 1094                   
 1095 E580  CD E4C9     ISRO:	CALL	PV7
 1096 E583  02          	DB	2
 1097 E584  C9          	RET
 1098                   ;_____________________________________________________________
 1099                   ;							**09**
 1100                   ; Abschluss Bandausgabe / Dateiausgabe schliessen:
 1101                   ; PE:	BC	Laenge Vorton
 1102                   ; PA:	CY=1	Fehler
 1103                   ; VR:	AF,BC,DE,HL
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 107
CE47    INC

 1104                   
 1105 E585  CD E4C9     CSRO:	CALL	PV7
 1106 E588  03          	DB	3
 1107 E589  C9          	RET
 1108                   ;_____________________________________________________________
 1109                   ;							**0A**
 1110                   ; Initialisierung Bandeingabe:
 1111                   ; (Datei zum Lesen oeffnen)
 1112                   ; PE:	HL	Dateiname
 1113                   ; PA:	CY=1	Fehler
 1114                   ; VR:	AF,BC
 1115                   
 1116 E58A  CD E4C9     ISRI:	CALL	PV7
 1117 E58D  04          	DB	4
 1118 E58E  C9          	RET
 1119                   ;_____________________________________________________________
 1120                   ;							**0B**
 1121                   ; Abschluss Bandeingabe / Dateieingabe schliessen:
 1122                   ; PA:	CY=1	Fehler
 1123                   
 1124 E58F  CD E4C9     CSRI:	CALL	PV7
 1125 E592  05          	DB	5
 1126 E593  C9          	RET
 1127                   ;
 1128                   ; ISR CTC Kanal 1 (Kassette-Out)
 1129                   ;
 1130 E594  F5          ISRC1:	PUSH	AF
 1131 E595  3E 87       	LD	A,10000111b	; EI,ZG16,Res
 1132 E597  D3 8D       	OUT	(CTC1),A
 1133 E599  DD 7E 00    	LD	A,(IX)		; Uebergabezelle Zeitkonstante
 1134 E59C  D3 8D       	OUT	(CTC1),A	; Start CTC
 1135 E59E  DD 36 00 00 	LD	(IX),0		; Quittierung
 1136 E5A2  18 0E       	JR	ISR1E		; EI, RETI
 1137                   ;
 1138                   ; ISR PIO Kanal A (Kassette-In)
 1139                   ;
 1140 E5A4  F5          ISRPA:	PUSH	AF
 1141 E5A5  DB 8E       	IN	A,(CTC2)	; CTC lesen
 1142 E5A7  DD 77 00    	LD	(IX),A		; und in Uebergabezelle ablegen
 1143 E5AA  3E 07       	LD	A,7
 1144 E5AC  D3 8E       	OUT	(CTC2),A	; CTC Neustart
 1145 E5AE  3E A3       	LD	A,IKEZK
 1146 E5B0  D3 8E       	OUT	(CTC2),A
 1147 E5B2  F1          ISR1E:	POP	AF
 1148 E5B3  FB          IRET:	EI
 1149 E5B4  ED 4D       	RETI
 1150                   
 1151                   ; ===== BASIC =====
 1152                   
 1153                   ; BASIC-Erweiterung 1: Erweiterungstoken starten
 1154                   ;
 1155                   ;***************************************************************
 1156                   ;*  E: <B>: TOKEN-LDTOK
 1157                   ;*     <HL>: AUF TOKEN
 1158                   ;*  A: <<SP>>: STARTADRESSE ROUTINE
 1159                   ;*     <HL>: AUF TOKEN
 1160                   ;***************************************************************
 1161                   
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 108
CE47    INC

 1162 E5B6  78          BEXP1:	LD	A,B		; Nr.
 1163 E5B7  D6 09       	SUB	9
 1164 E5B9  38 48       	JR	C,SNERR1
 1165 E5BB  FE 1F       	CP	(TOKJPE-TOKJP)/2-4	; 27 waren es Original
 1166 E5BD  30 44       	JR	NC,SNERR1	; Token ausserhalb
 1167 E5BF  07          	RLCA			; *2
 1168 E5C0  4F          	LD	C,A
 1169 E5C1  06 00       	LD	B,0
 1170 E5C3  EB          	EX	DE,HL
 1171 E5C4  21 FD91     	LD	HL,TADR5
 1172 E5C7  C3 C8B7     	JP	DLI22		; Ruecksprung zu Tokenverarbeitung
 1173                   
 1174 E5CA              LOCOL:	;LoadColor
 1175 E5CA  E5          	PUSH	HL
 1176 E5CB  21 B7A3     	LD	HL,COLOR	; 0B7A3H
 1177 E5CE  CD EB1D     	CALL	IRMRD
 1178 E5D1  E1          	POP	HL
 1179 E5D2  C9          	RET
 1180                   
 1181                   ; BASIC-Erweiterung 2: Print-Erweiterung?
 1182                   ;
 1183                   ;***************************************************************
 1184                   ;*  E:   <HL> AUF SIGNIF. ZEICHEN NACH PRTOK
 1185                   ;*  WENN  PRTFLG<>0 , DANN JP SNER
 1186                   ;*  A:   <HL> AUF ZEILENENDE
 1187                   ;***************************************************************
 1188                   
 1189 E5D3  7E          BEXP2:	LD	A,(HL)
 1190 E5D4  FE DF       	CP	0DFH		; INK-Token?
 1191 E5D6  D8          	RET	C		; <DFH
 1192 E5D7  FE E3       	CP	0E3H		; COLOR-Token?
 1193 E5D9  D0          	RET	NC		; >E2H
 1194 E5DA  FE E1       	CP	0E1H		; AT-Token?
 1195 E5DC  CA E945     	JP	Z,PRAT
 1196 E5DF  3A 03FD     	LD	A,(PRTFLG)
 1197 E5E2  A7          	AND	A		; PRINT-Erweiterung?
 1198 E5E3  20 1E       	JR	NZ,SNERR1
 1199 E5E5  3C          	INC	A
 1200 E5E6  32 03FD     	LD	(PRTFLG),A
 1201 E5E9  CD E5CA     PREX1:	CALL	LOCOL		; Farbwert lesen
 1202 E5EC  32 037E     	LD	(COLRET),A 	; Farbe merken
 1203 E5EF  7E          	LD	A,(HL)
 1204 E5F0  FE DF       	CP	0DFH		; INK?
 1205 E5F2  28 1A       	JR	Z,PRINK
 1206 E5F4  FE E2       	CP	0E2H		; COLOR?
 1207 E5F6  28 0E       	JR	Z,PRCOL
 1208 E5F8  CD C8BD     	CALL	TCHAR		; naechstes Zeichen holen
 1209 E5FB  CD EA1C     	CALL	PAPER		; Hintergrundfarbe
 1210 E5FE  7E          PREX2:	LD	A,(HL)
 1211 E5FF  FE 3B       	CP	';'
 1212 E601  28 3B       	JR	Z,PREX5
 1213 E603  C3 C348     SNERR1:	JP	SNER		; SN-ERROR
 1214                   
 1215 E606  CD C8BD     PRCOL:	CALL	TCHAR		; naechstes Zeichen holen
 1216 E609  CD EA0D     	CALL	BCOLOR		; Vordergrund- und Hintergrundfarbe
 1217 E60C  18 F0       	JR	PREX2
 1218                   
 1219 E60E  CD C8BD     PRINK:	CALL	TCHAR		; naechstes Zeichen holen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 109
CE47    INC

 1220 E611  CD E9FB     	CALL	INK		; Vordergrundfarbe
 1221 E614  7E          	LD	A,(HL)
 1222 E615  FE 3B       	CP	';'
 1223 E617  28 25       	JR	Z,PREX5
 1224 E619  CD C8CC     	CALL	CPSTX		; Komma?
 1225 E61C  2C          	DB	','
 1226 E61D  FE E0       	CP	0E0H		; PAPER?
 1227 E61F  20 E2       	JR	NZ,SNERR1
 1228 E621  CD C8BD     	CALL	TCHAR		; naechstes Zeichen holen
 1229 E624  CD EA1C     	CALL	PAPER
 1230 E627  CD C8CC     	CALL	CPSTX		; Semikolon?
 1231 E62A  3B          	DB	';'
 1232 E62B  CD CB03     PREX3:	CALL	PRINT2
 1233 E62E  3A 037E     	LD	A,(COLRET)	; Farbe
 1234 E631  E5          	PUSH	HL
 1235 E632  21 B7A3     	LD	HL,COLOR
 1236 E635  CD EB22     	CALL	IRMWR		; eintragen
 1237 E638  E1          	POP	HL
 1238 E639  C1          	POP	BC
 1239 E63A  C9          	RET
 1240                   
 1241 E63B  C5          PREX4:	PUSH	BC
 1242 E63C  18 AB       	JR	PREX1
 1243                   
 1244 E63E  CD C8BD     PREX5:	CALL	TCHAR		; naechstes Zeichen holen
 1245 E641  18 E8       	JR	PREX3
 1246                   
 1247                   ; BASIC: String vervielfaeltigen
 1248                   
 1249 E643  CD C8CC     STRING:	CALL	CPSTX		; Klammer auf?
 1250 E646  28          	DB	'('
 1251 E647  CD D421     	CALL	ARGVL1		; Wert abholen
 1252 E64A  F5          	PUSH	AF
 1253 E64B  CD C8D6     	CALL	CPCOMM		; Komma?
 1254 E64E  CD CD3A     	CALL	SNALY
 1255 E651  CD C8DB     	CALL	CPBRGT		; Klammer zu?
 1256 E654  F1          	POP	AF
 1257 E655  E5          	PUSH	HL
 1258 E656  F5          	PUSH	AF
 1259 E657  CD D330     	CALL	LEN1		; Laenge holen
 1260 E65A  23          	INC	HL
 1261 E65B  23          	INC	HL
 1262 E65C  5E          	LD	E,(HL)
 1263 E65D  23          	INC	HL
 1264 E65E  56          	LD	D,(HL)
 1265 E65F  C1          	POP	BC
 1266 E660  C5          	PUSH	BC
 1267 E661  F5          	PUSH	AF
 1268 E662  D5          	PUSH	DE
 1269 E663  4F          	LD	C,A
 1270 E664  AF          	XOR	A
 1271 E665  B9          	CP	C
 1272 E666  28 0C       	JR	Z,STR2
 1273 E668  B8          	CP	B
 1274 E669  28 09       	JR	Z,STR2
 1275 E66B  79          	LD	A,C
 1276 E66C  05          	DEC	B
 1277 E66D  28 05       	JR	Z,STR2
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 110
CE47    INC

 1278 E66F  81          STR1:	ADD	A,C
 1279 E670  38 2B       	JR	C,STR5		; LS-ERROR (String zu lang)
 1280 E672  10 FB       	DJNZ	STR1
 1281 E674  47          STR2:	LD	B,A
 1282 E675  0E 00       	LD	C,0
 1283 E677  C5          	PUSH	BC
 1284 E678  CD D1E1     	CALL	STROP		; String-Arithmetik
 1285 E67B  C1          	POP	BC
 1286 E67C  C1          	POP	BC
 1287 E67D  C5          	PUSH	BC
 1288 E67E  CD D17E     	CALL	SADTB1
 1289 E681  E1          	POP	HL
 1290 E682  E3          	EX	(SP),HL
 1291 E683  7C          	LD	A,H
 1292 E684  E1          	POP	HL
 1293 E685  E3          	EX	(SP),HL
 1294 E686  6F          	LD	L,A
 1295 E687  24          	INC	H
 1296 E688  25          STR3:	DEC	H
 1297 E689  E5          	PUSH	HL
 1298 E68A  C5          	PUSH	BC
 1299 E68B  28 07       	JR	Z,STR4
 1300 E68D  CD D2F2     	CALL	STRMV1
 1301 E690  C1          	POP	BC
 1302 E691  E1          	POP	HL
 1303 E692  18 F4       	JR	STR3
 1304                   	;
 1305 E694  C1          STR4:	POP	BC
 1306 E695  E1          	POP	HL
 1307 E696  D1          	POP	DE
 1308 E697  CD D302     	CALL	STRZS3
 1309 E69A  C3 D1A9     	JP	SLEN3
 1310                   	;
 1311 E69D  1E 1C       STR5:	LD	E,28		; LS-ERROR
 1312 E69F  C3 C356     	JP	ERROO		; Ausgabe Fehlercode
 1313                   
 1314                   ; BASIC: Neu nummerieren
 1315                   
 1316 E6A2  E5          RENUM:	PUSH	HL
 1317 E6A3  21 000A     	LD	HL,10
 1318 E6A6  22 0354     	LD	(DISTAN),HL	; Zeilennummernabstand
 1319 E6A9  2A 035F     	LD	HL,(PSTBEG)	; Programmbeginn
 1320 E6AC  F5          	PUSH	AF
 1321 E6AD  E5          	PUSH	HL
 1322 E6AE  23          	INC	HL
 1323 E6AF  23          	INC	HL
 1324 E6B0  7E          	LD	A,(HL)
 1325 E6B1  23          	INC	HL
 1326 E6B2  66          	LD	H,(HL)
 1327 E6B3  6F          	LD	L,A
 1328 E6B4  22 034E     	LD	(ANF),HL	; erste Zeilennummer
 1329 E6B7  22 0352     	LD	(NANF),HL
 1330 E6BA  ED 5B 03D7  	LD	DE,(SVARPT)	; Ende
 1331 E6BE  1B          	DEC	DE
 1332 E6BF  1B          	DEC	DE
 1333 E6C0  E1          REN01:	POP	HL
 1334 E6C1  E5          	PUSH	HL
 1335 E6C2  7E          	LD	A,(HL)
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 111
CE47    INC

 1336 E6C3  23          	INC	HL
 1337 E6C4  66          	LD	H,(HL)
 1338 E6C5  6F          	LD	L,A
 1339 E6C6  CD C689     	CALL	CPREG
 1340 E6C9  E3          	EX	(SP),HL
 1341 E6CA  20 F4       	JR	NZ,REN01
 1342 E6CC  D1          	POP	DE
 1343 E6CD  23          	INC	HL
 1344 E6CE  23          	INC	HL
 1345 E6CF  7E          	LD	A,(HL)
 1346 E6D0  23          	INC	HL
 1347 E6D1  66          	LD	H,(HL)
 1348 E6D2  6F          	LD	L,A
 1349 E6D3  22 0350     	LD	(ENDE),HL	; Zeilen-Abstand
 1350 E6D6  06 04       	LD	B,4
 1351 E6D8  F1          	POP	AF
 1352 E6D9  21 034E     	LD	HL,ANF
 1353 E6DC  E3          	EX	(SP),HL
 1354 E6DD  28 20       REN02:	JR	Z,REN05
 1355 E6DF  CD C986     	CALL	DCHEX
 1356 E6E2  F5          	PUSH	AF
 1357 E6E3  7A          	LD	A,D
 1358 E6E4  B3          	OR	E
 1359 E6E5  CA C967     REN03:	JP	Z,FCER	 	; FC-ERROR
 1360 E6E8  F1          	POP	AF
 1361 E6E9  E3          	EX	(SP),HL
 1362 E6EA  73          	LD	(HL),E
 1363 E6EB  23          	INC	HL
 1364 E6EC  72          	LD	(HL),D
 1365 E6ED  23          	INC	HL
 1366 E6EE  28 0F       	JR	Z,REN05
 1367 E6F0  F5          	PUSH	AF
 1368 E6F1  05          	DEC	B
 1369 E6F2  28 07       	JR	Z,REN04
 1370 E6F4  F1          	POP	AF
 1371 E6F5  E3          	EX	(SP),HL
 1372 E6F6  CD C8D6     	CALL	CPCOMM		; Komma?
 1373 E6F9  18 E2       	JR	REN02
 1374                   	;
 1375 E6FB  F1          REN04:	POP	AF
 1376 E6FC  C2 C348     	JP	NZ,SNER		; SN-ERROR
 1377 E6FF  2A 0350     REN05:	LD	HL,(ENDE)
 1378 E702  ED 5B 034E  	LD	DE,(ANF)	; ANFANG
 1379 E706  CD C689     	CALL	CPREG
 1380 E709  DA C967     REN06:	JP	C,FCER		; FC-ERROR
 1381 E70C  2A 035F     	LD	HL,(PSTBEG)
 1382 E70F  CD C4BE     REN07:	CALL	ZPOIT1		; naechste Zeile
 1383 E712  38 04       	JR	C,REN08
 1384 E714  28 CF       	JR	Z,REN03
 1385 E716  18 F7       	JR	REN07
 1386                   	;
 1387 E718  E1          REN08:	POP	HL
 1388 E719  C5          	PUSH	BC
 1389 E71A  ED 5B 0350  	LD	DE,(ENDE)
 1390 E71E  21 0000     	LD	HL,0
 1391 E721  22 0350     	LD	(ENDE),HL
 1392 E724  60          REN09:	LD	H,B
 1393 E725  69          	LD	L,C
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 112
CE47    INC

 1394 E726  4E          	LD	C,(HL)
 1395 E727  23          	INC	HL
 1396 E728  46          	LD	B,(HL)
 1397 E729  78          	LD	A,B
 1398 E72A  B1          	OR	C
 1399 E72B  28 B8       	JR	Z,REN03
 1400 E72D  23          	INC	HL
 1401 E72E  7E          	LD	A,(HL)
 1402 E72F  23          	INC	HL
 1403 E730  66          	LD	H,(HL)
 1404 E731  6F          	LD	L,A
 1405 E732  CD C689     	CALL	CPREG
 1406 E735  2A 0350     	LD	HL,(ENDE)
 1407 E738  23          	INC	HL
 1408 E739  22 0350     	LD	(ENDE),HL
 1409 E73C  20 E6       	JR	NZ,REN09
 1410 E73E  23          	INC	HL
 1411 E73F  23          	INC	HL
 1412 E740  29          	ADD	HL,HL
 1413 E741  23          	INC	HL
 1414 E742  ED 5B 03D7  	LD	DE,(SVARPT)
 1415 E746  19          	ADD	HL,DE
 1416 E747  38 C0       	JR	C,REN06
 1417 E749  CD C327     	CALL	TMEMO		; genug RAM?
 1418 E74C  22 03D7     	LD	(SVARPT),HL
 1419 E74F  AF          	XOR	A
 1420 E750  2B          	DEC	HL
 1421 E751  77          	LD	(HL),A
 1422 E752  2B          	DEC	HL
 1423 E753  77          	LD	(HL),A
 1424 E754  1B          	DEC	DE
 1425 E755  1B          	DEC	DE
 1426 E756  EB          	EX	DE,HL
 1427 E757  73          	LD	(HL),E
 1428 E758  23          	INC	HL
 1429 E759  72          	LD	(HL),D
 1430 E75A  23          	INC	HL
 1431 E75B  3D          	DEC	A
 1432 E75C  77          	LD	(HL),A
 1433 E75D  23          	INC	HL
 1434 E75E  77          	LD	(HL),A
 1435 E75F  23          	INC	HL
 1436 E760  EB          	EX	DE,HL
 1437 E761  2A 0352     	LD	HL,(NANF)
 1438 E764  22 034E     	LD	(ANF),HL
 1439 E767  E1          REN10:	POP	HL
 1440 E768  4E          	LD	C,(HL)
 1441 E769  23          	INC	HL
 1442 E76A  46          	LD	B,(HL)
 1443 E76B  23          	INC	HL
 1444 E76C  C5          	PUSH	BC
 1445 E76D  01 034E     	LD	BC,ANF
 1446 E770  7E          	LD	A,(HL)
 1447 E771  12          	LD	(DE),A
 1448 E772  0A          	LD	A,(BC)
 1449 E773  77          	LD	(HL),A
 1450 E774  23          	INC	HL
 1451 E775  13          	INC	DE
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 113
CE47    INC

 1452 E776  03          	INC	BC
 1453 E777  7E          	LD	A,(HL)
 1454 E778  12          	LD	(DE),A
 1455 E779  0A          	LD	A,(BC)
 1456 E77A  77          	LD	(HL),A
 1457 E77B  13          	INC	DE
 1458 E77C  2A 034E     	LD	HL,(ANF)
 1459 E77F  ED 4B 0354  	LD	BC,(DISTAN)
 1460 E783  09          	ADD	HL,BC
 1461 E784  22 034E     	LD	(ANF),HL
 1462 E787  2A 0350     	LD	HL,(ENDE)
 1463 E78A  2B          	DEC	HL
 1464 E78B  7C          	LD	A,H
 1465 E78C  B5          	OR	L
 1466 E78D  22 0350     	LD	(ENDE),HL
 1467 E790  20 D5       	JR	NZ,REN10
 1468 E792  12          	LD	(DE),A
 1469 E793  E1          	POP	HL
 1470 E794  2A 035F     	LD	HL,(PSTBEG)
 1471 E797  E5          	PUSH	HL
 1472 E798  E1          REN11:	POP	HL
 1473 E799  4E          	LD	C,(HL)
 1474 E79A  23          	INC	HL
 1475 E79B  46          	LD	B,(HL)
 1476 E79C  23          	INC	HL
 1477 E79D  C5          	PUSH	BC
 1478 E79E  7E          	LD	A,(HL)
 1479 E79F  23          	INC	HL
 1480 E7A0  A6          	AND	(HL)
 1481 E7A1  3C          	INC	A
 1482 E7A2  28 26       	JR	Z,REN15
 1483 E7A4  23          REN12:	INC	HL
 1484 E7A5  7E          REN13:	LD	A,(HL)
 1485 E7A6  B7          	OR	A		; Zeilen-Ende
 1486 E7A7  28 EF       	JR	Z,REN11
 1487 E7A9  FE 88       	CP	88H		; GOTO
 1488 E7AB  28 2A       	JR	Z,REN16
 1489 E7AD  FE 8C       	CP	8CH		; GOSUB
 1490 E7AF  28 26       	JR	Z,REN16
 1491 E7B1  FE 8B       	CP	8BH		; RESTORE
 1492 E7B3  28 08       	JR	Z,REN14
 1493 E7B5  FE D4       	CP	0D4H		; ELSE
 1494 E7B7  28 04       	JR	Z,REN14
 1495 E7B9  FE A9       	CP	0A9H		; THEN
 1496 E7BB  20 E7       	JR	NZ,REN12
 1497 E7BD  CD C987     REN14:	CALL	DCHEX1
 1498 E7C0  7B          	LD	A,E
 1499 E7C1  B2          	OR	D
 1500 E7C2  C4 E7EB     	CALL	NZ,RNUP1 	; Vergleich mit Tabelle
 1501 E7C5  C4 E81C     	CALL	NZ,RNUP2	; Zahl aendern
 1502 E7C8  18 DB       	JR	REN13
 1503                   	;
 1504 E7CA  2B          REN15:	DEC	HL
 1505 E7CB  22 03D7     	LD	(SVARPT),HL
 1506 E7CE  2B          	DEC	HL
 1507 E7CF  77          	LD	(HL),A
 1508 E7D0  2B          	DEC	HL
 1509 E7D1  77          	LD	(HL),A
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 114
CE47    INC

 1510 E7D2  E1          	POP	HL
 1511 E7D3  E1          	POP	HL
 1512 E7D4  C3 C48A     	JP	LIN10		; Zeile neu einsortieren
 1513                   	;
 1514 E7D7  CD C987     REN16:	CALL	DCHEX1
 1515 E7DA  7B          	LD	A,E
 1516 E7DB  B2          	OR	D
 1517 E7DC  28 C7       	JR	Z,REN13
 1518 E7DE  CD E7EB     	CALL	RNUP1
 1519 E7E1  C4 E81C     	CALL	NZ,RNUP2
 1520 E7E4  7E          	LD	A,(HL)
 1521 E7E5  FE 2C       	CP	','
 1522 E7E7  20 BC       	JR	NZ,REN13
 1523 E7E9  18 EC       	JR	REN16
 1524                   
 1525 E7EB  E5          RNUP1:	PUSH	HL
 1526 E7EC  D5          	PUSH	DE
 1527 E7ED  11 FFFF     	LD	DE,-1
 1528 E7F0  CD C4BB     	CALL	ZPOIT		; naechste Zeile
 1529 E7F3  D1          	POP	DE
 1530 E7F4  03          	INC	BC
 1531 E7F5  03          	INC	BC
 1532 E7F6  03          	INC	BC
 1533 E7F7  03          	INC	BC
 1534 E7F8  60          	LD	H,B
 1535 E7F9  69          	LD	L,C
 1536 E7FA  ED 4B 0352  	LD	BC,(NANF)
 1537 E7FE  7E          RUP11:	LD	A,(HL)
 1538 E7FF  23          	INC	HL
 1539 E800  E5          	PUSH	HL
 1540 E801  B6          	OR	(HL)
 1541 E802  28 15       	JR	Z,RUP13
 1542 E804  7E          	LD	A,(HL)
 1543 E805  2B          	DEC	HL
 1544 E806  6E          	LD	L,(HL)
 1545 E807  67          	LD	H,A
 1546 E808  CD C689     	CALL	CPREG
 1547 E80B  28 0A       	JR	Z,RUP12
 1548 E80D  2A 0354     	LD	HL,(DISTAN)
 1549 E810  09          	ADD	HL,BC
 1550 E811  44          	LD	B,H
 1551 E812  4D          	LD	C,L
 1552 E813  E1          	POP	HL
 1553 E814  23          	INC	HL
 1554 E815  18 E7       	JR	RUP11
 1555                   	;
 1556 E817  AF          RUP12:	XOR	A		; aus CAOS 3.4 uebernommen
 1557 E818  3D          	DEC	A		; A=0FFh, Z=0
 1558                   ;	LD	A,0FFH
 1559                   ;	OR	A
 1560 E819  E1          RUP13:	POP	HL
 1561 E81A  E1          	POP	HL
 1562 E81B  C9          	RET
 1563                   
 1564 E81C  C5          RNUP2:	PUSH	BC
 1565 E81D  EB          	EX	DE,HL
 1566 E81E  2A 03D7     	LD	HL,(SVARPT)
 1567 E821  ED 52       	SBC	HL,DE
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 115
CE47    INC

 1568 E823  E5          	PUSH	HL
 1569 E824  C1          RUP21:	POP	BC
 1570 E825  62          	LD	H,D
 1571 E826  6B          	LD	L,E
 1572 E827  1B          	DEC	DE
 1573 E828  1A          	LD	A,(DE)
 1574 E829  FE 2C       	CP	','
 1575 E82B  28 0B       	JR	Z,RUP22
 1576 E82D  FE 3A       	CP	':'
 1577 E82F  30 07       	JR	NC,RUP22
 1578 E831  C5          	PUSH	BC
 1579 E832  D5          	PUSH	DE
 1580 E833  ED B0       	LDIR
 1581 E835  D1          	POP	DE
 1582 E836  18 EC       	JR	RUP21
 1583                   	;
 1584 E838  EB          RUP22:	EX	DE,HL
 1585 E839  D1          	POP	DE
 1586 E83A  E5          	PUSH	HL
 1587 E83B  C5          	PUSH	BC
 1588 E83C  AF          	XOR	A
 1589 E83D  06 98       	LD	B,98H
 1590 E83F  CD D6AE     	CALL	SGN1
 1591 E842  CD D834     	CALL	NUMKON
 1592 E845  C1          	POP	BC
 1593 E846  D1          	POP	DE
 1594 E847  23          	INC	HL
 1595 E848  13          	INC	DE
 1596 E849  7E          RUP23:	LD	A,(HL)
 1597 E84A  B7          	OR	A
 1598 E84B  28 0F       	JR	Z,RUP24
 1599 E84D  C5          	PUSH	BC
 1600 E84E  E5          	PUSH	HL
 1601 E84F  EB          	EX	DE,HL
 1602 E850  09          	ADD	HL,BC
 1603 E851  54          	LD	D,H
 1604 E852  5D          	LD	E,L
 1605 E853  2B          	DEC	HL
 1606 E854  ED B8       	LDDR
 1607 E856  E1          	POP	HL
 1608 E857  ED A0       	LDI
 1609 E859  C1          	POP	BC
 1610 E85A  18 ED       	JR	RUP23
 1611                   	;
 1612 E85C  D5          RUP24:	PUSH	DE
 1613 E85D  ED 5B 035F  	LD	DE,(PSTBEG)
 1614 E861  CD C493     	CALL	LIN11
 1615 E864  23          RUP25:	INC	HL
 1616 E865  7E          	LD	A,(HL)
 1617 E866  23          	INC	HL
 1618 E867  B6          	OR	(HL)
 1619 E868  20 FA       	JR	NZ,RUP25
 1620 E86A  EB          	EX	DE,HL
 1621 E86B  73          	LD	(HL),E
 1622 E86C  23          	INC	HL
 1623 E86D  72          	LD	(HL),D
 1624 E86E  13          	INC	DE
 1625 E86F  13          	INC	DE
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 116
CE47    INC

 1626 E870  ED 53 03D7  	LD	(SVARPT),DE
 1627 E874  E1          	POP	HL
 1628 E875  54          	LD	D,H
 1629 E876  5D          	LD	E,L
 1630 E877  7E          RUP26:	LD	A,(HL)
 1631 E878  B7          	OR	A
 1632 E879  23          	INC	HL
 1633 E87A  20 FB       	JR	NZ,RUP26
 1634 E87C  C1          	POP	BC
 1635 E87D  E3          	EX	(SP),HL
 1636 E87E  C5          	PUSH	BC
 1637 E87F  EB          	EX	DE,HL
 1638 E880  C9          	RET
 1639                   
 1640                   ; BASIC: Zeile(n) loeschen
 1641                   
 1642 E881  C8          DELETE:	RET	Z
 1643 E882  CD C986     	CALL	DCHEX
 1644 E885  CA C442     	JP	Z,LIN13		; Zeiger auf folgende Zeilennummer stellen
 1645 E888  CD C8D6     	CALL	CPCOMM		; Komma?
 1646 E88B  D5          	PUSH	DE
 1647 E88C  CD C986     	CALL	DCHEX
 1648 E88F  E1          	POP	HL
 1649 E890  C0          	RET	NZ
 1650 E891  EB          	EX	DE,HL
 1651 E892  E5          	PUSH	HL
 1652 E893  CD C4BB     	CALL	ZPOIT		; naechste Zeile
 1653 E896  30 0A       	JR	NC,DELET1	; UL-ERROR
 1654 E898  D1          	POP	DE
 1655 E899  F5          	PUSH	AF
 1656 E89A  C5          	PUSH	BC
 1657 E89B  CD C4BE     	CALL	ZPOIT1
 1658 E89E  C1          	POP	BC
 1659 E89F  DA C450     	JP	C,LIN6		; einsortieren
 1660 E8A2  C3 C44D     DELET1:	JP	ULER		; UL-ERROR
 1661                   
 1662                   ; BASIC: Programm unterbrechen
 1663                   
 1664 E8A5  CD C8BE     PAUSE:	CALL	TCHAR1		; mit oder ohne Paramater?
 1665 E8A8  20 0F       	JR	NZ,PAUS2
 1666 E8AA  CD E368     PAUS1:	CALL	KBDS		; Tastaturabfrage
 1667 E8AD  30 FB       	JR	NC,PAUS1
 1668 E8AF  FE 03       	CP	3		; BRK?
 1669 E8B1  C8          	RET	Z
 1670 E8B2  FE 0A       	CP	LF		; CUU?
 1671 E8B4  20 F4       	JR	NZ,PAUS1
 1672 E8B6  C3 DDE4     	JP	CI		; Eingabe ASCII
 1673                   	;
 1674 E8B9  CD D421     PAUS2:	CALL	ARGVL1		; Wert abholen
 1675 E8BC  4F          	LD	C,A
 1676 E8BD  3E 10       PAUS3:	LD	A,16		; 16*6ms = 96 Millisekunden
 1677 E8BF  CD E2A3     	CALL	WAIT		; UP WAIT direkt aufrufen
 1678                   ;	LD	E,14H		; WAIT
 1679                   ;	CALL	PV5
 1680 E8C2  CD E368     	CALL	KBDS
 1681 E8C5  30 0A       	JR	NC,PAUS4
 1682 E8C7  FE 03       	CP	3		; BRK?
 1683 E8C9  C8          	RET	Z
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 117
CE47    INC

 1684 E8CA  FE 0A       	CP	LF		; CUU?
 1685 E8CC  20 03       	JR	NZ,PAUS4
 1686 E8CE  C3 DDE4     	JP	CI		; Eingabe ASCII
 1687                   	;
 1688 E8D1  0D          PAUS4:	DEC	C		; Zaehler verringern
 1689 E8D2  20 E9       	JR	NZ,PAUS3	; weiter warten
 1690 E8D4  C9          	RET
 1691                   
 1692                   ; BASIC: Signalton
 1693                   
 1694 E8D5  06 01       BBEEP:	LD	B,1		; ohne Angabe 1x
 1695 E8D7  CD C8BE     	CALL	TCHAR1		; Parameter angegeben?
 1696 E8DA  28 04       	JR	Z,BBP1
 1697 E8DC  CD D421     	CALL	ARGVL1		; Wert abholen
 1698 E8DF  47          	LD	B,A		; Anzahl
 1699 E8E0  3E 07       BBP1:	LD	A,7		; Beep
 1700 E8E2  1E 00       	LD	E,0		; CRT
 1701 E8E4  CD F02D     	CALL	PV5
 1702 E8E7  10 F7       	DJNZ	BBP1
 1703 E8E9  C9          	RET
 1704                   
 1705                   ; Hilfsroutine fuer mehrfachen Aufruf: naechsten Wert abholen
 1706                   
 1707 E8EA  CD C8D6     MC8D4:	CALL	CPCOMM		; Komma?
 1708 E8ED  C3 D421     	JP	ARGVL1		; Wert abholen
 1709                   
 1710                   ; BASIC: Fenster einstellen
 1711                   
 1712 E8F0  CD C8BE     WINDOW:	CALL	TCHAR1		; Parameter angegeben?
 1713 E8F3  28 31       	JR	Z,WDW2		; nein, dann volles Fenster
 1714 E8F5  CD D421     	CALL	ARGVL1		; 1. Wert abholen
 1715 E8F8  47          	LD	B,A		; B = erste Zeile
 1716 E8F9  C5          	PUSH	BC
 1717 E8FA  CD E8EA     	CALL	MC8D4		; 2. Wert holen
 1718 E8FD  57          	LD	D,A		; D = letzte Zeile
 1719 E8FE  D5          	PUSH	DE
 1720 E8FF  CD E8EA     	CALL	MC8D4		; 3. Wert holen
 1721 E902  D1          	POP	DE
 1722 E903  5F          	LD	E,A		; E = erste Spalte
 1723 E904  D5          	PUSH	DE
 1724 E905  CD E8EA     	CALL	MC8D4		; 4. Wert holen
 1725 E908  D1          	POP	DE		; A = letzte Spalte
 1726 E909  E3          	EX	(SP),HL		; H = erste Zeile
 1727 E90A  6B          	LD	L,E		; L = erste Spalte
 1728 E90B  93          	SUB	E		; Anzahl Spalten
 1729 E90C  38 34       	JR	C,SNERR2	; Anfang > Ende
 1730 E90E  3C          	INC	A
 1731 E90F  5F          	LD	E,A		; E = Fensterbreite
 1732 E910  7A          	LD	A,D		; letzte Zeile
 1733 E911  94          	SUB	H		; Anzahl Zeilen
 1734 E912  38 2E       	JR	C,SNERR2	; Anfang > Ende
 1735 E914  3C          	INC	A
 1736 E915  57          	LD	D,A		; D = Fensterhoehe
 1737 E916  CD F083     WDW1:	CALL	IRMON
 1738 E919  3A B79B     	LD	A,(WINNR)	; aktuelle Fensternummer
 1739 E91C  CD F7F7     	CALL	WININ		; Fenster initialisieren
 1740 E91F  CD F0A0     	CALL	IRMOF
 1741 E922  38 1E       	JR	C,SNERR2	; Fehler aufgetreten
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 118
CE47    INC

 1742 E924  E1          	POP	HL
 1743 E925  C9          	RET
 1744                   	;
 1745 E926  E5          WDW2:	PUSH	HL		; Standardfenstergoesse bei BASIC:
 1746 E927  21 0100     	LD	HL,100H		; 30 Zeilen, 40 Zeichen breit
 1747 E92A  11 1E28     	LD	DE,1E28H	; (oben und unten eine Zeile ungenutzt)
 1748 E92D  18 E7       	JR	WDW1
 1749                   
 1750                   ; BASIC: in IRM schreiben (8000h bis BFFFh):
 1751                   
 1752 E92F  CD C96C     VPOKE:	CALL	EPRVL4		; Parameter erfassen (Adresse)
 1753 E932  D5          	PUSH	DE
 1754 E933  CD E8EA     	CALL	MC8D4		; Wert abholen
 1755 E936  E3          	EX	(SP),HL
 1756 E937  11 8000     	LD	DE,8000H	; IRM-Offset
 1757 E93A  19          	ADD	HL,DE
 1758 E93B  38 05       	JR	C,SNERR2	; < 8000h
 1759 E93D  CB 74       	BIT	6,H
 1760 E93F  CA E9D8     	JP	Z,LOC1		; < C000h -> in IRM schreiben
 1761 E942  C3 C348     SNERR2:	JP	SNER		; SN-ERROR
 1762                   
 1763                   ; BASIC: PRINT AT:
 1764                   
 1765 E945  3A 03FD     PRAT:	LD	A,(PRTFLG)
 1766 E948  CB 4F       	BIT	1,A
 1767 E94A  CB CF       	SET	1,A
 1768 E94C  32 03FD     	LD	(PRTFLG),A
 1769 E94F  20 F1       	JR	NZ,SNERR2
 1770 E951  D5          	PUSH	DE
 1771 E952  E5          	PUSH	HL
 1772 E953  CD F083     	CALL	IRMON
 1773 E956  21 B79C     	LD	HL,WINON
 1774 E959  22 B9F6     	LD	(WNDFN+90),HL
 1775 E95C  11 B9EC     	LD	DE,WNDFN+80
 1776 E95F  01 0006     	LD	BC,6
 1777 E962  ED B0       	LDIR			; Fenster retten
 1778 E964  21 0000     	LD	HL,0
 1779 E967  22 B79C     	LD	(WINON),HL	; Fenster volle Groesse
 1780 E96A  21 2028     	LD	HL,2028H
 1781 E96D  22 B79E     	LD	(WINLG),HL
 1782 E970  CD F0A0     	CALL	IRMOF
 1783 E973  E1          	POP	HL
 1784 E974  CD E9A5     	CALL	LOCAT		; Cursor positionieren
 1785 E977  CD C8DB     	CALL	CPBRGT		; Klammer zu?
 1786 E97A  CD C8CC     	CALL	CPSTX		; Semikolon?
 1787 E97D  3B          	DB	';'
 1788 E97E  7E          	LD	A,(HL)
 1789 E97F  FE DF       	CP	0DFH
 1790 E981  38 1D       	JR	C,PRAT2		; <DFH
 1791 E983  FE E3       	CP	0E3H
 1792 E985  30 19       	JR	NC,PRAT2	; >E2H
 1793 E987  CD E63B     	CALL	PREX4		; INK, PAPER, COLOR
 1794 E98A  E5          PRAT1:	PUSH	HL
 1795 E98B  CD F083     	CALL	IRMON
 1796 E98E  21 B9EC     	LD	HL,WNDFN+80
 1797 E991  11 B79C     	LD	DE,WINON
 1798 E994  01 0006     	LD	BC,6
 1799 E997  ED B0       	LDIR			; Fenster regenerieren
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 119
CE47    INC

 1800 E999  CD F0A0     	CALL	IRMOF
 1801 E99C  E1          	POP	HL
 1802 E99D  D1          	POP	DE
 1803 E99E  C1          	POP	BC
 1804 E99F  C9          	RET
 1805                   	;
 1806 E9A0  CD CB03     PRAT2:	CALL	PRINT2
 1807 E9A3  18 E5       	JR	PRAT1
 1808                   
 1809                   ; BASIC: Cursor positionieren:
 1810                   
 1811 E9A5  CD C8BD     LOCAT:	CALL	TCHAR		; naechstes Zeichen holen
 1812 E9A8  CD C8CC     	CALL	CPSTX		; Klammer auf?
 1813 E9AB  28          	DB	'('
 1814 E9AC  CD D421     LOCATE:	CALL	ARGVL1		; Wert abholen
 1815 E9AF  57          	LD	D,A
 1816 E9B0  E5          	PUSH	HL
 1817 E9B1  21 B79F     	LD	HL,WINLG+1
 1818 E9B4  CD EB1D     	CALL	IRMRD
 1819 E9B7  E1          	POP	HL
 1820 E9B8  3D          	DEC	A
 1821 E9B9  BA          	CP	D
 1822 E9BA  38 3C       	JR	C,SNERR3
 1823 E9BC  D5          	PUSH	DE
 1824 E9BD  CD E8EA     	CALL	MC8D4		; Wert abholen
 1825 E9C0  D1          	POP	DE
 1826 E9C1  4F          	LD	C,A
 1827 E9C2  E5          	PUSH	HL
 1828 E9C3  21 B79E     	LD	HL,WINLG
 1829 E9C6  CD EB1D     	CALL	IRMRD		; Fenstergroesse lesen
 1830 E9C9  E1          	POP	HL
 1831 E9CA  3D          	DEC	A
 1832 E9CB  B9          	CP	C
 1833 E9CC  38 2A       	JR	C,SNERR3
 1834 E9CE  79          	LD	A,C
 1835 E9CF  E5          	PUSH	HL
 1836 E9D0  21 B7A0     	LD	HL,CURSO
 1837 E9D3  CD EB22     	CALL	IRMWR
 1838 E9D6  7A          	LD	A,D
 1839 E9D7  23          	INC	HL
 1840 E9D8  CD EB22     LOC1:	CALL	IRMWR		; in IRM schreiben
 1841 E9DB  E1          	POP	HL
 1842 E9DC  C9          	RET
 1843                   
 1844                   ; BASIC: Eingabe eines Zeichens:
 1845                   
 1846 E9DD  E5          INKEY:	PUSH	HL
 1847 E9DE  CD E368     	CALL	KBDS		; Tastaturabfrage
 1848 E9E1  30 0F       	JR	NC,INKEY3
 1849 E9E3  3E 01       	LD	A,1
 1850 E9E5  CD D17B     	CALL	STADTB
 1851 E9E8  CD DDE4     	CALL	CI		; Eingabe ASCII
 1852 E9EB  2A 03C2     INKEY1:	LD	HL,(STRDAT+2)
 1853 E9EE  77          	LD	(HL),A
 1854 E9EF  C3 D1A9     INKEY2:	JP	SLEN3
 1855                   	;
 1856 E9F2  AF          INKEY3:	XOR	A
 1857 E9F3  CD D17B     	CALL	STADTB
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 120
CE47    INC

 1858 E9F6  18 F7       	JR	INKEY2
 1859                   
 1860 E9F8  C3 C348     SNERR3:	JP	SNER		; SN-ERROR
 1861                   
 1862                   ; BASIC: Vordergrundfarbe einstellen:
 1863                   
 1864 E9FB  CD D421     INK:	CALL	ARGVL1		; Wert abholen
 1865 E9FE  FE 20       	CP	32
 1866 EA00  30 66       	JR	NC,FCERR	; FC-ERROR	(bisher SN-ERROR)
 1867 EA02  87          	ADD	A,A
 1868 EA03  87          	ADD	A,A		; *8
 1869 EA04  87          	ADD	A,A
 1870 EA05  57          	LD	D,A		; neuer Farbwert
 1871 EA06  CD E5CA     	CALL	LOCOL		; Farbwert lesen
 1872 EA09  E6 07       	AND	7		; Hintergrund-Bits erhalten
 1873 EA0B  18 1C       	JR	COL2
 1874                   
 1875                   ; BASIC: Vordergrund- und Hintergrundfarbe einstellen:
 1876                   
 1877 EA0D  CD C8BE     BCOLOR:	CALL	TCHAR1
 1878 EA10  28 56       	JR	Z,FCERR		; FC-ERROR	(bisher SN-ERROR)
 1879 EA12  CD E9FB     	CALL	INK		; Vordergrund
 1880 EA15  CD C8BE     	CALL	TCHAR1
 1881 EA18  C8          	RET	Z
 1882 EA19  CD C8D6     	CALL	CPCOMM		; Komma?
 1883                   ;	JR	PAPER		; Hintergrund
 1884                   
 1885                   ; BASIC: Hintergrundfarbe einstellen:
 1886                   
 1887 EA1C  CD D421     PAPER:	CALL	ARGVL1		; Wert abholen
 1888 EA1F  FE 08       COL1:	CP	8
 1889 EA21  30 45       	JR	NC,FCERR	; FC-ERROR	(bisher SN-ERROR)
 1890 EA23  57          	LD	D,A
 1891 EA24  CD E5CA     	CALL	LOCOL		; Farbwert lesen
 1892 EA27  E6 F8       	AND	0F8H		; Vordergrund-Bits erhalten
 1893 EA29  B2          COL2:	OR	D		; neuen Farbwert einbauen
 1894 EA2A  E5          	PUSH	HL
 1895 EA2B  21 B7A3     	LD	HL,COLOR
 1896 EA2E  18 A8       	JR	LOC1		; neuer Farbwert
 1897                   
 1898                   ; BASIC: Punkt loeschen:
 1899                   
 1900 EA30  1E 2F       PRESET:	LD	E,2FH		; UP PUDE
 1901 EA32  01          	DB	1	; LD BC,n
 1902                   
 1903                   ; BASIC: Punkt setzen:
 1904                   
 1905 EA33  1E 30       PSET:	LD	E,30H		; UP PUSE
 1906 EA35  D5          	PUSH	DE
 1907 EA36  CD C96C     	CALL	EPRVL4		; Parameter erfassen
 1908 EA39  E5          	PUSH	HL		; Adresszeiger
 1909 EA3A  7B          	LD	A,E
 1910 EA3B  21 B7D3     	LD	HL,HOR
 1911 EA3E  CD EB22     	CALL	IRMWR		; X-Koordinate (low)
 1912 EA41  7A          	LD	A,D
 1913 EA42  23          	INC	HL
 1914 EA43  CD EB22     	CALL	IRMWR		; X-Koordinate (high)
 1915 EA46  E3          	EX	(SP),HL
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 121
CE47    INC

 1916 EA47  CD E8EA     	CALL	MC8D4		; Wert abholen
 1917 EA4A  E3          	EX	(SP),HL
 1918 EA4B  23          	INC	HL		; HL=VERT
 1919 EA4C  CD EB22     	CALL	IRMWR		; Y-Koordinate
 1920 EA4F  E1          GRAPH2:	POP	HL		; HL=Adresszeiger
 1921 EA50  CD C8BE     	CALL	TCHAR1		; optionaler Parameter vorhanden?
 1922 EA53  28 0E       	JR	Z,GRAPH4	; nein
 1923 EA55  CD E8EA     	CALL	MC8D4		; Wert abholen nach A
 1924 EA58  17          	RLA
 1925 EA59  17          	RLA			; Rotieren in Bites fuer Vordergundfarbe
 1926 EA5A  17          	RLA
 1927 EA5B  E5          	PUSH	HL
 1928 EA5C  21 B7D6     	LD	HL,FARB		; Grafik-Farbe
 1929 EA5F  CD EB22     	CALL	IRMWR		; in IRM schreiben
 1930 EA62  E1          	POP	HL		; HL=Adresszeiger
 1931 EA63  D1          GRAPH4:	POP	DE		; E=UP-Nr. fuer PUSE, PUDE, LINE, CIRCLE
 1932 EA64  CD F02D     	CALL	PV5
 1933 EA67  D0          	RET	NC		; kein FC-ERROR	(bisher SN-ERROR)
 1934 EA68  C3 C967     FCERR:	JP	FCER		; FC-ERROR
 1935                   
 1936                   ; BASIC: Tonausgabe:
 1937                   
 1938 EA6B  CD D421     SOUND:	CALL	ARGVL1		; 1. Wert abholen
 1939 EA6E  E5          	PUSH	HL
 1940 EA6F  21 B782     	LD	HL,ARG1		; Argumente hier ablegen
 1941 EA72  06 04       	LD	B,4		; 4 Argumente holen
 1942 EA74  CD EB22     SOUND1:	CALL	IRMWR		; Argument einschreiben
 1943 EA77  23          	INC	HL
 1944 EA78  E3          	EX	(SP),HL		; Umschaltung auf Programmzeiger
 1945 EA79  05          	DEC	B
 1946 EA7A  28 08       	JR	Z,SOUND2	; fertig mit 4 Werten
 1947 EA7C  C5          	PUSH	BC
 1948 EA7D  CD E8EA     	CALL	MC8D4		; 2. bis 4. Wert abholen
 1949 EA80  C1          	POP	BC
 1950 EA81  E3          	EX	(SP),HL		; Umschaltung auf ARG-Zeiger
 1951 EA82  18 F0       	JR	SOUND1
 1952                   	;
 1953 EA84  CD C8BE     SOUND2:	CALL	TCHAR1		; weiterer Parameter?
 1954 EA87  28 16       	JR	Z,SOUND3
 1955 EA89  CD E8EA     	CALL	MC8D4		; optionalen 5. Wert (Lautstaerke) abholen
 1956 EA8C  E3          	EX	(SP),HL
 1957 EA8D  CD EB22     	CALL	IRMWR		; und einschreiben nach ARG3
 1958 EA90  23          	INC	HL
 1959 EA91  E3          	EX	(SP),HL
 1960 EA92  CD C8BE     	CALL	TCHAR1		; weiterer Parameter?
 1961 EA95  28 08       	JR	Z,SOUND3
 1962 EA97  CD E8EA     	CALL	MC8D4		; optionalen 6. Wert (Tondauer) abholen
 1963 EA9A  E3          	EX	(SP),HL
 1964 EA9B  CD EB22     	CALL	IRMWR		; und einschreiben nach ARG3+1
 1965 EA9E  E3          	EX	(SP),HL
 1966 EA9F  1E 35       SOUND3:	LD	E,35H		; UP-Nr. fuer TON
 1967 EAA1  C1          	POP	BC		; Stack bereinigen
 1968 EAA2  C3 F02D     	JP	PV5		; Tonausgabe aufrufen
 1969                   
 1970                   ; BASIC: String1 in String2 suchen
 1971                   
 1972 EAA5  CD CD36     INSTR:	CALL	SNALY6		; Klammer auf?
 1973 EAA8  CD C8D6     	CALL	CPCOMM		; Komma?
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 122
CE47    INC

 1974 EAAB  E5          	PUSH	HL
 1975 EAAC  CD D330     	CALL	LEN1		; Laenge holen
 1976 EAAF  28 B7       	JR	Z,FCERR		; FC-ERROR
 1977 EAB1  47          	LD	B,A
 1978 EAB2  23          	INC	HL
 1979 EAB3  23          	INC	HL
 1980 EAB4  5E          	LD	E,(HL)
 1981 EAB5  23          	INC	HL
 1982 EAB6  56          	LD	D,(HL)
 1983 EAB7  E1          	POP	HL
 1984 EAB8  D5          	PUSH	DE
 1985 EAB9  C5          	PUSH	BC
 1986 EABA  CD CD3A     	CALL	SNALY
 1987 EABD  CD C8DB     	CALL	CPBRGT		; Klammer zu?
 1988 EAC0  C1          	POP	BC
 1989 EAC1  D1          	POP	DE
 1990 EAC2  E5          	PUSH	HL
 1991 EAC3  D5          	PUSH	DE
 1992 EAC4  C5          	PUSH	BC
 1993 EAC5  CD D330     	CALL	LEN1		; Laenge holen
 1994 EAC8  28 9E       	JR	Z,FCERR		; FC-ERROR
 1995 EACA  23          	INC	HL
 1996 EACB  23          	INC	HL
 1997 EACC  4E          	LD	C,(HL)
 1998 EACD  23          	INC	HL
 1999 EACE  66          	LD	H,(HL)
 2000 EACF  69          	LD	L,C
 2001 EAD0  C1          	POP	BC
 2002 EAD1  4F          	LD	C,A
 2003 EAD2  D1          	POP	DE
 2004 EAD3  E5          	PUSH	HL
 2005 EAD4  C5          INSTR1:	PUSH	BC
 2006 EAD5  D5          	PUSH	DE
 2007 EAD6  1A          	LD	A,(DE)
 2008 EAD7  BE          INSTR2:	CP	(HL)
 2009 EAD8  28 0F       	JR	Z,INSTR5
 2010 EADA  23          	INC	HL
 2011 EADB  0D          	DEC	C
 2012 EADC  20 F9       	JR	NZ,INSTR2
 2013 EADE  AF          INSTR3:	XOR	A
 2014 EADF  E1          	POP	HL
 2015 EAE0  E1          	POP	HL
 2016 EAE1  E1          	POP	HL
 2017 EAE2  11 CDF3     INSTR4:	LD	DE,SNLY16	; Rueckkehr zu Syntax-Check ')'
 2018 EAE5  D5          	PUSH	DE
 2019 EAE6  C3 D0C0     	JP	POS1
 2020                   	;
 2021 EAE9  23          INSTR5:	INC	HL
 2022 EAEA  E5          	PUSH	HL
 2023 EAEB  2B          	DEC	HL
 2024 EAEC  23          INSTR6:	INC	HL
 2025 EAED  0D          	DEC	C
 2026 EAEE  28 0E       	JR	Z,INSTR7
 2027 EAF0  13          	INC	DE
 2028 EAF1  05          	DEC	B
 2029 EAF2  28 11       	JR	Z,INSTR8
 2030 EAF4  1A          	LD	A,(DE)
 2031 EAF5  BE          	CP	(HL)
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 123
CE47    INC

 2032 EAF6  28 F4       	JR	Z,INSTR6
 2033 EAF8  E1          	POP	HL
 2034 EAF9  D1          	POP	DE
 2035 EAFA  C1          	POP	BC
 2036 EAFB  0D          	DEC	C
 2037 EAFC  18 D6       	JR	INSTR1
 2038                   	;
 2039 EAFE  13          INSTR7:	INC	DE
 2040 EAFF  05          	DEC	B
 2041 EB00  E1          	POP	HL
 2042 EB01  20 DB       	JR	NZ,INSTR3
 2043 EB03  18 01       	JR	INSTR9
 2044                   	;
 2045 EB05  E1          INSTR8:	POP	HL
 2046 EB06  D1          INSTR9:	POP	DE
 2047 EB07  D1          	POP	DE
 2048 EB08  D1          	POP	DE
 2049 EB09  A7          	AND	A
 2050 EB0A  ED 52       	SBC	HL,DE
 2051 EB0C  7D          	LD	A,L
 2052 EB0D  18 D3       	JR	INSTR4
 2053                   
 2054                   ; BASIC: F-Taste belegen:
 2055                   
 2056 EB0F  CD D421     BKEY:	CALL	ARGVL1		; Wert abholen
 2057 EB12  FE 10       	CP	16		; F0 ... F15 zugelassen
 2058 EB14  D2 EBB7     	JP	NC,SNERR4
 2059 EB17  1E 39       	LD	E,39H		; UP-Nr. fuer KEY
 2060 EB19  01          	DB	1	; LC BC,nn
 2061                   
 2062                   ; BASIC: F-Tasten auflisten:
 2063                   
 2064 EB1A              KEYLIST:
 2065 EB1A  1E 3A       	LD	E,3AH		; UP-Nr. fuer KEYLI
 2066 EB1C  01          	DB	1	; LC BC,nn
 2067                   
 2068                   ; BASIC: Byte aus IRM lesen:
 2069                   
 2070 EB1D  1E 29       IRMRD:	LD	E,29H		; UP-Nr. fuer LDAM
 2071 EB1F  C3 F02D     JPV5:	JP	PV5
 2072                   
 2073                   ; BASIC: Byte in IRM schreiben:
 2074                   
 2075 EB22  1E 28       IRMWR:	LD	E,28H		; UP-Nr. fuer LDMA
 2076 EB24  18 F9       	JR	JPV5
 2077                   
 2078                   ; BASIC: Module schalten:
 2079                   
 2080 EB26  CD D421     SWITCH:	CALL	ARGVL1		; 1. Wert abholen
 2081 EB29  F5          	PUSH	AF		; Steckplatz
 2082 EB2A  CD E8EA     	CALL	MC8D4		; 2. Wert abholen
 2083 EB2D  57          	LD	D,A		; Steuerbyte
 2084 EB2E  F1          	POP	AF
 2085 EB2F  E5          	PUSH	HL
 2086 EB30  6F          	LD	L,A		; Steckplatz
 2087 EB31  3E 02       	LD	A,2		; schalten
 2088 EB33  1E 26       	LD	E,26H		; UP-Nr. fuer MODU
 2089 EB35  CD F02D     	CALL	PV5
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 124
CE47    INC

 2090 EB38  E1          	POP	HL
 2091 EB39  C9          	RET
 2092                   
 2093                   ; BASIC: Testen, ob Bildpunkt gesetzt ist:
 2094                   
 2095 EB3A  CD CD36     PTEST:	CALL	SNALY6		; Klammer auf?
 2096 EB3D  CD C96F     	CALL	EPRVL3		; Ausdruck berechnen -> DE
 2097 EB40  E5          	PUSH	HL		; Programmzeiger auf Stack legen
 2098 EB41  7B          	LD	A,E
 2099 EB42  21 B7D3     	LD	HL,HOR		; X-Koordinate eintragen
 2100 EB45  CD EB22     	CALL	IRMWR		; Low
 2101 EB48  7A          	LD	A,D
 2102 EB49  23          	INC	HL
 2103 EB4A  CD EB22     	CALL	IRMWR		; High
 2104 EB4D  23          	INC	HL		; VERT
 2105 EB4E  E3          	EX	(SP),HL		; HL=Programmzeiger, (Stack)=VERT
 2106 EB4F  0E 00       	ld	c,0		; Y-Koordinate nicht angegeben
 2107 EB51  7E          	LD	A,(HL)
 2108 EB52  FE 2C       	CP	','		; weiterer Parameter?
 2109 EB54  20 0A       	JR	NZ,PTEST1	; nein
 2110 EB56  CD E8EA     	CALL	MC8D4		; 2. Wert holen
 2111 EB59  E3          	EX	(SP),HL		; HL=VERT
 2112 EB5A  CD EB22     	CALL	IRMWR		; Y-Koordinate eintragen
 2113 EB5D  E3          	EX	(SP),HL		; HL=Programmzeiger
 2114 EB5E  0E FF       	ld	c,-1		; Y-Koordinate angegeben
 2115 EB60  CD C8DB     PTEST1:	CALL	CPBRGT		; Klammer zu?
 2116 EB63  D1          	POP	DE		; VERT - wird nicht mehr benoetigt
 2117 EB64  E3          	EX	(SP),HL		; Adresszeiger auf Stack
 2118 EB65  11 CDF3     	LD	DE,SNLY16	; Rueckkehr zu Syntax-Check ')'
 2119 EB68  D5          	PUSH	DE		; Sprungadresse auf Stack
 2120 EB69  E5          	PUSH	HL		; urspruenglicher Stack-Wert
 2121 EB6A  1E 2F       	LD	E,2FH		; UP-Nr. fuer PUDE
 2122 EB6C  CD F02D     	CALL	PV5
 2123 EB6F  DA C967     	JP	C,FCER		; ausserhalb -> FC-ERROR
 2124 EB72  F5          	PUSH	AF		; Z-Flag erhalten
 2125 EB73  DD CB 01 5E 	BIT	3,(IX+1)	; HiRes?
 2126 EB77  28 20       	JR	Z,PTEST4	; Farbwert steht bereits in Register A
 2127 EB79  F1          	POP	AF
 2128 EB7A  06 00       	LD	B,0
 2129 EB7C  28 19       	JR	Z,PTEST3	; Punkt war geloescht
 2130 EB7E  21 B7D6     	LD	HL,FARB
 2131 EB81  CD EB22     	CALL	IRMWR		; Grafikfarbe eintragen fuer folgendes PUSE
 2132 EB84  0F          	RRCA
 2133 EB85  0F          	RRCA			; Vordergrundfarbe nach Bit 0-3 rotieren
 2134 EB86  0F          	RRCA
 2135 EB87  E6 0F       	AND	0Fh
 2136 EB89  20 02       	JR	NZ,PTEST2	; Farbe 1-15
 2137 EB8B  3E 08       	LD	A,8		; Farbe 0 => 8 (beides ist schwarz)
 2138 EB8D  47          PTEST2:	LD	B,A		; Rueckgabewert = Farbe 1..15
 2139 EB8E  1E 30       	LD	E,30H		; UP-Nr. fuer PUSE
 2140 EB90  CD F02D     	CALL	PV5		; Punkt wieder setzen
 2141 EB93  0C          	inc	c		; war Y-Koordinate angegeben?
 2142 EB94  28 01       	jr	z,PTEST3	; ja, dann Farbcode zurueck geben
 2143 EB96  41          	ld	b,c		; ansonsten 1 fuer Punkt gesetzt
 2144 EB97  78          PTEST3:	LD	A,B		; Rueckgabewert (0=geloescht oder Farbcode)
 2145 EB98  06          	DB	06H		; LD B,0F1H
 2146 EB99  F1          PTEST4:	POP	AF
 2147 EB9A  18 65       	JR	JHPOS		; POP HL, JP POS1
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 125
CE47    INC

 2148                   
 2149                   ; BASIC: IRM lesen (8000h bis BFFFh):
 2150                   
 2151 EB9C  CD CDE1     VPEEK:	CALL	SNLY14		; Syntax-Check '('
 2152 EB9F  E3          	EX	(SP),HL
 2153 EBA0  11 CDF3     	LD	DE,SNLY16	; Rueckkehr zu Syntax-Check ')'
 2154 EBA3  D5          	PUSH	DE
 2155 EBA4  CD C96F     	CALL	EPRVL3		; Wert bestimmen
 2156 EBA7  E5          	PUSH	HL
 2157 EBA8  21 8000     	LD	HL,8000H	; IRM-Offset
 2158 EBAB  19          	ADD	HL,DE
 2159 EBAC  38 09       	JR	C,SNERR4	; < 8000h
 2160 EBAE  CB 74       	BIT	6,H
 2161 EBB0  20 05       	JR	NZ,SNERR4	; > BFFFh
 2162 EBB2  CD EB1D     	CALL	IRMRD
 2163 EBB5  18 4A       	JR	JHPOS		; POP HL, JP POS1
 2164                   
 2165 EBB7  C3 C348     SNERR4:	JP	SNER		; SN-ERROR
 2166                   
 2167                   ; BASIC-Erweiterung 3: Funktionen
 2168                   ;**************************************************************
 2169                   ;* VERTEILER ZU ZUSAETZLICHEN STANDARDFUNKTIONEN
 2170                   ;* E: <HL> AUF SIGN. ZEICHEN NACH TOKEN
 2171                   ;*    <BC> =<<SP>>  (TOKEN-SGTOK)*2
 2172                   ;* A: <HL> AUF SIGN. ZEICHEN NACH TOKEN
 2173                   ;**************************************************************
 2174                   
 2175 EBBA  79          BEXP3:	LD	A,C		; zulaessig?
 2176 EBBB  FE 62       	CP	62H
 2177 EBBD  28 DD       	JR	Z,VPEEK
 2178 EBBF  FE 6E       	CP	6EH
 2179 EBC1  CA EB3A     	JP	Z,PTEST
 2180 EBC4  FE 7C       	CP	7CH
 2181 EBC6  28 1A       	JR	Z,CSRLN
 2182 EBC8  FE 76       	CP	76H
 2183 EBCA  28 39       	JR	Z,VGET
 2184 EBCC  D6 3E       	SUB	3EH
 2185 EBCE  38 E7       	JR	C,SNERR4	; nein
 2186 EBD0  FE 07       	CP	7
 2187 EBD2  30 E3       	JR	NC,SNERR4	; nein
 2188                   ;--------------------------------
 2189 EBD4  EB          	EX	DE,HL
 2190 EBD5  01 FD89     	LD	BC,TOKJP	; Token-Adresstabelle
 2191 EBD8  E1          	POP	HL
 2192 EBD9  6F          	LD	L,A
 2193 EBDA  09          	ADD	HL,BC
 2194 EBDB  4E          	LD	C,(HL)
 2195 EBDC  23          	INC	HL
 2196 EBDD  66          	LD	H,(HL)
 2197 EBDE  69          	LD	L,C
 2198 EBDF  E5          	PUSH	HL		; Routine
 2199 EBE0  EB          	EX	DE,HL		; anspringen
 2200 EBE1  C9          	RET
 2201                   
 2202                   ; BASIC: aktuelle Zeilennummer holen:
 2203                   
 2204 EBE2  CD CDE1     CSRLN:	CALL	SNLY14		; Syntax-Check '('
 2205 EBE5  E3          	EX	(SP),HL
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 126
CE47    INC

 2206 EBE6  11 CDF3     	LD	DE,SNLY16	; Rueckkehr zu Syntax-Check ')'
 2207 EBE9  D5          	PUSH	DE
 2208 EBEA  CD D424     	CALL	ARGVL2
 2209 EBED  E5          	PUSH	HL
 2210 EBEE  A7          	AND	A		; Fenster beruecksichtigen?
 2211 EBEF  3E 00       	LD	A,0
 2212 EBF1  20 06       	JR	NZ,CSRLN1
 2213 EBF3  21 B79D     	LD	HL,WINON+1
 2214 EBF6  CD EB1D     	CALL	IRMRD
 2215 EBF9  47          CSRLN1:	LD	B,A
 2216 EBFA  21 B7A1     	LD	HL,CURSO+1
 2217 EBFD  CD EB1D     	CALL	IRMRD
 2218 EC00  80          	ADD	A,B		; aktuelle Zeile
 2219 EC01  E1          JHPOS:	POP	HL
 2220 EC02  C3 D0C0     CSRLN2:	JP	POS1
 2221                   
 2222                   ; BASIC: Zeichen von Bildschirm zurueck lesen
 2223                   
 2224 EC05  E3          VGET:	EX	(SP),HL
 2225 EC06  3E 01       	LD	A,1
 2226 EC08  CD D17B     	CALL	STADTB
 2227 EC0B  CD F083     	CALL	IRMON
 2228 EC0E  ED 5B B7A0  	LD	DE,(CURSO)
 2229 EC12  CD E068     	CALL	DABR
 2230 EC15  7E          	LD	A,(HL)
 2231 EC16  CD F0A0     	CALL	IRMOF
 2232 EC19  C3 E9EB     	JP	INKEY1		; als Zeichen zurueckgeben
 2233                   
 2234                   ; BASIC: Kanal schliessen:
 2235                   
 2236 EC1C  0E 00       CLOSE:	LD	C,0
 2237 EC1E  7E          	LD	A,(HL)
 2238 EC1F  FE 49       	CP	'I'		; Eingabe?
 2239 EC21  28 05       	JR	Z,CLOS1
 2240 EC23  0C          	INC	C
 2241 EC24  FE 4F       	CP	'O'		; Ausgabe?
 2242 EC26  20 8F       	JR	NZ,SNERR4
 2243 EC28  C5          CLOS1:	PUSH	BC
 2244 EC29  23          	INC	HL
 2245 EC2A  7E          	LD	A,(HL)
 2246 EC2B  FE 23       	CP	'#'
 2247 EC2D  20 88       CLOS2:	JR	NZ,SNERR4	; SN-ERROR
 2248 EC2F  23          	INC	HL
 2249 EC30  CD D421     	CALL	ARGVL1		; Wert abholen
 2250 EC33  E6 03       	AND	3		; 4 Geraete
 2251 EC35  C1          	POP	BC
 2252 EC36  C8          	RET	Z		; Console -> nichts tun
 2253 EC37  E5          	PUSH	HL
 2254 EC38  17          	RLA			; *2
 2255 EC39  81          	ADD	A,C		; Ein-/Ausgabe
 2256 EC3A  F5          	PUSH	AF
 2257 EC3B  3D          	DEC	A
 2258 EC3C  47          	LD	B,A
 2259 EC3D  3E FF       	LD	A,-1
 2260 EC3F  17          CLOS3:	RLA			; Bit platzieren
 2261 EC40  10 FD       	DJNZ	CLOS3
 2262 EC42  21 0307     	LD	HL,IOCHNL	; E/A-Flag
 2263 EC45  A6          	AND	(HL)		; Bit loeschen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 127
CE47    INC

 2264 EC46  77          	LD	(HL),A
 2265 EC47  F1          	POP	AF
 2266 EC48  E1          	POP	HL
 2267 EC49  CB F7       	SET	6,A		; close
 2268 EC4B  D5          	PUSH	DE
 2269 EC4C  5F          	LD	E,A
 2270 EC4D  16 03       	LD	D,3		; BRK-Code
 2271 EC4F  CD E00E     	CALL	BASIO		; Kanal schliessen
 2272 EC52  D1          	POP	DE
 2273 EC53  C9          	RET
 2274                   
 2275                   ; BASIC-Erweiterung JOYST(i)
 2276                   ; kompatibel zum KC 87 mit einem Joystick
 2277                   ;
 2278 EC54  CD CDE1     JOYST:	CALL	SNLY14		; Syntax-Check '('
 2279 EC57  E5          	PUSH	HL
 2280 EC58  11 CDF3     	LD	DE,SNLY16	; Rueckkehr zu Syntax-Check ')'
 2281 EC5B  D5          	PUSH	DE
 2282 EC5C  CD C96F     	CALL	EPRVL3		; Ausdruck berechnen -> DE
 2283 EC5F  7B          	LD	A,E
 2284 EC60  3D          	DEC	A
 2285 EC61  B2          	OR	D		; Argument gleich 1?
 2286 EC62  3E 00       	LD	A,0
 2287 EC64  20 9C       	JR	NZ,CSRLN2	; nein: Rueckgabewert 0
 2288 EC66  DB 90       	IN	A,(90h)		; M008 PIO A Daten
 2289 EC68  2F          	CPL
 2290 EC69  57          	LD	D,A
 2291 EC6A  E6 0F       	AND	00001111b	; nur Richtungsbits, CY=0
 2292 EC6C  1F          	RRA
 2293 EC6D  30 02       	JR	NC,JOYST1
 2294 EC6F  F6 10       	OR	00010000b	; <Up> auf Bit 3, CY=0
 2295 EC71  1F          JOYST1:	RRA
 2296 EC72  30 02       	JR	NC,JOYST2
 2297 EC74  F6 04       	OR	00000100b	; <Down> auf Bit 2
 2298 EC76  5F          JOYST2:	LD	E,A
 2299 EC77  3E 30       	LD	A,00110000b	; Feuertasten
 2300 EC79  A2          	AND	D
 2301 EC7A  B3          	OR	E
 2302 EC7B  18 85       	JR	CSRLN2		; Rueckgabewert in A
 2303                   
 2304                   ; BASIC: Zufallsgenerator:
 2305                   
 2306 EC7D  ED 5F       RANDOM:	LD	A,R
 2307 EC7F  32 031D     	LD	(RNDVR3+2),A
 2308 EC82  C9          	RET
 2309                   
 2310                   ; BASIC: Kanal oeffnen:
 2311                   
 2312 EC83  7E          OPEN:	LD	A,(HL)
 2313 EC84  23          	INC	HL
 2314 EC85  FE 49       	CP	'I'		; Eingabe?
 2315 EC87  28 19       	JR	Z,OPEN1
 2316 EC89  FE 4F       	CP	'O'		; Ausgabe?
 2317 EC8B  20 A0       	JR	NZ,CLOS2	; SN-ERROR
 2318 EC8D  CD DE25     	CALL	OUTCHL		; Kanal-Ausgabe
 2319 EC90  CD DDC8     	CALL	TESTCO
 2320 EC93  C8          	RET	Z
 2321 EC94  3E D5       	LD	A,0D5H		; *.UUU
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 128
CE47    INC

 2322 EC96  CD DCB2     	CALL	CASS1		; Dateiname aufbereiten
 2323 EC99  21 03EA     	LD	HL,INTPRB	; Druckpuffer=Dateiname
 2324 EC9C  AF          	XOR	A
 2325 EC9D  CD DDD5     	CALL	CO		; Ausgabe Zeichen
 2326 ECA0  E1          	POP	HL
 2327 ECA1  C9          	RET
 2328                   	;
 2329 ECA2  CD DE5F     OPEN1:	CALL	INCHNL		; Kanal-Eingabe
 2330 ECA5  3A 0309     	LD	A,(ININD)	; IN-Index
 2331 ECA8  E6 03       	AND	3
 2332 ECAA  C8          	RET	Z
 2333 ECAB  3E D5       	LD	A,0D5H		; *.UUU
 2334 ECAD  CD DCB2     	CALL	CASS1		; Dateiname aufbereiten
 2335 ECB0  21 03EA     	LD	HL,INTPRB	; Druckpuffer=Dateiname
 2336 ECB3  CD DDE4     	CALL	CI		; Eingabe eines Zeichens
 2337 ECB6  E1          	POP	HL
 2338 ECB7  C9          	RET
 2339                   
 2340                   ; BASIC: Linie zeichnen:
 2341                   
 2342 ECB8  01 043E     BLINE:	LD	BC,43EH		; 4 Parameter, UP LINE
 2343 ECBB  18 03       	JR	GRAPH
 2344                   
 2345                   ; BASIC: Kreis zeichnen:
 2346                   
 2347 ECBD  01 033F     CIRCLE:	LD	BC,33FH		; 3 Parameter, UP CIRCLE
 2348 ECC0  C5          GRAPH:	PUSH	BC
 2349 ECC1  CD C96C     	CALL	EPRVL4		; Parameter erfassen
 2350 ECC4  C1          	POP	BC
 2351 ECC5  C5          	PUSH	BC
 2352 ECC6  E5          	PUSH	HL
 2353 ECC7  21 B782     	LD	HL,ARG1		; hier ablegen
 2354 ECCA  7B          GRAPH1:	LD	A,E
 2355 ECCB  CD EB22     	CALL	IRMWR		; Ablage der Parameter
 2356 ECCE  23          	INC	HL
 2357 ECCF  7A          	LD	A,D
 2358 ECD0  CD EB22     	CALL	IRMWR
 2359 ECD3  23          	INC	HL
 2360 ECD4  05          	DEC	B
 2361 ECD5  CA EA4F     	JP	Z,GRAPH2	; alle Parameter erfasst
 2362 ECD8  E3          	EX	(SP),HL
 2363 ECD9  C5          	PUSH	BC
 2364 ECDA  CD C8D6     	CALL	CPCOMM		; Komma?
 2365 ECDD  CD C96C     	CALL	EPRVL4		; naechsten Parameter
 2366 ECE0  C1          	POP	BC
 2367 ECE1  E3          	EX	(SP),HL
 2368 ECE2  18 E6       	JR	GRAPH1
 2369                   	;
 2370                   ;GRAPH2:	POP	HL
 2371                   ;	CALL	GFARB		; optionaler Parameter (Farbwert)
 2372                   ;	POP	DE		; E=UP-Nr. fuer LINE oder CIRCLE
 2373                   ;	JP	PV5
 2374                   
 2375                   ; BASIC: DEVICE einstellen
 2376                   ;	Aufruf: DEVICE nr, wobei nr=0 fuer TAPE usw.
 2377                   
 2378 ECE4  CD C8BE     BDEV:	CALL	TCHAR1		; Parameter angegeben?
 2379 ECE7  3E FF       	LD	A,0FFH		; ohne Parameter auflisten was es gibt
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 129
CE47    INC

 2380 ECE9  C4 D421     	CALL	NZ,ARGVL1	; ansonsten Wert holen
 2381 ECEC  E5          	PUSH	HL
 2382 ECED  CD F083     	CALL	IRMON		; IRM ein
 2383 ECF0  CD FBD7     	CALL	SETDEV		; und Geraet entsprechend einstellen
 2384 ECF3  DA F883     	JP	C,BD2		; Treiber nicht aktiv -> IO-ERROR
 2385 ECF6  3E FE       	LD	A,0FEh
 2386 ECF8  CD FBD7     	CALL	SETDEV		; Name des Treibers anzeigen
 2387 ECFB  CD F4DB     	CALL	CRLF
 2388 ECFE  CD F0A0     BD1:	CALL	IRMOF		; IRM aus
 2389 ED01  E1          	POP	HL
 2390 ED02  C9          	RET
 2391                   
 2392                   ; BASIC: MC-Programm laden
 2393                   ;	Aufruf: BLOAD "name.typ", wobei Name bei DEVICE=TAPE entfallen kann
 2394                   ; PE:	HL	Zeiger auf Kommando
 2395                   ; PA:	HL	Zeiger weiter gerueckt, wieweit abgearbeitet ist
 2396                   
 2397 ED03  CD C8BE     BLOAD:	CALL	TCHAR1		; Parameter angegeben?
 2398 ED06  28 16       	JR	Z,BLOAD2	; ohne Parameter
 2399 ED08  CD CD3A     	CALL	SNALY
 2400 ED0B  E5          	PUSH	HL		; Kommandozeile
 2401 ED0C  3E 0C       	LD	A,12		; max. Laenge Dateiname+Typ
 2402 ED0E  CD ED56     	CALL	MASK		; Zeichenkette in DE
 2403 ED11  EB          	EX	DE,HL		; Dateiname in HL
 2404 ED12  CD F083     BLOAD1:	CALL	IRMON
 2405 ED15  AF          	XOR	A
 2406 ED16  32 B781     	LD	(ARGN),A	; ARGN=0 (kein Ladeoffset)
 2407 ED19  CD F6C6     	CALL	LOAD		; UP 10H direkt aufrufen
 2408 ED1C  18 E0       	JR	BD1
 2409                   	;
 2410 ED1E  E5          BLOAD2:	PUSH	HL
 2411 ED1F  CD ED97     	CALL	DEV1		; Kassette?
 2412 ED22  28 EE       	JR	Z,BLOAD1	; ja, das ist OK ohne Name
 2413                   ;	CALL	IRMOF
 2414 ED24  1E 24       	LD	E,36		; MO-ERROR
 2415 ED26  C3 C356     	JP	ERROO		; Error anzeigen
 2416                   
 2417                   ; BASIC: DIR anzeigen aktuelles Speichergeraet
 2418                   ;	Aufruf: FILES "maske", wobei Maske optional ist
 2419                   ; PE:	HL	Zeiger auf Kommando
 2420                   ; PA:	HL	Zeiger weiter gerueckt, wieweit abgearbeitet ist
 2421                   
 2422 ED29  CD C8BE     FILES:	CALL	TCHAR1		; Parameter angegeben?
 2423 ED2C  28 10       	JR	Z,FILES3	; ohne Parameter
 2424 ED2E  CD CD3A     	CALL	SNALY
 2425 ED31  E5          	PUSH	HL		; Kommandozeile
 2426 ED32  CD ED54     	CALL	MASK8		; Zeichenkette in DE
 2427 ED35  CD F083     FILES2:	CALL	IRMON		; IRM ein
 2428 ED38  CD E4C9     	CALL	PV7
 2429 ED3B  08          	DB	8		; DEVICE-Funktion DIR aufrufen
 2430 ED3C  18 C0       	JR	BD1
 2431                   	;
 2432 ED3E  E5          FILES3:	PUSH	HL		; Kommandozeile
 2433 ED3F  11 ED5D     	LD	DE,FILES0+1	; zeigt auf eine 0
 2434 ED42  18 F1       	JR	FILES2		; gesamtes Verzeichnis anzeigen
 2435                   
 2436                   ; BASIC: Verzeichnis wechseln
 2437                   ;	Aufruf: CD "verzeichnisname"
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 130
CE47    INC

 2438                   ; PE:	HL	Zeiger auf Kommando
 2439                   ; PA:	HL	Zeiger weiter gerueckt, wieweit abgearbeitet ist
 2440                   
 2441 ED44              CHDIR:	;CALL	TCHAR1		; Parameter angegeben?
 2442 ED44  CD CD3A     	CALL	SNALY
 2443 ED47  E5          	PUSH	HL		; Kommandozeile
 2444 ED48  CD ED54     	CALL	MASK8		; Zeichenkette "Verzeichnis" in DE bereitstellen
 2445 ED4B  CD F083     	CALL	IRMON		; IRM ein
 2446 ED4E  CD E4C9     	CALL	PV7
 2447 ED51  09          	DB	9		; DEVICE-Funktion CD aufrufen
 2448 ED52  18 AA       	JR	BD1
 2449                   
 2450                   ; Zeichenkette "Maske" bzw. "Verzeichnis" in DE bereitstellen
 2451                   
 2452 ED54  3E 08       MASK8:	LD	A,8		; max. Laenge
 2453 ED56  F5          MASK:	PUSH	AF
 2454 ED57  CD D33F     	CALL	ASC1		; in DE ist jetzt die Maske nach dem "
 2455 ED5A  EB          	EX	DE,HL		; Zeichenkette jetzt in HL
 2456 ED5B  D1          	POP	DE		; D=max. Laenge der Zeichenkette
 2457 ED5C  06 00       FILES0:	LD	B,0
 2458 ED5E  79          	LD	A,C		; Anzahl Zeichen bis zum zweiten "
 2459 ED5F  BA          	CP	D		; kleiner als max. Anzahl
 2460 ED60  38 01       	JR	C,MASK1		; dann so viele Zeichen kopieren
 2461 ED62  4A          	LD	C,D		; ansonsten nur max. Anzahl Zeichen
 2462 ED63  11 03EA     MASK1:	LD	DE,INTPRB	; Maske in BASIC-PRINTPUFFER bereitstellen
 2463 ED66  D5          	PUSH	DE
 2464 ED67  ED B0       	LDIR
 2465 ED69  AF          	XOR	A
 2466 ED6A  12          	LD	(DE),A		; 0 anhaengen
 2467 ED6B  D1          	POP	DE		; Maske in PRINTPUFFER
 2468 ED6C  C9          	RET
 2469                   
 2470                   ; Sprung aus CAOS-ROM-C in INIT-Routine des ROM-Moduls (z.B. M052-USB)
 2471                   ; PE:	A	Schaltzustand Modul ein
 2472                   ;	B	Steckplatz
 2473                   
 2474 ED6D  57          JROM:	LD	D,A		; Schaltzustand
 2475 ED6E  68          	LD	L,B		; Steckplatz
 2476 ED6F  E5          	PUSH	HL		; Steckplatz merken zum wieder ausschalten
 2477 ED70  CD F102     	CALL	MODUSW		; M052 einschalten (und MODST aktualisieren)
 2478                   ;	IN	A,(PIOAD)
 2479                   ;	AND	7Fh		; USER-ROM abschalten (wegen Aufruf aus TEMO)
 2480                   ;	OUT	(PIOAD),A
 2481                   	RESIXA	7,4		; RES 7,(IX+4),A
    1 ED73  DD CB 04    	 DB	0DDh,0CBh,4
    2 ED76  BF          	 DB	7 SHL 3 OR 10000111b
 2482 ED77  D3 86       	OUT	(PORT2),A	; CAOS-ROM C aus!
 2483 ED79  45          	LD	B,L		; Steckplatz
 2484 ED7A  21 ED81     	LD	HL,JREX		; Rueckkehr hierher
 2485 ED7D  E5          	PUSH	HL
 2486 ED7E  C3 C020     	JP	0C020h		; Sprung in Modul-ROM -> Treiber initialisieren
 2487                   	;
 2488 ED81  E1          JREX:	POP	HL		; L=Stekplatz des Moduls
 2489 ED82  16 00       	LD	D,0		; Modul AUS
 2490 ED84  CD F102     	CALL	MODUSW		; Modul wieder aus schalten
 2491 ED87  C3 FB8F     	JP	CON		; Sprung zurueck in CAOS-ROM C
 2492                   ;_____________________________________________________________
 2493                   ;							**40**
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 131
CE47    INC

 2494                   ; Berechnen der Quadratwurzel
 2495                   ; PE:	HL	16 Bit-Zahl (vorzeichenlos)
 2496                   ; PA:	A	Ergebnis 8 Bit
 2497                   ; VR:	AF,HL,DE
 2498                   
 2499 ED8A  CD FB8F     SQR:	CALL	CON
 2500 ED8D  C3 D2CD     	JP	SQRC
 2501                   ;
 2502                   ; DEVICE ermitteln:
 2503                   ; PA:	A	DEVICE-Nummer*32
 2504                   ;	Z=1	TAPE
 2505                   ;	CY=0
 2506                   ;
 2507 ED90  CD ED97     DEV:	CALL	DEV1		; Device ermitteln, Z=1 wenn Kassette
 2508 ED93  07          	RLCA
 2509 ED94  07          	RLCA			; Nr. *8
 2510 ED95  07          	RLCA
 2511 ED96  C9          	RET
 2512                   	;
 2513 ED97  DD 7E 08    DEV1:	LD	A,(IX+8)
 2514 ED9A  E6 1C       	AND	00011100b	; Device-Nr. ausfiltern, Z=1 wenn Device=0
 2515         0000      if turbo
 2520                   endif
 2521 ED9C  C9          	RET
 2522                   
 2523                   ; Initialisierungstabelle fuer M021:
 2524                   
 2525 ED9D  03          CENINI:	DB	3
 2526                   
 2527 ED9E  92 05       JOYINI:	 DB	92h,5		; PIO-A Steuerwort
 2528 EDA0  E0          	  DB	0E0h		; Interruptvektor
 2529 EDA1  CF          	  DB	11001111b	; Einzelbit-Steuermodus
 2530 EDA2  7F          	  DB	01111111b	; Nur Bit 7 = Ausgabe (Strobe)
 2531 EDA3  97          	  DB	10010111b	; Interrupt bei jeder Bitaenderung
 2532 EDA4  C0          	  DB	11000000b	; Ueberwache Bits 0..5
 2533                   
 2534 EDA5  93 02       	 DB	93h,2		; PIO-B Steuerwort
 2535 EDA7  CF          	  DB	11001111b	; Bitbetrieb
 2536 EDA8  00          	  DB	00000000b	; alles Ausgaenge
 2537                   
 2538 EDA9  90 01       	 DB	90h,1		; PIO-A Daten
 2539 EDAB  80          	  DB	10000000b	; Strobe passiv
 2540         0000      if turbo
 2575                   endif
 2576                   ;
 2577                   ; ISR fuer CTC2: Tonlaenge
 2578                   ;
 2579 EDAC  F5          ISRC2:	PUSH	AF
 2580 EDAD  E5          	PUSH	HL
 2581 EDAE  CD E46A     	CALL	TOFF		; kehrt mit EI zurueck
 2582 EDB1  E1          	POP	HL
 2583 EDB2  F1          	POP	AF
 2584 EDB3  ED 4D       	RETI
 2585                   ;
 2586                   ; Tabelle der ESC-Funktionen:
 2587                   ;
 2588 EDB5  E1BA        ESCTAB:	DW	ESC0		; Tabulatorsprung			ESC'0'
 2589 EDB7  F957        	DW	ESC1		; Anzeige Bild 0	Zugriff Bild 0	ESC'1'
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 132
CE47    INC

 2590 EDB9  F95C        	DW	ESC2		;	  Bild 1		Bild 1	ESC'2'
 2591 EDBB  F961        	DW	ESC3		;	  Bild 0		Bild 1	ESC'3'
 2592 EDBD  F966        	DW	ESC4		;	  Bild 1		Bild 0	ESC'4'
 2593 EDBF  F0EC        	DW	ESC5		; MODUL-Anzeige				ESC'5'
 2594 EDC1  F0F4        	DW	ESC6		; SYSTEM-Anzeige			ESC'6'
 2595 EDC3  F97E        	DW	ESC7		; Pixel invertieren			ESC'7'
 2596 EDC5  E2BE        	DW	ESC8		; Farbe invertieren			ESC'8'
 2597 EDC7  F987        	DW	ESC9		; Farbebene ein/aus			ESC'9'
 2598 EDC9  F98F        	DW	ESCA		; HiRes ein/aus				ESC'A'
 2599 EDCB  F9A5        	DW	ESCB		; HRG ein/aus				ESC'B'
 2600 EDCD  F9AC        	DW	ESCC		; IBM/CAOS-Zeichensatz			ESC'C'
 2601 EDCF  F10D        	DW	ESCD		; DEVICE-Umschaltung			ESC'D'
 2602                   ;	DW	ESCH		; Hilfefunktion (Idee aus CAOS 6.0)
 2603                   
 2604                   	ABSFILL	0EDFFh,<ROM-E-Ende>
    7 EDD1  FF FF FF FF 	  DS	0EDFFh - $,0FFh
 2605                   
 2606 EDFF              VERSION:
 2607 EDFF  47          	DB	47H		; CAOS-Version 4.7
  197 EE00              LARGE:	INCLUDE ZSGROSS.INC	; Zeichensatz Grossbuchstaben
    1                   ;*****************************************
    2                   ;**	CAOS 4.7 Zeichensatz Gross	**
    3                   ;**					**
    4                   ;**	Adresse:  EE00h bis EFFFh	**
    5                   ;**					**
    6                   ;**	letzte Aenderung: 31.03.2018	**
    7                   ;*****************************************
    8                   ;
    9                   ; 05.02.2018 geaendert (alle Zeichen links/oben):
   10                   ; Codes fuer 22h, 24h
   11                   
   12 EE00  00 00 00 00 	DB	000H, 000H, 000H, 000H, 000H, 000H, 000H, 000H	; 20H
   13 EE08  30 78 78 30 	DB	030H, 078H, 078H, 030H, 030H, 000H, 030H, 000H	; 21H !
   14 EE10  EE 66 CC 00 	DB	0EEH, 066H, 0CCH, 000H, 000H, 000H, 000H, 000H	; 22H "
   15 EE18  36 36 FE 6C 	DB	036H, 036H, 0FEH, 06CH, 0FEH, 0D8H, 0D8H, 000H	; 23H #
   16                   ;	DB	030H, 07CH, 0D8H, 07CH, 036H, 036H, 0FCH, 030H	; 24H $
   17 EE20  30 7C D0 7C 	DB	030H, 07CH, 0D0H, 07CH, 036H, 0FCH, 030H, 000H	; 24H $
   18 EE28  00 C6 CC 18 	DB	000H, 0C6H, 0CCH, 018H, 030H, 066H, 0C6H, 000H	; 25H %
   19 EE30  38 6C 38 76 	DB	038H, 06CH, 038H, 076H, 0DCH, 0CCH, 076H, 000H	; 26H &
   20 EE38  1C 0C 18 00 	DB	01CH, 00CH, 018H, 000H, 000H, 000H, 000H, 000H	; 27H '
   21 EE40  18 30 60 60 	DB	018H, 030H, 060H, 060H, 060H, 030H, 018H, 000H	; 28H (
   22 EE48  60 30 18 18 	DB	060H, 030H, 018H, 018H, 018H, 030H, 060H, 000H	; 29H )
   23 EE50  00 66 3C FF 	DB	000H, 066H, 03CH, 0FFH, 03CH, 066H, 000H, 000H	; 2AH *
   24 EE58  00 30 30 FC 	DB	000H, 030H, 030H, 0FCH, 030H, 030H, 000H, 000H	; 2BH +
   25 EE60  00 00 00 00 	DB	000H, 000H, 000H, 000H, 000H, 01CH, 00CH, 018H	; 2CH ,
   26 EE68  00 00 00 FE 	DB	000H, 000H, 000H, 0FEH, 000H, 000H, 000H, 000H	; 2DH -
   27 EE70  00 00 00 00 	DB	000H, 000H, 000H, 000H, 000H, 030H, 030H, 000H	; 2EH .
   28 EE78  06 0C 18 30 	DB	006H, 00CH, 018H, 030H, 060H, 0C0H, 080H, 000H	; 2FH /
   29                   
   30 EE80  7C C6 CE DE 	DB	07CH, 0C6H, 0CEH, 0DEH, 0F6H, 0E6H, 07CH, 000H	; 30H 0
   31 EE88  30 70 30 30 	DB	030H, 070H, 030H, 030H, 030H, 030H, 0FCH, 000H	; 31H 1
   32 EE90  78 CC 0C 38 	DB	078H, 0CCH, 00CH, 038H, 060H, 0CCH, 0FCH, 000H	; 32H 2
   33 EE98  FC 18 30 78 	DB	0FCH, 018H, 030H, 078H, 00CH, 0CCH, 078H, 000H	; 33H 3
   34 EEA0  1C 3C 6C CC 	DB	01CH, 03CH, 06CH, 0CCH, 0FEH, 00CH, 01EH, 000H	; 34H 4
   35 EEA8  FC C0 F8 0C 	DB	0FCH, 0C0H, 0F8H, 00CH, 00CH, 0CCH, 078H, 000H	; 35H 5
   36 EEB0  38 60 C0 F8 	DB	038H, 060H, 0C0H, 0F8H, 0CCH, 0CCH, 078H, 000H	; 36H 6
   37 EEB8  FC CC 0C 18 	DB	0FCH, 0CCH, 00CH, 018H, 030H, 030H, 030H, 000H	; 37H 7
   38 EEC0  78 CC CC 78 	DB	078H, 0CCH, 0CCH, 078H, 0CCH, 0CCH, 078H, 000H	; 38H 8
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 133
ZSGROSS INC

   39 EEC8  78 CC CC 7C 	DB	078H, 0CCH, 0CCH, 07CH, 00CH, 018H, 070H, 000H	; 39H 9
   40 EED0  00 00 30 30 	DB	000H, 000H, 030H, 030H, 000H, 030H, 030H, 000H	; 3AH :
   41 EED8  00 00 30 30 	DB	000H, 000H, 030H, 030H, 000H, 030H, 030H, 060H	; 3BH ;
   42 EEE0  18 30 60 C0 	DB	018H, 030H, 060H, 0C0H, 060H, 030H, 018H, 000H	; 3CH <
   43 EEE8  00 00 FC 00 	DB	000H, 000H, 0FCH, 000H, 0FCH, 000H, 000H, 000H	; 3DH =
   44 EEF0  60 30 18 0C 	DB	060H, 030H, 018H, 00CH, 018H, 030H, 060H, 000H	; 3EH >
   45 EEF8  78 CC 0C 18 	DB	078H, 0CCH, 00CH, 018H, 030H, 000H, 030H, 000H	; 3FH ?
   46                   
   47 EF00  7C C6 DE D6 	DB	07CH, 0C6H, 0DEH, 0D6H, 0DEH, 0C0H, 078H, 000H	; 40H @
   48 EF08  30 78 CC CC 	DB	030H, 078H, 0CCH, 0CCH, 0FCH, 0CCH, 0CCH, 000H	; 41H A
   49 EF10  FC 66 66 7C 	DB	0FCH, 066H, 066H, 07CH, 066H, 066H, 0FCH, 000H	; 42H B
   50 EF18  3C 66 C0 C0 	DB	03CH, 066H, 0C0H, 0C0H, 0C0H, 066H, 03CH, 000H	; 43H C
   51 EF20  F8 6C 66 66 	DB	0F8H, 06CH, 066H, 066H, 066H, 06CH, 0F8H, 000H	; 44H D
   52 EF28  FE 62 68 78 	DB	0FEH, 062H, 068H, 078H, 068H, 062H, 0FEH, 000H	; 45H E
   53 EF30  FE 62 68 78 	DB	0FEH, 062H, 068H, 078H, 068H, 060H, 0F0H, 000H	; 46H F
   54 EF38  3C 66 C0 C0 	DB	03CH, 066H, 0C0H, 0C0H, 0CEH, 066H, 03CH, 000H	; 47H G
   55 EF40  CC CC CC FC 	DB	0CCH, 0CCH, 0CCH, 0FCH, 0CCH, 0CCH, 0CCH, 000H	; 48H H
   56 EF48  78 30 30 30 	DB	078H, 030H, 030H, 030H, 030H, 030H, 078H, 000H	; 49H I
   57 EF50  1E 0C 0C 0C 	DB	01EH, 00CH, 00CH, 00CH, 0CCH, 0CCH, 078H, 000H	; 4AH J
   58 EF58  E6 66 6C 70 	DB	0E6H, 066H, 06CH, 070H, 06CH, 066H, 0E6H, 000H	; 4BH K
   59 EF60  F0 60 60 60 	DB	0F0H, 060H, 060H, 060H, 062H, 066H, 0FEH, 000H	; 4CH L
   60 EF68  C6 EE FE D6 	DB	0C6H, 0EEH, 0FEH, 0D6H, 0C6H, 0C6H, 0C6H, 000H	; 4DH M
   61 EF70  C6 E6 F6 DE 	DB	0C6H, 0E6H, 0F6H, 0DEH, 0CEH, 0C6H, 0C6H, 000H	; 4EH N
   62 EF78  38 6C C6 C6 	DB	038H, 06CH, 0C6H, 0C6H, 0C6H, 06CH, 038H, 000H	; 4FH O
   63                   
   64 EF80  FC 66 66 7C 	DB	0FCH, 066H, 066H, 07CH, 060H, 060H, 0F0H, 000H	; 50H P
   65 EF88  78 CC CC CC 	DB	078H, 0CCH, 0CCH, 0CCH, 0DCH, 078H, 01CH, 000H	; 51H Q
   66 EF90  FC 66 66 7C 	DB	0FCH, 066H, 066H, 07CH, 06CH, 066H, 0E6H, 000H	; 52H R
   67 EF98  7C C6 F0 3C 	DB	07CH, 0C6H, 0F0H, 03CH, 00EH, 0C6H, 07CH, 000H	; 53H S
   68 EFA0  FC B4 30 30 	DB	0FCH, 0B4H, 030H, 030H, 030H, 030H, 078H, 000H	; 54H T
   69 EFA8  CC CC CC CC 	DB	0CCH, 0CCH, 0CCH, 0CCH, 0CCH, 0CCH, 078H, 000H	; 55H U
   70 EFB0  CC CC CC 78 	DB	0CCH, 0CCH, 0CCH, 078H, 078H, 030H, 030H, 000H	; 56H V
   71 EFB8  C6 C6 C6 D6 	DB	0C6H, 0C6H, 0C6H, 0D6H, 0FEH, 0EEH, 0C6H, 000H	; 57H W
   72 EFC0  C6 C6 6C 38 	DB	0C6H, 0C6H, 06CH, 038H, 06CH, 0C6H, 0C6H, 000H	; 58H X
   73 EFC8  CC CC CC 78 	DB	0CCH, 0CCH, 0CCH, 078H, 030H, 030H, 078H, 000H	; 59H Y
   74 EFD0  FE C6 8C 18 	DB	0FEH, 0C6H, 08CH, 018H, 032H, 066H, 0FEH, 000H	; 5AH Z
   75 EFD8  FF FF FF FF 	DB	0FFH, 0FFH, 0FFH, 0FFH, 0FFH, 0FFH, 0FFH, 0FFH	; 5BH Vollzeichen
   76 EFE0  18 18 18 18 	DB	018H, 018H, 018H, 018H, 018H, 018H, 018H, 000H	; 5CH senkr. Strich
   77 EFE8  00 FE 06 06 	DB	000H, 0FEH, 006H, 006H, 000H, 000H, 000H, 000H	; 5DH Negationszeichen
   78 EFF0  10 38 6C C6 	DB	010H, 038H, 06CH, 0C6H, 000H, 000H, 000H, 000H	; 5EH ^
   79 EFF8  00 00 00 00 	DB	000H, 000H, 000H, 000H, 000H, 000H, 000H, 0FFH	; 5FH _
  198                   
  199                   	INCLUDE	CF47.INC	; ROM-F (F000-FDFF)
    1                   ;*****************************************
    2                   ;**	CAOS 4.7	ROM F		**
    3                   ;**					**
    4                   ;**	Adresse:  F000h bis FDFFh	**
    5                   ;**					**
    6                   ;**	letzte Aenderung: 30.03.2019	**
    7                   ;*****************************************
    8                   
    9                   ;	ORG	0F000H
   10                   				;				Adresse
   11 F000  C3 F15F     	JP	PWRON		; >> POWER ON <<		F000
   12 F003  18 4C       	JR	PV1		; DEFB nr			F003
   13 F005  00          OUTT1:	DB	0	; CRT
   14 F006  18 67       	JR	PV2		; (ARGC)=nr			F006
   15 F008  02          ZEI2:	DB	2	; UOUT1
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 134
CF47    INC

   16 F009  18 62       	JR	PV3		; E=nr				F009
   17 F00B  03          ZEI3:	DB	3	; UOUT2
   18 F00C  18 2B       	JR	PV4		; E=nr, IRM e/a			F00C
   19 F00E  04          INTT1:	DB	4	; KBD
   20 F00F  C3 F0B7     	JP	RCALL		; DEFW offset			F00F
   21 F012  C3 F166     	JP	BYE		; JUMP-Einsprung		F012
   22 F015  C3 F02D     	JP	PV5		; E=nr, IRM/Stack		F015
   23 F018  C3 F083     	JP	IRMON		;				F018
   24 F01B  C3 F0A0     	JP	IRMOF		;				F01B
   25 F01E  C3 F024     	JP	PV6		; (ARGC)=nr			F01E
   26 F021  C3 E4C9     	JP	PV7		; DEVICE-Aufruf, DEFB nr.	F021
   27                   				; PV7 ab CAOS 4.7 verfuegbar
   28 F024  C5          PV6:	PUSH	BC
   29 F025  CD F083     	CALL	IRMON
   30 F028  CD F06F     	CALL	PV2
   31 F02B  18 07       	JR	PV51
   32                   
   33 F02D  C5          PV5:	PUSH	BC
   34 F02E  CD F083     	CALL	IRMON
   35 F031  CD F06D     	CALL	PV3
   36 F034  CD F0A0     PV51:	CALL	IRMOF
   37 F037  C1          	POP	BC
   38 F038  C9          	RET
   39                   
   40 F039  CD F048     PV4:	CALL	SCRON
   41 F03C  CD F06D     	CALL	PV3
   42 F03F  F5          SCROFF:	PUSH	AF
   43 F040  DB 88       	IN	A,(PIOAD)
   44 F042  E6 FB       	AND	11111011b	; IRM aus
   45 F044  D3 88       	OUT	(PIOAD),A
   46 F046  F1          	POP	AF
   47 F047  C9          	RET
   48                   
   49 F048  F5          SCRON:	PUSH	AF
   50 F049  DB 88       	IN	A,(PIOAD)
   51 F04B  F6 04       	OR	00000100b	; IRM ein
   52 F04D  D3 88       	OUT	(PIOAD),A
   53 F04F  F1          	POP	AF
   54 F050  C9          	RET
   55                   
   56 F051  F3          PV1:	DI
   57 F052  E5          	PUSH	HL
   58 F053  E1          	POP	HL
   59 F054  E1          	POP	HL
   60 F055  23          	INC	HL		; nr uebergehen
   61 F056  E5          	PUSH	HL
   62 F057  2B          	DEC	HL		; (HL)=nr
   63 F058  3B          	DEC	SP
   64 F059  3B          	DEC	SP
   65 F05A  FB          	EI
   66 F05B  F5          	PUSH	AF
   67 F05C  D5          	PUSH	DE
   68 F05D  5E          	LD	E,(HL)
   69 F05E  16 00       PV22:	LD	D,0
   70 F060  2A B7B0     	LD	HL,(SUTAB)
   71 F063  19          	ADD	HL,DE
   72 F064  19          	ADD	HL,DE		; HL=Pos. in Tab
   73 F065  5E          	LD	E,(HL)
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 135
CF47    INC

   74 F066  23          	INC	HL
   75 F067  56          	LD	D,(HL)
   76 F068  EB          	EX	DE,HL
   77 F069  D1          	POP	DE
   78 F06A  F1          	POP	AF
   79 F06B  E3          	EX	(SP),HL
   80 F06C  C9          	RET			; UP anspringen
   81                   
   82 F06D  37          PV3:	SCF			; VR: F
   83                   ;	JR	PV21
   84 F06E  ED          	DB	0EDH		; ED A0 = NOP (Trick aus CAOS 3.4 uebernommern)
   85 F06F  A7          PV2:	AND	A		; VR: F
   86 F070  E5          PV21:	PUSH	HL
   87 F071  D5          	PUSH	DE
   88 F072  C5          	PUSH	BC
   89 F073  E5          	PUSH	HL
   90 F074  21 F3EC     	LD	HL,POP3		; Returnadresse
   91 F077  E3          	EX	(SP),HL		; auf Stack legen
   92 F078  E5          	PUSH	HL
   93 F079  F5          	PUSH	AF
   94 F07A  D5          	PUSH	DE
   95 F07B  38 E1       	JR	C,PV22		; falls PV3
   96 F07D  3A B780     	LD	A,(ARGC)	; sonst E
   97 F080  5F          	LD	E,A		; beschaffen
   98 F081  18 DB       	JR	PV22
   99                   ;
  100                   ; IRM ein und Stack auf (SYSP) setzen
  101                   ; aktuellen SP in IY merken
  102                   ; VR:	BC, F
  103                   ;
  104 F083  C1          IRMON:	POP	BC		; Rueckkehradresse
  105 F084  FD E5       	PUSH	IY		; Inhalt von IY auf Anwenderstack legen
  106 F086  FD 21 0000  	LD	IY,0		; SP in IY merken
  107 F08A  FD 39       	ADD	IY,SP		; (kein UP veraendert IY waehrend IRM ON!)
  108 F08C  F3          	DI
  109 F08D  DD 77 0B    	LD	(IX+11),A	; Inhalt von Register A merken
  110 F090  DB 88       	IN	A,(PIOAD)
  111 F092  F6 24       	OR	00100100b	; IRM+LED ein
  112 F094  D3 88       	OUT	(PIOAD),A
  113 F096  ED 7B B7AE  	LD	SP,(SYSP)	; System-SP verwenden
  114 F09A  FB          	EI
  115 F09B  DD 7E 0B    	LD	A,(IX+11)	; Register A regenerieren
  116 F09E  C5          	PUSH	BC
  117 F09F  C9          	RET			; wie JP (BC)
  118                   ;
  119                   ; IRM ausschalten und Stack auf IY setzen
  120                   ; VR:	BC
  121                   ;
  122 F0A0  C1          IRMOF:	POP	BC		; analog IRMON
  123 F0A1  DD 77 0B    	LD	(IX+11),A	; Inhalt von Register A merken
  124 F0A4  DB 88       	IN	A,(PIOAD)
  125 F0A6  CB 97       	RES	2,A		; IRM+LED aus
  126 F0A8  CB AF       	RES	5,A		; (F unveraendert)
  127 F0AA  F3          	DI
  128 F0AB  D3 88       	OUT	(PIOAD),A
  129 F0AD  FD F9       	LD	SP,IY		; gemerkten Anwender-SP regenerieren
  130 F0AF  FB          	EI
  131 F0B0  DD 7E 0B    	LD	A,(IX+11)	; Register A regenerieren
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 136
CF47    INC

  132 F0B3  FD E1       	POP	IY		; Inhalt von IY von Anwenderstack holen
  133 F0B5  C5          	PUSH	BC
  134 F0B6  C9          	RET
  135                   
  136                   ; Relativer UP-Aufruf ohne Registerzerstoerung:
  137                   
  138 F0B7  E3          RCALL:	EX	(SP),HL
  139 F0B8  D5          	PUSH	DE
  140 F0B9  5E          	LD	E,(HL)
  141 F0BA  23          	INC	HL
  142 F0BB  56          	LD	D,(HL)		; DE=Offset
  143 F0BC  23          	INC	HL
  144 F0BD  EB          	EX	DE,HL
  145 F0BE  19          	ADD	HL,DE		; addieren
  146 F0BF  E3          	EX	(SP),HL		; Zieladresse
  147 F0C0  EB          	EX	DE,HL		; DE von Stack
  148 F0C1  F3          	DI
  149 F0C2  33          	INC	SP
  150 F0C3  33          	INC	SP
  151 F0C4  E3          	EX	(SP),HL		; HL von Stack
  152 F0C5  3B          	DEC	SP
  153 F0C6  3B          	DEC	SP
  154 F0C7  FB          	EI
  155 F0C8  C9          	RET			; Ziel anspringen
  156                   
  157 F0C9  DD 7E 02    BNROST:	LD	A,(IX+2)	; Blocknummer
  158 F0CC  CD F3C4     AHOSTR:	CALL	AHEX		; Register A und folgende Zeichenkette
  159                   ;_____________________________________________________________
  160                   ;							**23**
  161                   ; Ausgabe einer Zeichenkette
  162                   ; Zeichektette hinter dem CALL, Ende mit 00h
  163                   ; PE/PA: -
  164                   ; VR: AF
  165                   
  166 F0CF  E3          OSTR:	EX	(SP),HL
  167 F0D0  CD F906     	CALL	ZKOUT		; Zeichenkette ausgeben
  168 F0D3  E3          	EX	(SP),HL
  169 F0D4  C9          	RET
  170                   
  171                   ; Module listen, lesen, schalten:
  172                   
  173 F0D5  7F7F        SWI7F:	DW	7F7FH
  174 F0D7  53 57 49 54 	DB	'SWITCH'
  175 F0DD  01          	DB	1
  176 F0DE  A7          	AND	A		; Argumente?
  177 F0DF  28 08       	JR	Z,MLIST
  178 F0E1  CD FB8F     	CALL	CON
  179 F0E4  CD C331     	CALL	SWIC		; lesen/schalten
  180 F0E7  18 21       	JR	MCOFF
  181                   	;
  182 F0E9  CD F0F4     MLIST:	CALL	ESC6		; interne Module listen
  183                   	;
  184 F0EC  CD FB8F     ESC5:	CALL	CON
  185 F0EF  CD C275     	CALL	MODULC		; externe Module listen
  186 F0F2  18 06       	JR	ESC61
  187                   
  188                   ;SYS7F:	DW	7F7FH		; Dieses Menuewort ist ab CAOS 4.6 nicht
  189                   ;	DB	'SYSTEM'	; mehr erforderlich - macht SWITCH mit!
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 137
CF47    INC

  190                   ;	DB	11H
  191 F0F4  CD FB8F     ESC6:	CALL	CON
  192 F0F7  CD C1A1     	CALL	SYSTC		; Systemcheck (interne Module 0-5)
  193 F0FA  ED 5B B7A0  ESC61:	LD	DE,(CURSO)	; aktuelle Cursorposition mitnehmen
  194 F0FE  18 0A       	JR	MCOFF
  195                   
  196                   ; Module lesen und Schalten
  197 F100  2E 02       MODUL2:	LD	L,2		; 2=USER-ROM
  198 F102  3E 02       MODUSW:	LD	A,2		; Modul schalten
  199                   ;_____________________________________________________________
  200                   ;							**26**
  201                   ; Module lesen und Schalten
  202                   ; PE:	A=0 oder 1	Lesen
  203                   ;	A=2 oder >2	Schalten
  204                   ;	L	Steckplatz
  205                   ;	D	Steuerbyte
  206                   ; PA:	H	Modultyp (Strukturbyte)
  207                   ;	D	Modulsteuerbyte
  208                   ; VR:	AF,H,BC
  209                   
  210 F104  CD FB8F     MODU:	CALL	CON
  211 F107  CD C39C     	CALL	MODUC
  212 F10A  C3 FB9C     MCOFF:	JP	COFF
  213                   
  214 F10D  CD FB8F     ESCD:	CALL	CON		; DEVICE-Umschaltung
  215 F110  CD D656     	CALL	ESCDD
  216 F113  18 E5       	JR	ESC61
  217                   
  218                   ; Betriebssystem wechseln:
  219                   
  220 F115  7F7F        JUMP7F:	DW	7F7FH
  221 F117  4A 55 4D 50 	DB	'JUMP'
  222 F11B  03          	DB	3
  223 F11C  7D          	LD	A,L		; Steckplatz
  224                   ;_____________________________________________________________
  225                   ;							**27**
  226                   ; Sprung in ein neues Betriebssystem
  227                   ; PE:	A	Modulsteckplatz
  228                   
  229         0000      if SYSROM
  232                   else
  233 F11D  B7          JUMP:	OR	A
  234 F11E  28 46       	JR	Z,BYE		; JUMP 0 entspricht RESET
  235                   endif
  236 F120  47          	LD	B,A
  237 F121  0E 80       	LD	C,80H
  238 F123  ED 78       	IN	A,(C)
  239 F125  3C          	INC	A		; Kennbyte FF?
  240 F126  20 13       	JR	NZ,JUM0
  241 F128  CD F0CF     	CALL	OSTR
  242 F12B  4B 65 69 6E 	DB	'Kein Modul!'
  243 F136  07 0D 0A 00 	DB	7,CR,LF,0
  244 F13A  C9          	RET
  245                   	;
  246 F13B  C5          JUM0:	PUSH	BC
  247 F13C  26 B8       	LD	H,HIGH(MODST)	; Modulsteuerbytespeicher
  248 F13E  06 07       	LD	B,7		; ab Platz 7!
  249 F140  04          JUM1:	INC	B
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 138
CF47    INC

  250 F141  28 0D       	JR	Z,JUM2		; bis FF
  251 F143  ED 78       	IN	A,(C)
  252 F145  2F          	CPL
  253 F146  E6 70       	AND	70H		; Speichermodul?
  254 F148  20 F6       	JR	NZ,JUM1
  255 F14A  ED 79       	OUT	(C),A		; aus
  256 F14C  68          	LD	L,B
  257 F14D  77          	LD	(HL),A
  258 F14E  18 F0       	JR	JUM1
  259                   	;
  260 F150  C1          JUM2:	POP	BC
  261 F151  3E FD       	LD	A,0FDH		; Ausgabe FD (Adresse C000, schreibgeschuetzt)
  262 F153  68          	LD	L,B
  263 F154  77          	LD	(HL),A		; Eintrag
  264 F155  F3          	DI
  265 F156  ED 79       	OUT	(C),A		; einschalten
  266 F158  DB 88       	IN	A,(PIOAD)
  267 F15A  E6 7E       	AND	01111110b	; interne ROMs abschalten
  268 F15C  C3 B7B4     	JP	NCAOS		; Sprung ueber IRM
  269         0000      if SYSROM
  284                   endif
  285                   
  286                   ; Einschalt-Initialisierung:
  287                   
  288 F15F  3E E3       PWRON:	LD	A,0E3H		; RAM4 WR einschalten, CAOS-Bank 0
  289 F161  D3 86       	OUT	(PORT2),A	; und CAOS-C ein
  290 F163  C3 C051     	JP	PWRONC		; Programm im ROM-C weiter abarbeiten ...
  291                   ;
  292                   ; Tasten-RESET und JUMP-Einsprung:
  293                   ;
  294 F166  31 01C4     BYE:	LD	SP,STACK	; System-Stack setzen
  295         0000      if SYSROM
  298                   else
  299 F169  3E E3       	LD	A,0E3H		; RAM4 WR einschalten, CAOS-Bank 0
  300                   endif
  301 F16B  D3 86       	OUT	(PORT2),A	; und CAOS-C ein
  302 F16D  CD C091     	CALL	SYSI		; Systeminitialisierung
  303 F170  CD C9F0     PWR4:	CALL	V24INI		; M003 suchen und initialisieren
  304 F173  CD FB9C     	CALL	COFF		; CAOS-C ausschalten (Standard)
  305 F176  01 0880     	LD	BC,880H		; auf Steckplatz 8
  306 F179  ED 78       	IN	A,(C)		; ROM-Modul mit Strukturbyte
  307 F17B  3D          	DEC	A		; 01 vorhanden?
  308 F17C  20 14       	JR	NZ,PWR6		; nein!
  309 F17E  3E 41       	LD	A,41H		; 43H bis CAOS 4.6, also mit Schreibfreigabe
  310 F180  ED 79       	OUT	(C),A		; R/O einschalten auf Adresse 4000H
  311 F182  32 B808     	LD	(MODST+8),A	; Schaltzustand eintragen
  312 F185  DD 7E 04    	LD	A,(IX+4)
  313 F188  E6 FC       	AND	0FCH		; internen RAM4 ausschalten
  314 F18A  DD 77 04    	LD	(IX+4),A
  315 F18D  D3 86       	OUT	(PORT2),A
  316 F18F  C3 4000     	JP	4000H		; Adresse 4000h im Modul anspringen
  317                   	;
  318 F192  06 FC       PWR6:	LD	B,0FCH
  319 F194  ED 78       	IN	A,(C)
  320 F196  FE A7       	CP	0A7H		; Floppy vorhanden?
  321 F198  20 37       	JR	NZ,PWR7		; nein
  322                   ;	OUT	(C),A		; einschalten mit Steuerbyte A7H
  323                   ; Befehl kann entfallen, da die Kopplung fuer die Treibersuche bereits ein ist!
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 139
CF47    INC

  324 F19A  01 B3F3     	LD	BC,UROK		; 0B3F3H
  325 F19D  ED 78       	IN	A,(C)		; Betriebsart ermitteln
  326 F19F  3D          	DEC	A
  327 F1A0  28 2F       	JR	Z,PWR7		; 1=CP/M-Betriebsart erkannt
  328 F1A2  FE 04       	CP	4
  329 F1A4  28 2B       	JR	Z,PWR7		; 5=CAOS-Betriebsart erkannt
  330 F1A6  CD F0CF     	CALL	OSTR
  331 F1A9  0C 0A       	DB	0CH,LF		; Ansonsten: Autostart mit JUMP FC
  332 F1AB  41 75 74 6F 	DB	'Autostart Floppy'
  333 F1BB  0D 0A 00    	DB	CR,LF,0
  334 F1BE  06 00       	LD	B,0
  335 F1C0  CD E37C     PWR5:	CALL	BRKT		; BRK-Taste gedrueckt?
  336 F1C3  38 0C       	JR	C,PWR7		; ja, dann kein Floppy-Autostart
  337 F1C5  10 F9       	DJNZ	PWR5		; 256-mal abfragen
  338 F1C7  3E 01       	LD	A,1
  339 F1C9  32 B781     	LD	(ARGN),A	; 1 Parameter fuer JUMP FC vorgeben
  340 F1CC  3E FC       	LD	A,0FCH
  341 F1CE  CD F11D     	CALL	JUMP		; Startversuch
  342 F1D1  AF          PWR7:	XOR	A
  343 F1D2  32 B781     	LD	(ARGN),A	; MENU ohne Parameter ausfuehren!
  344 F1D5  18 08       	JR	MEN0
  345                   ;
  346                   ;*__*__*__*__*__*__*__*__*__*__*__*__*__
  347                   ;
  348                   ; Epilogverwaltung:		(bereits in CAOS 2.5 von Frank Klemm realisiert)
  349                   ; -----------------
  350                   ; Epiloge 0 ... 1F
  351                   ;
  352                   ; Bit:  4      3      2      1      0
  353                   ;	I      I      I	     I	    \
  354                   ;  0: mindes-  -------+-------	   IRM 
  355                   ;      tens	  Anzahl der
  356                   ;  1:  genau	   Argumente	  on/off
  357                   ;
  358                   ; wenn Epilog 1F -> dann keine Auswer-
  359                   ; tung der Argumente, DE Zeiger auf Args
  360                   ;
  361                   ;*__*__*__*__*__*__*__*__*__*__*__*__*__
  362                   ;
  363                   ; Menue Display
  364                   ;
  365 F1D7  7F7F        	DW	7F7FH
  366 F1D9  4D 45 4E 55 	DB	'MENU'
  367 F1DD  01          	DB	1
  368 F1DE  E1          	POP	HL		; Stack clear
  369 F1DF  CD F0CF     MEN0:	CALL	OSTR
  370 F1E2  0C 0A       	DB	0CH,LF
  371 F1E4  2A 20 4B 43 	DB	'* KC-CAOS 4.7 ',0
  372 F1F3  CD FBD2     	CALL	DEVANZ		; aktuelles Device anzeigen
  373 F1F6  CD F0CF     	CALL	OSTR
  374 F1F9  20 2A 00    	DB	' *',0
  375                   ;_____________________________________________________________
  376                   ;							**46**
  377                   ; Menue anzeigen und Uebergang zur Kommandoeingabe
  378                   ; PE:	(IX+9)	Prologbyte
  379                   ;	ARGN=1	ARG1 auswerten
  380                   ;	ARG1=0	MENU normal anzeigen
  381                   ;	ARG1=1	versteckte Menueworte mit anzeigen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 140
CF47    INC

  382                   ;	ARG1=2	Adressen mit anzeigen
  383                   ;	ARGN=3	versteckte Menueworte und Adressen anzeigen
  384                   ; PA/VR: -
  385                   
  386 F1FC  2A B781     MENU:	LD	HL,(ARGN)
  387 F1FF  1E 00       	LD	E,0		; Parameter zum Testen in E bereithalten
  388 F201  2D          	DEC	L		; ARGN=1?
  389 F202  20 01       	JR	NZ,men9		; nein, E=0 verwenden
  390 F204  5C          	LD	E,H		; E=ARG1
  391 F205  21 C000     men9:	LD	HL,0C000H	; Menuewortsuche immer ab C000H
  392 F208  4D          	LD	C,L
  393 F209  45          	LD	B,L		; BC=0 (Suchlaenge)
  394 F20A  CD F4DB     MEN1:	CALL	CRLF
  395 F20D  3E 02       MEN2:	LD	A,2		; CLLN
  396 F20F  CD F3A6     	CALL	OPRCHR		; Prompt ausgeben
  397 F212  CD E37C     	CALL	BRKT
  398 F215  38 62       	JR	C,LOOP2		; Break
  399 F217  DD 7E 09    	LD	A,(IX+9)	; Prologbyte
  400 F21A  ED B1       MEN4:	CPIR
  401 F21C  E2 F279     	JP	PO,LOOP2	; ausgesucht
  402 F21F  ED A1       	CPI			; 2mal nacheinander?
  403 F221  E2 F279     	JP	PO,LOOP2	; ausgesucht
  404 F224  20 F4       	JR	NZ,MEN4		; nicht 2mal
  405 F226  7E          MEN5:	LD	A,(HL)
  406 F227  FE 20       	CP	20h		; Epilog (0..1Fh)?
  407 F229  38 27       	JR	C,MEN7
  408 F22B  CB 43       	bit	0,e		; versteckte Menueworte anzeigen?
  409 F22D  28 06       	jr	z,men8		; nein
  410 F22F  FE 7B       	CP	'z'+1		; <= 'z'?
  411 F231  30 DA       	JR	NC,MEN2		; groesser als 'z'
  412 F233  18 10       	jr	men6
  413                   	;
  414 F235  FE 30       men8:	CP	'0'		; >= '0' und
  415 F237  38 D4       	JR	C,MEN2		; kleiner als '0'
  416 F239  FE 5B       	CP	'Z'+1		; <= 'Z'?
  417 F23B  30 D0       	JR	NC,MEN2		; groesser als 'Z'
  418 F23D  FE 41       	CP	'A'		; >= 'A' oder
  419 F23F  30 04       	JR	NC,MEN6		; groesser als 'A'
  420 F241  FE 3B       	CP	':'+1		; <= ':'?
  421 F243  30 C8       	JR	NC,MEN2		; groesser als ':'
  422 F245  CD F3D5     MEN6:	CALL	OCHR
  423 F248  23          	INC	HL
  424 F249  0B          	DEC	BC
  425 F24A  79          	LD	A,C
  426 F24B  B0          	OR	B
  427 F24C  20 D8       	JR	NZ,MEN5
  428 F24E  3E 02       	LD	A,2		; CLLN
  429 F250  18 24       	JR	LOOP1		; ausgesucht
  430                   	;
  431 F252  CB 4B       MEN7:	bit	1,e
  432 F254  28 B4       	jr	z,men1		; keine Adressen anzeigen
  433 F256  3A B79E     	ld	a,(winlg)
  434 F259  FE 0F       	cp	15		; Fensterbreite fuer Adressen ausreichend?
  435 F25B  38 AD       	jr	c,men1		; nein, dann nicht anzeigen!
  436 F25D  3E 0B       	ld	a,11
  437 F25F  32 B7A0     	ld	(curso),a	; Spalte fuer Adressanzeige
  438 F262  23          	inc	hl
  439 F263  CD F3B4     	call	hlhx		; Startadresse anzeigen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 141
CF47    INC

  440 F266  2B          	dec	hl
  441 F267  18 A1       	JR	MEN1
  442                   ;_____________________________________________________________
  443                   ;							**12**
  444                   ; Eingabeschleife:
  445                   
  446 F269  DB 88       LOOP:	IN	A,(PIOAD)
  447 F26B  E6 DF       	AND	11011111b	; LED aus
  448 F26D  F6 04       	OR	00000100b	; IRM ein
  449 F26F  D3 88       	OUT	(PIOAD),A
  450 F271  CD FB9C     	CALL	COFF
  451 F274  3E 0D       	LD	A,CR		; Zeilenanfang
  452 F276  CD F3A6     LOOP1:	CALL	OPRCHR		; Prompt ausgeben
  453 F279  CD F27E     LOOP2:	CALL	INPUT
  454 F27C  18 EB       	JR	LOOP
  455                   
  456                   ; Menuekommandoroutine
  457                   
  458 F27E  CD F499     INPUT:	CALL	INLIN		; Eingabe
  459 F281  30 0A       	JR	NC,INPT1	; mit Enter abgeschlossen
  460 F283  3E 0B       	LD	A,0BH		; bei BRK
  461 F285  CD E08C     	CALL	CRT		; Cursor hoch
  462 F288  3E 02       	LD	A,2		; und
  463 F28A  C3 E08C     	JP	CRT		; Zeile loeschen
  464                   	;
  465 F28D  13          INPT1:	INC	DE		; Zeichen nach Prompt
  466 F28E  1A          	LD	A,(DE)
  467 F28F  E6 DF       	AND	0DFH		; leer?
  468 F291  C8          	RET	Z
  469 F292  3A B802     	LD	A,(MODST+2)	; Schaltzustand USER-ROM
  470 F295  32 B780     	LD	(ARGC),A	; CAOS 4.6: hier uebergeben an USER-Programme
  471 F298  CD F351     	CALL	MSUCH		; Suche ab C000H
  472 F29B  38 3F       	JR	C,INPT5		; gefunden
  473 F29D  3A B805     	LD	A,(MODST+5)
  474 F2A0  E6 01       	AND	1
  475 F2A2  20 0A       	JR	NZ,INPT2	; CAOS-C war bereits an
  476 F2A4  CD FB8F     	CALL	CON
  477 F2A7  06 20       	LD	B,20H		; ansonsten 2000h Bytes
  478 F2A9  CD F353     	CALL	MS1		; durchsuchen im CAOS-ROM-C
  479 F2AC  38 2E       	JR	C,INPT5		; gefunden
  480 F2AE  D5          INPT2:	PUSH	DE
  481         0000      if SYSROM
  483                   else
  484 F2AF  16 D1       	LD	D,0D1H		; 1. Ebene (BASIC nicht mit durchsuchen)
  485                   endif
  486 F2B1  CD F100     INPT3:	CALL	MODUL2		; USER-ROM-C Ebene ein
  487                   	RESIXA	7,4		; RES 7,(IX+4),A
    1 F2B4  DD CB 04    	 DB	0DDh,0CBh,4
    2 F2B7  BF          	 DB	7 SHL 3 OR 10000111b
  488 F2B8  D3 86       	OUT	(PORT2),A	; CAOS-ROM-C aus!
  489 F2BA  EB          	EX	DE,HL
  490 F2BB  E3          	EX	(SP),HL		; DE=Suchkette
  491 F2BC  EB          	EX	DE,HL
  492 F2BD  06 20       	LD	B,20H		; Suchlaenge 2000h Bytes
  493 F2BF  CD F353     	CALL	MS1		; Menuewort in USER-ROM suchen
  494 F2C2  38 13       	JR	C,INPT4		; gefunden
  495 F2C4  EB          	EX	DE,HL
  496 F2C5  E3          	EX	(SP),HL		; DE=Schaltzustand
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 142
CF47    INC

  497 F2C6  EB          	EX	DE,HL
  498         0000      if SYSROM
  500                   else
  501 F2C7  3E 10       	LD	A,10H		; Offset zur naechsten Ebene: C1, D1, E1, F1
  502                   endif
  503 F2C9  82          	ADD	A,D		; naechste Ebene berechnen
  504 F2CA  57          	LD	D,A
  505 F2CB  30 E4       	JR	NC,INPT3	; naechste Ebene
  506 F2CD  ED 5B B77F  	LD	DE,(ARGC-1)	; CAOS 4.6: D = USERC-Schaltzustand vor Suche
  507 F2D1  CD F100     	CALL	MODUL2		; USER-ROMC wie zuvor
  508 F2D4  D1          	POP	DE
  509 F2D5  18 2C       	JR	ERR1		; invalid command
  510                   	;
  511 F2D7  F1          INPT4:	POP	AF		; Schaltzustand USER-ROM-C vergessen
  512 F2D8  AF          	XOR	A
  513 F2D9  32 B805     	LD	(MODST+5),A	; CAOS-C ausschalten
  514 F2DC  7E          INPT5:	LD	A,(HL)		; Epilog
  515 F2DD  23          	INC	HL
  516 F2DE  E5          	PUSH	HL
  517 F2DF  FE 1F       	CP	1FH
  518 F2E1  C8          	RET	Z		; ohne arg!
  519 F2E2  F5          	PUSH	AF
  520 F2E3  CD F520     	CALL	GARG		; Arg's erfassen
  521 F2E6  C1          	POP	BC
  522 F2E7  38 46       	JR	C,ERR4		; bad args
  523 F2E9  3A B781     	LD	A,(ARGN)
  524 F2EC  48          	LD	C,B
  525 F2ED  CB A0       	RES	4,B
  526 F2EF  CB 28       	SRA	B
  527 F2F1  B8          	CP	B
  528 F2F2  38 2D       	JR	C,ERR3		; zu wenig arg
  529 F2F4  28 04       	JR	Z,INPT6
  530 F2F6  CB 61       	BIT	4,C
  531 F2F8  20 19       	JR	NZ,ERR2		; zu viele arg
  532 F2FA  CB 41       INPT6:	BIT	0,C
  533 F2FC  CD F5FF     	CALL	LARG		; Arg's laden
  534 F2FF  C0          	RET	NZ		; mit IRM on
  535 F300  C3 F03F     	JP	SCROFF		; mit IRM off
  536                   
  537 F303  CD F0CF     ERR1:	CALL	OSTR
  538 F306  4B 6F 6D 6D 	DB	'Kommando?',7,0
  539 F311  18 3B       	JR	ERRCR
  540                   	;
  541 F313  CD F0CF     ERR2:	CALL	OSTR
  542 F316  5A 75 20 76 	DB	'Zu viele',0
  543 F31F  18 1D       	JR	ERRA
  544                   	;
  545 F321  CD F0CF     ERR3:	CALL	OSTR
  546 F324  5A 75 20 77 	DB	'Zu wenig',0
  547 F32D  18 0F       	JR	ERRA
  548                   	;
  549 F32F  CD F0CF     ERR4:	CALL	OSTR
  550 F332  46 65 68 6C 	DB	'Fehlerhafte',0
  551 F33E  E1          ERRA:	POP	HL		; Stack clear
  552 F33F  CD F0CF     	CALL	OSTR
  553 F342  20 41 72 67 	DB	' Argumente',7,0
  554 F34E  C3 F4DB     ERRCR:	JP	CRLF
  555                   
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 143
CF47    INC

  556 F351  06 00       MSUCH:	LD	B,0
  557 F353  21 C000     MS1:	LD	HL,0C000H	; Standard-Suchbeginn
  558 F356  4D          	LD	C,L
  559 F357  DD 7E 09    ZS0:	LD	A,(IX+9)	; Prologbyte
  560                   ;_____________________________________________________________
  561                   ;							**1D**
  562                   ; Zeichenkette/Menuewort suchen
  563                   ; PE:	A	Prologbyte (bei CAOS: 7FH)
  564                   ;	BC	Laege des Suchbereiches
  565                   ;	DE	Anfang der Vergleichskette
  566                   ;	HL	Anfang des Suchbereichs
  567                   ; PA:	DE	Ende+1 Vergleichskette (wenn gefunden)
  568                   ;	HL	Ende+1 gefundene Kette
  569                   ;	CY=1	Kette gefunden
  570                   ; VR:	AF,BC,DE,HL
  571                   
  572 F35A  ED B1       ZSUCH:	CPIR
  573 F35C  37          	SCF
  574 F35D  3F          	CCF			; CY=0
  575 F35E  E0          	RET	PO		; Prolog nicht gefunden
  576 F35F  ED A1       	CPI
  577 F361  20 F7       	JR	NZ,ZSUCH	; nur 1x gefunden
  578 F363  F5          	PUSH	AF
  579 F364  D5          	PUSH	DE		; Beginn der Vergleichskette retten
  580 F365  1A          ZS1:	LD	A,(DE)		; Zeichen von Vergleichskette
  581 F366  13          	INC	DE
  582 F367  FE 21       	CP	21H
  583 F369  38 0D       	JR	C,ZS3		; Kettenende bei Vergleichskette erkannt
  584 F36B  CB 6E       	BIT	5,(HL)		; Grossbuchstabe im Speicher?
  585 F36D  CC F53D     	CALL	Z,UPCASE	; dann Zeichen von Vergleichskette upcasen
  586 F370  ED A1       	CPI
  587 F372  28 F1       	JR	Z,ZS1		; stimmt ueberein
  588 F374  D1          ZS2:	POP	DE		; wieder zu Begenn der Vergleichskette
  589 F375  F1          	POP	AF		; und verwendetes Prologbyte restaurieren
  590 F376  18 E2       	JR	ZSUCH		; Suche fortsetzen
  591                   	;
  592 F378  7E          ZS3:	LD	A,(HL)		; Zeichen aus Speicher weiter testen
  593 F379  FE 20       	CP	20H		; bis Epilogbyte (0..1Fh) kommt
  594 F37B  38 08       	JR	C,ZS4		; Epilog gefunden
  595                   ;	JR	Z,ZS2		; SPC (war in CAOS 4.3 und 4.4 nicht zugelassen)
  596 F37D  FE 80       	CP	80H
  597 F37F  30 F3       	JR	NC,ZS2		; Zeichen ab 80H nicht zugelassen
  598 F381  23          	INC	HL
  599 F382  0B          	DEC	BC		; Befehl am 11.04.2010 ergaenzt
  600 F383  18 F3       	JR	ZS3
  601                   	;
  602 F385  F1          ZS4:	POP	AF
  603 F386  F1          	POP	AF
  604 F387  37          	SCF			; CY=1 fuer gefunden
  605 F388  C9          	RET
  606                   ;_____________________________________________________________
  607                   ;							**13**
  608                   ; Normalein- und Ausgabe: CRT und KBD
  609                   ; PE:	-
  610                   ; PA:	HL	alter Ausgabezeiger
  611                   ; VR:	HL
  612                   
  613 F389  CD F399     NORM:	CALL	NIN		; Normaleingabe
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 144
CF47    INC

  614                   ;_____________________________________________________________
  615                   ;							**20**
  616                   ; Setzen eines neuen Output Kanals
  617                   
  618 F38C  21 F005     NOUT:	LD	HL,OUTT1
  619                   ;_____________________________________________________________
  620                   ;							**1E**
  621 F38F  E5          SOUT:	PUSH	HL
  622 F390  2A B7B9     	LD	HL,(OUTAB)	; bisheriger Zeiger
  623 F393  E3          	EX	(SP),HL
  624 F394  22 B7B9     	LD	(OUTAB),HL	; neuer Zeiger
  625 F397  E1          	POP	HL
  626 F398  C9          	RET
  627                   ;_____________________________________________________________
  628                   ;							**21**
  629                   ; Setzen eines neuen Input Kanals
  630                   
  631 F399  21 F00E     NIN:	LD	HL,INTT1
  632                   ;_____________________________________________________________
  633                   ;							**1F**
  634 F39C  E5          SIN:	PUSH	HL
  635 F39D  2A B7BB     	LD	HL,(INTAB)	; bisheriger Zeiger
  636 F3A0  E3          	EX	(SP),HL
  637 F3A1  22 B7BB     	LD	(INTAB),HL	; neuer Zeiger
  638 F3A4  E1          	POP	HL
  639 F3A5  C9          	RET
  640                   
  641                   ; Steuerzeichen und Prompt ausgeben
  642                   ; PE: A=Steuerzeichen
  643 F3A6  CD E08C     OPRCHR:	CALL	CRT
  644 F3A9  3A B7EC     	LD	A,(PROMPT)
  645 F3AC  FE 20       	CP	' '
  646 F3AE  30 02       	JR	NC,OPRCH1
  647 F3B0  3E 25       	LD	A,'%'		; Standard
  648 F3B2  18 21       OPRCH1:	JR	OCHR		; Prompt
  649                   ;_____________________________________________________________
  650                   ;							**1A**
  651                   ; 16-Bit-Wert hexadezimal anzeigen und ein Leerzeichen danach
  652                   
  653 F3B4  7C          HLHX:	LD	A,H
  654 F3B5  CD F3C4     	CALL	AHEX
  655 F3B8  7D          ALSPC:	LD	A,L
  656 F3B9  CD F3C4     AHSPC:	CALL	AHEX
  657                   ;_____________________________________________________________
  658                   ;							**2B**
  659                   ; Leerzeichen anzeigen
  660                   
  661 F3BC  3E 20       SPACE:	LD	A,' '		; Leerzeichen
  662 F3BE  18 15       	JR	OCHR
  663                   ;_____________________________________________________________
  664                   ;							**2D**
  665                   ; Cursor in Home-Position
  666                   
  667 F3C0  3E 10       HOME:	LD	A,10H		; Home-Code
  668 F3C2  18 11       	JR	OCHR
  669                   ;_____________________________________________________________
  670                   ;							**1C**
  671                   ; 8-Bit-Wert hexadezimal anzeigen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 145
CF47    INC

  672                   
  673 F3C4  F5          AHEX:	PUSH	AF
  674 F3C5  0F          	RRCA			; Tetradentausch
  675 F3C6  0F          	RRCA
  676 F3C7  0F          	RRCA
  677 F3C8  0F          	RRCA
  678 F3C9  CD F3CD     	CALL	AHEX0		; erst aufrufen,
  679 F3CC  F1          	POP	AF		; dann reinlaufen
  680 F3CD  E6 0F       AHEX0:	AND	0FH		; Maske
  681 F3CF  C6 90       	ADD	A,90H		; uebliche
  682 F3D1  27          	DAA			; Routine
  683 F3D2  CE 40       	ADC	A,40H		; fuer die
  684 F3D4  27          	DAA			; Hexausgabe
  685                   ;_____________________________________________________________
  686                   ;							**24**
  687                   ; Ausgabe eines Zeichens ueber def. Kanal
  688                   
  689 F3D5  E5          OCHR:	PUSH	HL
  690 F3D6  2A B7B9     	LD	HL,(OUTAB)	; Ausgabekanal
  691 F3D9  D5          INTA1:	PUSH	DE		; siehe auch PV1 (sehr aehnlich)
  692 F3DA  C5          	PUSH	BC
  693 F3DB  5E          	LD	E,(HL)		; UP-Nr. der Routine
  694 F3DC  16 00       	LD	D,0
  695 F3DE  2A B7B0     	LD	HL,(SUTAB)
  696 F3E1  F5          	PUSH	AF
  697 F3E2  19          	ADD	HL,DE
  698 F3E3  19          	ADD	HL,DE
  699 F3E4  F1          	POP	AF
  700 F3E5  5E          	LD	E,(HL)
  701 F3E6  23          	INC	HL
  702 F3E7  56          	LD	D,(HL)		; DE = Adresse der Routine
  703 F3E8  EB          	EX	DE,HL
  704                   	; hier CAOS-C ausschalten
  705 F3E9  CD E1B9     	CALL	JPHL		; Routine aufrufen
  706                   	; hier CAOS-C wieder einschalten wie er war
  707 F3EC  C1          POP3:	POP	BC		; auch fuer PV2
  708 F3ED  D1          	POP	DE		; bis PV6!
  709 F3EE  E1          	POP	HL
  710 F3EF  C9          	RET
  711                   ;_____________________________________________________________
  712                   ;							**16**
  713                   ; Eingabe eines Zeichens ueber def. Kanal
  714                   ;
  715 F3F0  E5          INTB:	PUSH	HL
  716 F3F1  2A B7BB     	LD	HL,(INTAB)	; Eingabekanal
  717 F3F4  18 E3       	JR	INTA1
  718                   ;_____________________________________________________________
  719                   ;							**04**
  720                   ; Eingabe eines Zeichens mit Cursoreinblendung
  721                   ;
  722 F3F6  E5          KBD:	PUSH	HL
  723 F3F7  D5          	PUSH	DE
  724 F3F8  C5          	PUSH	BC
  725 F3F9  DD CB 08 76 KBD1:	BIT	6,(IX+8)	; F-Taste aktiv?
  726 F3FD  20 60       	JR	NZ,KBD9		; ja
  727 F3FF  1E 00       KBD2:	LD	E,0
  728 F401  CD F051     KBD3:	CALL	PV1
  729 F404  25          	DB	25h		; CUCP - blinken
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 146
CF47    INC

  730 F405  1C          	INC	E		; e/a-Merker
  731 F406  06 0F       	LD	B,15		; F00h mal
  732 F408  CD E373     KBD4:	CALL	KBDZ		; abfragen
  733 F40B  38 07       	JR	C,KBD5
  734 F40D  0B          	DEC	BC
  735 F40E  78          	LD	A,B
  736 F40F  B1          	OR	C
  737 F410  20 F6       	JR	NZ,KBD4		; warten,
  738 F412  18 ED       	JR	KBD3		; dann Cursor wieder weg usw.
  739                   	;
  740 F414  CB 43       KBD5:	BIT	0,E		; gerade ein?
  741 F416  28 04       	JR	Z,KBD5a
  742 F418  CD F051     	CALL	PV1		; Cursor wegnehmen
  743 F41B  25          	DB	25h		; CUCP
  744 F41C  57          KBD5a:	LD	D,A
  745 F41D  DD CB 08 6E 	BIT	5,(IX+8)	; Click ein?
  746 F421  C4 E2B1     	CALL	NZ,CLIK		; Click-Ton erzeugen
  747 F424  7A          	LD	A,D
  748 F425  21 B7A2     	LD	HL,STBT
  749 F428  CB 66       	BIT	4,(HL)		; ESC aktiv?
  750 F42A  28 0D       	JR	Z,KBD6
  751 F42C  ED 5B B7A0  	LD	DE,(CURSO)
  752 F430  CD E183     	CALL	CRT1		; ESC ausfuehren
  753 F433  ED 53 B7A0  	LD	(CURSO),DE
  754 F437  18 C6       	JR	KBD2
  755                   	;
  756 F439  FE 1B       KBD6:	CP	ESC
  757 F43B  20 04       	JR	NZ,KBD7
  758 F43D  CB E6       	SET	4,(HL)		; ESC merken
  759 F43F  18 BE       KBD2J:	JR	KBD2
  760                   	;
  761 F441  FE F1       KBD7:	CP	0F1H		; F-Taste?
  762 F443  38 A7       	JR	C,POP3
  763 F445  E6 0F       	AND	0FH
  764 F447  47          	LD	B,A
  765 F448  21 B900     	LD	HL,FTASTE	; 0B900H
  766 F44B  7E          KBD8:	LD	A,(HL)
  767 F44C  2C          	INC	L
  768 F44D  28 B0       	JR	Z,KBD2		; Speicherende
  769 F44F  A7          	AND	A
  770 F450  20 F9       	JR	NZ,KBD8		; Position im Puffer
  771 F452  10 F7       	DJNZ	KBD8		; auszaehlen
  772 F454  7D          	LD	A,L
  773 F455  FE 9C       	CP	9CH
  774 F457  30 A6       	JR	NC,KBD2		; Speicherende
  775 F459  DD CB 08 F6 	SET	6,(IX+8)	; F-Taste aktiv
  776 F45D  18 08       	JR	KBD10
  777                   	;
  778 F45F  CD E37C     KBD9:	CALL	BRKT		; Abbruch?
  779 F462  38 1A       	JR	C,KBD12
  780 F464  2A B7D1     	LD	HL,(FTAST)	; Zeiger auf
  781 F467  7E          KBD10:	LD	A,(HL)		; naechstes CHR
  782 F468  FE 1B       	CP	ESC
  783 F46A  20 0B       	JR	NZ,KBD11
  784 F46C  23          	INC	HL
  785 F46D  22 B7D1     	LD	(FTAST),HL
  786 F470  21 B7A2     	LD	HL,STBT
  787 F473  CB E6       	SET	4,(HL)		; ESC merken
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 147
CF47    INC

  788 F475  18 82       KBD1J:	JR	KBD1
  789                   	;
  790 F477  23          KBD11:	INC	HL
  791 F478  22 B7D1     	LD	(FTAST),HL	; Zeiger retten
  792 F47B  A7          	AND	A		; NUL-Ende?
  793 F47C  20 06       	JR	NZ,KBD13
  794 F47E  DD CB 08 B6 KBD12:	RES	6,(IX+8)	; ja - inaktiv
  795 F482  18 BB       	JR	KBD2J
  796                   	;
  797 F484  21 B7A2     KBD13:	LD	HL,STBT
  798 F487  CB 66       	BIT	4,(HL)
  799 F489  CA F3EC     	JP	Z,POP3
  800 F48C  ED 5B B7A0  	LD	DE,(CURSO)
  801 F490  CD E183     	CALL	CRT1		; ESC ausfuehren
  802 F493  ED 53 B7A0  	LD	(CURSO),DE
  803 F497  18 DC       	JR	KBD1J
  804                   ;_____________________________________________________________
  805                   ;							**17**
  806                   ; Eingabe einer Zeile mit Funktion aller Cursortasten,
  807                   ; Abschluss mit <ENTER> oder Abbruch <BRK>
  808                   
  809 F499  CD F3F0     INLIN:	CALL	INTB
  810 F49C  CD F3D5     	CALL	OCHR
  811 F49F  FE 03       	CP	3		; BRK?
  812 F4A1  37          	SCF
  813 F4A2  28 04       	JR	Z,INLI1
  814 F4A4  FE 0D       	CP	CR		; ENTER?
  815 F4A6  20 F1       	JR	NZ,INLIN
  816 F4A8  F5          INLI1:	PUSH	AF
  817 F4A9  CD F4DB     	CALL	CRLF		; PA: A=0
  818 F4AC  ED 5B B7A0  	LD	DE,(CURSO)
  819 F4B0  BA          	CP	D		; Zeile 1 durch PAGE-Mode?
  820 F4B1  20 04       	JR	NZ,INLI2
  821 F4B3  3A B79F     	LD	A,(WINLG+1)	; Anzahl Zeilen
  822 F4B6  57          	LD	D,A		; D muss dann in letzte Zeile zeigen
  823 F4B7  15          INLI2:	DEC	D		; Zeile drueber
  824 F4B8  E5          	PUSH	HL
  825 F4B9  CD E068     	CALL	DABR
  826 F4BC  EB          	EX	DE,HL
  827 F4BD  E1          	POP	HL		; PA: DE
  828 F4BE  F1          	POP	AF		; PA: CY=BRK
  829 F4BF  C9          NOOP:	RET
  830                   ;
  831                   ; Sprung zu einer Adresse mit Registeruebergabe
  832                   ; Syntax: %go ADR [HL] [DE] [BC] [A]
  833                   ;
  834 F4C0  7F7F        GO7F:	DW	7F7FH
  835 F4C2  67 6F       	DB	'go'
  836 F4C4  03          	DB	3		; mindestens 1 Argument erforderlich
  837 F4C5  E5          	PUSH	HL		; Adresse auf den Stack
  838 F4C6  EB          	EX	DE,HL		; ARG2 von DE nach HL
  839 F4C7  50          	LD	D,B
  840 F4C8  59          	LD	E,C		; ARG3 von BC nach DE
  841 F4C9  ED 4B B788  	LD	BC,(ARG4)	; ARG4 nach BC
  842 F4CD  3A B78A     	LD	A,(ARG5)
  843 F4D0  C9          	RET
  844                   ;_____________________________________________________________
  845                   ;							**19**
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 148
CF47    INC

  846                   ; ERROR anzeigen
  847                   
  848 F4D1  CD F0CF     ERRM:	CALL	OSTR
  849 F4D4  45 52 52 4F 	DB	'ERROR',7,0
  850                   ;_____________________________________________________________
  851                   ;							**2C**
  852                   ; Neue Zeile mit CR,LF
  853                   ; PA:	A=0
  854                   ; VR:	AF
  855                   ;
  856 F4DB  CD F0CF     CRLF:	CALL	OSTR
  857 F4DE  0D 0A 00    	DB	CR,LF,0
  858 F4E1  C9          	RET
  859                   ;_____________________________________________________________
  860                   ;							**1B**
  861                   ; Zwei 16-Bit-Werte hexadezimal anzeigen und
  862                   ; ein Leerzeichen danach
  863                   
  864 F4E2  CD F4E5     HLDE:	CALL	HLDE1		; 1x aufrufen, dann reinlaufen
  865 F4E5  CD F3B4     HLDE1:	CALL	HLHX		; HL anzeigen
  866 F4E8  EB          	EX	DE,HL		; HL <-> DE tauschen
  867 F4E9  C9          	RET
  868                   ;_____________________________________________________________
  869                   ;							**18**
  870                   ; Erfassung einer eingegebenen Hex-Zahl
  871                   ; PE:	DE	Adresse im VRAM
  872                   ; PA:	(NUMNX)	Anzahl der HEX-Zeichen (0-4)
  873                   ;	(NUMVX)	Wert der erfassten Zahl
  874                   ;	CY=1	Fehler
  875                   ;
  876 F4EA  13          RHEX0:	INC	DE
  877 F4EB  1A          RHEX:	LD	A,(DE)
  878 F4EC  FE 20       	CP	' '		; Trennzeichen
  879 F4EE  28 FA       	JR	Z,RHEX0		; uebergehen
  880 F4F0  AF          	XOR	A
  881 F4F1  21 B798     	LD	HL,NUMVX+1
  882 F4F4  77          	LD	(HL),A
  883 F4F5  2B          	DEC	HL		; HL=NUMVX
  884 F4F6  77          	LD	(HL),A
  885 F4F7  2B          	DEC	HL		; HL=NUMNX
  886 F4F8  77          	LD	(HL),A		; alles auf 0 setzen
  887                   ; Erfassen der ASCII-Zeichen
  888 F4F9  1A          RH1:	LD	A,(DE)
  889 F4FA  B7          	OR	A		; Ende-Dummy?
  890 F4FB  C8          	RET	Z
  891 F4FC  FE 20       	CP	' '		; Ende-Space?
  892 F4FE  C8          	RET	Z
  893 F4FF  D6 30       	SUB	'0'
  894 F501  D8          	RET	C
  895 F502  FE 0A       	CP	10
  896 F504  38 0B       	JR	C,RH2
  897 F506  D6 07       	SUB	7
  898 F508  E6 DF       	AND	11011111b	; klein -> gross
  899 F50A  FE 0A       	CP	10
  900 F50C  D8          	RET	C
  901 F50D  FE 10       	CP	16
  902 F50F  3F          	CCF
  903 F510  D8          	RET	C
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 149
CF47    INC

  904 F511  13          RH2:	INC	DE		; naechstes Zeichen
  905 F512  34          	INC	(HL)		; NUMNX erhoehen
  906 F513  23          	INC	HL
  907 F514  ED 6F       	RLD			; Tetrade
  908 F516  23          	INC	HL
  909 F517  ED 6F       	RLD			; durchschieben
  910 F519  2B          	DEC	HL
  911 F51A  2B          	DEC	HL
  912 F51B  28 DC       	JR	Z,RH1		; RLD setzt auch Z-Flag!
  913 F51D  1B          	DEC	DE
  914 F51E  37          	SCF			; Fehler: Zahl zu gross
  915 F51F  C9          	RET
  916                   ;_____________________________________________________________
  917                   ;							**22**
  918                   ; Bis zu 10 Argumente erfassen
  919                   ; PE:	DE	Adresse im VRAM
  920                   ; PA:	(ARGN) und (ARG1) bis (ARG9)
  921                   ;	CY=1	Fehler
  922                   ;
  923 F520  01 B781     GARG:	LD	BC,ARGN
  924 F523  AF          	XOR	A
  925 F524  02          	LD	(BC),A		; (ARGN)=0
  926 F525  CD F4EB     GARG1:	CALL	RHEX
  927 F528  D8          	RET	C		; Fehler
  928 F529  7E          	LD	A,(HL)
  929 F52A  B7          	OR	A		; Ende-Dummy?
  930 F52B  C8          	RET	Z
  931 F52C  23          	INC	HL
  932 F52D  03          	INC	BC
  933 F52E  7E          	LD	A,(HL)		; LOW(NUMVX)
  934 F52F  02          	LD	(BC),A		; LOW(ARG) eintragen
  935 F530  23          	INC	HL
  936 F531  03          	INC	BC
  937 F532  7E          	LD	A,(HL)		; HIGH(NUMVX)
  938 F533  02          	LD	(BC),A		; HIGH(ARG) eintragen
  939 F534  2E 81       	LD	L,LOW(ARGN)	; HL=ARGN
  940 F536  34          	INC	(HL)
  941 F537  7E          	LD	A,(HL)
  942 F538  C6 F5       	ADD	A,-11		; 10 Argumente?
  943 F53A  30 E9       	JR	NC,GARG1
  944 F53C  C9          	RET			; Fehler: zu viele Argumente
  945                   
  946                   ; Kleinbuchstaben in A in Grossbuchstaben umwandeln:
  947 F53D  FE 61       UPCASE:	CP	'a'
  948 F53F  D8          	RET	C
  949 F540  FE 7B       	CP	'z' + 1
  950 F542  D0          	RET	NC
  951 F543  E6 DF       	AND	11011111b
  952 F545  C9          	RET
  953                   
  954 F546  DD 36 05 00 KPUFF:	LD	(IX+5),LOW(CASS)
  955 F54A  DD 36 06 B7 	LD	(IX+6),HIGH(CASS)
  956 F54E  C9          	RET
  957                   ;_____________________________________________________________
  958                   ;							**43**
  959                   ; E/A-Kanal initialisieren
  960                   ; PE:	HL	Tabelle mit Initialisierungsdaten
  961                   ;		1. Byte: E/A-Adresse
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 150
CF47    INC

  962                   ;		2. Byte: Anzahl
  963                   ;		danach die Initialisierungsbytes
  964                   ; VR:	F, HL
  965                   
  966 F54F  C5          INIEA:	PUSH	BC
  967 F550  4E          	LD	C,(HL)		; erstes Byte: Portadresse
  968 F551  23          	INC	HL
  969 F552  46          	LD	B,(HL)		; zweites Byte: Anzahl
  970 F553  23          	INC	HL
  971 F554  ED B3       	OTIR			; ... Bytes
  972 F556  C1          	POP	BC
  973 F557  C9          	RET
  974                   ;
  975                   ; CAOS-interne Initialisierung meherer E/A-Kanaele ohne DI/EI
  976                   ; PE:	HL	Initialisierungsdaten mit vorangestelltem Byte fuer Anzahl
  977                   
  978 F558  56          INIMEX:	LD	D,(HL)		; Anzahl Kanaele
  979 F559  23          	INC	HL
  980 F55A  CD F54F     INIMX1:	CALL	INIEA
  981 F55D  15          	DEC	D
  982 F55E  20 FA       	JR	NZ,INIMX1
  983 F560  C9          	RET
  984                   ;_____________________________________________________________
  985                   ;							**44**
  986                   ; Initialisierung mehrerer E/A-Kanaele
  987                   ; PE:	HL	Tabelle mit Initialisierungsdaten
  988                   ;	D	Anzahl der Kanaele
  989                   ; VR:	F, D, HL
  990                   
  991 F561  F3          INIME:	DI
  992 F562  CD F55A     	CALL	INIMX1
  993 F565  FB          	EI
  994 F566  C9          	RET
  995                   ;
  996                   ; Dateiname abfragen
  997                   ; PA:	HL	Zeiger auf den eingegebenen Namen
  998                   ;	CY=1	mit BRK abgebrochen
  999                   ;
 1000 F567  21 0006     NAME:	LD	HL,6
 1001 F56A  CD F0CF     NAMHL:	CALL	OSTR
 1002 F56D  4E 61 6D 65 	DB	'Name :',0
 1003 F574  CD F499     	CALL	INLIN		; Dateiname abfragen
 1004 F577  D8          	RET	C		; BRK
 1005 F578  19          	ADD	HL,DE		; Beginn Name
 1006 F579  C9          	RET
 1007                   
 1008 F57A  7F7F        SAVE7F:	DW	7F7FH
 1009 F57C  53 41 56 45 	DB	'SAVE'
 1010 F580  05          	DB	5
 1011 F581  CD F567     	CALL	NAME		; Dateiname abfragen
 1012 F584  D8          	RET	C		; mit BRK abgebrochen
 1013                   ;_____________________________________________________________
 1014                   ;							**36**
 1015                   ; Datei speichern
 1016                   
 1017 F585  CD E4C0     SAVE:	CALL	CLC		; Kassettenpuffer loeschen
 1018                   ;	LD	DE,CASS		; DE wird von CLC uebergeben
 1019 F588  E5          	PUSH	HL		; Dateiname
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 151
CF47    INC

 1020 F589  01 000B     	LD	BC,11
 1021 F58C  ED B0       	LDIR			; Name in Puffer kopieren
 1022 F58E  AF          	XOR	A
 1023 F58F  12          	LD	(DE),A		; Ende-0 anhaengen
 1024 F590  21 B781     	LD	HL,ARGN		; alle Argumente inklusive ARGN
 1025 F593  1E 10       	LD	E,10H
 1026 F595  0E 15       	LD	C,15H
 1027 F597  ED B0       	LDIR			; in den Puffer kopieren
 1028 F599  CD F546     	CALL	KPUFF		; Standard-Puffer setzen
 1029 F59C  E1          	POP	HL		; Dateiname
 1030 F59D  CD E4C9     	CALL	PV7		; Vorblock ausgeben
 1031 F5A0  02          	DB	2		; ISRO
 1032 F5A1  D8          	RET	C		; Fehler
 1033 F5A2  2A B784     	LD	HL,(ARG2)	; Endadresse+1
 1034 F5A5  ED 5B B782  	LD	DE,(ARG1)	; Anfangsadresse
 1035 F5A9  A7          	AND	A
 1036 F5AA  ED 52       	SBC	HL,DE		; Anzahl Datenbytes
 1037 F5AC  E5          	push	hl		; Anzahl auf Stack 
 1038 F5AD  2A B782     SAV1:	LD	HL,(ARG1)	; Adresse fuer aktuellen Block
 1039 F5B0  11 B700     	LD	DE,CASS
 1040 F5B3  01 0080     	LD	BC,128
 1041 F5B6  3A B801     	LD	A,(MODST+1)
 1042 F5B9  E6 01       	AND	1
 1043 F5BB  20 0F       	JR	NZ,SAV3		; IRM ein
 1044 F5BD  41          	LD	B,C
 1045 F5BE  CD F03F     SAV2:	CALL	SCROFF
 1046 F5C1  7E          	LD	A,(HL)		; vom RAM
 1047 F5C2  CD F048     	CALL	SCRON
 1048 F5C5  12          	LD	(DE),A		; in den Puffer
 1049 F5C6  23          	INC	HL
 1050 F5C7  13          	INC	DE
 1051 F5C8  10 F4       	DJNZ	SAV2
 1052 F5CA  18 02       	JR	SAV4
 1053 F5CC  ED B0       SAV3:	LDIR			; kopieren
 1054 F5CE  22 B782     SAV4:	LD	(ARG1),HL	; Adresse fuer naechsten Block eintragen
 1055 F5D1  E1          	pop	hl		; Anzahl
 1056 F5D2  CD F0CF     	CALL	OSTR
 1057 F5D5  02 00       	DB	2,0		; CLLN
 1058 F5D7  CD F0C9     	CALL	BNROST		; Blocknummer ausgeben
 1059 F5DA  00          	DB	0
 1060 F5DB  CD E37C     	CALL	BRKT
 1061 F5DE  01 00A0     	LD	BC,160		; kurzer Vorton
 1062 F5E1  38 11       	JR	C,SAV5		; BRK -> Datei schliessen
 1063 F5E3  11 0080     	ld	de,128		; Blocklaenge
 1064 F5E6  ED 52       	sbc	hl,de		; Ende erreicht?
 1065 F5E8  28 0A       	jr	z,SAV5		; ja, genau das Blockende
 1066 F5EA  38 08       	jr	c,SAV5		; ja, letzter Block mit weniger Bytes
 1067 F5EC  E5          	push	hl		; restliche Anzahl
 1068 F5ED  CD E4C9     	CALL	PV7		; Datenblock ausgeben
 1069 F5F0  00          	DB	0		; MBO
 1070 F5F1  30 BA       	JR	NC,SAV1		; kein Fehler
 1071 F5F3  E1          	pop	hl		; restliche Byte-Anzahl vom Stack nehmen
 1072                   	;
 1073 F5F4  CD E4C9     SAV5:	CALL	PV7		; Ausgabe Endeblock 0FFH
 1074 F5F7  03          	DB	3		; CSRO
 1075 F5F8  CD E4C0     	CALL	CLC		; CAOS 4.6: Puffer loeschen nicht mehr in CSRO
 1076 F5FB  CD F4DB     	CALL	CRLF		; CAOS 4.6: Zeilenvorschub nicht mehr in CSRO
 1077 F5FE  C9          	RET
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 152
CF47    INC

 1078                   ;_____________________________________________________________
 1079                   ;							**15**
 1080                   ; Laden der Argumente in Register
 1081                   ; PA:	HL, DE, BC, A mit Daten der Argumente
 1082                   ;
 1083 F5FF  ED 4B B786  LARG:	LD	BC,(ARG3)
 1084 F603  ED 5B B784  	LD	DE,(ARG2)
 1085 F607  2A B782     	LD	HL,(ARG1)
 1086 F60A  3A B781     	LD	A,(ARGN)
 1087 F60D  C9          	RET
 1088                   
 1089                   ; Lesen eines Blockes mit Ausschrift Blocknummer bzw. Name
 1090                   ;
 1091                   ; PE:	(IX+3)	zu lesender Block
 1092                   ; VR:	AF,BC	(Block<>1) ( 00>  )
 1093                   ;	AF,BC,HL (Block=1) ( Name )
 1094                   ; PA:	CY=1	BRK gedrueckt nach Lesefehler oder Fehler bei Device nicht TAPE
 1095                   
 1096 F60E  DD 34 03    RDBLK:	INC	(IX+3)		; erwarteter Block
 1097 F611  CD E4C9     LUP1:	CALL	PV7
 1098 F614  01          	DB	1		; MBI
 1099 F615  30 25       LUP2:	JR	NC,LUP3		; kein Fehler aufgetreten
 1100                   
 1101 F617  CD ED97     	CALL	DEV1		; Kassette?
 1102 F61A  37          	SCF			; Fehlerflag wieder setzen
 1103 F61B  C0          	RET	NZ		; Abbruch bei Fehler wenn kein TAPE
 1104                   
 1105 F61C  CD F0CF     	CALL	OSTR		; bei Kassette nach Wiederholung fragen:
 1106 F61F  09 09 09 20 	DB	9,9,9,' ',0
 1107 F624  CD F0C9     	CALL	BNROST
 1108 F627  20 3F       	DB	' ?'		; Pruefsumme fehlerhaft
 1109 F629  1E 00       	DB	1EH,0
 1110 F62B  DD 7E 03    	LD	A,(IX+3)
 1111 F62E  3D          	DEC	A		; Vorblock mit Nr. 01 erwartet?
 1112 F62F  28 E0       	JR	Z,LUP1		; dann weiter versuchen...
 1113 F631  CD F3F6     	CALL	KBD		; Tastaturabfrage
 1114 F634  FE 03       	CP	3		; BRK?
 1115 F636  37          	SCF
 1116 F637  C8          	RET	Z
 1117 F638  FE 0A       	CP	LF		; CUD? (fehlerhaften Block uebernehmen?)
 1118 F63A  20 D5       	JR	NZ,LUP1
 1119 F63C  DD 7E 02    LUP3:	LD	A,(IX+2)	; gelesener Block
 1120 F63F  DD 46 03    	LD	B,(IX+3)	; zu lesender Block
 1121 F642  05          	DEC	B		; Block 01?
 1122 F643  28 17       	JR	Z,LUP6		; Block 1 soll gelesen werden
 1123 F645  04          	INC	B
 1124 F646  B8          	CP	B		; richtige Blocknummer?
 1125 F647  28 0B       	JR	Z,LUP5
 1126 F649  3C          	INC	A		; Block FF?
 1127 F64A  28 08       	JR	Z,LUP5		; Endeblock immer als richtig werten
 1128 F64C  CD F0C9     LUP4:	CALL	BNROST
 1129 F64F  2A 19 00    	DB	'*',19H,0	; falsche Blocknummer
 1130 F652  18 BD       	JR	LUP1		; weiter versuchen
 1131                   	;
 1132 F654  CD F0C9     LUP5:	CALL	BNROST
 1133 F657  3E 20 19 00 	DB	'> ',19H,0	; korrekter Block
 1134 F65B  C9          	RET
 1135                   	;
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 153
CF47    INC

 1136 F65C  3D          LUP6:	DEC	A		; Block 01?
 1137 F65D  20 ED       	JR	NZ,LUP4		; nein -> falsche Blocknummer anzeigen
 1138                   
 1139 F65F  21 B700     	LD	HL,CASS		; Dateiname in Kassettenpuffer
 1140 F662  06 0B       	LD	B,11
 1141 F664  7E          LUP7:	LD	A,(HL)		; auf gueltige Zeichen testen
 1142 F665  B7          	OR	A
 1143 F666  28 10       	JR	Z,LUP8		; 00h ist OK
 1144 F668  FE 20       	CP	20h
 1145 F66A  38 20       	JR	C,LUP10		; <20h also raus
 1146 F66C  FE 7F       	CP	7Fh
 1147 F66E  38 08       	JR	C,LUP8		; 20h..7Eh ist OK
 1148 F670  FE D3       	CP	0D3h
 1149 F672  38 18       	JR	C,LUP10		; 7Fh..D2h raus
 1150 F674  FE D6       	CP	0D6h		; (D3..D5 sind BASIC-Dateitypen)
 1151 F676  30 14       	JR	NC,LUP10	; >D5h also raus
 1152 F678  2C          LUP8:	INC	L
 1153 F679  10 E9       	DJNZ	LUP7
 1154 F67B  2E 00       	LD	L,0		; wieder zurueck auf Anfang Kassettenpuffer
 1155 F67D  06 0B       	LD	B,11
 1156 F67F  7E          LUP9:	LD	A,(HL)		; aus Kassettenpuffer anzeigen
 1157 F680  E6 7F       	AND	7Fh		; hohe Zeichen fuer BASIC-Dateiname
 1158 F682  23          	INC	HL
 1159 F683  B7          	OR	A
 1160 F684  C4 E08C     	CALL	NZ,CRT		; nur echte Zeichen anzeigen
 1161 F687  10 F6       	DJNZ	LUP9
 1162 F689  CD F3BC     	CALL	SPACE		; Leerzeichen zwischen Dateiname + Adressen
 1163 F68C  A7          LUP10:	AND	A		; kein Fehler
 1164 F68D  C9          	RET
 1165                   
 1166 F68E  CD F0CF     NOMC:	CALL	OSTR
 1167 F691  4B 65 69 6E 	DB	'Keine MC-Datei!',0
 1168 F6A1  CD E58F     CLJP:	CALL	CSRI		; Datei schliessen
 1169 F6A4  37          	SCF			; Fehlerflag setzen
 1170 F6A5  C9          	RET
 1171                   
 1172 F6A6  7F7F        VERI7F:	DW	7F7FH
 1173 F6A8  56 45 52 49 	DB	'VERIFY',1
 1174                   ;_____________________________________________________________
 1175                   ;							**11**
 1176                   ; Kassettendatei kontrollieren
 1177                   
 1178 F6AF  CD ED97     VERIF:	CALL	DEV1		; Kassette?
 1179 F6B2  C0          	RET	NZ		; nur bei TAPE sinnvoll
 1180 F6B3  DD 77 07    	LD	(IX+7),A	; A=0
 1181 F6B6  18 1D       	JR	LOAD1
 1182                   
 1183 F6B8  7F7F        LOAD7F:	DW	7F7FH
 1184 F6BA  4C 4F 41 44 	DB	'LOAD',1
 1185 F6BF  CD ED97     	CALL	DEV1		; Kassette?
 1186 F6C2  C4 F567     	CALL	NZ,NAME		; Dateiname abfragen falls nicht TAPE
 1187 F6C5  D8          	RET	C		; mit BRK abgebrochen
 1188                   ;_____________________________________________________________
 1189                   ;							**10**
 1190                   ; Datei einlesen
 1191                   
 1192 F6C6  DD 36 07 01 LOAD:	LD	(IX+7),1	; Daten lesen
 1193 F6CA  3A B781     	LD	A,(ARGN)
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 154
CF47    INC

 1194 F6CD  FE 02       	CP	2
 1195 F6CF  38 04       	JR	C,LOAD1		; Autostart?
 1196 F6D1  DD CB 07 CE 	SET	1,(IX+7)	; unterdruecken
 1197 F6D5  CD F546     LOAD1:	CALL	KPUFF		; Standardpuffer setzen
 1198 F6D8  CD E4C9     	CALL	PV7		; HL = Dateiname
 1199 F6DB  04          	DB	4		; ISRI (Vorblock einlesen)
 1200 F6DC  30 05       	JR	NC,LOAD0	; kein Fehler aufgetreten
 1201 F6DE  CD ED97     	CALL	DEV1		; Kassette?
 1202 F6E1  37          	SCF			; Fehlerflag setzen
 1203 F6E2  C0          	RET	NZ		; Abbruch wenn nicht Kassette
 1204 F6E3  CD F615     LOAD0:	CALL	LUP2		; Blockinhalt auswerten (Name anzeigen usw.)
 1205 F6E6  38 B9       LOAD2:	JR	C,CLJP		; BRK -> CSRI -> Fehler
 1206 F6E8  DD CB 07 46 	BIT	0,(IX+7)
 1207 F6EC  28 4D       	JR	Z,LOAD5		; Verify
 1208 F6EE  2E 10       	LD	L,10H
 1209 F6F0  7E          	LD	A,(HL)		; Anzahl der Argumente beim Abspeichern
 1210 F6F1  07          	RLCA
 1211 F6F2  07          	RLCA			; nach Bits 2..4
 1212 F6F3  DD AE 07    	XOR	(IX+7)
 1213 F6F6  E6 1C       	AND	00011100b	; Bits 0..1 und 5..7 zuruecksetzen
 1214 F6F8  DD AE 07    	XOR	(IX+7)		; a = (a XOR b) XOR b fuer Bits 2..4
 1215 F6FB  DD 77 07    	LD	(IX+7),A	; in IX+7 merken fuer spaetere Auswertung
 1216 F6FE  7E          	LD	A,(HL)		; Anzahl der Argumente
 1217 F6FF  D6 02       	SUB	2
 1218 F701  FE 09       	CP	9		; MC?
 1219 F703  30 89       	JR	NC,NOMC		; Fehler: kein gueltiger CAOS-Vorblock
 1220 F705  2A B715     	LD	HL,(CASS+15H)	; SADR
 1221 F708  E5          	PUSH	HL
 1222 F709  ED 5B B713  	LD	DE,(CASS+13H)	; EADR+1
 1223 F70D  2A B711     	LD	HL,(CASS+11H)	; AADR
 1224 F710  3A B781     	LD	A,(ARGN)
 1225 F713  A7          	AND	A		; Ladeoffset?
 1226 F714  28 11       	JR	Z,LOAD3		; nein
 1227 F716  ED 4B B782  	LD	BC,(ARG1)	; Offset
 1228 F71A  09          	ADD	HL,BC		; Anfangsadresse und Endadresse
 1229 F71B  EB          	EX	DE,HL		; umrechnen
 1230 F71C  09          	ADD	HL,BC
 1231 F71D  EB          	EX	DE,HL
 1232 F71E  DD CB 07 66 	BIT	4,(IX+7)	; 4 bis 7 Argumente?
 1233 F722  20 03       	JR	NZ,LOAD3
 1234 F724  E3          	EX	(SP),HL
 1235 F725  09          	ADD	HL,BC		; Startadresse auch umrechnen
 1236 F726  E3          	EX	(SP),HL
 1237 F727  CD F4E2     LOAD3:	CALL	HLDE		; Anfangsadresse und Endadresse anzeigen
 1238 F72A  3A B710     	LD	A,(CASS+10H)
 1239 F72D  FE 03       	CP	3
 1240 F72F  38 05       	JR	C,LOAD4		; keine Startadresse
 1241 F731  E3          	EX	(SP),HL
 1242 F732  CD F3B4     	CALL	HLHX		; Startadresse anzeigen
 1243 F735  E3          	EX	(SP),HL
 1244 F736  C1          LOAD4:	POP	BC		; Startadresse merken
 1245 F737  ED 43 B786  	LD	(ARG3),BC
 1246 F73B  CD F4DB     LOAD5:	CALL	CRLF		; Zeilenvorschub nach Dateiname + Adressen
 1247 F73E  EB          	EX	DE,HL		; DE = Ladeadresse
 1248                   ; Load-Hauptschleife
 1249 F73F  CD F60E     LOAD6:	CALL	RDBLK		; 128-Byte-Block einlesen
 1250 F742  38 A2       	JR	C,LOAD2		; BRK -> CSRI -> Fehler melden
 1251 F744  DD CB 07 46 	BIT	0,(IX+7)
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 155
CF47    INC

 1252 F748  28 25       	JR	Z,LOAD11	; Verify
 1253 F74A  E5          	PUSH	HL		; Endadresse
 1254 F74B  ED 52       	SBC	HL,DE		; noch zu lesende Bytes
 1255 F74D  01 0080     	LD	BC,128		; Blockgroesse 128 Byte
 1256 F750  ED 42       	SBC	HL,BC		; voller Block?
 1257 F752  09          	ADD	HL,BC
 1258 F753  30 01       	JR	NC,LOAD7	; ja
 1259 F755  4D          	LD	C,L		; restliche Anzahl
 1260 F756  21 B700     LOAD7:	LD	HL,CASS		; Standard-Kassettenpuffer
 1261 F759  3A B801     	LD	A,(MODST+1)
 1262 F75C  E6 01       	AND	1
 1263 F75E  20 16       	JR	NZ,LOAD9	; IRM ist ein
 1264 F760  41          	LD	B,C
 1265 F761  7E          LOAD8:	LD	A,(HL)		; Byteweise aus dem Puffer
 1266 F762  CD F03F     	CALL	SCROFF
 1267 F765  12          	LD	(DE),A		; in den RAM kopieren
 1268 F766  23          	INC	HL
 1269 F767  13          	INC	DE
 1270 F768  CD F048     	CALL	SCRON
 1271 F76B  10 F4       	DJNZ	LOAD8
 1272 F76D  18 09       	JR	LOAD10
 1273                   ;
 1274                   ; CAOS 4.7:
 1275                   ; Bei VERIFY wird mit Blocknummer FF der Vergleich beendet
 1276                   ;
 1277 F76F  DD 34 02    LOAD11:	INC	(IX+2)		; Blocknummer FF?
 1278 F772  28 0A       	JR	Z,LOAD12	; ja, bei VERIFY Einlesen beenden
 1279 F774  18 C9       	JR	LOAD6
 1280                   	;
 1281 F776  ED B0       LOAD9:	LDIR			; gelesenen Block kopieren
 1282 F778  E1          LOAD10:	POP	HL
 1283 F779  ED 52       	SBC	HL,DE		; Endadresse erreicht?
 1284 F77B  19          	ADD	HL,DE		; EADR regenerieren (Z-Flag bleibt erhalten)
 1285                   ;
 1286                   ; CAOS 4.6:
 1287                   ; Damit das Einlesen auch bei Diskette funktioniert, muss zusaetzlich oder
 1288                   ; ausschliesslich (?) der Adressvergleich stattfinden! Da hier nur MC-Dateien
 1289                   ; gelesen werden, ist eigentlich keine Abfrage auf Blocknr. FF erforderlich
 1290                   ;
 1291 F77C  20 C1       	JR	NZ,LOAD6
 1292 F77E  CD E4C0     LOAD12:	CALL	CLC		; CAOS 4.6: Puffer loeschen nicht mehr in CSRI
 1293 F781  CD F4DB     	CALL	CRLF		; CAOS 4.6: Zeilenvorschub nicht mehr in CSRI
 1294                   	;
 1295 F784  CD E4C9     	CALL	PV7		; Datei schliessen
 1296 F787  05          	DB	5		; CSRI
 1297 F788  D8          	RET	C		; Fehler
 1298 F789  DD 7E 07    	LD	A,(IX+7)
 1299 F78C  E6 03       	AND	3
 1300 F78E  3D          	DEC	A
 1301 F78F  C0          	RET	NZ		; kein Start oder Verify
 1302 F790  DD 7E 07    	LD	A,(IX+7)
 1303 F793  E6 1C       	AND	1CH
 1304 F795  FE 0C       	CP	0CH
 1305 F797  DD 36 07 00 	LD	(IX+7),0	; Befehl fehlte in CAOS 4.3!
 1306 F79B  3F          	CCF			; kein Fehler
 1307 F79C  D0          	RET	NC		; keine Startadresse
 1308 F79D  2A B786     	LD	HL,(ARG3)	; Startadresse
 1309 F7A0  E9          	JP	(HL)		; anspringen
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 156
CF47    INC

 1310                   
 1311 F7A1  7F7F        	DW	7F7FH
 1312 F7A3  43 4F 4C 4F 	DB	'COLOR'
 1313 F7A8  01          	DB	1
 1314 F7A9  CD FB8F     	CALL	CON
 1315 F7AC  C3 C566     	JP	COLRC
 1316                   ;_____________________________________________________________
 1317                   ;							**0F**
 1318 F7AF  CD FB8F     COLR:	CALL	CON
 1319 F7B2  C3 C580     	JP	SETCO
 1320                   ;_____________________________________________________________
 1321                   ;							**42**
 1322 F7B5  E5          CSTBT:	PUSH	HL
 1323 F7B6  21 B7A2     	LD	HL,STBT
 1324 F7B9  CB DE       	SET	3,(HL)
 1325 F7BB  CD F3D5     	CALL	OCHR		; Steuerzeichen darstellen
 1326 F7BE  CB 9E       	RES	3,(HL)
 1327 F7C0  E1          	POP	HL
 1328 F7C1  C9          	RET
 1329                   
 1330 F7C2  7F7F        	DW	7F7FH
 1331 F7C4  44 49 53 50 	DB	'DISPLAY'
 1332 F7CB  03          	DB	3
 1333                   ;_____________________________________________________________
 1334                   ;							**3B**
 1335 F7CC  CD FB8F     DISP:	CALL	CON
 1336 F7CF  CD C7FD     	CALL	DISPC
 1337 F7D2  18 0F       	JR	JCOFF
 1338                   
 1339 F7D4  7F7F        	DW	7F7FH
 1340 F7D6  4D 4F 44 49 	DB	'MODIFY'
 1341 F7DC  03          	DB	3
 1342                   ;_____________________________________________________________
 1343                   ;							**2E**
 1344 F7DD  CD FB8F     MODI:	CALL	CON
 1345 F7E0  CD C82E     	CALL	MODIC
 1346 F7E3  C3 FB9C     JCOFF:	JP	COFF
 1347                   
 1348 F7E6  7F7F        WIND7F:	DW	7F7FH
 1349 F7E8  57 49 4E 44 	DB	'WINDOW'
 1350 F7EE  01          	DB	1
 1351 F7EF  CD FB8F     	CALL	CON
 1352 F7F2  CD C59B     	CALL	WINDC
 1353 F7F5  18 EC       	JR	JCOFF
 1354                   ;_____________________________________________________________
 1355                   ;							**3C**
 1356                   ; PE:	A	Fensternummer 0..9
 1357                   ;	HL	Fensteranfang
 1358                   ;	DE	Fenstrergroesse
 1359                   ; PA:	CY=1	Fehler
 1360                   ; VR:	AF, BC, DE, HL
 1361                   ;
 1362 F7F7  CD FB8F     WININ:	CALL	CON
 1363 F7FA  CD C5FA     	CALL	WININC
 1364 F7FD  18 E4       	JR	JCOFF
 1365                   ;_____________________________________________________________
 1366                   ;							**3D**
 1367                   ; PE:	A	Fensternummer 0..9
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 157
CF47    INC

 1368                   ; PA:	CY=1	Fehler
 1369                   ; VR:	AF, BC, DE, HL
 1370                   ;
 1371 F7FF  CD FB8F     WINAK:	CALL	CON
 1372 F802  CD C5CA     	CALL	WINAKC
 1373 F805  18 DC       	JR	JCOFF
 1374                   ;
 1375 F807  7F7F        KEY7F:	DW	7F7FH
 1376 F809  4B 45 59    	DB	'KEY'
 1377 F80C  01          	DB	1
 1378 F80D  FE 01       	CP	1
 1379 F80F  30 08       	JR	NC,KEYL
 1380                   ;_____________________________________________________________
 1381                   ;							**3A**
 1382 F811  CD FB8F     KEYLI:	CALL	CON
 1383 F814  CD C51C     	CALL	KEYLIC		; Keylist
 1384 F817  18 CA       	JR	JCOFF
 1385                   
 1386 F819  7D          KEYL:	LD	A,L		; Nummer
 1387                   ;_____________________________________________________________
 1388                   ;							**39**
 1389 F81A  CD FB8F     KEY:	CALL	CON
 1390 F81D  CD C470     	CALL	KEYC		; Taste belegen
 1391 F820  18 C1       	JR	JCOFF
 1392                   ;_____________________________________________________________
 1393                   ;							**25**
 1394                   ; Cursor komplementieren
 1395                   
 1396 F822  D5          CUCP:	PUSH	DE
 1397 F823  F5          	PUSH	AF
 1398 F824  E5          	PUSH	HL
 1399 F825  CD E03E     	CALL	PADR0		; Adresse im VRAM berechnen
 1400 F828  38 22       	JR	C,CUCP3		; ausserhalb
 1401 F82A  E5          	PUSH	HL
 1402 F82B  CD E068     	CALL	DABR
 1403 F82E  7E          	LD	A,(HL)
 1404 F82F  E1          	POP	HL
 1405 F830  A7          	AND	A		; Dummy?
 1406 F831  20 0A       	JR	NZ,CUCP1
 1407 F833  3E 06       	LD	A,6		; vorletzte
 1408 F835  B5          	OR	L		; Cursorzeile
 1409 F836  6F          	LD	L,A
 1410 F837  7E          	LD	A,(HL)
 1411 F838  EE 7F       	XOR	7FH		; Strichcursor
 1412 F83A  77          	LD	(HL),A
 1413 F83B  18 0F       	JR	CUCP3
 1414                   	;
 1415 F83D  C5          CUCP1:	PUSH	BC
 1416 F83E  ED 5B B7EE  	LD	DE,(CUMUST)	; Muster
 1417 F842  06 08       	LD	B,8		; Zeichenhoehe
 1418 F844  1A          CUCP2:	LD	A,(DE)
 1419 F845  AE          	XOR	(HL)		; verknuepfen
 1420 F846  77          	LD	(HL),A
 1421 F847  13          	INC	DE
 1422 F848  2C          	INC	L
 1423 F849  10 F9       	DJNZ	CUCP2		; 8-mal
 1424 F84B  C1          	POP	BC
 1425 F84C  E1          CUCP3:	POP	HL
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 158
CF47    INC

 1426 F84D  F1          	POP	AF
 1427 F84E  D1          	POP	DE
 1428 F84F  C9          	RET
 1429                   ;_____________________________________________________________
 1430                   ;							**30**
 1431                   ; Punkt setzen
 1432                   ; PE:	(HOR)	Horizontalkoordinate
 1433                   ;	(VERT)	Vertikalkoordinate
 1434                   ;	(FARB)	Bildpunktfarbe
 1435                   ; PA:	CY=1	Punkt auaerhalb (Fehler)
 1436                   ; VR:	AF
 1437                   ;
 1438 F850  CD FB8F     PUSE:	CALL	CON
 1439 F853  CD C774     	CALL	PUSEC		; Punkt setzen
 1440 F856  18 16       	JR	COF
 1441                   ;_____________________________________________________________
 1442                   ;							**2F**
 1443                   ; Punkt loeschen
 1444                   ; PE:	(HOR)	Horizontalkoordinate
 1445                   ;	(VERT)	Vertikalkoordinate
 1446                   ;	(FARB)	Bildpunktfarbe
 1447                   ; PA:	CY=1	Punkt auaerhalb (Fehler)
 1448                   ;	Z=1	Punkt war nicht gesetzt
 1449                   ;	A	Farbbyte
 1450                   ; VR:	AF
 1451                   ;
 1452 F858  CD FB8F     PUDE:	CALL	CON
 1453 F85B  CD C77F     	CALL	PUDEC		; Punkt loeschen
 1454 F85E  18 0E       	JR	COF
 1455                   ;_____________________________________________________________
 1456                   ;							**3F**
 1457                   ; Kreis zeichnen
 1458                   ; PE:	(ARG1)	X-Koordinate Mittelpunkt
 1459                   ;	(ARG2)	Y-Koordinate Mittelpunkt
 1460                   ;	(ARG3)	Radius
 1461                   ;	(FARB)	Farbe des Kreises
 1462                   ; PA:	-
 1463                   ; VR:	AF, BC, DE, HL, BC', DE', HL'
 1464                   
 1465 F860  CD FB8F     CIRCL:	CALL	CON
 1466 F863  CD C6AD     	CALL	CIRCLC		; Kreis
 1467 F866  18 06       	JR	COF
 1468                   ;_____________________________________________________________
 1469                   ;							**3E**
 1470                   ; Linie zeichnen
 1471                   ; PE:	(ARG1)	X-Koordinate-Anfang
 1472                   ;	(ARG2)	Y-Koordinate-Anfang
 1473                   ;	(ARG3)	X-Koordinate-Ende
 1474                   ;	(ARG4)	Y-Koordinate-Ende
 1475                   ;	(FARB)	Farbe der Linie
 1476                   ; PA:	-
 1477                   ; VR:	AF, BC, DE, HL, AF', BC', DE', HL'
 1478                   
 1479 F868  CD FB8F     LINE:	CALL	CON
 1480 F86B  CD C630     	CALL	LINEC		; Linie
 1481 F86E  C3 FB9C     COF:	JP	COFF
 1482                   ;_____________________________________________________________
 1483                   ;							**37**
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 159
CF47    INC

 1484                   ; Byteweise Eingabe:
 1485                   
 1486 F871  CD FB8F     MBIN:	CALL	CON		; CAOS-ROM C ein
 1487 F874  CD CD79     	CALL	MBIC		; Byte einlesen
 1488 F877  18 06       	JR	MBERR
 1489                   ;_____________________________________________________________
 1490                   ;							**38**
 1491                   ; Byteweise Ausgabe:
 1492                   
 1493 F879  CD FB8F     MBOUT:	CALL	CON		; CAOS-ROM C ein
 1494 F87C  CD CCE3     	CALL	MBOC		; Byte ausgeben
 1495 F87F  CD FB9C     MBERR:	CALL	COFF		; CAOS-ROM C aus
 1496 F882  D0          	RET	NC		; kein Fehler
 1497                   ;	JP	JIOERR		; Sprung zu Fehlerroutine in BASIC-ROM
 1498                   
 1499                   ; BASIC: Sprung zu ?IO ERROR
 1500                   ;JIOERR:	CALL	COFF
 1501 F883  2A B7C9     BD2:	LD	HL,(IOERR)	; Adresse aus IRM holen
 1502 F886  CD F0A0     	CALL	IRMOF		; IRM aus
 1503 F889  E9          	JP	(HL)		; Sprung in BASIC-ROM
 1504                   
 1505                   ; BASIC-I/O-Verteiler
 1506                   ; PE:	E	Steuerbyte
 1507                   ;	Bit 0..2 Kanalauswahl
 1508                   ;		00 = Eingabe Kanal 0 = Tastatur
 1509                   ;		01 = Ausgabe Kanal 0 = Bildschirm
 1510                   ;		02 = Eingabe Kanal 1 = Kassette
 1511                   ;		03 = Ausgabe Kanal 1 = Kassette
 1512                   ;		04 = Eingabe Kanal 2 = Anwenderkanal 1
 1513                   ;		05 = Ausgabe Kanal 2 = Anwenderkanal 1
 1514                   ;		06 = Eingabe Kanal 3 = Anwenderkanal 2
 1515                   ;		07 = Ausgabe Kanal 3 = Anwenderkanal 2
 1516                   ;	Bit 3	Init = Datei oeffnen
 1517                   ;	Bit 4	BIT8
 1518                   ;	Bit 5	Ruecksprung zu CAOS (BYE)
 1519                   ;	Bit 6	Close = Datei schliessen
 1520                   ;	Bit 7	Abfrage Tastaturstatus
 1521                   ;	HL	Zeiger, bei Init beginnt Dateiname 2 Byte danach
 1522                   ;	A	Datenbyte bei Ausgabe
 1523                   ; PA:	A	Datenbyte bei Eingabe
 1524                   
 1525 F88A  E5          BASPV:	PUSH	HL
 1526 F88B  C5          	PUSH	BC
 1527 F88C  CD F083     	CALL	IRMON
 1528 F88F  CB 6B       	BIT	5,E
 1529 F891  20 59       	JR	NZ,BASBYE	; BYE
 1530 F893  D5          	PUSH	DE		; E = Steuerbyte
 1531 F894  23          	INC	HL
 1532 F895  23          	INC	HL
 1533 F896  CB 7B       	BIT	7,E
 1534 F898  20 47       	JR	NZ,BSA2		; Tastaturstatus
 1535 F89A  E5          	PUSH	HL
 1536 F89B  7B          	LD	A,E		; Kanalnummer
 1537 F89C  E6 07       	AND	7		; 0-3
 1538 F89E  21 FDF0     	LD	HL,BUPTAB	; Tabelle der Unterprogramme
 1539 F8A1  85          	ADD	A,L
 1540 F8A2  6F          	LD	L,A
 1541 F8A3  7A          	LD	A,D		; Parameter
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 160
CF47    INC

 1542 F8A4  53          	LD	D,E		; Steuerbyte
 1543 F8A5  5E          	LD	E,(HL)		; UP-Nummer
 1544 F8A6  E1          	POP	HL		; Dateiname
 1545 F8A7  CD F06D     	CALL	PV3		; Aufruf (UP-Nr. in E)
 1546 F8AA  D1          	POP	DE		; E = Steuerbyte
 1547 F8AB  57          	LD	D,A		; D = Ausgabeparameter
 1548 F8AC  7B          	LD	A,E		; Steuerbyte
 1549 F8AD  E6 4F       	AND	4FH		; Kanalnummer und Close-Bit ausfiltern
 1550 F8AF  EE 43       	XOR	43H		; Close bei Kassettenausgabe?
 1551 F8B1  20 25       	JR	NZ,BSA1
 1552 F8B3  CD ED97     	CALL	DEV1		; DEVICE=Kassette?
 1553 F8B6  20 20       	JR	NZ,BSA1		; VERIFY nur bei TAPE ausfuehren
 1554 F8B8  CD F0CF     	CALL	OSTR
 1555 F8BB  56 45 52 49 	DB	'VERIFY ?(Y):',0
 1556 F8C8  CD F3F6     	CALL	KBD
 1557 F8CB  CD F7B5     	CALL	CSTBT		; anzeigen, was eingegeben wurde
 1558 F8CE  F5          	PUSH	AF
 1559 F8CF  CD F4DB     	CALL	CRLF		; auf neue Zeile wechseln
 1560 F8D2  F1          	POP	AF
 1561 F8D3  FE 59       	CP	'Y'
 1562 F8D5  CC F6AF     	CALL	Z,VERIF		; bei "Y" VERIFY ausfuehren
 1563 F8D8  7A          BSA1:	LD	A,D		; Ausgabeparameter
 1564 F8D9  CB 9B       	RES	3,E		; Init ruecksetzen
 1565 F8DB  CD F0A0     	CALL	IRMOF
 1566 F8DE  C1          	POP	BC
 1567 F8DF  E1          	POP	HL
 1568 F8E0  C9          	RET
 1569                   
 1570 F8E1  CD E368     BSA2:	CALL	KBDS		; Tastaturabfrage
 1571 F8E4  D1          	POP	DE
 1572 F8E5  57          	LD	D,A		; Zeichencode in D zurueck geben
 1573 F8E6  30 F0       	JR	NC,BSA1		; keine Taste gedrueckt
 1574 F8E8  CB BB       	RES	7,E		; Rueckmeldung, dass Taste gedrueckt wurde
 1575 F8EA  18 EC       	JR	BSA1
 1576                   
 1577 F8EC  3A 035E     BASBYE:	LD	A,(DATFLG)	; geschuetzt?
 1578 F8EF  A7          	AND	A
 1579 F8F0  28 09       	JR	Z,BASB1
 1580 F8F2  CD F0A0     	CALL	IRMOF
 1581 F8F5  CD C641     	CALL	NEW1		; NEW
 1582 F8F8  CD F083     	CALL	IRMON
 1583 F8FB  16 00       BASB1:	LD	D,0
 1584 F8FD  CD F100     	CALL	MODUL2		; BASIC-ROM abschalten
 1585 F900  C3 F269     	JP	LOOP
 1586                   
 1587 F903  CD F3D5     ZKOUT0:	CALL	OCHR
 1588                   ;_____________________________________________________________
 1589                   ;							**45**
 1590 F906  7E          ZKOUT:	LD	A,(HL)
 1591 F907  23          	INC	HL
 1592 F908  A7          	AND	A
 1593 F909  20 F8       	JR	NZ,ZKOUT0
 1594 F90B  C9          	RET
 1595                   ;_____________________________________________________________
 1596                   ;							**35**
 1597                   ; Tonausgabe
 1598                   ;
 1599                   ; (ARG1) => HL	L = Tonhoehe 1 (ZK fuer CTC 0, 0=kein Ton)
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 161
CF47    INC

 1600                   ;		H = Vorteiler 1 (0, 1)
 1601                   ; (ARG2) => DE	E = Tonhoehe 2 (ZK fuer CTC 1, 0=kein Ton)
 1602                   ;		D = Vorteiler 2 (0, 1)
 1603                   ; (ARG3) => BC	C = Lautstaerke (0 ... 1FH)
 1604                   ;		B = Tondauer (0 ... FFH) (in 20 ms-Schritten)
 1605                   ;		    bzw. 0 = Dauerton)
 1606                   
 1607 F90C  CD F5FF     TON:	CALL	LARG		; Argumente laden
 1608 F90F  DD CB 08 4E TON1:	BIT	1,(IX+8)	; noch alter Ton?
 1609 F913  20 FA       	JR	NZ,TON1		; warten
 1610 F915  79          TON2:	LD	A,C		; Lautstaerke
 1611 F916  E6 1E       	AND	00011110b	; maskieren
 1612 F918  EE 9F       	XOR	10011111b	; Komplement da nullaktiv
 1613 F91A  4F          	LD	C,A
 1614 F91B  78          	LD	A,B
 1615 F91C  A7          	AND	A		; Dauerton?
 1616 F91D  F3          	DI
 1617 F91E  28 0D       	JR	Z,TON3		; ja, keine CTC starten
 1618 F920  CB B9       	RES	7,C		; nein, Blinken aus
 1619 F922  DD CB 08 CE 	SET	1,(IX+8)	; neuer Ton
 1620 F926  3E C7       	LD	A,11000111b	; EI, Zaehler 50Hz
 1621 F928  D3 8E       	OUT	(CTC2),A	; CTC2
 1622 F92A  78          	LD	A,B		; Dauer
 1623 F92B  D3 8E       	OUT	(CTC2),A
 1624 F92D  DB 89       TON3:	IN	A,(PIOBD)
 1625 F92F  E6 60       	AND	01100000b	; RAM8 maskieren
 1626 F931  B1          	OR	C
 1627 F932  D3 89       	OUT	(PIOBD),A	; Lautstaerke ausgeben
 1628 F934  FB          	EI
 1629 F935  0E 8C       	LD	C,CTC0
 1630 F937  CD F93C     	CALL	TON4		; Tonkanal 1 starten
 1631 F93A  0C          	INC	C		; CTC1
 1632 F93B  EB          	EX	DE,HL		; Tonkanal 2 starten
 1633 F93C  7D          TON4:	LD	A,L		; Zeitkonstante
 1634 F93D  A7          	AND	A		; Ton?
 1635 F93E  2E 03       	LD	L,3		; CTC Stop
 1636 F940  28 0C       	JR	Z,TON6		; kein Ton
 1637 F942  6F          	LD	L,A		; Zeitkonstante wieder in L
 1638 F943  3E 38       	LD	A,00111000b	; Steuerbyte "Zeitgeber" vor 3x RRA
 1639 F945  CB 3C       	SRL	H		; Bit 0 (Vorteiler) nach CY
 1640 F947  1F          	RRA
 1641 F948  1F          	RRA			; Vorteiler nach Bit 5 rotieren
 1642 F949  1F          	RRA
 1643 F94A  F3          	DI
 1644 F94B  ED 79       	OUT	(C),A
 1645 F94D  FB          	EI			; Interrupts wieder ein nach zweitem OUT
 1646 F94E  ED 69       TON6:	OUT	(C),L
 1647 F950  C9          	RET
 1648                   
 1649                   ; ESC-Funktionen:
 1650                   
 1651 F951  21 B7A2     ESCPRG:	LD	HL,STBT		; ShSTOP
 1652 F954  CB E6       	SET	4,(HL)		; Kennung, dass ESC-Funktion folgt
 1653 F956  C9          	RET
 1654                   
 1655 F957  01 B200     ESC1:	LD	BC,VRAM0	; 0B200H
 1656 F95A  18 0D       	JR	ESCVR
 1657                   
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 162
CF47    INC

 1658 F95C  01 AD05     ESC2:	LD	BC,VRAM1+05H	; 0AD05H
 1659 F95F  18 08       	JR	ESCVR
 1660                   
 1661 F961  01 AD04     ESC3:	LD	BC,VRAM1+04H	; 0AD04H
 1662 F964  18 03       	JR	ESCVR
 1663                   
 1664 F966  01 B201     ESC4:	LD	BC,VRAM0+01H	; 0B201H
 1665 F969  60          ESCVR:	LD	H,B
 1666 F96A  2E 00       	LD	L,0
 1667 F96C  22 B7CB     	LD	(VRAM),HL
 1668 F96F  06 FA       	LD	B,0FAH
 1669 F971  78          AXO84:	LD	A,B		; AND/XOR/OUT84
 1670 F972  F3          	DI			; Befehl ab CAOS 4.3 zusaetzlich
 1671 F973  DD A6 01    	AND	(IX+1)
 1672 F976  A9          	XOR	C
 1673 F977  DD 77 01    OUT84:	LD	(IX+1),A
 1674 F97A  D3 84       	OUT	(PORT1),A
 1675 F97C  FB          	EI			; Befehl ab CAOS 4.3 zusaetzlich
 1676 F97D  C9          	RET
 1677                   
 1678 F97E  0E 04       ESC7:	LD	C,00000100b	; Invers-Bit
 1679 F980  21 B7A2     XORSTB:	LD	HL,STBT
 1680 F983  7E          	LD	A,(HL)
 1681 F984  A9          	XOR	C
 1682 F985  77          	LD	(HL),A
 1683 F986  C9          	RET
 1684                   
 1685 F987  F3          ESC9:	DI			; Befehl ab CAOS 4.3 zusaetzlich
 1686 F988  DD 7E 01    	LD	A,(IX+1)	; VR: A
 1687 F98B  EE 02       	XOR	2
 1688 F98D  18 E8       	JR	OUT84		; BC unveraendert
 1689                   
 1690 F98F  21 B7A2     ESCA:	LD	HL,STBT
 1691 F992  CB B6       	RES	6,(HL)		; HRG aus
 1692 F994  01 FF08     ESCAB:	LD	BC,0FF08h
 1693 F997  CD F971     	CALL	AXO84
 1694 F99A  A1          	AND	C
 1695 F99B  80          	ADD	A,B		; CY = Bit 3
 1696 F99C  F3          	DI			; Befehl ab CAOS 4.5 zusaetzlich
 1697 F99D  DB 89       	IN	A,(PIOBD)
 1698 F99F  17          	RLA			; als Bit 0 einschieben
 1699 F9A0  0F          	RRCA			; auf Bit 7 rotieren
 1700 F9A1  D3 89       	OUT	(PIOBD),A
 1701 F9A3  FB          	EI			; Befehl ab CAOS 4.5 zusaetzlich
 1702 F9A4  C9          	RET
 1703                   
 1704 F9A5  21 B7A2     ESCB:	LD	HL,STBT
 1705 F9A8  CB F6       	SET	6,(HL)		; HRG ein
 1706 F9AA  18 E8       	JR	ESCAB
 1707                   
 1708 F9AC  0E 20       ESCC:	LD	C,00100000b	; IBM <-> CAOS
 1709 F9AE  18 D0       	JR	XORSTB
 1710                   
 1711                   ; Druckerinitialisierung V.24 oder Centronics:
 1712 F9B0  7F7F        LST7F:	DW	7F7FH
 1713 F9B2  4C 53 54 44 	DB	'LSTDEV'
 1714 F9B8  01          	DB	1
 1715                   ;_____________________________________________________________
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 163
CF47    INC

 1716                   ;							**47**
 1717 F9B9  CD FB8F     V24OUT:	CALL	CON
 1718 F9BC  CD C8A4     	CALL	LSTC
 1719 F9BF  C3 FB9C     COF1:	JP	COFF
 1720                   
 1721                   ; Reaktion auf ShCLR:
 1722                   
 1723 F9C2  F5          HCPGM:	PUSH	AF
 1724 F9C3  DD 7E 04    	LD	A,(IX+4)	; CAOS-C merken
 1725 F9C6  F5          	PUSH	AF
 1726                   	SETIXA	7,4		; SET 7,(IX+4),A
    1 F9C7  DD CB 04    	 DB	0DDh,0CBh,4
    2 F9CA  FF          	 DB	7 SHL 3 OR 11000111b
 1727 F9CB  D3 86       	OUT	(PORT2),A	; CAOS-C on
 1728 F9CD  CD CA62     	CALL	HCPGMC
 1729 F9D0  F1          	POP	AF
 1730 F9D1  DD 77 04    	LD	(IX+4),A	; wie vorher
 1731 F9D4  D3 86       	OUT	(PORT2),A
 1732 F9D6  F1          	POP	AF
 1733 F9D7  C9          	RET
 1734                   
 1735                   ; Duplexroutine
 1736                   
 1737 F9D8  7F7F        V24D7F:	DW	7F7FH
 1738 F9DA  56 32 34 44 	DB	'V24DUP'
 1739 F9E0  01          	DB	1
 1740                   ;_____________________________________________________________
 1741                   ;							**48**
 1742 F9E1  CD FB8F     V24DUP:	CALL	CON		; CAOS-C on
 1743 F9E4  CD C985     	CALL	V24DC
 1744 F9E7  DC F4D1     	CALL	C,ERRM		; Fehler
 1745 F9EA  18 D3       	JR	COF1		; CAOS-C off
 1746                   
 1747                   ; Druckroutine mit Protokoll
 1748                   
 1749 F9EC  CD E08C     ECHO:	CALL	CRT
 1750 F9EF  DD CB 04 7E PRINT:	BIT	7,(IX+4)
 1751 F9F3  20 08       	JR	NZ,PR1		; CAOS-C on!
 1752 F9F5  E5          	PUSH	HL
 1753 F9F6  21 FB9C     	LD	HL,COFF		; nach PRINTC
 1754 F9F9  E3          	EX	(SP),HL		; wieder aus
 1755 F9FA  CD FB8F     	CALL	CON
 1756 F9FD  C3 CA12     PR1:	JP	PRINTC		; drucken
 1757                   
 1758                   ; Druckroutine fuer M001:			17 Byte
 1759                   ;
 1760                   ; PE:	A	Zeichen
 1761                   ; VR:	-
 1762                   
 1763 FA00  C5          M001PR:	PUSH	BC
 1764 FA01  F5          	PUSH	AF
 1765 FA02  0E 05       	LD	C,05h		; M001 PIO Port B (Steuersignale)
 1766 FA04  ED 40       CBUSY1:	IN	B,(C)
 1767 FA06  CB 50       	BIT	2,B		; BUSY?
 1768 FA08  20 FA       	JR	NZ,CBUSY1
 1769 FA0A  06 01       	LD	B,00000001b	; Bit 0 = Strobe
 1770 FA0C  F3          	DI			; DI wegen Joysticktreiber
 1771 FA0D  D3 04       	OUT	(04h),A		; M001 PIO Port A (Daten)
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 164
CF47    INC

 1772 FA0F  18 0F       	JR	CSTROB
 1773                    
 1774                   ; Druckroutine fuer M021:
 1775                   ;
 1776                   ; PE:	A	Zeichen
 1777                   ; VR:	-
 1778                   
 1779 FA11  C5          M021PR:	PUSH	BC
 1780 FA12  F5          	PUSH	AF
 1781 FA13  0E 90       	LD	C,90h		; M021 PIO Port A (Steuersignale)
 1782 FA15  ED 40       CBUSY2:	IN	B,(C)
 1783 FA17  CB 70       	BIT	6,B		; BUSY?
 1784 FA19  20 FA       	JR	NZ,CBUSY2
 1785 FA1B  06 80       	LD	B,10000000b	; Bit 7 = Strobe
 1786 FA1D  F3          	DI			; DI wegen Joysticktreiber
 1787 FA1E  D3 91       	OUT	(91h),A		; M021 PIO Port B (Daten)
 1788 FA20  AF          CSTROB:	XOR	A		; Strobe-Impuls aktiv
 1789 FA21  ED 79       	OUT	(C),A		; war vorher ED 71 = OUT (C),0
 1790 FA23  FB          	EI			; (erst nach naechstem Befehl)
 1791 FA24  ED 41       	OUT	(C),B		; Strobe-Impuls passiv
 1792 FA26  F1          	POP	AF
 1793 FA27  C1          	POP	BC
 1794 FA28  C9          	RET
 1795                   
 1796                   ; Druckroutine fuer V.24:
 1797                   ;
 1798                   ; PE:	A	Zeichen
 1799                   ; VR:	-
 1800                   
 1801 FA29  C5          V24PR:	PUSH	BC
 1802 FA2A  F5          	PUSH	AF
 1803 FA2B  CD FA83     	CALL	LCSO
 1804 FA2E  C6 0A       V24PR0:	ADD	A,0Ah		; SIO-Steuerport
 1805 FA30  4F          	LD	C,A
 1806 FA31  ED 78       V24PR1:	IN	A,(C)
 1807 FA33  E6 04       	AND	00000100b	; bereit?
 1808 FA35  20 03       	JR	NZ,V24PR2
 1809 FA37  3C          	INC	A		; A=1
 1810                   ;	CALL	WAIT		; nein: warten (wofuer?)
 1811 FA38  18 F7       	JR	V24PR1
 1812                   	;
 1813 FA3A  0D          V24PR2:	DEC	C		; SIO-Datenport
 1814 FA3B  0D          	DEC	C
 1815 FA3C  F1          	POP	AF
 1816 FA3D  ED 79       	OUT	(C),A		; Ausgabe
 1817 FA3F  C1          	POP	BC
 1818 FA40  C9          	RET
 1819                   
 1820                   ; Ausgabe V.24-Duplex:
 1821                   ;
 1822                   ; PE:	A	Zeichen
 1823                   ; VR:	-
 1824                   ;
 1825 FA41  C5          V24OT:	PUSH	BC
 1826 FA42  F5          	PUSH	AF
 1827 FA43  CD FA8B     	CALL	LCSOD		; Adresse holen
 1828 FA46  18 E6       	JR	V24PR0
 1829                   
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 165
CF47    INC

 1830                   ; Eingabe V.24-Duplex (Interrupt):
 1831                   ;
 1832                   ; PA:	A	Zeichen
 1833                   ;	CY	Status (1 = BRK, 0 = Zeichen gueltig)
 1834                   ; VR:	AF
 1835                   ;
 1836 FA48  3E EE       V24I:	LD	A,11101110b	; Steuerbyte fuer Interrupt-Betrieb
 1837 FA4A  18 03       	JR	V24IN0
 1838                   
 1839                   ; Eingabe V.24-Duplex (Polling):
 1840                   ;
 1841                   ; PA:	A	Zeichen
 1842                   ;	CY	Status (1 = BRK, 0 = Zeichen gueltig)
 1843                   ; VR:	AF
 1844                   ;
 1845 FA4C  3A B7E8     V24IN:	LD	A,(HCPZ2)
 1846 FA4F  C5          V24IN0:	PUSH	BC
 1847 FA50  D5          	PUSH	DE
 1848 FA51  57          	LD	D,A		; Steuerbyte
 1849 FA52  E6 04       	AND	00000100b	; Kanal A oder B?
 1850 FA54  0F          	RRCA
 1851 FA55  0F          	RRCA
 1852 FA56  C6 0A       	ADD	A,0Ah		; SIO-Steuerport
 1853 FA58  4F          	LD	C,A
 1854 FA59  3E 68       	LD	A,01101000b	; Sendeeinstellungen
 1855 FA5B  A2          	AND	D
 1856 FA5C  5F          	LD	E,A
 1857 FA5D  ED 78       V24IN1:	IN	A,(C)
 1858 FA5F  E6 01       	AND	00000001b	; CY=0, Daten abholbereit?
 1859 FA61  3E 05       	LD	A,5		; WR5 auswaehlen
 1860 FA63  F3          	DI			; Interrupts waehrend I/O-Sequenz sperren
 1861 FA64  ED 79       	OUT	(C),A
 1862 FA66  20 0B       	JR	NZ,V24IN2
 1863 FA68  3E 82       	LD	A,10000010b	; DTR+RTS ein
 1864 FA6A  B3          	OR	E
 1865 FA6B  ED 79       	OUT	(C),A		; Senderfreigabe
 1866 FA6D  FB          	EI
 1867 FA6E  CD E37C     	CALL	BRKT
 1868 FA71  30 EA       	JR	NC,V24IN1
 1869 FA73  ED 59       V24IN2:	OUT	(C),E		; DTR+RTS aus: Sender sperren
 1870 FA75  FB          	EI
 1871 FA76  38 08       	JR	C,V24IN3
 1872 FA78  0D          	DEC	C		; SIO-Datenport auswaehlen
 1873 FA79  0D          	DEC	C
 1874 FA7A  ED 40       	IN	B,(C)
 1875 FA7C  3E 7F       	LD	A,01111111b	; Maske fuer 7 Bit
 1876 FA7E  B2          	OR	D
 1877 FA7F  A0          	AND	B		; maskieren, CY=0
 1878 FA80  D1          V24IN3:	POP	DE
 1879 FA81  C1          	POP	BC
 1880 FA82  C9          	RET
 1881                   
 1882                   ; SIO-Offset fuer V24OUT
 1883                   ; PA: A (SIO-Offset)
 1884                   ; VR: AF
 1885 FA83  3A B7E1     LCSO:	LD	A,(HCPZ)
 1886 FA86  E6 04       LCSO1:	AND	00000100b	; Kanal A oder B?
 1887 FA88  0F          	RRCA
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 166
CF47    INC

 1888 FA89  0F          	RRCA
 1889 FA8A  C9          	RET
 1890                   
 1891                   ; SIO-Offset fuer V24DUP
 1892 FA8B  3A B7E8     LCSOD:	LD	A,(HCPZ2)
 1893 FA8E  18 F6       	JR	LCSO1
 1894                   ;
 1895                   ; ISR SIO B (Empfangsinterrupt)
 1896                   ; fuer MC-Load, MC-Start, Umschaltung auf Fremdtastatur
 1897                   ;
 1898 FA90  E5          ISRSB:	PUSH	HL
 1899 FA91  D5          	PUSH	DE
 1900 FA92  C5          	PUSH	BC
 1901 FA93  F5          	PUSH	AF
 1902 FA94  21 A800     	LD	HL,V24PL	; Steckplatz M003
 1903 FA97  CD E386     	CALL	IRMGET		; aus IRM lesen (Rueckkehr mit EI)
 1904 FA9A  47          	LD	B,A		; Steckplatz M003 holen
 1905 FA9B  0E 80       	LD	C,80h
 1906 FA9D  3E 01       	LD	A,1
 1907 FA9F  ED 79       	OUT	(C),A		; Modul einschalten
 1908 FAA1  D9          	EXX			; auf Zweitregistersatz wechseln
 1909 FAA2  D5          	 PUSH	DE		; DE' sichern
 1910 FAA3  C5          	 PUSH	BC		; BC' sichern
 1911 FAA4  DB 88       	 IN	A,(PIOAD)
 1912 FAA6  47          	 LD	B,A		; Schaltzustand IRM in Register B' merken
 1913 FAA7  DD 4E 04    	 LD	C,(IX+4)	; Schaltzustand CAOS-C  in Reg. C' merken
 1914                   	 SETIXA	7,4		; SET 7,(IX+4),A
    1 FAAA  DD CB 04    	 DB	0DDh,0CBh,4
    2 FAAD  FF          	 DB	7 SHL 3 OR 11000111b
 1915 FAAE  D3 86       	 OUT	(PORT2),A	; CAOS-C einschalten
 1916 FAB0  D9          	EXX
 1917 FAB1  21 D848     	LD	HL,V24POL
 1918 FAB4  F3          	DI
 1919 FAB5  DB 09       	IN	A,(9)		; empfangenes Zeichen von SIO abholen
 1920 FAB7  CD F54F     	CALL	INIEA		; DTR off
 1921 FABA  CD E5B3     	CALL	IRET		; EI; RETI
 1922                   
 1923 FABD  FE 0D       	CP	CR		; Fremdtastatur?
 1924 FABF  28 2D       	JR	Z,ISB2
 1925 FAC1  FE 1B       	CP	ESC		; MC-Programm?
 1926 FAC3  20 0A       	JR	NZ,ISB1
 1927                   
 1928 FAC5  CD FA48     	CALL	V24I		; Folgezeichen nach ESC abholen
 1929 FAC8  D6 54       	SUB	'T'		; ESC-T ?
 1930 FACA  28 2E       	JR	Z,ISB4		; -> MC laden
 1931 FACC  3D          	DEC	A		; ESC-U ?
 1932 FACD  28 74       	JR	Z,ISB6		; -> MC starten
 1933                   
 1934 FACF  26 B8       ISB1:	LD	H,HIGH(MODST)	; Modulsteuerbytespeicher
 1935 FAD1  68          	LD	L,B		; Steckplatz
 1936 FAD2  CD E386     	CALL	IRMGET		; Schaltzustand vor ISR ermitteln
 1937 FAD5  21 D83B     	LD	HL,V24INT	; SIO Kanal B wieder auf Interrupt einstellen
 1938 FAD8  0E 80       	LD	C,80h
 1939 FADA  F3          	DI
 1940 FADB  CD F54F     	CALL	INIEA		; initialisieren
 1941 FADE  ED 79       	OUT	(C),A		; M003-Schaltzustand wiederherstellen
 1942 FAE0  FB          	EI
 1943 FAE1  D9          	EXX
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 167
CF47    INC

 1944 FAE2  79          	 LD	A,C
 1945 FAE3  DD 77 04    	 LD	(IX+4),A
 1946 FAE6  D3 86       	 OUT	(PORT2),A	; CAOS-C wie vor Interrupt
 1947 FAE8  C1          	 POP	BC		; BC' regenerieren
 1948 FAE9  D1          	 POP	DE		; DE' regenerieren
 1949 FAEA  D9          	EXX
 1950 FAEB  C3 E097     	JP	POP4		; POP	AF,BC,DE,HL   RET
 1951                   
 1952 FAEE  F3          ISB2:	DI
 1953 FAEF  DD 36 F2 97 	LD	(IX-14),LOW(ISRT)	; neue Tastatur-ISR fuer SIO-B in
 1954 FAF3  DD 36 F3 E3 	LD	(IX-13),HIGH(ISRT)	; Interrupttabelle 01E2H+01E3H
 1955 FAF7  FB          	EI
 1956 FAF8  18 D5       	JR	ISB1
 1957                   ;
 1958                   ; MC laden (ESC-T, Adresse, Anzahl, Daten):
 1959                   ;
 1960 FAFA  21 B801     ISB4:	LD	HL,MODST+1	; IRM = internes Modul 1
 1961 FAFD  CD E386     	CALL	IRMGET		; Modulsteuerwort holen
 1962 FB00  E6 01       	AND	1
 1963 FB02  07          	RLCA			; auf Bit 2 rotieren
 1964 FB03  07          	RLCA
 1965 FB04  D9          	EXX			; auf Zweitregistersatz wechseln
 1966 FB05  57          	 LD	D,A
 1967 FB06  3E 7B       	 LD	A,01111011b	; USER-C aus
 1968 FB08  A0          	 AND	B		; gemerkte Schaltzustaende
 1969 FB09  B2          	 OR	D		; gewuenschter IRM-Schaltzustand
 1970 FB0A  57          	 LD	D,A
 1971 FB0B  D9          	EXX
 1972                   	RESIXA	7,4		; RES 7,(IX+4),A
    1 FB0C  DD CB 04    	 DB	0DDh,0CBh,4
    2 FB0F  BF          	 DB	7 SHL 3 OR 10000111b
 1973 FB10  D3 86       	OUT	(PORT2),A	; CAOS-C ausschalten
 1974 FB12  CD FA48     	CALL	V24I
 1975 FB15  6F          	LD	L,A		; HL = Adresse
 1976 FB16  CD FA48     	CALL	V24I
 1977 FB19  67          	LD	H,A
 1978 FB1A  CD FA48     	CALL	V24I
 1979 FB1D  5F          	LD	E,A		; DE = Anzahl Bytes
 1980 FB1E  CD FA48     	CALL	V24I
 1981 FB21  57          	LD	D,A
 1982 FB22  CD FA48     ISB5:	CALL	V24I
 1983 FB25  38 14       	JR	C,ISB8		; Break
 1984 FB27  4F          	LD	C,A		; C = Datenbyte
 1985 FB28  D9          	EXX
 1986 FB29  7A          	 LD	A,D		; logischer IRM-Schaltzustand
 1987 FB2A  D9          	EXX
 1988 FB2B  F3          	DI
 1989 FB2C  D3 88       	OUT	(PIOAD),A	; USER-C aus und IRM schalten
 1990 FB2E  71          	LD	(HL),C		; Daten in Speicher poken
 1991 FB2F  D9          	EXX
 1992 FB30  78          	 LD	A,B		; gemerkter IRM-Schaltzustand
 1993 FB31  D3 88       	 OUT	(PIOAD),A	; USER-C und IRM wiederherstellen
 1994 FB33  FB          	 EI
 1995 FB34  D9          	EXX
 1996 FB35  23          	INC	HL
 1997 FB36  1B          	DEC	DE		; Zaehler verringern
 1998 FB37  7B          	LD	A,E
 1999 FB38  B2          	OR	D		; bis Anzahl=0
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 168
CF47    INC

 2000 FB39  20 E7       	JR	NZ,ISB5
 2001 FB3B              ISB8:	SETIXA	7,4		; SET 7,(IX+4),A
    1 FB3B  DD CB 04    	 DB	0DDh,0CBh,4
    2 FB3E  FF          	 DB	7 SHL 3 OR 11000111b
 2002 FB3F  D3 86       	OUT	(PORT2),A	; CAOS-C einschalten
 2003 FB41  18 8C       	JR	ISB1
 2004                   ;
 2005                   ; MC starten (ESC-U, Adresse):
 2006                   ;
 2007 FB43  CD FA48     ISB6:	CALL	V24I
 2008 FB46  5F          	LD	E,A		; DE = Startadresse
 2009 FB47  CD FA48     	CALL	V24I
 2010 FB4A  57          	LD	D,A
 2011 FB4B  21 D83B     	LD	HL,V24INT	; SIO Kanal B wieder auf Interrupt einstellen
 2012 FB4E  D9          	EXX
 2013 FB4F  78          	 LD	A,B		; gemerkter IRM-Schaltzustand
 2014 FB50  D9          	EXX
 2015 FB51  F6 04       	OR	00000100b	; IRM einschalten
 2016 FB53  F3          	DI
 2017 FB54  CD F54F     	CALL	INIEA		; uminitialisieren
 2018 FB57  D3 88       	OUT	(PIOAD),A	; IRM schalten
 2019                   	RESIXA	7,4		; RES 7,(IX+4),A
    1 FB59  DD CB 04    	 DB	0DDh,0CBh,4
    2 FB5C  BF          	 DB	7 SHL 3 OR 10000111b
 2020 FB5D  D3 86       	OUT	(PORT2),A	; CAOS-C ausschalten
 2021 FB5F  ED 7B B7AE  	LD	SP,(SYSP)
 2022 FB63  26 B8       	LD	H,HIGH(MODST)	; Modulsteuerbytespeicher
 2023 FB65  68          	LD	L,B		; Steckplatz
 2024 FB66  7E          	LD	A,(HL)		; M003-Schaltzustand vor ISR ermitteln
 2025 FB67  ED 79       	OUT	(C),A		; und wiederherstellen
 2026 FB69  FB          	EI
 2027 FB6A  21 F269     	LD	HL,LOOP		; Rueckkehradresse nach Programmaufruf
 2028 FB6D  E5          	PUSH	HL
 2029 FB6E  EB          	EX	DE,HL
 2030 FB6F  E9          	JP	(HL)		; Programm jetzt starten
 2031                   
 2032                   ; fuer MODIC, FLOAD
 2033 FB70  CD FB9C     LDMAE:	CALL	COFF
 2034 FB73  F5          	PUSH	AF
 2035 FB74  3A B801     	LD	A,(MODST+1)
 2036 FB77  E6 01       	AND	1		; IRM off?
 2037 FB79  CC F03F     	CALL	Z,SCROFF
 2038 FB7C  F1          	POP	AF
 2039 FB7D  77          	LD	(HL),A		; Byte eintragen
 2040 FB7E  18 0C       	JR	JCON
 2041                   
 2042                   ; Datenbyte holen (fuer DISPC, MODIC, FSAVE, view)
 2043 FB80  CD FB9C     LDAME:	CALL	COFF		; CAOS-C aus
 2044 FB83  3A B801     	LD	A,(MODST+1)
 2045 FB86  E6 01       	AND	1		; IRM aus?
 2046 FB88  CC F03F     	CALL	Z,SCROFF
 2047 FB8B  7E          	LD	A,(HL)		; Byte holen
 2048 FB8C  CD F048     JCON:	CALL	SCRON
 2049                   
 2050                   ; CAOS-ROM-C einschalten:
 2051 FB8F  F5          CON:	PUSH	AF
 2052                   	SETIXA	7,4		; SET 7,(IX+4),A
    1 FB90  DD CB 04    	 DB	0DDh,0CBh,4
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 169
CF47    INC

    2 FB93  FF          	 DB	7 SHL 3 OR 11000111b
 2053 FB94  18 12       	JR	CSW
 2054                   ;_____________________________________________________________
 2055                   ;							**31**
 2056                   ; CAOS-Arbeitsbereich verlagern
 2057                   ; PE:	A	HW-Teil der IX-Arbeitszellen
 2058                   
 2059 FB96  CD FB8F     SIXD:	CALL	CON
 2060 FB99  CD C15C     	CALL	SIXC
 2061                   ;	JP	COFF		; reinlaufen...
 2062                   
 2063                   ; CAOS-ROM-C ausschalten falls erforderlich:
 2064                   ; VR:	-
 2065                   ;
 2066 FB9C  F5          COFF:	PUSH	AF
 2067 FB9D  3A B805     	LD	A,(MODST+5)	; Schaltzustand Moduladresse 5
 2068 FBA0  E6 01       	AND	1
 2069 FBA2  20 06       	JR	NZ,CNSW		; bleibt ein!
 2070                   	RESIXA	7,4		; RES 7,(IX+4),A
    1 FBA4  DD CB 04    	 DB	0DDh,0CBh,4
    2 FBA7  BF          	 DB	7 SHL 3 OR 10000111b
 2071 FBA8  D3 86       CSW:	OUT	(PORT2),A
 2072 FBAA  F1          CNSW:	POP	AF
 2073 FBAB  C9          	RET
 2074                   ;_____________________________________________________________
 2075                   ;							**41**
 2076                   ; Berechnung des Produktes zweier 8-Bit-Zahlen
 2077                   ; PE:	D, C	Faktoren (8 Bit)
 2078                   ; PA:	BA	Produkt (16 Bit)
 2079                   ; VR:	AF,HL,DE,B
 2080                   
 2081 FBAC  CD FB8F     MULT:	CALL	CON
 2082 FBAF  CD D2DB     	CALL	MULC		; BA=D*C
 2083 FBB2  18 E8       	JR	COFF
 2084                   ;
 2085                   ; CAOS 4.6 - Geraeteumschaltung und Anzeige
 2086                   ; %DEVICE	Auflisten der installierten Treiber
 2087                   ; %DEVICE n	Umschaltung Geraet n (0..7)
 2088                   ;
 2089 FBB4  7F7F        	DW	7F7Fh
 2090 FBB6  44 45 56 49 	DB	'DEVICE',1
 2091 FBBD  A7          	AND	A		; Parameter angegeben?
 2092 FBBE  28 15       	JR	Z,DRLIST	; nein, Treiber auflisten
 2093 FBC0  7D          	LD	A,L
 2094 FBC1  FE 08       	CP	8
 2095 FBC3  D2 F4D1     	JP	NC,ERRM		; n>8
 2096 FBC6  CD FBD7     	CALL	SETDEV		; Treiber einstellen
 2097 FBC9  DA F4D1     	JP	C,ERRM		; Treiber nicht aktiv
 2098 FBCC  CD FBD2     	CALL	DEVANZ		; Ergebnis anzeigen
 2099 FBCF  C3 F4DB     	JP	CRLF
 2100                   
 2101                   ; Geraetecode in Bits 2-4 (IX+8) eintragen und Treiberadressen in SUTAB kopieren
 2102                   ; PE:	A	Geraetecode 0...7
 2103                   ;		0 = Kassette - Standard
 2104                   ;		1 = Diskette - D004/D008
 2105                   ;		2 = USB (M052)
 2106                   ;		3 = Netzwerk (M052)
 2107                   ;		4-7 noch nicht benutzt
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 170
CF47    INC

 2108                   ;		8-FE	Name des aktuellen Treibers anzeigen
 2109                   ;		FF	alle Treiber auflisten
 2110                   ; PA:	CY=1	ausgewaehlter Treiber nicht aktiv
 2111                   ;	IX+8	Bit 2-4 entsprechend Treibernummer gesetzt
 2112                   ; VR:	AF,BC,DE,HL
 2113                   
 2114 FBD2  3E FE       DEVANZ:	LD	A,0FEh		; aktuellen Treiber anzeigen
 2115 FBD4  21          	db	21h
 2116 FBD5  3E FF       DRLIST:	LD	A,0FFh		; Treiber auflisten
 2117                   ;_____________________________________________________________
 2118                   ;							**49**
 2119                   ; Geraetetreiber auswaehlen, abfragen oder anzeigen
 2120                   ; PE:	A 	0..7	- Auswahl Geraetetreiber Nr. 0-7
 2121                   ;		8	- aktuellen Treiber abfragen
 2122                   ;		9-FEH	- aktuellen Treibername anzeigen
 2123                   ;		FFH	- Auflisten aller Treiber
 2124                   ; PA:	CY=1	ausgewhlter Treiber nicht aktiv
 2125                   ;	bei CY=0	HL = Zeiger auf Treibername
 2126                   ;			Z=1 - Kassettentreiber
 2127                   ; VR:	AF,BC,DE,HL
 2128                   
 2129 FBD7  CD FB8F     SETDEV:	CALL	CON
 2130 FBDA  CD D5F2     	CALL	SET_DD		; Routine im ROM C/D aufrufen
 2131 FBDD  C3 FB9C     SETDC:	JP	COFF
 2132                   
 2133                   ; Verzeichnis anzeigen:
 2134                   
 2135 FBE0  7F7F        	DW	7F7FH
 2136 FBE2  44 49 52 20 	DB	'DIR '
 2137 FBE6  1F          	DB	1FH		; Textargument zulaessig (Maske in DE)
 2138 FBE7  CD E4C9     	CALL	PV7
 2139 FBEA  08          	DB	8
 2140 FBEB  C9          	RET
 2141                   
 2142                   ; Laufwerk wechseln:
 2143                   
 2144 FBEC  7F7F        	DW	7F7FH
 2145 FBEE  43 44 20    	DB	'CD '		; ersetzt bisheriges Menuewort DRIVE
 2146 FBF1  1F          	DB	1FH		; Textargument zulaessig (Verzeichnis)
 2147 FBF2  CD E4C9     	CALL	PV7
 2148 FBF5  09          	DB	9
 2149 FBF6  C9          	RET
 2150                   
 2151                   ; Datei loeschen:
 2152                   
 2153 FBF7  7F7F        	DW	7F7FH
 2154 FBF9  45 52 41 20 	DB	'ERA '
 2155 FBFD  1F          	DB	1FH		; Textargument zulaessig (Dateiname)
 2156 FBFE  CD E4C9     	CALL	PV7
 2157 FC01  0A          	DB	10
 2158 FC02  C9          	RET
 2159                   
 2160                   ; Datei umbenennen:
 2161                   
 2162 FC03  7F7F        	DW	7F7FH
 2163 FC05  52 45 4E 20 	DB	'REN '
 2164 FC09  1F          	DB	1FH		; Textargument zulaessig (2 Dateinamen)
 2165 FC0A  CD E4C9     	CALL	PV7
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 171
CF47    INC

 2166 FC0D  0B          	DB	11
 2167 FC0E  C9          	RET
 2168                   ;
 2169                   ; Tastaturcodetabelle:
 2170                   ;				 Taste		Scancode:
 2171 FC0F  57 77       KTAB:	DB	'Ww'		;		00 01
 2172 FC11  41 61       	DB	'Aa'		;		02 03
 2173 FC13  32 22       	DB	'2"'		;		04 05
 2174 FC15  08 19       	DB	8,19H		; CUL		06 07
 2175 FC17  10 0C       	DB	10H,0CH		; HOME		08 09
 2176 FC19  2D 3D       	DB	'-='		;		0A 0B
 2177 FC1B  F2 F8       	DB	0F2H,0F8H	; F2		0C 0D
 2178 FC1D  59 79       	DB	'Yy'		;		0E 0F	
 2179 FC1F  45 65       	DB	'Ee'		;		10 11
 2180 FC21  53 73       	DB	'Ss'		;		12 13
 2181 FC23  33 23       	DB	'3#'		;		14 15
 2182 FC25  5E 5D       	DB	'^]'		;		16 17
 2183 FC27  01 0F       	DB	1,0FH		; CLR		18 19
 2184 FC29  3A 2A       	DB	':*'		;		1A 1B
 2185 FC2B  F3 F9       	DB	0F3H,0F9H	; F3		1C 1D
 2186 FC2D  58 78       	DB	'Xx'		;		1E 1F
 2187 FC2F  54 74       	DB	'Tt'		;		20 21
 2188 FC31  46 66       	DB	'Ff'		;		22 23
 2189 FC33  35 25       	DB	'5%'		;		24 25
 2190 FC35  50 70       	DB	'Pp'		;		26 27
 2191 FC37  1F 02       	DB	1FH,2		; DEL		28 29
 2192 FC39  30 40       	DB	'0',40H		;		2A 2B
 2193 FC3B  F5 FB       	DB	0F5H,0FBH	; F5		2C 2D
 2194 FC3D  56 76       	DB	'Vv'		;		2E 2F
 2195 FC3F  55 75       	DB	'Uu'		;		30 31
 2196 FC41  48 68       	DB	'Hh'		;		32 33
 2197 FC43  37 27       	DB	'7',27H		; 7 / Apostroph	34 35
 2198 FC45  4F 6F       	DB	'Oo'		;		36 37
 2199 FC47  1A 14       	DB	1AH,14H		; INS		38 39
 2200 FC49  39 29       	DB	'9)'		;		3A 3B
 2201 FC4B  03 04       	DB	3,4		; BRK		3C 3D
 2202 FC4D  4E 6E       	DB	'Nn'		;		3E 3F
 2203 FC4F  49 69       	DB	'Ii'		;		40 41
 2204 FC51  4A 6A       	DB	'Jj'		;		42 43
 2205 FC53  38 28       	DB	'8('		;		44 45
 2206 FC55  20 5B       	DB	' ['		; SPC		46 47
 2207 FC57  4B 6B       	DB	'Kk'		;		48 49
 2208 FC59  2C 3C       	DB	',<'		;		4A 4B
 2209 FC5B  13 1B       	DB	13H,ESC		; STOP		4C 4D
 2210 FC5D  4D 6D       	DB	'Mm'		;		4E 4F
 2211 FC5F  5A 7A       	DB	'Zz'		;		50 51
 2212 FC61  47 67       	DB	'Gg'		;		52 53
 2213 FC63  36 26       	DB	'6&'		;		54 55
 2214 FC65  1C 1D       	DB	1CH,1DH		; LIST/RUN	56 57
 2215 FC67  4C 6C       	DB	'Ll'		;		58 59
 2216 FC69  2E 3E       	DB	'.>'		;		5A 5B
 2217 FC6B  F6 FC       	DB	0F6H,0FCH	; F6		5C 5D
 2218 FC6D  42 62       	DB	'Bb'		;		5E 5F
 2219 FC6F  52 72       	DB	'Rr'		;		60 61
 2220 FC71  44 64       	DB	'Dd'		;		62 63
 2221 FC73  34 24       	DB	'4$'		;		64 65
 2222 FC75  5F 5C       	DB	'_\'		;		66 67
 2223 FC77  2B 3B       	DB	'+;'		;		68 69
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 172
CF47    INC

 2224 FC79  2F 3F       	DB	'/?'		;		6A 6B
 2225 FC7B  F4 FA       	DB	0F4H,0FAH	; F4		6C 6D
 2226 FC7D  43 63       	DB	'Cc'		;		6E 6F
 2227 FC7F  51 71       	DB	'Qq'		;		70 71
 2228 FC81  16 05       	DB	16H,5		; CAPS		72 73
 2229 FC83  31 21       	DB	'1!'		;		74 75
 2230 FC85  0A 12       	DB	LF,12H		; CUD		76 77
 2231 FC87  0B 11       	DB	0BH,11H		; CUU		78 79
 2232 FC89  09 18       	DB	9,18H		; CUR		7A 7B
 2233 FC8B  F1 F7       	DB	0F1H,0F7H	; F1		7C 7D
 2234 FC8D  0D 0E       	DB	CR,0EH		; ENTER		7E 7F
 2235                   ;
 2236                   ; Steuercodetabelle:
 2237                   ;
 2238 FC8F  F4BF        CRTTAB:	DW	NOOP	; 00
 2239 FC91  E201        	DW	CLR	; 01
 2240 FC93  E278        	DW	CLLN	; 02
 2241 FC95  F4BF        	DW	NOOP	; 03=BRK
 2242 FC97  F4BF        	DW	NOOP	; 04=Sh-BRK
 2243 FC99  E1BA        	DW	ESC0	; 05=TAB
 2244 FC9B  F4BF        	DW	NOOP	; 06 (bei CAOS 3.3 invers)
 2245 FC9D  E28C        	DW	BEEP	; 07
 2246 FC9F  E1E0        	DW	CUL	; 08
 2247 FCA1  E1C9        	DW	CUR	; 09
 2248 FCA3  E1D2        	DW	CUD	; 0A
 2249 FCA5  E1F0        	DW	CUU	; 0B
 2250 FCA7  E256        	DW	CLS	; 0C
 2251 FCA9  E266        	DW	CBL	; 0D=Enter
 2252 FCAB  F4BF        	DW	NOOP	; 0E=Sh-Enter
 2253 FCAD  E1DC        	DW	HCOPY	; 0F
 2254 FCAF  E264        	DW	HOMEPG	; 10
 2255 FCB1  E1F5        	DW	PAGEM	; 11
 2256 FCB3  E1FC        	DW	SCROL	; 12
 2257 FCB5  F4BF        	DW	NOOP	; 13=STOP
 2258 FCB7  E2D8        	DW	CLICK	; 14
 2259 FCB9  F4BF        	DW	NOOP	; 15
 2260 FCBB  F4BF        	DW	NOOP	; 16=CAPS
 2261 FCBD  F4BF        	DW	NOOP	; 17
 2262 FCBF  E1EA        	DW	CEL	; 18
 2263 FCC1  E266        	DW	CBL	; 19
 2264 FCC3  E237        	DW	INS	; 1A
 2265 FCC5  F951        	DW	ESCPRG	; 1B
 2266 FCC7  F4BF        	DW	NOOP	; 1C=LIST
 2267 FCC9  F4BF        	DW	NOOP	; 1D=RUN
 2268 FCCB  E1D0        	DW	NL	; 1E=CONT
 2269 FCCD  E204        	DW	DEL	; 1F
 2270                   ;
 2271                   ; BASIC-Token	(Bit 7 im 1. Byte gesetzt!)
 2272                   ;
 2273 FCCF              TOKTAB:	TOKEN	INKEY$		; D5
    1 FCCF  C9          	  DB	'I' + Y
    1 FCD0  4E          	  DB	'N' + Y
    1 FCD1  4B          	  DB	'K' + Y
    1 FCD2  45          	  DB	'E' + Y
    1 FCD3  59          	  DB	'Y' + Y
    1 FCD4  24          	  DB	'$' + Y
 2274                   	TOKEN	JOYST		; D6
    1 FCD5  CA          	  DB	'J' + Y
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 173
CF47    INC

    1 FCD6  4F          	  DB	'O' + Y
    1 FCD7  59          	  DB	'Y' + Y
    1 FCD8  53          	  DB	'S' + Y
    1 FCD9  54          	  DB	'T' + Y
 2275                   	TOKEN	STRING$		; D7
    1 FCDA  D3          	  DB	'S' + Y
    1 FCDB  54          	  DB	'T' + Y
    1 FCDC  52          	  DB	'R' + Y
    1 FCDD  49          	  DB	'I' + Y
    1 FCDE  4E          	  DB	'N' + Y
    1 FCDF  47          	  DB	'G' + Y
    1 FCE0  24          	  DB	'$' + Y
 2276                   	TOKEN	INSTR		; D8
    1 FCE1  C9          	  DB	'I' + Y
    1 FCE2  4E          	  DB	'N' + Y
    1 FCE3  53          	  DB	'S' + Y
    1 FCE4  54          	  DB	'T' + Y
    1 FCE5  52          	  DB	'R' + Y
 2277                   	TOKEN	RENUMBER	; D9
    1 FCE6  D2          	  DB	'R' + Y
    1 FCE7  45          	  DB	'E' + Y
    1 FCE8  4E          	  DB	'N' + Y
    1 FCE9  55          	  DB	'U' + Y
    1 FCEA  4D          	  DB	'M' + Y
    1 FCEB  42          	  DB	'B' + Y
    1 FCEC  45          	  DB	'E' + Y
    1 FCED  52          	  DB	'R' + Y
 2278                   	TOKEN	DELETE		; DA
    1 FCEE  C4          	  DB	'D' + Y
    1 FCEF  45          	  DB	'E' + Y
    1 FCF0  4C          	  DB	'L' + Y
    1 FCF1  45          	  DB	'E' + Y
    1 FCF2  54          	  DB	'T' + Y
    1 FCF3  45          	  DB	'E' + Y
 2279                   	TOKEN	PAUSE		; DB
    1 FCF4  D0          	  DB	'P' + Y
    1 FCF5  41          	  DB	'A' + Y
    1 FCF6  55          	  DB	'U' + Y
    1 FCF7  53          	  DB	'S' + Y
    1 FCF8  45          	  DB	'E' + Y
 2280                   	TOKEN	BEEP		; DC
    1 FCF9  C2          	  DB	'B' + Y
    1 FCFA  45          	  DB	'E' + Y
    1 FCFB  45          	  DB	'E' + Y
    1 FCFC  50          	  DB	'P' + Y
 2281                   	TOKEN	WINDOW		; DD
    1 FCFD  D7          	  DB	'W' + Y
    1 FCFE  49          	  DB	'I' + Y
    1 FCFF  4E          	  DB	'N' + Y
    1 FD00  44          	  DB	'D' + Y
    1 FD01  4F          	  DB	'O' + Y
    1 FD02  57          	  DB	'W' + Y
 2282                   	TOKEN	BORDER		; DE
    1 FD03  C2          	  DB	'B' + Y
    1 FD04  4F          	  DB	'O' + Y
    1 FD05  52          	  DB	'R' + Y
    1 FD06  44          	  DB	'D' + Y
    1 FD07  45          	  DB	'E' + Y
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 174
CF47    INC

    1 FD08  52          	  DB	'R' + Y
 2283                   	TOKEN	INK		; DF
    1 FD09  C9          	  DB	'I' + Y
    1 FD0A  4E          	  DB	'N' + Y
    1 FD0B  4B          	  DB	'K' + Y
 2284                   	TOKEN	PAPER		; E0
    1 FD0C  D0          	  DB	'P' + Y
    1 FD0D  41          	  DB	'A' + Y
    1 FD0E  50          	  DB	'P' + Y
    1 FD0F  45          	  DB	'E' + Y
    1 FD10  52          	  DB	'R' + Y
 2285                   	TOKEN	AT		; E1
    1 FD11  C1          	  DB	'A' + Y
    1 FD12  54          	  DB	'T' + Y
 2286                   	TOKEN	COLOR		; E2
    1 FD13  C3          	  DB	'C' + Y
    1 FD14  4F          	  DB	'O' + Y
    1 FD15  4C          	  DB	'L' + Y
    1 FD16  4F          	  DB	'O' + Y
    1 FD17  52          	  DB	'R' + Y
 2287                   	TOKEN	SOUND		; E3
    1 FD18  D3          	  DB	'S' + Y
    1 FD19  4F          	  DB	'O' + Y
    1 FD1A  55          	  DB	'U' + Y
    1 FD1B  4E          	  DB	'N' + Y
    1 FD1C  44          	  DB	'D' + Y
 2288                   	TOKEN	PSET		; E4
    1 FD1D  D0          	  DB	'P' + Y
    1 FD1E  53          	  DB	'S' + Y
    1 FD1F  45          	  DB	'E' + Y
    1 FD20  54          	  DB	'T' + Y
 2289                   	TOKEN	PRESET		; E5
    1 FD21  D0          	  DB	'P' + Y
    1 FD22  52          	  DB	'R' + Y
    1 FD23  45          	  DB	'E' + Y
    1 FD24  53          	  DB	'S' + Y
    1 FD25  45          	  DB	'E' + Y
    1 FD26  54          	  DB	'T' + Y
 2290                   	TOKEN	BLOAD		; E6
    1 FD27  C2          	  DB	'B' + Y
    1 FD28  4C          	  DB	'L' + Y
    1 FD29  4F          	  DB	'O' + Y
    1 FD2A  41          	  DB	'A' + Y
    1 FD2B  44          	  DB	'D' + Y
 2291                   	TOKEN	VPEEK		; E7
    1 FD2C  D6          	  DB	'V' + Y
    1 FD2D  50          	  DB	'P' + Y
    1 FD2E  45          	  DB	'E' + Y
    1 FD2F  45          	  DB	'E' + Y
    1 FD30  4B          	  DB	'K' + Y
 2292                   	TOKEN	VPOKE		; E8
    1 FD31  D6          	  DB	'V' + Y
    1 FD32  50          	  DB	'P' + Y
    1 FD33  4F          	  DB	'O' + Y
    1 FD34  4B          	  DB	'K' + Y
    1 FD35  45          	  DB	'E' + Y
 2293                   	TOKEN	LOCATE		; E9
    1 FD36  CC          	  DB	'L' + Y
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 175
CF47    INC

    1 FD37  4F          	  DB	'O' + Y
    1 FD38  43          	  DB	'C' + Y
    1 FD39  41          	  DB	'A' + Y
    1 FD3A  54          	  DB	'T' + Y
    1 FD3B  45          	  DB	'E' + Y
 2294                   	TOKEN	KEYLIST		; EA
    1 FD3C  CB          	  DB	'K' + Y
    1 FD3D  45          	  DB	'E' + Y
    1 FD3E  59          	  DB	'Y' + Y
    1 FD3F  4C          	  DB	'L' + Y
    1 FD40  49          	  DB	'I' + Y
    1 FD41  53          	  DB	'S' + Y
    1 FD42  54          	  DB	'T' + Y
 2295                   	TOKEN	KEY		; EB
    1 FD43  CB          	  DB	'K' + Y
    1 FD44  45          	  DB	'E' + Y
    1 FD45  59          	  DB	'Y' + Y
 2296                   	TOKEN	SWITCH		; EC
    1 FD46  D3          	  DB	'S' + Y
    1 FD47  57          	  DB	'W' + Y
    1 FD48  49          	  DB	'I' + Y
    1 FD49  54          	  DB	'T' + Y
    1 FD4A  43          	  DB	'C' + Y
    1 FD4B  48          	  DB	'H' + Y
 2297                   	TOKEN	PTEST		; ED
    1 FD4C  D0          	  DB	'P' + Y
    1 FD4D  54          	  DB	'T' + Y
    1 FD4E  45          	  DB	'E' + Y
    1 FD4F  53          	  DB	'S' + Y
    1 FD50  54          	  DB	'T' + Y
 2298                   	TOKEN	CLOSE		; EE
    1 FD51  C3          	  DB	'C' + Y
    1 FD52  4C          	  DB	'L' + Y
    1 FD53  4F          	  DB	'O' + Y
    1 FD54  53          	  DB	'S' + Y
    1 FD55  45          	  DB	'E' + Y
 2299                   	TOKEN	OPEN		; EF
    1 FD56  CF          	  DB	'O' + Y
    1 FD57  50          	  DB	'P' + Y
    1 FD58  45          	  DB	'E' + Y
    1 FD59  4E          	  DB	'N' + Y
 2300                   	TOKEN	RANDOMIZE	; F0
    1 FD5A  D2          	  DB	'R' + Y
    1 FD5B  41          	  DB	'A' + Y
    1 FD5C  4E          	  DB	'N' + Y
    1 FD5D  44          	  DB	'D' + Y
    1 FD5E  4F          	  DB	'O' + Y
    1 FD5F  4D          	  DB	'M' + Y
    1 FD60  49          	  DB	'I' + Y
    1 FD61  5A          	  DB	'Z' + Y
    1 FD62  45          	  DB	'E' + Y
 2301                   	TOKEN	VGET$		; F1
    1 FD63  D6          	  DB	'V' + Y
    1 FD64  47          	  DB	'G' + Y
    1 FD65  45          	  DB	'E' + Y
    1 FD66  54          	  DB	'T' + Y
    1 FD67  24          	  DB	'$' + Y
 2302                   	TOKEN	LINE		; F2
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 176
CF47    INC

    1 FD68  CC          	  DB	'L' + Y
    1 FD69  49          	  DB	'I' + Y
    1 FD6A  4E          	  DB	'N' + Y
    1 FD6B  45          	  DB	'E' + Y
 2303                   	TOKEN	CIRCLE		; F3
    1 FD6C  C3          	  DB	'C' + Y
    1 FD6D  49          	  DB	'I' + Y
    1 FD6E  52          	  DB	'R' + Y
    1 FD6F  43          	  DB	'C' + Y
    1 FD70  4C          	  DB	'L' + Y
    1 FD71  45          	  DB	'E' + Y
 2304                   	TOKEN	CSRLIN		; F4 bis hierher in CAOS 3.1 bis 4.4
    1 FD72  C3          	  DB	'C' + Y
    1 FD73  53          	  DB	'S' + Y
    1 FD74  52          	  DB	'R' + Y
    1 FD75  4C          	  DB	'L' + Y
    1 FD76  49          	  DB	'I' + Y
    1 FD77  4E          	  DB	'N' + Y
 2305                   	TOKEN	DEVICE		; F5 (DRIVE in CAOS 4.5, 4.6 und HCBASIC.COM)
    1 FD78  C4          	  DB	'D' + Y
    1 FD79  45          	  DB	'E' + Y
    1 FD7A  56          	  DB	'V' + Y
    1 FD7B  49          	  DB	'I' + Y
    1 FD7C  43          	  DB	'C' + Y
    1 FD7D  45          	  DB	'E' + Y
 2306                   	TOKEN	FILES		; F6
    1 FD7E  C6          	  DB	'F' + Y
    1 FD7F  49          	  DB	'I' + Y
    1 FD80  4C          	  DB	'L' + Y
    1 FD81  45          	  DB	'E' + Y
    1 FD82  53          	  DB	'S' + Y
 2307                   	TOKEN	CHDIR		; F7 bis hierher in CAOS 4.7
    1 FD83  C3          	  DB	'C' + Y
    1 FD84  48          	  DB	'H' + Y
    1 FD85  44          	  DB	'D' + Y
    1 FD86  49          	  DB	'I' + Y
    1 FD87  52          	  DB	'R' + Y
 2308 FD88  80          	DB	80H		; Ende-Kennung
 2309                   ;
 2310                   ; zugehoerige Sprungtabelle fuer BASIC-Token
 2311                   ;
 2312 FD89  E9DD        TOKJP:	DW	INKEY
 2313 FD8B  EC54        	DW	JOYST
 2314 FD8D  E643        	DW	STRING
 2315 FD8F  EAA5        	DW	INSTR
 2316 FD91  E6A2        TADR5:	DW	RENUM
 2317 FD93  E881        	DW	DELETE
 2318 FD95  E8A5        	DW	PAUSE
 2319 FD97  E8D5        	DW	BBEEP
 2320 FD99  E8F0        	DW	WINDOW
 2321 FD9B  D421        	DW	ARGVL1		; BORDER
 2322 FD9D  E9FB        	DW	INK
 2323 FD9F  EA1C        	DW	PAPER
 2324 FDA1  C348        	DW	SNER		; AT
 2325 FDA3  EA0D        	DW	BCOLOR
 2326 FDA5  EA6B        	DW	SOUND
 2327 FDA7  EA33        	DW	PSET
 2328 FDA9  EA30        	DW	PRESET
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 177
CF47    INC

 2329 FDAB  ED03        	DW	BLOAD
 2330 FDAD  C348        	DW	SNER		; VPEEK
 2331 FDAF  E92F        	DW	VPOKE
 2332 FDB1  E9AC        	DW	LOCATE
 2333 FDB3  EB1A        	DW	KEYLIST
 2334 FDB5  EB0F        	DW	BKEY
 2335 FDB7  EB26        	DW	SWITCH
 2336 FDB9  C348        	DW	SNER		; PTEST
 2337 FDBB  EC1C        	DW	CLOSE
 2338 FDBD  EC83        	DW	OPEN
 2339 FDBF  EC7D        	DW	RANDOM
 2340 FDC1  C348        	DW	SNER		; VGET
 2341 FDC3  ECB8        	DW	BLINE
 2342 FDC5  ECBD        	DW	CIRCLE
 2343 FDC7  C348        	DW	SNER		; CSRLIN
 2344 FDC9  ECE4        	DW	BDEV		; Speichergeraet einstellen
 2345 FDCB  ED29        	DW	FILES		; Verzeichnis anzeigen
 2346 FDCD  ED44        	DW	CHDIR		; Verzeichnis wechseln
 2347 FDCF              TOKJPE:
 2348                   
 2349                   	ABSFILL	0FDF0h,<ROM-F-Ende>
    7 FDCF  FF FF FF FF 	  DS	0FDF0h - $,0FFh
 2350                   
 2351                   ; High-Byte der Adresse muss konstant sein!
 2352                   ; je 1 Byte fuer Eingabe + Ausgabe pro Kanal
 2353                   
 2354 FDF0  16 24       BUPTAB:	DB	16H, 24H	; INTB, OCHR	Kanel #0 - Konsole
 2355 FDF2  37 38       	DB	37H, 38H	; MBIN, MBOUT	Kanal #1 - Kassette
 2356 FDF4  06 02       	DB	06H, 02H	; USIN1, UOT1	Kanal #2 - Anwenderkanal 2
 2357 FDF6  07 03       	DB	07H, 03H	; USIN2, UOT2	Kanal #3 - Anwenderkanal 3
 2358                   
 2359                   ; Adresse FDF8h fest - wird von anderen Programmen (z.B. TEMO) miz genutzt!
 2360                   
 2361 FDF8  80 40 20 10 BITTAB:	DB	80H,40H,20H,10H,8,4,2,1
  200 FE00              SMALL:	INCLUDE	ZSKLEIN.INC	; Zeichensatz Kleinbuchstaben
    1                   ;*****************************************
    2                   ;**	CAOS 4.7 Zeichensatz Klein	**
    3                   ;**					**
    4                   ;**	Adresse:  FE00h bis FFFFh	**
    5                   ;**					**
    6                   ;**	letzte Aenderung: 05.02.2018	**
    7                   ;*****************************************
    8                   ;
    9                   ; 31.10.2017 geaendert (aehnlich CAOS 3.3):
   10                   ; Codes fuer 02h, 08h, 09h, 0Dh, 0Ah, 0Bh, 0Ch, 11h, 12h, 13h, 16h, 18h, 19h
   11                   
   12 FE00  00 00 00 00 	DB	000H, 000H, 000H, 000H, 000H, 000H, 081H, 0FFH	; 00H Dummy
   13 FE08  00 00 22 72 	DB	000H, 000H, 022H, 072H, 022H, 03EH, 000H, 000H	; 01H Backspace
   14 FE10  00 32 62 FE 	DB	000H, 032H, 062H, 0FEH, 062H, 032H, 000H, 000H	; 02H Zeile loeschen
   15 FE18  7E 81 B9 A5 	DB	07EH, 081H, 0B9H, 0A5H, 0B9H, 0A5H, 0B9H, 081H	; 03H Break
   16 FE20  55 FF 55 FF 	DB	055H, 0FFH, 055H, 0FFH, 055H, 0FFH, 055H, 0FFH	; 04H
   17 FE28  AA AA AA AA 	DB	0AAH, 0AAH, 0AAH, 0AAH, 0AAH, 0AAH, 0AAH, 0AAH	; 05H
   18 FE30  FF 00 FF 00 	DB	0FFH, 000H, 0FFH, 000H, 0FFH, 000H, 0FFH, 000H	; 06H
   19 FE38  00 00 3C 42 	DB	000H, 000H, 03CH, 042H, 042H, 07EH, 000H, 000H	; 07H Beep
   20 FE40  00 30 60 FE 	DB	000H, 030H, 060H, 0FEH, 060H, 030H, 000H, 000H	; 08H Cursor links
   21 FE48  00 18 0C FE 	DB	000H, 018H, 00CH, 0FEH, 00CH, 018H, 000H, 000H	; 09H Cursor rechts
   22 FE50  10 10 10 54 	DB	010H, 010H, 010H, 054H, 07CH, 038H, 010H, 000H	; 0AH Cursor unten
   23 FE58  10 38 7C 54 	DB	010H, 038H, 07CH, 054H, 010H, 010H, 010H, 000H	; 0BH Cursor oben
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 178
ZSKLEIN INC

   24 FE60  70 60 50 10 	DB	070H, 060H, 050H, 010H, 010H, 010H, 07CH, 000H	; 0CH Bildschirm loeschen
   25 FE68  00 02 12 32 	DB	000H, 002H, 012H, 032H, 07EH, 030H, 010H, 000H	; 0DH Enter
   26 FE70  AA 55 AA 55 	DB	0AAH, 055H, 0AAH, 055H, 0AAH, 055H, 0AAH, 055H	; 0EH
   27 FE78  3E 7C 7C 3E 	DB	03EH, 07CH, 07CH, 03EH, 03EH, 07CH, 0F8H, 0F8H	; 0FH Hardcopy
   28                   
   29 FE80  38 30 28 04 	DB	038H, 030H, 028H, 004H, 004H, 004H, 004H, 000H	; 10H Cursor Home
   30 FE88  FE 10 38 7C 	DB	0FEH, 010H, 038H, 07CH, 054H, 010H, 010H, 000H	; 11H Page-Modus
   31 FE90  10 10 54 7C 	DB	010H, 010H, 054H, 07CH, 038H, 010H, 0FEH, 000H	; 12H Scroll-Modus
   32 FE98  7E 81 9D A1 	DB	07EH, 081H, 09DH, 0A1H, 099H, 085H, 0B9H, 081H	; 13H Stop
   33 FEA0  00 3C 42 5A 	DB	000H, 03CH, 042H, 05AH, 05AH, 042H, 03CH, 000H	; 14H Tastenclick
   34                   ;	DB	03EH, 022H, 03EH, 022H, 022H, 02EH, 0ECH, 0C0H	; 14H Tastenclick (Noten)
   35 FEA8  88 44 22 11 	DB	088H, 044H, 022H, 011H, 088H, 044H, 022H, 011H	; 15H
   36 FEB0  00 FE 44 E4 	DB	000H, 0FEH, 044H, 0E4H, 04EH, 044H, 0FEH, 000H	; 16H Shift-Lock
   37 FEB8  11 22 44 88 	DB	011H, 022H, 044H, 088H, 011H, 022H, 044H, 088H	; 17H
   38 FEC0  02 32 1A FE 	DB	002H, 032H, 01AH, 0FEH, 01AH, 032H, 002H, 000H	; 18H Cursor an Zeilenende
   39 FEC8  80 98 B0 FE 	DB	080H, 098H, 0B0H, 0FEH, 0B0H, 098H, 080H, 000H	; 19H Cursor an Zeilenanfang
   40 FED0  00 08 7C 06 	DB	000H, 008H, 07CH, 006H, 07CH, 008H, 000H, 000H	; 1AH INS
   41 FED8  CC CC 33 33 	DB	0CCH, 0CCH, 033H, 033H, 0CCH, 0CCH, 033H, 033H	; 1BH ESC
   42 FEE0  7E 81 A1 A1 	DB	07EH, 081H, 0A1H, 0A1H, 0A1H, 0A1H, 0BDH, 081H	; 1CH List
   43 FEE8  7E 81 B9 A5 	DB	07EH, 081H, 0B9H, 0A5H, 0B9H, 0A5H, 0A5H, 081H	; 1DH Run
   44 FEF0  7E 81 99 A5 	DB	07EH, 081H, 099H, 0A5H, 0A1H, 0A5H, 099H, 081H	; 1EH Cont
   45 FEF8  00 10 3E 60 	DB	000H, 010H, 03EH, 060H, 03EH, 010H, 000H, 000H	; 1FH DEL
   46                   
   47 FF00  3C 42 99 A1 	DB	03CH, 042H, 099H, 0A1H, 0A1H, 099H, 042H, 03CH	; 60H (c)
   48 FF08  00 00 78 0C 	DB	000H, 000H, 078H, 00CH, 07CH, 0CCH, 076H, 000H	; 61H a
   49 FF10  E0 60 7C 66 	DB	0E0H, 060H, 07CH, 066H, 066H, 066H, 0DCH, 000H	; 62H b
   50 FF18  00 00 78 CC 	DB	000H, 000H, 078H, 0CCH, 0C0H, 0CCH, 078H, 000H	; 63H c
   51 FF20  1C 0C 7C CC 	DB	01CH, 00CH, 07CH, 0CCH, 0CCH, 0CCH, 076H, 000H	; 64H d
   52 FF28  00 00 78 CC 	DB	000H, 000H, 078H, 0CCH, 0FCH, 0C0H, 078H, 000H	; 65H e
   53 FF30  38 6C 60 F0 	DB	038H, 06CH, 060H, 0F0H, 060H, 060H, 0F0H, 000H	; 66H f
   54 FF38  00 00 76 CC 	DB	000H, 000H, 076H, 0CCH, 0CCH, 07CH, 00CH, 0F8H	; 67H g
   55 FF40  E0 60 6C 76 	DB	0E0H, 060H, 06CH, 076H, 066H, 066H, 0E6H, 000H	; 68H h
   56 FF48  30 00 70 30 	DB	030H, 000H, 070H, 030H, 030H, 030H, 0FCH, 000H	; 69H i
   57 FF50  0C 00 1C 0C 	DB	00CH, 000H, 01CH, 00CH, 00CH, 0CCH, 0CCH, 078H	; 6AH j
   58 FF58  E0 60 66 6C 	DB	0E0H, 060H, 066H, 06CH, 078H, 06CH, 0E6H, 000H	; 6BH k
   59 FF60  70 30 30 30 	DB	070H, 030H, 030H, 030H, 030H, 030H, 0FCH, 000H	; 6CH l
   60 FF68  00 00 CC FE 	DB	000H, 000H, 0CCH, 0FEH, 0FEH, 0D6H, 0C6H, 000H	; 6DH m
   61 FF70  00 00 F8 CC 	DB	000H, 000H, 0F8H, 0CCH, 0CCH, 0CCH, 0CCH, 000H	; 6EH n
   62 FF78  00 00 78 CC 	DB	000H, 000H, 078H, 0CCH, 0CCH, 0CCH, 078H, 000H	; 6FH o
   63                   
   64 FF80  00 00 DC 66 	DB	000H, 000H, 0DCH, 066H, 066H, 07CH, 060H, 0F0H	; 70H p
   65 FF88  00 00 76 CC 	DB	000H, 000H, 076H, 0CCH, 0CCH, 07CH, 00CH, 01EH	; 71H q
   66 FF90  00 00 DC 76 	DB	000H, 000H, 0DCH, 076H, 066H, 060H, 0F0H, 000H	; 72H r
   67 FF98  00 00 7C C0 	DB	000H, 000H, 07CH, 0C0H, 078H, 00CH, 0F8H, 000H	; 73H s
   68 FFA0  10 30 7C 30 	DB	010H, 030H, 07CH, 030H, 030H, 034H, 018H, 000H	; 74H t
   69 FFA8  00 00 CC CC 	DB	000H, 000H, 0CCH, 0CCH, 0CCH, 0CCH, 076H, 000H	; 75H u
   70 FFB0  00 00 CC CC 	DB	000H, 000H, 0CCH, 0CCH, 0CCH, 078H, 030H, 000H	; 76H v
   71 FFB8  00 00 C6 D6 	DB	000H, 000H, 0C6H, 0D6H, 0FEH, 0FEH, 06CH, 000H	; 77H w
   72 FFC0  00 00 C6 6C 	DB	000H, 000H, 0C6H, 06CH, 038H, 06CH, 0C6H, 000H	; 78H x
   73 FFC8  00 00 CC CC 	DB	000H, 000H, 0CCH, 0CCH, 0CCH, 07CH, 00CH, 0F8H	; 79H y
   74 FFD0  00 00 FC 98 	DB	000H, 000H, 0FCH, 098H, 030H, 064H, 0FCH, 000H	; 7AH z
   75 FFD8  6C 00 78 0C 	DB	06CH, 000H, 078H, 00CH, 07CH, 0CCH, 076H, 000H	; 7BH ae
   76 FFE0  CC 00 78 CC 	DB	0CCH, 000H, 078H, 0CCH, 0CCH, 0CCH, 078H, 000H	; 7CH oe
   77 FFE8  CC 00 CC CC 	DB	0CCH, 000H, 0CCH, 0CCH, 0CCH, 0CCH, 076H, 000H	; 7DH ue
   78 FFF0  3C 66 66 6C 	DB	03CH, 066H, 066H, 06CH, 066H, 066H, 06CH, 0F0H	; 7EH sz
   79 FFF8  FF 81 81 81 	DB	0FFH, 081H, 081H, 081H, 081H, 081H, 081H, 0FFH	; 7FH
  201                   
  202                   	.DEPHASE
SLR180 SuperFast Relocating Macro Assembler     			    SLR180 1.31 Page 179
CAOS47  Z80

  203                   
  204                   	END
 0 Error(s) Detected.
 16512 Absolute Bytes. 1236 Symbols Detected.
C6 D6 	DB	000H, 000H, 0C6H, 0D6H, 0FEH, 0FEH, 06CH, 000H	; 77H w
   72 FFC0  00 00 C6 6C 	DB	000H, 000H, 0C6